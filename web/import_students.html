<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Import h·ªçc vi√™n | Admission Check</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <link rel="stylesheet" href="style.css">
  <link rel="icon" type="image/png" href="hutech.png" sizes="32x32">
  <link rel="apple-touch-icon" href="hutech.png">
  <meta name="theme-color" content="#2563eb">
</head>
<body class="bg-gray-50">
  <div class="max-w-7xl mx-auto p-6 space-y-6">

    <!-- Header -->
    <header class="flex flex-wrap gap-3 items-center justify-between">
      <div class="flex items-center gap-3 min-w-0">
        <a href="/index_home.html" title="V·ªÅ trang ch·ªß" class="flex items-center gap-2 hover:opacity-80 transition">
          <img src="hutech.png" alt="HUTECH" class="h-8 w-8 object-contain select-none" />
        </a>
        <div>
          <h1 class="text-2xl font-bold leading-tight">Import danh s√°ch h·ªçc vi√™n</h1>
          <p class="text-sm text-gray-500">N·∫°p .xlsx/.csv ‚Üí map c·ªôt ‚Üí g·ª≠i t·∫°o h·ªì s∆° (docs ƒë·ªÉ tr·ªëng).</p>
        </div>
      </div>

      <div class="flex items-center gap-2">
        <button id="btnTplXlsx" class="btn btn-soft" title="T·∫£i file m·∫´u Excel">‚¨áÔ∏è Template XLSX</button>
        <button id="btnTplCsv" class="btn btn-outline" title="T·∫£i file m·∫´u CSV">‚¨áÔ∏è Template CSV</button>
        <span class="hidden md:inline-block w-px h-6 bg-gray-200"></span>

        <label class="text-sm text-gray-500">API Base</label>
        <input id="apiBase" class="input w-72 md:w-80" placeholder="" />

        <span class="hidden md:inline-block w-px h-6 bg-gray-200"></span>
        <a href="/students_list.html" class="btn btn-outline" title="Danh s√°ch h·ªì s∆°">üìã Danh s√°ch</a>
        <a href="/index_home.html" class="btn btn-outline" title="Trang ch·ªß">‚Üê Trang ch·ªß</a>
      </div>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- LEFT -->
      <aside class="card space-y-5 lg:col-span-1 lg:sticky lg:top-6 lg:self-start">
        <!-- File -->
        <section class="space-y-2">
          <div class="font-semibold">T·ªáp d·ªØ li·ªáu</div>
          <div id="drop" class="drop p-5 text-center cursor-pointer select-none">
            <div class="text-gray-700 font-medium">K√©o & th·∫£ t·ªáp v√†o ƒë√¢y</div>
            <div class="text-xs text-gray-500">Ho·∫∑c b·∫•m ƒë·ªÉ ch·ªçn .xlsx/.xls/.csv</div>
            <input id="file" type="file" accept=".xlsx,.xls,.csv" class="hidden" />
          </div>
        </section>

        <!-- Defaults -->
        <section class="grid grid-cols-1 gap-3">
          <div>
            <div class="font-semibold mb-1">Ng√†y nh·∫≠n HS (m·∫∑c ƒë·ªãnh)</div>
            <small class="text-xs text-gray-500">√Åp d·ª•ng cho t·∫•t c·∫£ b·∫£n ghi khi import.</small>
            <input id="defaultNgayNhan" type="date" class="input" />
          </div>
        </section>
        <section class="grid grid-cols-1 gap-3">
          <div>
              <div class="font-semibold mb-2">Ng∆∞·ªùi nh·∫≠p</div>
              <div class="relative">
                <input id="nguoiNhan" class="input pr-10" placeholder="Ch∆∞a ƒëƒÉng nh·∫≠p" readonly>
                <span class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 text-sm" title="T·ª± ƒë·ªông l·∫•y theo t√†i kho·∫£n ƒëƒÉng nh·∫≠p">üîí</span>
              </div>
              <p id="meStatus" class="text-xs text-gray-500 mt-1"></p>
          </div>
        </section>

        <!-- Mapping -->
        <section class="space-y-2">
          <div class="flex items-center justify-between">
            <div class="font-semibold">Map c·ªôt ‚Üí tr∆∞·ªùng</div>
            <div class="flex gap-2">
              <button id="btnResetMap" class="btn btn-outline text-sm">Reset map</button>
            </div>
          </div>
          <div id="mappings" class="grid grid-cols-1 sm:grid-cols-2 gap-2"></div>
          <p class="text-xs text-gray-500">
            B·∫Øt bu·ªôc ph·∫£i map: <b>ma_ho_so</b>, <b>ho_ten</b>, <b>ma_so_hv</b>.
            <br>Ng√†y nh·∫≠n HS l·∫•y t·ª´ √¥ b√™n tr√°i, kh√¥ng c·∫ßn c√≥ trong file.
          </p>
        </section>

        <!-- Actions -->
        <section class="space-y-3">
          <div class="flex gap-2 flex-wrap">
            <button id="btnPreview" class="btn btn-outline" disabled>Xem tr∆∞·ªõc</button>
            <button id="btnUpload"  class="btn btn-primary" disabled>B·∫Øt ƒë·∫ßu import</button>
            <button id="btnStop"    class="btn btn-outline hidden">D·ª´ng</button>
          </div>
          <div>
            <div class="flex items-center justify-between text-sm text-gray-600">
              <span>Ti·∫øn ƒë·ªô</span><span id="stats">Ch∆∞a ch·∫°y.</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full overflow-hidden mt-1">
              <div id="bar" class="bg-blue-600 text-white text-xs text-center py-1 transition-all" style="width:0%">0%</div>
            </div>
          </div>
        </section>
      </aside>

      <!-- RIGHT -->
      <main class="card space-y-4 lg:col-span-2">
        <div class="flex flex-wrap items-end justify-between gap-2">
          <div>
            <div class="font-semibold">Xem tr∆∞·ªõc d·ªØ li·ªáu</div>
            <div class="text-xs text-gray-500">Hi·ªÉn th·ªã t·ªëi ƒëa <b>5</b> d√≤ng ƒë·∫ßu (cu·ªôn ƒë·ªÉ xem).</div>
          </div>
        </div>

        <div class="overflow-hidden border rounded-xl">
          <!-- Gi·ªõi h·∫°n chi·ªÅu cao, cho cu·ªôn -->
          <div id="previewBox" class="overflow-x-auto overflow-y-auto">
            <table class="table min-w-full">
              <thead id="thead"></thead>
              <tbody id="tbody"></tbody>
            </table>
          </div>
        </div>

        <!-- K·∫æT QU·∫¢ -->
        <div class="space-y-3">
          <div class="flex items-center justify-between flex-wrap gap-2">
            <div class="font-semibold">K·∫øt qu·∫£</div>
            <div class="flex items-center gap-2">
              <span class="px-2 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-700">DONE: <span id="okCount">0</span></span>
              <span class="px-2 py-1 rounded-full text-xs font-semibold bg-red-100 text-red-700">ERROR: <span id="errCount">0</span></span>
              <span class="px-2 py-1 rounded-full text-xs font-semibold bg-amber-100 text-amber-700">SKIP: <span id="skipCount">0</span></span>

              <!-- Export buttons -->
              <button id="btnExportErr" class="btn btn-outline btn-xs" disabled>üì§ Xu·∫•t l·ªói (XLSX)</button>
              <button id="btnExportAll" class="btn btn-outline btn-xs" disabled>üì¶ Xu·∫•t t·∫•t c·∫£ (XLSX)</button>

              <span class="hidden md:inline-block w-px h-4 bg-gray-200"></span>
              <button id="btnClearLog" class="btn btn-outline btn-xs">Clear</button>
            </div>
          </div>

          <div class="overflow-hidden border rounded-xl">
            <div class="overflow-auto max-h-72">
              <table class="table min-w-full">
                <thead>
                  <tr>
                    <th class="text-center w-16">STT</th>
                    <th class="text-center w-36">M√£ HS</th>
                    <th class="text-center w-40">Tr·∫°ng th√°i</th>
                    <th class="text-center">Th√¥ng ƒëi·ªáp</th>
                  </tr>
                </thead>
                <tbody id="resBody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <footer class="max-w-6xl mx-auto px-6 pb-4 text-right text-xs text-gray-500">
    ¬© <span class="font-semibold"><a href="https://hutech.edu.vn/e-hutech" target="_blank" rel="noopener noreferrer">V-HT.PTƒêT HUTECH</a></span>
    ‚ûñ Code by: <span class="font-semibold"><a href="http://zalo.me/tuanconghuynh" target="_blank" rel="noopener noreferrer">HC- Tuan</a></span>
  </footer>

  <script>
    // ===== Helpers & API base =====
    const $ = id => document.getElementById(id);
    const apiBase = () => $("apiBase").value.trim().replace(/\/+$/,'');
    const PREFIX_CANDIDATES = ["", "/api"];
    let API_PREFIX = "";

    (function initApiBase(){
      if (!$("apiBase").value) $("apiBase").value = window.location.origin;
      $("defaultNgayNhan").value = new Date().toISOString().slice(0,10);
    })();

    async function detectPrefix() {
      for (const p of PREFIX_CANDIDATES) {
        try { const r = await fetch(apiBase() + p + "/health", {credentials:"include"}); if (r.ok) { API_PREFIX = p; return; } } catch(_){}
      }
      API_PREFIX = "";
    }
    const makeUrl = (path) => apiBase() + API_PREFIX + path;

    async function apiFetch(path, init = {}){
      const opts = { credentials: "include", ...init };
      let r;
      try { r = await fetch(makeUrl(path), opts); }
      catch(e){ throw new Error("Kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c API: " + e.message); }

      if (r.status === 404) {
        const alt = API_PREFIX === "" ? "/api" : "";
        try {
          const r2 = await fetch(apiBase() + alt + path, opts);
          if (r2.ok) { API_PREFIX = alt; return r2; }
          return r2;
        } catch (e) { throw new Error("Kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c API (alt): " + e.message); }
      }
      return r;
    }

    // ===== Log & progress =====
    let parsedRows = [];
    let stopFlag = false;

    // K·∫øt qu·∫£: l∆∞u c·∫£ data g·ªëc ƒë√£ g·ª≠i (payload)
    // {type:'OK'|'ERR'|'SKIP', idx:number, msg:string, data:{...payload}}
    const results = [];

    //--- X·ª≠ l√Ω l·ªói th∆∞·ªùng g·∫∑p ---
    function translateMessage(msg){
      if (msg.includes("HTTP 409") && msg.includes("MSSV")) return "‚ùó M√£ s·ªë h·ªçc vi√™n (MSSV) ƒë√£ t·ªìn t·∫°i.";
      if (msg.includes("HTTP 422") && msg.includes("10 ch·ªØ s·ªë")) return "‚ö†Ô∏è MSSV ph·∫£i g·ªìm ƒë√∫ng 10 ch·ªØ s·ªë.";
      if (msg.includes("HTTP 400")) return "‚ö†Ô∏è D·ªØ li·ªáu kh√¥ng h·ª£p l·ªá ho·∫∑c thi·∫øu tr∆∞·ªùng b·∫Øt bu·ªôc.";
      if (msg.includes("HTTP 500")) return "üí• L·ªói h·ªá th·ªëng (Internal Server Error).";
      return msg.replace(/\(id=(\d+)\)/, "(MSSV: $1)");
    }

    function badge(type){
      if (type==='OK')   return '<span class="px-2 py-0.5 rounded-full text-xs font-semibold bg-green-100 text-green-700">TH√ÄNH C√îNG</span>';
      if (type==='SKIP') return '<span class="px-2 py-0.5 rounded-full text-xs font-semibold bg-amber-100 text-amber-700" title="Thi·∫øu d·ªØ li·ªáu b·∫Øt bu·ªôc">B·ªé QUA</span>';
      return '<span class="px-2 py-0.5 rounded-full text-xs font-semibold bg-red-100 text-red-700">L·ªñI</span>';
    }

    function rowClass(type){
      return type==='OK' ? 'bg-green-50/50' : (type==='SKIP' ? 'bg-amber-50/50' : 'bg-red-50/50');
    }

    function refreshExportButtons(){
      const any = results.length > 0;
      const hasErr = results.some(r => r.type !== 'OK');
      $("btnExportAll").disabled = !any;
      $("btnExportErr").disabled = !hasErr;
    }

    function renderResults(){
      const tbody = $('resBody');
      const ok   = results.filter(r=>r.type==='OK').length;
      const err  = results.filter(r=>r.type==='ERR').length;
      const skip = results.filter(r=>r.type==='SKIP').length;
      $('okCount').textContent = ok;
      $('errCount').textContent = err;
      $('skipCount').textContent = skip;

      tbody.innerHTML = results.map(r => `
        <tr class="${rowClass(r.type)}">
          <td class="text-center border-b">${r.idx}</td>
          <td class="border-b whitespace-nowrap font-medium">${r.data?.ma_ho_so || '‚Äî'}</td>
          <td class="border-b">${badge(r.type)}</td>
          <td class="border-b">${translateMessage(r.msg || '')}</td>
        </tr>
      `).join('');

      refreshExportButtons();
    }

    function addResult(type, idx, data, msg){
      results.push({type, idx, data, msg});
      renderResults();
    }

    // ·∫®n log text, gi·ªØ API t∆∞∆°ng th√≠ch
    function log(){ /* no-op */ }

    // Copy / Clear
    $('btnClearLog')?.addEventListener('click', ()=>{
      results.splice(0, results.length); renderResults();
    });

    function setBar(done, total){
      const pct = total ? Math.round(done*100/total) : 0;
      $('bar').style.width = pct + "%";
      $('bar').textContent = pct + "%";
      $('stats').textContent = total ? `ƒê√£ g·ª≠i ${done}/${total}` : "Ch∆∞a ch·∫°y.";
    }

    // ===== Field defs (ƒë·ªÉ hi·ªÉn th·ªã ti·∫øng Vi·ªát ph·∫ßn xem tr∆∞·ªõc) =====
    const FIELD_DEFS = [
      {key:"ma_ho_so",       label:"M√£ HS",           aliases:["ma ho so","ma_hs","mhs"]},
      {key:"ho_ten",         label:"H·ªç t√™n",          aliases:["ho va ten","hovaten","hoten","ten_hv","tenhv","ten"]},
      {key:"ma_so_hv",       label:"M√£ s·ªë HV",        aliases:["mshv","ma so","ma hoc vien","ma_hv","mahv"]},
      {key:"ngay_sinh",      label:"Ng√†y sinh",       aliases:["dob","date of birth","ns"]},
      {key:"so_dt",          label:"S·ªë ƒêT",           aliases:["sdt","so dien thoai","dien thoai","so lien he"]},
      {key:"email_hoc_vien", label:"Email h·ªçc vi√™n",  aliases:["email","email hoc vien","mail","gmail"]},
      {key:"nganh_nhap_hoc", label:"Ng√†nh nh·∫≠p h·ªçc",  aliases:["nganh","nganh hoc"]},
      {key:"dot",            label:"ƒê·ª£t",             aliases:["dot nhap hoc","dot tuyen"]},
      {key:"khoa",           label:"Kh√≥a",            aliases:["nien khoa","khoa hoc","nk"]},
      {key:"da_tn_truoc_do", label:"ƒê√£ TN tr∆∞·ªõc ƒë√≥",  aliases:["doi tuong","da tn","trinh do"]},
      {key:"ghi_chu",        label:"Ghi ch√∫",         aliases:["note","ghi chu"]},
    ];
    const LABEL_BY_KEY = Object.fromEntries(FIELD_DEFS.map(f=>[f.key,f.label]));
    const norm = s => String(s||"").toLowerCase().trim().replace(/\s+/g,' ').normalize('NFD').replace(/[\u0300-\u036f]/g,'');

    function guessMappings(headers){
      const hNorm = headers.map(h=>norm(h));
      const map = {};
      FIELD_DEFS.forEach(f=>{
        const idxExact = hNorm.findIndex(hn => hn === norm(f.key) || hn === norm(f.label));
        if (idxExact >= 0) { map[f.key] = headers[idxExact]; return; }
        if (f.aliases?.length){
          const idxAli = hNorm.findIndex(hn => f.aliases.some(a=> hn === norm(a)));
          if (idxAli >= 0) { map[f.key] = headers[idxAli]; return; }
        }
      });
      return map;
    }

    function renderMappingUI(headers){
      const container = $('mappings');
      container.innerHTML = "";
      const guess = guessMappings(headers);
      FIELD_DEFS.forEach(f=>{
        const wrap = document.createElement('div');
        wrap.innerHTML = `
          <label class="text-xs text-gray-600">${LABEL_BY_KEY[f.key]}</label>
          <select class="input mt-1" data-field="${f.key}">
            <option value="">‚Äî Ch·ªçn c·ªôt ‚Äî</option>
            ${headers.map(h=>`<option ${guess[f.key]===h?'selected':''}>${h}</option>`).join("")}
          </select>`;
        container.appendChild(wrap);
      });
    }

    function getMappingFromUI(){
      const selects = Array.from(document.querySelectorAll('#mappings select'));
      const m = {}; selects.forEach(sel=>{ if(sel.value) m[sel.dataset.field] = sel.value; });
      return m;
    }
    $('btnResetMap').onclick = ()=>{ document.querySelectorAll('#mappings select').forEach(s=> s.selectedIndex = 0); };

    // ===== File parsing =====
    function toArrayBuffer(file) {
      return new Promise((res, rej)=>{
        const fr = new FileReader();
        fr.onload = () => res(fr.result);
        fr.onerror = rej;
        fr.readAsArrayBuffer(file);
      });
    }
    function parseCSV(text){
      const lines = text.replace(/\r\n/g,"\n").split("\n").filter(x=>x.trim().length>0);
      const headers = lines[0].split(",").map(s=>s.trim());
      const rows = lines.slice(1).map(ln=>{
        const cols = ln.split(",");
        theObj = {}; headers.forEach((h,i)=> theObj[h]= (cols[i] ?? "").trim());
        return theObj;
      });
      return {headers, rows};
    }

    const dz = $('drop'), fileInput = $('file');
    dz.addEventListener("click", ()=> fileInput.click());
    ["dragenter","dragover"].forEach(ev => dz.addEventListener(ev, e => { e.preventDefault(); dz.classList.add("drag"); }));
    ["dragleave","drop"].forEach(ev => dz.addEventListener(ev, e => { e.preventDefault(); dz.classList.remove("drag"); }));
    dz.addEventListener("drop", e => {
      if (e.dataTransfer?.files?.length) { fileInput.files = e.dataTransfer.files; fileInput.dispatchEvent(new Event("change")); }
    });

    fileInput.addEventListener("change", async (e)=>{
      const f = e.target.files[0]; if(!f) return;
      parsedRows = []; $('thead').innerHTML=""; $('tbody').innerHTML="";
      try{
        if (f.name.toLowerCase().endsWith(".csv")) {
          const text = await f.text();
          const {headers, rows} = parseCSV(text);
          parsedRows = rows; renderMappingUI(headers); preview(headers, rows);
        } else {
          const buf = await toArrayBuffer(f);
          const wb = XLSX.read(buf, {type:"array"});
          const ws = wb.Sheets[wb.SheetNames[0]];
          const rows = XLSX.utils.sheet_to_json(ws, {header:1, defval:""});
          const headers = (rows[0]||[]).map(x=>String(x).trim());
          const objs = rows.slice(1)
            .filter(r=>r.some(c=>String(c).trim()!==""))
            .map(r=>{ const o={}; headers.forEach((h,i)=>o[h]= String(r[i]??"").trim()); return o; });
          parsedRows = objs; renderMappingUI(headers); preview(headers, objs);
        }
      }catch(err){ alert("Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c file: "+err.message); }
    });

    // Ti√™u ƒë·ªÅ xem tr∆∞·ªõc: chuy·ªÉn sang TV n·∫øu kh·ªõp key chu·∫©n
    function labelForPreview(h){
      const k = String(h||"").trim();
      return LABEL_BY_KEY[k] || k;
    }

    // === CH·ªà 5 D√íNG & KHUNG CU·ªòN (max-h-40 ·ªü outer) ===
    function preview(headers, rows){
      $('thead').innerHTML = `<tr>${headers.map(h=>`<th class="text-left">${labelForPreview(h)}</th>`).join("")}</tr>`;
      $('tbody').innerHTML = rows.slice(0,5).map(r=>`<tr>${headers.map(h=>`<td>${(r[h]??"")}</td>`).join("")}</tr>`).join("");
    }

    // ===== Date helpers =====
    function excelSerialToISO(n){
      const base = new Date(Date.UTC(1899,11,30));
      base.setUTCDate(base.getUTCDate() + Number(n));
      return base.toISOString().slice(0,10);
    }
    function parseDateFlexible(v){
      if (v == null) return "";
      const s = String(v).trim();
      if (!s) return "";
      if (/^\d+$/.test(s)) return excelSerialToISO(Number(s));
      let m = s.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/);
      if (m){ const dd=m[1].padStart(2,"0"), mm=m[2].padStart(2,"0"); return `${m[3]}-${mm}-${dd}`; }
      m = s.match(/^(\d{4})-(\d{2})-(\d{2})/);
      if (m) return `${m[1]}-${m[2]}-${m[3]}`;
      const d = new Date(s); if (!isNaN(d)) return d.toISOString().slice(0,10);
      return "";
    }

    // ===== Build payload & call API =====
    function makeApplicantPayload(src, map){
      const pick = (key, d="") => (map[key] ? (src[map[key]] ?? "").trim() : d);

      const ma_ho_so = pick("ma_ho_so","");

      // ‚úÖ lu√¥n d√πng ng√†y ·ªü √¥ m·∫∑c ƒë·ªãnh
      const ngay_nhan_form = $('defaultNgayNhan').value; // YYYY-MM-DD t·ª´ input[type=date]
      const ngay_nhan_iso = parseDateFlexible(ngay_nhan_form) || ngay_nhan_form;

      const ngay_sinh_iso = parseDateFlexible(pick("ngay_sinh")) || null;

      return {
        ma_ho_so,
        ngay_nhan_hs: ngay_nhan_iso,         // ‚úÖ ch·ªâ d√πng t·ª´ form
        ho_ten: pick("ho_ten"),
        ma_so_hv: pick("ma_so_hv"),
        ngay_sinh: ngay_sinh_iso,
        so_dt: pick("so_dt") || null,
        email_hoc_vien: pick("email_hoc_vien") || null,
        nganh_nhap_hoc: pick("nganh_nhap_hoc") || null,
        dot: pick("dot") || null,
        khoa: pick("khoa") || null,
        da_tn_truoc_do: pick("da_tn_truoc_do") || null,
        ghi_chu: pick("ghi_chu") || null,
        nguoi_nhan_ky_ten: $('nguoiNhan').value.trim() || null,
        docs: [],
        checklist_version_name: "v1"
      };
    }

    function requireMappings(m){
      const need = ["ma_ho_so","ho_ten","ma_so_hv"];
      const miss = need.filter(k=>!m[k]);
      if (miss.length){ alert("Thi·∫øu map c·ªôt: " + miss.join(", ")); return false; }
      return true;
    }

    $('btnPreview').onclick = () => {
      const m = getMappingFromUI();
      if (!requireMappings(m)) return;
      const test = parsedRows.slice(0,5).map(row=> makeApplicantPayload(row, m));
    };

    $('btnUpload').onclick = async ()=>{
      if (parsedRows.length === 0) { alert("Ch∆∞a ch·ªçn t·ªáp ho·∫∑c t·ªáp r·ªóng"); return; }
      if (!$('defaultNgayNhan').value) {
        alert("Vui l√≤ng ch·ªçn 'Ng√†y nh·∫≠n HS (m·∫∑c ƒë·ªãnh)' tr∆∞·ªõc khi import.");
        return;
      }
      await detectPrefix();
      stopFlag = false; $('btnStop').classList.remove('hidden');
      $('btnUpload').disabled = true;

      const m = getMappingFromUI();
      if (!requireMappings(m)) { $('btnUpload').disabled=false; return; }

      const total = parsedRows.length; let done=0, ok=0, fail=0;
      setBar(0,total); $('log').textContent="";

      for (let i=0;i<parsedRows.length;i++){
        if (stopFlag) { log("== ƒê√É D·ª™NG =="); break; }
        const body = makeApplicantPayload(parsedRows[i], m);

        if (!body.ma_ho_so || !body.ho_ten || !body.ma_so_hv){
          fail++; done++; setBar(done,total);
          addResult('SKIP', i+1, body, 'Thi·∫øu b·∫Øt bu·ªôc (ma_ho_so/ho_ten/ma_so_hv)');
          continue;
        }
        try{
          const r = await apiFetch("/applicants", {
            method:"POST", headers:{"Content-Type":"application/json"},
            body: JSON.stringify(body)
          });
          if(!r.ok){
            const t = await r.text();
            fail++; addResult('ERR', i+1, body, `HTTP ${r.status} ${t}`);
          } else {
            const j = await r.json();
            if (j?.ma_so_hv) body.ma_so_hv = j.ma_so_hv;
            ok++; addResult('OK', i+1, body, `T·∫°o th√†nh c√¥ng (MSSV: ${j.ma_so_hv || j.id || body.ma_so_hv})`);
          }
        }catch(e){
          fail++; addResult('ERR', i+1, body, e.message);
        }finally{
          done++; setBar(done,total);
          await new Promise(res=>setTimeout(res, 25));
        }
      }
      $('btnStop').classList.add('hidden');
      $('btnUpload').disabled = false;
    };
    $('btnStop').onclick = ()=>{ stopFlag = true; };

    // ===== /me
    async function ensureNguoiNhanFromSession(){
      try{
        await detectPrefix();
        const r = await apiFetch("/me");
        if (!r.ok) throw new Error();
        const me = await r.json();
        const name = me.full_name || me.username || "";
        $('nguoiNhan').value = name;
        $('nguoiNhan').setAttribute("readonly", "readonly");
        if (me.role === "Admin" || me.role === "NhanVien") {
          $('meStatus').textContent = `ƒê√£ g·∫Øn t·ª± ƒë·ªông: ${name} (${me.role})`;
          $('btnUpload').disabled = false;
          $('btnPreview').disabled = false;
        } else {
          $('meStatus').innerHTML = `T√†i kho·∫£n <b>${name}</b> (${me.role}) kh√¥ng c√≥ quy·ªÅn import.`;
          $('btnUpload').disabled = true;
          $('btnPreview').disabled = true;
        }
      } catch {
        $('nguoiNhan').value = "";
        $('nguoiNhan').setAttribute("readonly", "readonly");
        $('meStatus').innerHTML = 'Ch∆∞a ƒëƒÉng nh·∫≠p. <a class="text-blue-600 hover:underline" href="/login">ƒêƒÉng nh·∫≠p</a> ƒë·ªÉ g√°n ng∆∞·ªùi nh·∫≠n.';
        $('btnUpload').disabled = true;
        $('btnPreview').disabled = true;
      }
    }
    window.addEventListener("load", ensureNguoiNhanFromSession);

    // ===== Template
    function buildTemplateHeaders(){
      return ["ma_ho_so","ho_ten","ma_so_hv","ngay_sinh","so_dt","email_hoc_vien",
              "nganh_nhap_hoc","dot","khoa","da_tn_truoc_do","ghi_chu"]; // ‚ùå kh√¥ng c√≥ 'ngay_nhan_hs'
    }

    function sampleRows(){
      return [
        { ma_ho_so:"HS-0001", ho_ten:"Nguy·ªÖn VƒÉn A", ma_so_hv:"1234567890", ngay_sinh:"15/01/2005",
          so_dt:"0901234567", email_hoc_vien:"vana@example.com", nganh_nhap_hoc:"C√¥ng ngh·ªá th√¥ng tin",
          dot:"1/2025", khoa:"25", da_tn_truoc_do:"THPT", ghi_chu:"" },
        { ma_ho_so:"HS-0002", ho_ten:"Tr·∫ßn Th·ªã B",   ma_so_hv:"0987654321", ngay_sinh:"20/12/2004",
          so_dt:"0912345678", email_hoc_vien:"tran@example.com", nganh_nhap_hoc:"Qu·∫£n tr·ªã kinh doanh",
          dot:"1/2025", khoa:"25", da_tn_truoc_do:"Cao ƒë·∫≥ng", ghi_chu:"" }
      ];
    }

    $('btnTplXlsx').onclick = ()=>{
      const wb = XLSX.utils.book_new();
      const headers = buildTemplateHeaders();
      const data = [headers, ...sampleRows().map(r=>headers.map(h=>r[h]??""))];
      const ws = XLSX.utils.aoa_to_sheet(data);
      XLSX.utils.book_append_sheet(wb, ws, "HocVien");
      const guide = [
        ["H∆∞·ªõng d·∫´n"],
        ["- C·ªôt b·∫Øt bu·ªôc: ma_ho_so | ho_ten | ma_so_hv"],
        ["- Ng√†y nh·∫≠n HS ƒë∆∞·ª£c ch·ªçn ·ªü giao di·ªán, KH√îNG c·∫ßn c√≥ trong file."],
        ["- ƒê·ªãnh d·∫°ng ng√†y sinh g·ª£i √Ω: DD/MM/YYYY (v√≠ d·ª•: 01/10/2005)."]
      ];
      XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(guide), "HuongDan");
      XLSX.writeFile(wb, "template_hoc_vien.xlsx");
    };

    $('btnTplCsv').onclick = ()=>{
      const headers = buildTemplateHeaders();
      const rows = sampleRows();
      const csv = [headers.join(",")]
        .concat(rows.map(r=>headers.map(h=>String(r[h]??"").replace(/,/g," ")).join(",")))
        .join("\n");
      const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "template_hoc_vien.csv";
      document.body.appendChild(a); a.click(); a.remove();
      setTimeout(()=>URL.revokeObjectURL(a.href), 60000);
    };

    // ===== Export XLSX t·ª´ k·∫øt qu·∫£ (ƒë·∫ßy ƒë·ªß tr∆∞·ªùng) =====
    function toAoAFull(list){
      const header = [
        "MaHO","H·ªç t√™n","MSSV","Ng√†y sinh","S·ªë ƒêT","Email",
        "Ng√†nh nh·∫≠p h·ªçc","ƒê·ª£t","Kh√≥a","ƒê√£ TN tr∆∞·ªõc ƒë√≥","Ng√†y nh·∫≠n",
        "K·∫øt qu·∫£","Ghi ch√∫ k·∫øt qu·∫£"
      ];
      const aoa = [header];
      list.forEach(r=>{
        const d = r.data || {};
        const label = r.type==='OK' ? 'TH√ÄNH C√îNG' : (r.type==='SKIP' ? 'B·ªé QUA' : 'L·ªñI');
        aoa.push([
          d.ma_ho_so || "",
          d.ho_ten || "",
          d.ma_so_hv || "",
          d.ngay_sinh || "",
          d.so_dt || "",
          d.email_hoc_vien || "",
          d.nganh_nhap_hoc || "",
          d.dot || "",
          d.khoa || "",
          d.da_tn_truoc_do || "",
          d.ngay_nhan_hs || "",
          label,
          (r.msg ? translateMessage(r.msg) : "")
        ]);
      });
      return aoa;
    }
    function nowTag(){
      const d = new Date();
      const pad = n => String(n).padStart(2,"0");
      return `${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}_${pad(d.getHours())}${pad(d.getMinutes())}`;
    }
    function exportResults(onlyErrors=false){
      const data = onlyErrors ? results.filter(r=>r.type!=='OK') : results.slice();
      if (!data.length) return;
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(toAoAFull(data));
      ws['!cols'] = [
        {wch:12},{wch:22},{wch:14},{wch:12},{wch:12},{wch:26},
        {wch:22},{wch:10},{wch:8},{wch:16},{wch:12},{wch:12},{wch:60}
      ];
      XLSX.utils.book_append_sheet(wb, ws, "KetQuaImport");
      const fname = onlyErrors ? `import_errors_${nowTag()}.xlsx` : `import_result_${nowTag()}.xlsx`;
      XLSX.writeFile(wb, fname);
    }
    $("btnExportAll").addEventListener("click", ()=> exportResults(false));
    $("btnExportErr").addEventListener("click", ()=> exportResults(true));

    function adjustPreviewHeight() {
      const box = document.getElementById('previewBox');
      if (!box) return;

      box.style.maxHeight = 'none'; // b·ªè limit t·∫°m ƒë·ªÉ ƒëo
      const thead = document.querySelector('#thead');
      const tbody = document.querySelector('#tbody');

      const headerH = thead ? thead.getBoundingClientRect().height : 36;
      let rowH = 40;
      const firstRow = tbody?.querySelector('tr');
      if (firstRow) rowH = firstRow.getBoundingClientRect().height || rowH;

      const desired = headerH + rowH * 5 + 8;        // ~5 d√≤ng
      const maxByViewport = Math.floor(window.innerHeight * 0.7);

      box.style.maxHeight = Math.min(desired, maxByViewport) + 'px';
      box.style.overflowY = 'auto';   // ƒë·∫£m b·∫£o c√≥ cu·ªôn d·ªçc
      box.style.overflowX = 'auto';   // cu·ªôn ngang n·∫øu c·∫ßn
    }

    // ‚¨áÔ∏è Render T·∫§T C·∫¢ c√°c d√≤ng, KH√îNG slice
    function preview(headers, rows) {
      const labelForPreview = (h) => {
        const k = String(h || '').trim();
        return (LABEL_BY_KEY && LABEL_BY_KEY[k]) ? LABEL_BY_KEY[k] : k;
      };

      document.getElementById('thead').innerHTML =
        `<tr>${headers.map(h => `<th class="text-left">${labelForPreview(h)}</th>`).join('')}</tr>`;

      document.getElementById('tbody').innerHTML =
        rows.map(r => `<tr>${headers.map(h => `<td>${(r[h] ?? '')}</td>`).join('')}</tr>`).join('');

      requestAnimationFrame(adjustPreviewHeight);
    }

    window.addEventListener('resize', adjustPreviewHeight);

  </script>
</body>
</html>
