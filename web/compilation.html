<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bi√™n nh·∫≠n h·ªì s∆° nh·∫≠p h·ªçc | V-HT.PTƒêT HUTECH</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="style.css">
  <link rel="icon" type="image/png" href="hutech.png" sizes="32x32">
  <link rel="apple-touch-icon" href="hutech.png">
  <meta name="theme-color" content="#2563eb">
</head>
<body class="bg-gray-50">
  <!-- Toast -->
  <div id="toast-wrap"></div>

  <div class="max-w-6xl mx-auto p-6 space-y-6">
    <header class="flex flex-wrap items-center justify-between border-b border-gray-200 pb-3">
      <div class="flex items-center gap-3 min-w-0">
        <a href="/ams_home.html" class="flex items-center gap-3 hover:opacity-90 transition">
          <img src="hutech.png" alt="HUTECH" class="h-9 w-9 object-contain select-none" />
          <h1 class="text-2xl font-bold leading-none truncate text-blue-700">BI√äN NH·∫¨N H·ªí S∆† NH·∫¨P H·ªåC</h1>
        </a>
      </div>

      <div class="flex flex-wrap items-center gap-2 text-sm">
        <label for="apiBase" class="text-gray-600 font-medium">API Base</label>
        <input id="apiBase" class="input w-64 md:w-80" placeholder="http://..." />
        <button class="btn btn-outline" id="btnTestApi" title="Ki·ªÉm tra k·∫øt n·ªëi API">üîç Test</button>
        <button class="btn btn-outline" id="btnReloadChecklist" title="T·∫£i l·∫°i danh s√°ch checklist">‚Üª Checklist</button>
      </div>
    </header>

    <style>
      header { background: rgba(255,255,255,0.85); backdrop-filter: blur(6px); }
      a:hover img { transform: scale(1.05); transition: transform 0.2s ease; }
    </style>

    <!-- Quick Nav -->
    <nav class="flex flex-wrap items-center gap-2 -mt-2">
      <a id="navHome"    href="/ams_home.html" class="btn btn-primary">üè† Trang ch·ªß</a>
      <a id="navStudents" href="/students_list.html" class="btn btn-outline">üìã Danh s√°ch h·ªì s∆°</a>

      <span class="flex-1"></span>

      <span id="navHello" class="text-sm text-gray-600 hidden"></span>
      <a id="navLogin"  href="/login" class="btn btn-outline">Login</a>
      <button id="navLogout" class="btn btn-secondary hidden">LogOut</button>
    </nav>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Form -->
      <section class="lg:col-span-2 card">
        <div class="section-title">Nh·∫≠p Th√¥ng Tin H·ªì S∆°</div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="label">M√£ h·ªì s∆°</label>
            <input class="input" id="ma_ho_so" placeholder="0000" readonly />
          </div>
          <div>
            <label class="label">Ng√†y nh·∫≠n HS (M·∫∑c ƒë·ªãnh)</label>
            <input class="input" id="ngay_nhan_hs" type="date" readonly disabled />
          </div>
          <div>
            <label class="label" for="khoa">Ni√™n Kh√≥a</label>
            <select class="input" id="khoa" name="khoa">
              <option value="">-- Ch·ªçn kh√≥a --</option>
              <option>23</option><option>24</option><option>25</option><option>26</option>
              <option>27</option><option>28</option><option>29</option><option>30</option>
            </select>
          </div>
          <div>
            <label class="label">ƒê·ª£t</label>
            <select class="input" id="dot">
              <option value="">-- Ch·ªçn ƒë·ª£t --</option>
              <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
              <option>6</option><option>7</option><option>8</option><option>9</option><option>10</option>
              <option>11</option><option>12</option><option>13</option><option>14</option><option>15</option>
              <option>16</option><option>17</option><option>18</option><option>19</option><option>20</option>
            </select>
          </div>
        </div>

        <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="label">H·ªç v√† t√™n</label>
            <input class="input" id="ho_ten" placeholder="Nguy·ªÖn VƒÉn A" />
          </div>
          <div>
            <label class="label">M√£ s·ªë HV</label>
            <input class="input" id="ma_so_hv" placeholder="2510200xxx" />
          </div>
          <div>
            <label class="label">Gi·ªõi t√≠nh</label>
            <select class="input" id="gioi_tinh">
              <option value="">-- Ch·ªçn gi·ªõi t√≠nh --</option>
              <option value="Nam">Nam</option>
              <option value="N·ªØ">N·ªØ</option>
              <option value="Kh√°c">Kh√°c</option>
            </select>
          </div>
          <div>
            <label class="label">D√¢n t·ªôc</label>
            <input class="input" id="dan_toc" placeholder="Kinh, Hoa, Khmer..." />
          </div>
          <div>
            <label class="label">Ng√†y sinh</label>
            <input class="input" id="ngay_sinh" type="date" />
          </div>
          <div>
            <label class="label">S·ªë ƒëi·ªán tho·∫°i</label>
            <input class="input" id="so_dt" placeholder="012.345.678"/>
          </div>
          <div>
            <label class="label">Email h·ªçc vi√™n</label>
            <input class="input" id="email_hoc_vien" type="email" placeholder="nguyenvana@gmail.com"/>
          </div>
          <div>
            <label class="label">Ng√†nh nh·∫≠p h·ªçc</label>
            <select class="input" id="nganh_nhap_hoc">
              <option value="">-- Ch·ªçn ng√†nh --</option>
              <option>T√¢m l√Ω h·ªçc</option>
              <option>Ng√¥n ng·ªØ Anh</option>
              <option>C√¥ng ngh·ªá th√¥ng tin</option>
              <option>Qu·∫£n tr·ªã kinh doanh</option>
              <option>K·∫ø to√°n</option>
              <option>Lu·∫≠t kinh t·∫ø</option>
              <option>Qu·∫£n l√Ω x√¢y d·ª±ng</option>
              <option>T√†i ch√≠nh - Ng√¢n h√†ng</option>
              <option>Marketing</option>
            </select>
          </div>
          <div>
            <label class="label">ƒê√£ TN tr∆∞·ªõc ƒë√≥</label>
            <select class="input" id="da_tn_truoc_do">
              <option value="">-- Ch·ªçn ƒê·ªëi t∆∞·ª£ng --</option>
              <option>THPT</option><option>Trung c·∫•p</option><option>Cao ƒë·∫≥ng</option><option>ƒê·∫°i h·ªçc</option>
            </select>
          </div>
          <div>
            <label class="label">Ng∆∞·ªùi nh·∫≠n (Ch·ªØ k√Ω)</label>
            <div class="relative">
              <input id="nguoi_nhan_ky_ten" class="input pr-9 bg-gray-100 text-gray-500 cursor-not-allowed" readonly />
              <span class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 select-none" title="ƒê√£ kh√≥a">üîí</span>
            </div>
          </div>
        </div>

        <!-- Checklist -->
        <div class="mt-6">
          <div class="section-title">H·ªì s∆° g·ªìm:</div>
          <div class="overflow-auto">
            <table class="min-w-full border bg-white">
              <thead class="bg-gray-100">
                <tr>
                  <th class="p-2 border">STT</th>
                  <th class="p-2 border text-center">Danh m·ª•c</th>
                  <th class="p-2 border">C√≥?</th>
                  <th class="p-2 border">S·ªë l∆∞·ª£ng</th>
                </tr>
              </thead>
              <tbody id="docsBody"></tbody>
            </table>
          </div>
        </div>

        <!-- Ghi ch√∫ -->
        <div class="mt-4">
          <label class="label">Ghi ch√∫ (C√°c ch·ª©ng ch·ªâ kh√°c s·∫Ω ƒëi·ªÅn ·ªü ƒë√¢y)</label>
          <input class="input" id="ghi_chu" />
        </div>

        <div class="mt-6 flex gap-3 flex-wrap items-center">
          <button id="btnSave" class="btn btn-secondary">L∆∞u</button>
          <button id="btnUpdateApplicantMain" class="btn btn-secondary">C·∫≠p nh·∫≠t</button>
        </div>
        <div id="msg" class="mt-3 text-sm text-green-700"></div>
      </section>

      <!-- Panel ph·∫£i -->
      <aside class="card space-y-6 lg:sticky lg:top-4">
        <section>
          <div class="section-title">Tra c·ª©u & Ch·ªânh s·ª≠a h·ªì s∆°</div>

          <label class="label">Nh·∫≠p M√£ S·ªë H·ªçc Vi√™n</label>
          <div class="flex gap-2">
            <input class="input flex-1" id="q_ma_so_hv" placeholder="VD: 2510xxxxxx" />
            <button id="btnLoadApplicantMSHV" class="btn btn-outline">T·∫£i</button>
          </div>

          <label class="label mt-3 block">Ho·∫∑c Nh·∫≠p H·ªç v√† t√™n</label>
          <div class="flex gap-2">
            <input class="input flex-1" id="q_ho_ten" placeholder="VD: Nguy·ªÖn VƒÉn A" />
            <button id="btnSearchByName" class="btn btn-outline">T√¨m</button>
          </div>

          <div id="nameResults" class="mt-2 hidden">
            <div class="text-xs text-gray-500 mb-1">Ch·ªçn m·ªôt k·∫øt qu·∫£ ƒë·ªÉ t·∫£i v√†o form:</div>
            <ul id="nameResultsList" class="divide-y border rounded-md bg-white"></ul>
          </div>

          <div class="grid grid-cols-2 gap-2 mt-3">
            <button id="btnUpdateApplicant" class="btn btn-secondary">C·∫≠p nh·∫≠t</button>
            <button id="btnDeleteApplicant" class="btn btn-outline">X√≥a</button>

            <!-- Modal c·∫≠p nh·∫≠t l√Ω do -->
            <div id="modalUpdateReason" class="fixed inset-0 bg-slate-900/50 hidden items-center justify-center z-50 backdrop-blur-sm">
              <div class="bg-white rounded-2xl shadow-2xl w-[95vw] max-w-2xl transform transition-all scale-100">
                <div class="px-6 py-4 border-b flex items-center justify-between bg-blue-50 rounded-t-2xl">
                  <div class="text-lg font-bold text-blue-800">üìù Y√äU C·∫¶U C·∫¨P NH·∫¨T H·ªí S∆†</div>
                  <button id="urClose" class="text-sm px-3 py-1.5 border border-gray-300 rounded-lg hover:bg-gray-100 focus:ring-2 focus:ring-blue-300">‚ùå</button>
                </div>

                <div class="p-6 space-y-4 text-base">
                  <div>
                    <label for="updateReasonSelect" class="block font-semibold text-gray-800 mb-2">Y√™u c·∫ßu c·∫≠p nh·∫≠t</label>
                    <select id="updateReasonSelect" class="input w-full h-12 text-base">
                      <option value="">-- Ch·ªçn l·ªánh b·ªï sung --</option>
                      <option value="capnhat_hoso_moi">C·∫≠p nh·∫≠t h·ªì s∆° m·ªõi</option>
                      <option value="bosung_hoso">B·ªï sung h·ªì s∆°</option>
                      <option value="capnhat_thongtin">C·∫≠p nh·∫≠t th√¥ng tin h·ªçc vi√™n</option>
                      <option value="capnhat_chungchi">C·∫≠p nh·∫≠t ch·ª©ng ch·ªâ</option>
                      <option value="chinhsua_hoso">Ch·ªânh s·ª≠a h·ªì s∆°</option>
                      <option value="khac">L√Ω do kh√°c...</option>
                    </select>
                  </div>

                  <div id="reasonOtherWrap" class="hidden">
                    <label for="updateReasonText" class="block font-semibold text-gray-800 mb-2">Nh·∫≠p l√Ω do kh√°c</label>
                    <textarea id="updateReasonText" rows="3" class="input w-full text-base" placeholder="Nh·∫≠p l√Ω do kh√°c..."></textarea>
                  </div>
                </div>

                <div class="px-6 py-4 border-t flex justify-end gap-3 bg-gray-50 rounded-b-2xl">
                  <button id="urCancel" class="px-5 py-2 text-sm border border-gray-400 rounded-lg hover:bg-gray-100">H·ªßy</button>
                  <button id="urOK" class="px-5 py-2 text-sm bg-blue-600 text-white rounded-lg hover:bg-blue-700">C·∫≠p nh·∫≠t</button>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- In -->
        <section id="sectionPrintLoaded" class="mt-2">
          <div class="flex gap-2">
            <button id="btnPrintLoadedA5" class="btn btn-outline" disabled>In A5</button>
            <button id="btnPrintLoadedA4" class="btn btn-outline" disabled>In A4</button>
          </div>
          <p id="lookupMsg" class="text-sm text-gray-600 mt-2"></p>
        </section>

        <hr/>

        <section>
          <div class="section-title"><center>TR·ª¢ GI√öP</center></div>
          <ul class="list-disc ml-5 text-sm text-gray-600 space-y-1">
            <li>Ch·ªçn API Base r·ªìi nh·∫•n n√∫t Test cho l·∫ßn ƒë·∫ßu ho·∫∑c khi ƒë·ªïi server.</li>
            <li>Nh·∫•n n√∫t ‚Üª ƒë·ªÉ t·∫£i l·∫°i danh s√°ch h·ªì s∆° v√† checklist t·ª´ server.</li>
            <li>M√£ h·ªì s∆° v√† ng√†y nh·∫≠n HS s·∫Ω t·ª± ƒë·ªông g√°n</li>
            <li>PDF m·ªü trong tab m·ªõi; n·∫øu b·ªã ch·∫∑n s·∫Ω m·ªü ngay t·∫°i tab.</li>
            <li>T√¨m ki·∫øm theo <b>M√£ s·ªë HV</b> ho·∫∑c <b>H·ªç t√™n</b>.</li>
            <li>ƒê·ªÉ tr·ªëng s·ªë l∆∞·ª£ng trong checklist ƒë·ªÉ ƒë√°nh d·∫•u c√≥/kh√¥ng.</li>
            <li>Li√™n h·ªá Email: <a href="mailto:hc.tuan@hutech.edu.vn">hc.tuan@hutech.edu.vn</a></li>
            <li>Li√™n h·ªá zalo: <a href="http://zalo.me/tuanconghuynh">Hu·ª≥nh C√¥ng Tu·∫•n T·∫°i ƒë√¢y!</a></li>
          </ul>
        </section>
      </aside>
    </div>
  </div>

  <footer class="max-w-6xl mx-auto px-6 pb-4 text-right text-xs text-gray-500">
    ¬© <span class="font-semibold"><a href="https://hutech.edu.vn/e-hutech" target="_blank" rel="noopener noreferrer">V-HT.PTƒêT HUTECH</a></span>
    ‚ûñ Code by: <span class="font-semibold"><a href="http://zalo.me/tuanconghuynh" target="_blank" rel="noopener noreferrer">HC- Tuan</a></span>
  </footer>

  <!-- Modal Xo√° -->
  <div id="modalDel" class="fixed inset-0 bg-slate-900/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-2xl shadow-2xl w-[92vw] max-w-xl">
      <div class="px-5 py-4 border-b flex items-center justify-between">
        <div class="font-semibold">Xo√° h·ªì s∆°</div>
        <button id="mdClose" class="btn btn-outline btn-xs">ƒê√≥ng</button>
      </div>
      <div class="p-5 space-y-3">
        <div id="mdTitle" class="text-sm text-slate-700"></div>
        <label class="text-sm font-semibold text-gray-800 block mb-1">L√Ω do xo√° (b·∫Øt bu·ªôc)</label>
        <textarea id="mdReason" rows="4" class="input w-full" placeholder="Nh·∫≠p l√Ω do..."></textarea>
      </div>
      <div class="px-5 py-4 border-t flex justify-end gap-2">
        <button id="mdCancel" class="btn btn-outline">H·ªßy</button>
        <button id="mdOK" class="btn btn-secondary">OK</button>
      </div>
    </div>
  </div>

  <script>
  /* ·∫®n trang khi check ƒëƒÉng nh·∫≠p */
  document.documentElement.style.visibility = 'hidden';
  (async () => {
    const base = location.origin.replace(/\/+$/, '');
    const candidates = ["", "/api"];
    let ok = false, matchedPrefix = "";
    for (const p of candidates) {
      try {
        const r = await fetch(base + p + "/me", { credentials: "include", cache: "no-store" });
        if (r.ok) { ok = true; matchedPrefix = p; break; }
      } catch (_) {}
    }
    if (!ok) { const next = encodeURIComponent(location.pathname + location.search); location.replace(`/login?next=${next}`); return; }
    try { localStorage.setItem("apiBase", base); } catch {}
    window.__API_PREFIX = matchedPrefix;
    document.documentElement.style.visibility = '';
  })();

  /* ===== helpers ===== */
  const $ = (id) => document.getElementById(id);
  const debounce = (fn, ms=400) => { let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; };

  function showToast(msg, type='info', ms=2500){
    const escapeHtml = (s) => String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[c]));
    const wrap = $('toast-wrap'); if (!wrap) return;
    const existing = wrap.querySelectorAll('.toast'); if (existing.length >= 3) existing[0].remove();
    const el = document.createElement('div'); el.className = `toast ${type}`; el.setAttribute('role','status'); el.innerHTML = escapeHtml(msg);
    wrap.appendChild(el); requestAnimationFrame(()=> el.classList.add('show'));
    const t = setTimeout(()=>dismiss(), ms);
    function dismiss(){ el.classList.remove('show'); el.addEventListener('transitionend', ()=> el.remove(), {once:true}); }
    el.onclick = ()=>{ clearTimeout(t); dismiss(); };
  }

  // Date utils
  const ymdKeep = (s)=> (s||"").slice(0,10);
  function fmtDateToInput(s){
    if(!s) return "";
    const m = String(s).match(/^(\d{1,2})[\/-](\d{1,2})[\/-](\d{4})$/);
    if (m) return `${m[3]}-${m[2].padStart(2,'0')}-${m[1].padStart(2,'0')}`;
    const d = new Date(s); return Number.isNaN(d.getTime()) ? String(s).slice(0,10) : d.toISOString().slice(0,10);
  }

  // API base / prefix
  const STORAGE_KEY="apiBase"; let API_PREFIX = window.__API_PREFIX || "";
  function apiBase(){ return ($("apiBase").value || localStorage.getItem(STORAGE_KEY) || window.location.origin).trim().replace(/\/+$/,''); }
  async function pingPrefix(base){
    try{let r=await fetch(base+"/health",{credentials:"include"}); if(r.ok) return "";}catch(_){}
    try{let r2=await fetch(base+"/api/health",{credentials:"include"}); if(r2.ok) return "/api";}catch(_){}
    return null;
  }
  async function ensureApiBaseAndPrefix(){
    let base = localStorage.getItem(STORAGE_KEY) || window.location.origin; $("apiBase").value = base;
    let pref = await pingPrefix(base); if (pref !== null){ API_PREFIX=pref; return; }
    const guesses=[base, window.location.origin, "http://127.0.0.1:8000", "http://localhost:8000"];
    for (const g of guesses){ const p = await pingPrefix(g); if (p !== null){ $("apiBase").value=g; localStorage.setItem(STORAGE_KEY,g); API_PREFIX=p; return; } }
    for(;;){ const m = prompt("Kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c API.\nNh·∫≠p IP/URL server (vd: http://192.168.2.82:8000):", base); if(!m) break; const p=await pingPrefix(m.trim()); if(p!==null){ $("apiBase").value=m.trim(); localStorage.setItem(STORAGE_KEY,m.trim()); API_PREFIX=p; return; } base=m.trim(); }
    API_PREFIX="";
  }
  const makeUrl = (path)=> apiBase() + (API_PREFIX || "") + path;
  async function apiFetch(path, init={}){ const opts={credentials:"include", ...init}; let r=await fetch(makeUrl(path), opts).catch(()=>null); return r; }
  function handleAuth(r){ if(r && (r.status===401||r.status===403)){ showToast("Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n, vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.","warn",2500); setTimeout(()=>location.href="/login",700); return true; } return false; }
  const safeJson = async (r)=>{ try{ return await r.json(); }catch{ return {}; } };

  /* ===== Deleted flags helper ===== */
  function isSoftDeleted(x) {
    if (!x) return false;
    const status = String(x.status ?? x.trang_thai ?? x.trangthai ?? '').toUpperCase().trim();
    const state  = String(x.state ?? '').toUpperCase().trim();
    const dts = x.deleted_at || x.deletedAt || x.removed_at || x.archived_at;
    const boolTrue = (v) => String(v).toLowerCase() === 'true' || v === true || v === 1 || v === '1';
    const flags =
      boolTrue(x.deleted) ||
      boolTrue(x.is_deleted) ||
      boolTrue(x.isDeleted) ||
      boolTrue(x.hard_deleted) ||
      !String(x.active ?? x.is_active ?? true).match(/^(true|1)$/i) ||
      ['DELETED','DELETE_SOFT','DELETED_SOFT','REMOVED','INACTIVE','ARCHIVED'].includes(status) ||
      ['DELETED','REMOVED','ARCHIVED','INACTIVE'].includes(state);
    return Boolean(dts || flags);
  }

  /* ===== NAV / Auth UI ===== */
  async function refreshAuthUI(){
    try{
      const r = await apiFetch('/me', { credentials:'include' });
      if (!r || !r.ok){
        ['navHello'].forEach(id=>$(id)?.classList.add("hidden"));
        $('navLogin')?.classList.remove("hidden");
        $('navLogout')?.classList.add("hidden");
        const rec = $('nguoi_nhan_ky_ten'); if (rec) rec.value = "";
        return;
      }
      const me = await r.json();
      const role = me.role || "";
      const displayName = me.full_name || me.username || "";

      $('navHello').textContent = `Xin ch√†o, ${displayName} (${role})`;
      $('navHello').classList.remove("hidden");
      $('navLogin')?.classList.add("hidden");
      $('navLogout')?.classList.remove("hidden");

      const rec = $('nguoi_nhan_ky_ten');
      if (rec && !rec.value) { rec.value = displayName; rec.title = `T·ª± ƒë·ªông theo t√†i kho·∫£n: ${displayName}`; }
    }catch(_){
      ['navHello'].forEach(id=>$(id)?.classList.add("hidden"));
      $('navLogin')?.classList.remove("hidden");
      $('navLogout')?.classList.add("hidden");
    }
  }
  $('navLogout')?.addEventListener('click', async ()=>{ try{ await apiFetch('/logout', { method:'POST', credentials:'include' }); }catch(_){ } location.href='/login'; });

  /* ===== Checklist ===== */
  const DEFAULT_QTY = { bang_tot_nghiep_dai_hoc:2, bang_diem_dai_hoc:2, bang_tot_nghiep_cao_dang:2, bang_diem_cao_dang:2, bang_tot_nghiep_trung_cap:2, bang_diem_trung_cap:2, anh_3x4:2 };
  const getDefaultQty = (code) => DEFAULT_QTY[code] ?? 1;

  async function loadChecklist() {
    try {
      const r = await apiFetch("/checklist/active");
      if (!r || !r.ok) { showToast("Kh√¥ng l·∫•y ƒë∆∞·ª£c checklist", "error"); return; }
      const data = await r.json();
      window.__CHECKLIST_VERSION_NAME__ = data?.version_name || data?.version || data?.name || 'unknown';
      const body = $("docsBody"); body.innerHTML = "";
      (data.items||[])
        .sort((a,b)=> (a.order_index ?? a.order_no ?? 0) - (b.order_index ?? b.order_no ?? 0))
        .forEach((it, idx) => {
          const def = getDefaultQty(it.code);
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td class="p-2 border text-center">${idx+1}</td>
            <td class="p-2 border"><div class="font-medium">${it.display_name}</div></td>
            <td class="p-2 border text-center"><input type="checkbox" class="w-5 h-5 has-doc" data-code="${it.code}"></td>
            <td class="p-2 border text-center"><input type="number" min="0" class="input w-24 text-center qty bg-gray-100 text-gray-400" data-code="${it.code}" value="" placeholder="${def}" disabled /></td>`;
          body.appendChild(tr);
        });
      document.querySelectorAll('.has-doc').forEach((chk) => {
        const code = chk.dataset.code; const qty = document.querySelector(`.qty[data-code="${code}"]`); const def = getDefaultQty(code);
        chk.addEventListener("change", () => {
          if (chk.checked) { qty.value = String(def); qty.disabled=false; qty.classList.remove("bg-gray-100","text-gray-400"); }
          else { qty.value=""; qty.disabled=true; qty.classList.add("bg-gray-100","text-gray-400"); }
        });
      });
    } catch (err) { console.error(err); showToast('L·ªói t·∫£i checklist', 'error'); }
  }

  function collectDocs() {
    const rows = Array.from(document.querySelectorAll('#docsBody tr'));
    return rows.map(tr => {
      const chk  = tr.querySelector('.has-doc');
      const qtyI = tr.querySelector('.qty');
      const code = chk?.dataset.code || '';
      const def  = getDefaultQty(code);
      let val = chk?.checked ? Number(qtyI.value || def) : 0;
      if (!Number.isFinite(val) || val < 0) val = 0;
      return { code, so_luong: val };
    });
  }

// ===== M√£ HS theo NH√ìM (Kh√≥a, ƒê·ª£t) + helper hi·ªÉn th·ªã 4 s·ªë =====
function composeMaHoSoByGroup(khoa, dot, seq) {
  return `HS-${String(khoa).trim()}-${String(dot).trim()}-${String(seq).padStart(4,'0')}`;
}

function extractSeq4(code) {
  const m = String(code || '').match(/(\d{4})$/);
  return m ? m[1] : '';
}

async function getMaxSeqInGroup(khoa, dot) {
  const q = String(khoa).trim(); // query r·ªông theo kh√≥a
  let page = 1, size = 500, max = 0;
  for (;;) {
    const r = await apiFetch(`/applicants/search?q=${encodeURIComponent(q)}&page=${page}&size=${size}`);
    if (!r || !r.ok) break;
    const j = await (r.json().catch(()=>({})));
    const arr = Array.isArray(j?.items) ? j.items : [];
    for (const it of arr) {
      if (String(it.khoa).trim() !== String(khoa).trim()) continue;
      if (String(it.dot).trim()  !== String(dot).trim())  continue;
      const m = String(it.ma_ho_so || '').match(/(\d{4})$/); // l·∫•y 4 s·ªë cu·ªëi
      if (m) {
        const n = parseInt(m[1], 10);
        if (Number.isFinite(n) && n > max) max = n;
     }
    }
    if (arr.length < size) break;
    page += 1;
  }
  return max;
}

async function generateNextSeq4(khoa, dot) {
  if (!khoa || !dot) return "";
  const cur = await getMaxSeqInGroup(khoa, dot);
  return String(cur + 1).padStart(4, '0');
}

async function generateNextMaHoSoByGroup(khoa, dot) {
  const max = await getMaxSeqInGroup(khoa, dot);
  return composeMaHoSoByGroup(khoa, dot, max + 1);
}

async function payloadForCreate() {
  const k = ($('khoa')?.value || '').trim();
  const d = ($('dot')?.value  || '').trim();
  if (!k || !d) {
    showToast("Vui l√≤ng ch·ªçn Ni√™n kho√° v√† ƒê·ª£t tr∆∞·ªõc khi l∆∞u.", "warn");
    return null;
  }

  // √¥ input ch·ªâ hi·ªÉn th·ªã 4 s·ªë
  let seq4 = ($('ma_ho_so')?.value || '').trim();
  if (!/^\d{4}$/.test(seq4)) {
    // n·∫øu ch∆∞a c√≥ s·ªë th√¨ h·ªèi API ƒë·ªÉ l·∫•y s·ªë ti·∫øp theo
    const seq = await generateNextSeq4(k, d) || '0001';
    $('ma_ho_so').value = seq4;
    $('ma_ho_so').placeholder = seq4;
  }

  // üóìÔ∏è Ng√†y nh·∫≠n m·∫∑c ƒë·ªãnh h√¥m nay
  const today = new Date().toISOString().slice(0,10);
  $('ngay_nhan_hs').value = today;

  return {
    ma_ho_so: seq4,           // << ch·ªâ 4 s·ªë
    ngay_nhan_hs: ymdKeep(today),
    ho_ten: $('ho_ten').value.trim(),
    gioi_tinh: $('gioi_tinh').value || null,
    dan_toc: $('dan_toc').value.trim() || null,
    ma_so_hv: $('ma_so_hv').value.trim(),
    ngay_sinh: ymdKeep($('ngay_sinh').value) || null,
    so_dt: $('so_dt').value.trim() || null,
    email_hoc_vien: $('email_hoc_vien').value.trim() || null,
    nganh_nhap_hoc: $('nganh_nhap_hoc').value.trim() || null,
    dot: d,
    khoa: k,
    da_tn_truoc_do: $('da_tn_truoc_do').value || null,
    ghi_chu: $('ghi_chu').value.trim() || null,
    nguoi_nhan_ky_ten: $('nguoi_nhan_ky_ten').value.trim() || null,
    docs: collectDocs(),
    checklist_version_name: window.__CHECKLIST_VERSION_NAME__ || 'v1',
  };
}

/* Hi·ªÉn th·ªã tr∆∞·ªõc: ch·ªâ 4 s·ªë */
/* ‚úÖ GI·ªÆ h√†m n√†y */
async function tryPreviewMaHoSo(force = false) {
  if (!force && window.loadedApplicant?.ma_so_hv) return;
  const k = ($('khoa')?.value || '').trim();
  const d = ($('dot')?.value  || '').trim();
  const el = $('ma_ho_so');
  if (!el) return;
  if (!k || !d) { el.value = ''; el.placeholder = '0000'; return; }

  try {
    const full = await generateNextMaHoSoByGroup(k, d);
    const m = /(\d{4})$/.exec(full);
    const seq = (m ? m[1] : '0001');
    el.value = seq;
    el.placeholder = seq;
  } catch {
    el.value = ''; el.placeholder = '0000';
  }
}

$('khoa').addEventListener('change', () => tryPreviewMaHoSo(true));
$('dot').addEventListener('change',  () => tryPreviewMaHoSo(true));

  function payloadForUpdate() {
    const currentDate = $("ngay_nhan_hs").value || new Date().toISOString().split("T")[0];
    return {
      ma_ho_so: $("ma_ho_so").value.trim(),
      ngay_nhan_hs: ymdKeep(currentDate),
      ho_ten: $("ho_ten").value.trim(),
      gioi_tinh: $("gioi_tinh").value || null,
      dan_toc: $("dan_toc").value.trim() || null, 
      ma_so_hv: $("ma_so_hv").value.trim(),
      ngay_sinh: ymdKeep($("ngay_sinh").value) || null,
      so_dt: $("so_dt").value.trim() || null,
      email_hoc_vien: $("email_hoc_vien").value.trim() || null,
      nganh_nhap_hoc: $("nganh_nhap_hoc").value.trim() || null,
      dot: $("dot").value.trim() || null,
      khoa: $("khoa").value.trim() || null,
      da_tn_truoc_do: $("da_tn_truoc_do").value || null,
      ghi_chu: $("ghi_chu").value.trim() || null,
      nguoi_nhan_ky_ten: $("nguoi_nhan_ky_ten").value.trim() || null,
      docs: collectDocs(),
    };
  }

  // ===== Local tombstone cho MSHV ƒë√£ xo√° =====
  const TOMBSTONE_KEY = 'deleted_mshv_set_v1';
  function getDeletedSet() { try { return new Set(JSON.parse(localStorage.getItem(TOMBSTONE_KEY) || '[]')); } catch { return new Set(); } }
  function saveDeletedSet(set) { try { localStorage.setItem(TOMBSTONE_KEY, JSON.stringify(Array.from(set))); } catch {} }
  function markDeleted(mshv) { const s = getDeletedSet(); s.add(String(mshv).trim()); saveDeletedSet(s); }
  function isMarkedDeleted(mshv) { return getDeletedSet().has(String(mshv).trim()); }

  /* ===== Lookup / Update / Delete ===== */
  let loadedDocsByCode = {};
  function setPrintButtonsEnabled(on) {
    $('btnPrintLoadedA5').disabled = !on;
    $('btnPrintLoadedA4').disabled = !on;
  }

function populateFormFromApplicant(a={}, docs){
  $('ma_ho_so').value = extractSeq4(a.ma_ho_so) || "";   // <-- ch·ªâ 4 s·ªë
  $('ngay_nhan_hs').value = fmtDateToInput(a.ngay_nhan_hs);
  $('khoa').value = a.khoa || "";
  $('ho_ten').value = a.ho_ten || "";
  $('ma_so_hv').value = a.ma_so_hv || "";
  $('ngay_sinh').value = fmtDateToInput(a.ngay_sinh);
  $('gioi_tinh').value = a.gioi_tinh || "";
  $('dan_toc').value = a.dan_toc || "";
  $('so_dt').value = a.so_dt || "";
  $('email_hoc_vien').value = a.email_hoc_vien || "";
  $('nganh_nhap_hoc').value = a.nganh_nhap_hoc || "";
  $('dot').value = a.dot || "";
  $('da_tn_truoc_do').value = a.da_tn_truoc_do || "";
  $('ghi_chu').value = a.ghi_chu || "";
  $('nguoi_nhan_ky_ten').value = a.nguoi_nhan_ky_ten || $('nguoi_nhan_ky_ten').value || "";

    loadedDocsByCode = {}; (docs||[]).forEach(d => loadedDocsByCode[d.code] = d.so_luong || 0);
    const applyDocsToTable = () => {
      document.querySelectorAll('.has-doc').forEach(chk => {
        const code = chk.dataset.code; const qty = document.querySelector(`.qty[data-code="${code}"]`);
        const n = loadedDocsByCode[code] ?? 0;
        if (n > 0) { chk.checked = true; qty.disabled=false; qty.classList.remove("bg-gray-100","text-gray-400"); qty.value = String(n); }
        else { chk.checked = false; qty.disabled=true; qty.classList.add("bg-gray-100","text-gray-400"); qty.value = ""; }
      });
    };
    if (document.querySelectorAll('#docsBody tr').length === 0) loadChecklist().then(applyDocsToTable); else applyDocsToTable();
  }

  async function loadApplicantByMSHV(mshv){
    // endpoint chu·∫©n
    let r = await apiFetch(`/applicants/by-mshv/${encodeURIComponent(mshv)}`);
    if (r && r.ok) {
      const data = await r.json();
      const ap = (data && data.applicant) ? { ...data.applicant, docs: data.docs || [] } : data;
      if (isSoftDeleted(ap)) {
        showToast(`MSHV ${mshv} ƒë√£ b·ªã x√≥a, kh√¥ng th·ªÉ m·ªü!`, "warn");
        throw new Error(`H·ªì s∆° ${mshv} ƒë√£ b·ªã x√≥a!`);
      }
      return ap;
    }

    // 404: kh√¥ng c√≥
    if (r && r.status === 404) {
      showToast(`Kh√¥ng t√¨m th·∫•y MSHV ${mshv}`, "warn");
      throw new Error(`Kh√¥ng t√¨m th·∫•y h·ªì s∆° ${mshv}`);
    }

    // Fallback (API c≈©): ph·∫£i l·ªçc k·ªπ
    if (!r || r.status === 405) {
      const rs = await apiFetch(`/applicants/search?q=${encodeURIComponent(mshv)}`);
      if (rs && rs.ok) {
        const j = await rs.json();
        let raw = Array.isArray(j.items) ? j.items : (Array.isArray(j) ? j : []);
        raw = (raw || []).filter(it => !isSoftDeleted(it));
        const hit = raw.find(x => (String(x.ma_so_hv||'').toLowerCase() === String(mshv).toLowerCase()));
        if (hit) {
          const rd = await apiFetch(`/applicants/by-code/${encodeURIComponent(hit.ma_ho_so)}`);
          if (rd && rd.ok) {
            const d2 = await rd.json();
            const ap2 = (d2 && d2.applicant) ? { ...d2.applicant, docs: d2.docs || [] } : d2;
            if (isSoftDeleted(ap2)) {
              showToast(`MSHV ${mshv} ƒë√£ b·ªã x√≥a kh√¥ng th·ªÉ m·ªü!`, "warn");
              throw new Error(`H·ªì s∆° ${mshv} ƒë√£ b·ªã x√≥a!`);
            }
            return ap2;
          }
        }
      }
    }

    const t = r ? await r.text().catch(()=>"(kh√¥ng ph·∫£n h·ªìi)") : "(kh√¥ng ph·∫£n h·ªìi)";
    throw new Error(`L·ªói t·∫£i h·ªì s∆° (HTTP ${r ? r.status : '???'})\n${t}`);
  }

  function askUpdateReason() {
    return new Promise((resolve) => {
      const wrap = $('modalUpdateReason');
      const select = $('updateReasonSelect');
      const txt = $('updateReasonText');
      const ok = $('urOK');
      const cancel = $('urCancel');
      const close = $('urClose');

      select.value = ""; txt.value = "";
      const toggleOther = ()=>{ (select.value === 'khac') ? txt.parentElement.classList.remove('hidden') : txt.parentElement.classList.add('hidden'); };
      toggleOther();

      wrap.classList.remove('hidden'); wrap.classList.add('flex');

      const onBackdrop = (e) => { if (e.target === wrap) done(null); };
      const onEsc = (e) => { if (e.key === 'Escape') done(null); };
      wrap.addEventListener('click', onBackdrop);
      document.addEventListener('keydown', onEsc);
      select.addEventListener('change', toggleOther);

      const done = (v) => {
        wrap.classList.add('hidden'); wrap.classList.remove('flex');
        ok.onclick = cancel.onclick = close.onclick = null;
        wrap.removeEventListener('click', onBackdrop);
        document.removeEventListener('keydown', onEsc);
        select.removeEventListener('change', toggleOther);
        resolve(v);
      };

      ok.onclick = () => {
        const key = select.value;
        const text = txt.value.trim();
        if (!key) { showToast("Vui l√≤ng ch·ªçn l√Ω do c·∫≠p nh·∫≠t.", "warn"); return; }
        if (key === "khac" && !text) { showToast("Nh·∫≠p l√Ω do kh√°c.", "warn"); return; }
        done({ key, text });
      };
      cancel.onclick = close.onclick = () => done(null);
    });
  }

  // Modal h·ªèi l√Ω do xo√°
  function askDeleteReason(title, defText=""){
    return new Promise((resolve)=>{
      const wrap = $('modalDel'); const titleEl = $('mdTitle'); const input = $('mdReason');
      const ok = $('mdOK'); const cancel = $('mdCancel'); const close = $('mdClose');
      titleEl.textContent = title || "Xo√° h·ªì s∆° n√†y?"; input.value = defText || "";
      wrap.classList.remove('hidden'); wrap.classList.add('flex'); input.focus();

      const done = (v)=>{ wrap.classList.add('hidden'); wrap.classList.remove('flex'); ok.onclick=cancel.onclick=close.onclick=null; resolve(v); };
      ok.onclick = ()=>{ const v = (input.value||"").trim(); if(!v){ showToast("Vui l√≤ng nh·∫≠p l√Ω do xo√°.", "warn"); input.focus(); return; } done(v); };
      cancel.onclick = close.onclick = ()=> done(null);
      wrap.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ e.preventDefault(); done(null); } }, { once:true });
    });
  }

  async function clearForm(){
    ["ma_ho_so","ngay_nhan_hs","khoa","ho_ten","ma_so_hv","gioi_tinh","ngay_sinh","so_dt","email_hoc_vien","nganh_nhap_hoc","dot","da_tn_truoc_do","ghi_chu"].forEach(id=>{
      const el=$(id); if(!el) return; if(el.type==='checkbox') el.checked=false; else el.value="";
    });
    document.querySelectorAll('.has-doc').forEach(chk=>{ chk.checked=false; });
    document.querySelectorAll('.qty').forEach(q=>{ q.value=""; q.disabled=true; q.classList.add("bg-gray-100","text-gray-400"); });
  }

  function resetToNewForm(){
    const today = new Date().toISOString().slice(0,10);
    clearForm();
    $('ngay_nhan_hs').value = today;
    window.loadedApplicant = null;
    setPrintButtonsEnabled(false);
    $('lookupMsg').textContent = "";
    $('msg').textContent = "";
    $('nameResults')?.classList.add('hidden');
    $('gioi_tinh').value = "";
    tryPreviewMaHoSo(true);
  }

  // L∆∞u
  $('btnSave').addEventListener('click', async ()=>{
    const btn = $('btnSave'); btn.disabled = true; const old = btn.textContent; btn.textContent = "ƒêang l∆∞u...";
    try{
      const res = await createApplicant();
      if (res) {
        showToast(`ƒê√£ l∆∞u h·ªì s∆° ${res.ma_so_hv || $('ma_so_hv').value}`, "success");
        $('msg').textContent = `ƒê√£ l∆∞u MSHV ${res.ma_so_hv || $('ma_so_hv').value}`;
        resetToNewForm();
      }
    } finally{ btn.disabled = false; btn.textContent = old; }
  });

  // C·∫≠p nh·∫≠t (2 n√∫t)
  ["btnUpdateApplicant", "btnUpdateApplicantMain"].forEach(id => {
    const handler = async ()=>{
      try {
        const btn = $(id); const old = btn.textContent; btn.disabled = true; btn.textContent = "ƒêang c·∫≠p nh·∫≠t...";
        if (!window.loadedApplicant?.ma_so_hv) { showToast("Ch∆∞a t·∫£i h·ªì s∆° n√†o ƒë·ªÉ c·∫≠p nh·∫≠t.", "warn"); return; }

        const reason = await askUpdateReason(); if (!reason) return;
        const body = payloadForUpdate(); body.update_reason_key = reason.key; body.update_reason_text = reason.text;

        $('lookupMsg').textContent = "ƒêang c·∫≠p nh·∫≠t...";
        const r = await apiFetch(`/applicants/${encodeURIComponent(window.loadedApplicant.ma_so_hv)}`, {
          method: "PUT", headers: { "Content-Type": "application/json" }, body: JSON.stringify(body),
        });
        if (handleAuth(r)) return;
        if (!r.ok) { const t = await r.text(); throw new Error(`C·∫≠p nh·∫≠t th·∫•t b·∫°i (${r.status}): ${t}`); }

        const res = await r.json();
        showToast(`ƒê√£ c·∫≠p nh·∫≠t h·ªì s∆° c·ªßa MSHV: ${res.ma_so_hv}`, "success");
        $('lookupMsg').textContent = `C·∫≠p nh·∫≠t xong MSHV ${res.ma_so_hv}.`;
        resetToNewForm();
      } catch (e) {
        $('lookupMsg').textContent = e.message;
        showToast(e.message || "C·∫≠p nh·∫≠t th·∫•t b·∫°i!", "error");
      } finally {
        const btn = $(id); if (btn) { btn.disabled = false; btn.textContent = "C·∫≠p nh·∫≠t"; }
      }
    };
    $(id)?.addEventListener('click', handler);
  });

  async function createApplicant(){
    // l·∫•y & chu·∫©n ho√° input
    const hoTen = ($('ho_ten')?.value || '').trim();
    const msHv  = ($('ma_so_hv')?.value || '').trim();

    // highlight helper
    const markError = (elId, msg) => {
      const el = $(elId);
      if (el) {
        el.classList.add('ring-2','ring-red-400');
        el.scrollIntoView({behavior:'smooth', block:'center'});
        el.focus();
        setTimeout(()=> el.classList.remove('ring-2','ring-red-400'), 1800);
      }
      showToast(msg, 'error');
    };

    // validate b·∫Øt bu·ªôc
    if (!hoTen) { markError('ho_ten', 'Vui l√≤ng nh·∫≠p H·ªç t√™n.'); return null; }
    if (!msHv)  { markError('ma_so_hv','Vui l√≤ng nh·∫≠p MSHV.');   return null; }

    // validate KH√ìA/ƒê·ª¢T (b·∫Øt bu·ªôc)
    const khoa = ($('khoa')?.value || '').trim();
    const dot  = ($('dot')?.value  || '').trim();
    if (!khoa) { markError('khoa', 'Ch·ªçn Ni√™n kho√°.'); return null; }
    if (!dot)  { markError('dot',  'Ch·ªçn ƒê·ª£t.');      return null; }

    // validate ƒë·ªãnh d·∫°ng m·ªÅm
    const email = ($('email_hoc_vien')?.value || '').trim();
    if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) { markError('email_hoc_vien','Email kh√¥ng h·ª£p l·ªá.'); return null; }
    const phone = ($('so_dt')?.value || '').trim();
    if (phone && !/^[0-9 +().-]{8,20}$/.test(phone)) { markError('so_dt','S·ªë ƒëi·ªán tho·∫°i ch∆∞a ƒë√∫ng.'); return null; }


    // build payload (c√≥ th·ªÉ t·ª± set ng√†y + c·ªë g·∫Øng g·ª£i √Ω m√£)
    // let body = await payloadForCreate();
    const body = await payloadForCreate();
    if (!body) return null; // thi·∫øu kh√≥a/ƒë·ª£t th√¨ d·ª´ng
    // ƒë·∫£m b·∫£o c√°c tr∆∞·ªùng b·∫Øt bu·ªôc ƒë√∫ng gi√° tr·ªã v·ª´a nh·∫≠p
    body.ho_ten   = hoTen;
    body.ma_so_hv = msHv;
    body.khoa     = khoa;
    body.dot      = dot;

    // b√π ng√†y nh·∫≠n n·∫øu tr·ªëng + ƒë·ªìng b·ªô UI
    if (!body.ngay_nhan_hs) {
      body.ngay_nhan_hs = new Date().toISOString().slice(0,10);
      const ngayNhan = $('ngay_nhan_hs'); if (ngayNhan) ngayNhan.value = body.ngay_nhan_hs;
    }

    if (!body.ma_ho_so) {
      const seq = await generateNextSeq4(khoa, dot);
      body.ma_ho_so = seq;                              // g·ª≠i 4 s·ªë
      const mhs = $('ma_ho_so'); if (mhs) mhs.value = seq;
    }

    // g·ª≠i API
    const r = await apiFetch("/applicants", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(body)
    });
    if (handleAuth(r)) return null;

    const j = await safeJson(r);
    if (!r || !r.ok){
      console.log("üëÄ Payload g·ª≠i l√™n:", body);
      showToast(j.detail || `L·ªói l∆∞u (HTTP ${r ? r.status : '???'})`, "error", 4000);
      return null;
    }

    window.loadedApplicant = {
      ma_so_hv: j.ma_so_hv || body.ma_so_hv,
      ma_ho_so: j.ma_ho_so || body.ma_ho_so
    };
    setPrintButtonsEnabled(true);
    return j;
  }

  async function deleteLoadedApplicant(){
    if(!window.loadedApplicant?.ma_so_hv) { showToast("Ch∆∞a t·∫£i h·ªì s∆° n√†o ƒë·ªÉ xo√°.", "warn"); return; }
    const mshv = window.loadedApplicant.ma_so_hv;
    const reason = await askDeleteReason(`Xo√° t·∫°m h·ªì s∆° MSHV ${mshv}?`, "");
    if (reason === null) return;

    const r = await apiFetch(`/applicants/${encodeURIComponent(mshv)}`, {
      method: "DELETE", headers: { "Content-Type":"application/json" }, body: JSON.stringify({ reason })
    });
    if (handleAuth(r)) return;

    if (r && r.status === 204){
      markDeleted(mshv);
      window.loadedApplicant = null; loadedDocsByCode = {};
      setPrintButtonsEnabled(false);
      await clearForm();
      $('lookupMsg').textContent = "ƒê√£ xo√° h·ªì s∆°!";
      showToast("ƒê√£ xo√° h·ªì s∆° v√† ghi v√†o l∆∞u tr·ªØ!", "success");
      return;
    }

    let msg = `Xo√° th·∫•t b·∫°i (HTTP ${r ? r.status : '???'})`;
    try { const t = await r.text(); const j = JSON.parse(t); if (j?.detail) msg = j.detail; } catch(_){}
    showToast(msg, "error", 4000);
  }

  /* ===== T√¨m theo t√™n ===== */
  async function searchByName(name) {
    const q = String(name || "").trim().replace(/\s+/g, " ");
    if (q.length < 2) throw new Error("Nh·∫≠p t·ªëi thi·ªÉu 2 k√Ω t·ª± ƒë·ªÉ t√¨m theo t√™n.");

    const urls = [
      `/applicants/search?q=${encodeURIComponent(q)}`,
      `/applicants/search?name=${encodeURIComponent(q)}`,
      `/applicants/search?full_name=${encodeURIComponent(q)}`,
      `/applicants/by-name?q=${encodeURIComponent(q)}`,
    ];
    const readJson = async (r) => { try { return await r.json(); } catch { return null; } };

    let lastErrText = "";
    for (const u of urls) {
      const r = await apiFetch(u);
      if (!r) continue;
      if (r.status === 401 || r.status === 403) { handleAuth(r); return []; }
      if (!r.ok) { try { lastErrText = await r.text(); } catch {} ; continue; }

      const j = await readJson(r);
      if (!j) continue;

      let raw = [];
      if (Array.isArray(j)) raw = j;
      else if (Array.isArray(j.items)) raw = j.items;
      else if (Array.isArray(j.data))  raw = j.data;
      else if (Array.isArray(j.results)) raw = j.results;
      else if (j.items && j.items.data && Array.isArray(j.items.data)) raw = j.items.data;

      raw = (raw || []).filter(it => !isSoftDeleted(it));

      const list = raw.map(it => ({
        ho_ten: it.ho_ten || it.full_name || it.ten || "",
        ma_ho_so: it.ma_ho_so || it.code || it.ma_hs || "",
        ma_so_hv: it.ma_so_hv || it.mssv || it.mshv || "",
        ngay_nhan_hs: it.ngay_nhan_hs || it.created_at || it.ngay || null,
        dot: it.dot || it.dot_tuyen || "",
      }));
      if (list.length) return list;
    }
    if (lastErrText) console.warn("Name search last error:", lastErrText);
    return [];
  }

  function vnNorm(s){ return (s||"").normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/ƒë/g,'d').replace(/ƒê/g,'D').trim().toLowerCase(); }
  function matchScore(name, query){
    const a=vnNorm(name), b=vnNorm(query); if(!a||!b) return 0;
    if (a===b) return 100; if (a.startsWith(b)) return 90; if (a.includes(b)) return 70;
    const toks=b.split(/\s+/).filter(Boolean); return toks.every(t=>a.includes(t)) ? 60 : 0;
  }
  function filterAndSortByName(list, q, limit=20){
    const scored=(list||[]).map(it=>({it, score:matchScore(it.ho_ten||it.full_name||it.ten||'', q)})).filter(x=>x.score>0);
    scored.sort((p,q)=>q.score-p.score); return scored.slice(0,limit).map(x=>x.it);
  }
  function renderNameResults(list){
    list = Array.isArray(list) ? list : (Array.isArray(list?.items) ? list.items : []);
    const box = $('nameResults'); const ul = $('nameResultsList'); if(!box||!ul) return;
    if(!list || list.length===0){ box.classList.remove("hidden"); ul.innerHTML='<li class="p-2 text-sm text-gray-500">Kh√¥ng t√¨m th·∫•y.</li>'; return; }
    ul.innerHTML = list.map(it => {
      const ngay = it.ngay_nhan_hs ? String(it.ngay_nhan_hs).slice(0,10) : '';
      return `
        <li class="p-2 hover:bg-gray-50 cursor-pointer" data-mshv="${it.ma_so_hv||''}">
          <div class="flex justify-between">
            <div class="font-medium">${it.ho_ten||it.full_name||""}</div>
            <div class="text-xs text-gray-500">${ngay}</div>
          </div>
          <div class="text-xs text-gray-600">
            M√£ HS: <span class="font-semibold">${it.ma_ho_so||it.code||""}</span>
            ‚Ä¢ MSHV: ${it.ma_so_hv||it.mssv||it.mshv||''}
            ‚Ä¢ ƒê·ª£t: ${it.dot||it.dot_tuyen||''}
          </div>
        </li>`;
    }).join("");
    if (!ul._boundClick) {
      ul.addEventListener('click', (e)=>{ const li=e.target.closest('li[data-mshv]'); if(!li) return; $('q_ma_so_hv').value = li.dataset.mshv || ''; box.classList.add('hidden'); $('btnLoadApplicantMSHV')?.click(); });
    }
    box.classList.remove('hidden');
  }

  // === Autocomplete: H·ªå T√äN (live, kh√¥ng c·∫ßn Enter) ===
const liveSearchName = debounce(async () => {
  const name = $('q_ho_ten').value.trim();
  if (name.length < 2) {
    $('nameResults')?.classList.add('hidden');
    return;
  }
  $('lookupMsg').textContent = 'ƒêang t√¨m...';
  let list = await searchByName(name);
  list = filterAndSortByName(list, name, 25);
  renderNameResults(list);
  $('lookupMsg').textContent = list.length ? `T√¨m th·∫•y ${list.length} k·∫øt qu·∫£.` : 'Kh√¥ng t√¨m th·∫•y.';
}, 300);

$('q_ho_ten').addEventListener('input', liveSearchName);
$('q_ho_ten').addEventListener('focus', liveSearchName);

// ·∫®n list khi click ngo√†i
document.addEventListener('click', (e) => {
  if (!e.target.closest('#nameResults') && !e.target.closest('#q_ho_ten')) {
    $('nameResults')?.classList.add('hidden');
  }
});

// ƒêi·ªÅu h∆∞·ªõng b·∫±ng ph√≠m ‚Üë ‚Üì Enter Esc
(function () {
  const input = $('q_ho_ten');
  const box = $('nameResults');
  const ul  = $('nameResultsList');
  let idx = -1;

  input.addEventListener('keydown', (e) => {
    if (box.classList.contains('hidden')) return;
    const items = ul.querySelectorAll('li[data-mshv]');
    if (!items.length) return;

    if (e.key === 'ArrowDown') {
      e.preventDefault();
      idx = (idx + 1) % items.length;
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      idx = (idx - 1 + items.length) % items.length;
    } else if (e.key === 'Enter' && idx >= 0) {
      e.preventDefault();
      items[idx].click();
      idx = -1;
      return;
    } else if (e.key === 'Escape') {
      box.classList.add('hidden');
      idx = -1;
      return;
    }

    items.forEach((el, i) => el.classList.toggle('bg-blue-50', i === idx));
    if (idx >= 0) items[idx].scrollIntoView({ block: 'nearest' });
  });
})();

// === Autocomplete: MSHV (live, kh√¥ng c·∫ßn Enter) ===
function ensureMshvBox() {
  let box = $('mshvResults');
  if (!box) {
    // L·∫•y ƒë√∫ng wrapper ch·ª©a input + n√∫t
    const fld = $('q_ma_so_hv').parentElement; // <div class="flex gap-2">
    // ƒê·∫£m b·∫£o relative ƒë·ªÉ dropdown b√°m theo
    fld.classList.add('relative'); // thay v√¨ fld.style.position = 'relative';

    box = document.createElement('div');
    box.id = 'mshvResults';
    box.className = [
      // ‚ûú ƒê·∫∑t d∆∞·ªõi input: left-0 top-full mt-1
      'absolute', 'left-0', 'top-full', 'mt-1',
      // K√≠ch th∆∞·ªõc & hi·ªÉn th·ªã
      'z-50', 'w-full', 'max-h-64', 'overflow-auto',
      'rounded-md', 'border', 'bg-white', 'shadow',
      // ·∫®n m·∫∑c ƒë·ªãnh
      'hidden'
    ].join(' ');
    box.innerHTML = '<ul id="mshvResultsList" class="divide-y"></ul>';

    fld.appendChild(box);
  }
  return box;
}

async function searchMSHVPartial(q) {
  const r = await apiFetch(`/applicants/search?q=${encodeURIComponent(q)}`);
  if (r && r.ok) {
    const j = await safeJson(r);
    let raw = Array.isArray(j?.items) ? j.items : (Array.isArray(j) ? j : []);
    raw = (raw || []).filter((it) => !isSoftDeleted(it));
    return raw
      .map((it) => ({
        ho_ten: it.ho_ten || it.full_name || '',
        ma_so_hv: it.ma_so_hv || it.mssv || it.mshv || '',
        ma_ho_so: it.ma_ho_so || it.code || '',
        ngay_nhan_hs: it.ngay_nhan_hs || it.created_at || null,
      }))
      .filter((x) => String(x.ma_so_hv || '').toLowerCase().includes(q.toLowerCase()))
      .slice(0, 20);
  }
  return [];
}

function renderMshvResults(list) {
  const box = ensureMshvBox();
  const ul  = $('mshvResultsList');

  if (!list.length) {
    box.classList.remove('hidden');
    ul.innerHTML = '<li class="p-2 text-sm text-gray-500">Kh√¥ng t√¨m th·∫•y.</li>';
    return;
  }

  ul.innerHTML = list
    .map(
      (it) => `
    <li class="p-2 hover:bg-gray-50 cursor-pointer" data-mshv="${it.ma_so_hv}">
      <div class="flex justify-between">
        <div class="font-medium">${it.ma_so_hv}</div>
        <div class="text-xs text-gray-500">${(it.ngay_nhan_hs || '').toString().slice(0, 10)}</div>
      </div>
      <div class="text-xs text-gray-600">
        ${it.ho_ten} ‚Ä¢ M√£ HS: <span class="font-semibold">${it.ma_ho_so}</span>
      </div>
    </li>`
    )
    .join('');

  if (!ul._boundClick) {
    ul.addEventListener('click', (e) => {
      const li = e.target.closest('li[data-mshv]');
      if (!li) return;
      $('q_ma_so_hv').value = li.dataset.mshv || '';
      box.classList.add('hidden');
      $('btnLoadApplicantMSHV')?.click();
    });
    ul._boundClick = true;
  }

  box.classList.remove('hidden');
}

const liveSearchMSHV = debounce(async () => {
  const v = $('q_ma_so_hv').value.trim();
  if (v.length < 3) {
    $('mshvResults')?.classList.add('hidden');
    return;
  }
  $('lookupMsg').textContent = 'ƒêang g·ª£i √Ω MSHV...';
  const list = await searchMSHVPartial(v);
  renderMshvResults(list);
  $('lookupMsg').textContent = '';
}, 250);

$('q_ma_so_hv').addEventListener('input', liveSearchMSHV);
$('q_ma_so_hv').addEventListener('focus', liveSearchMSHV);

// ·∫®n khi click ngo√†i
document.addEventListener('click', (e) => {
  if (!e.target.closest('#mshvResults') && !e.target.closest('#q_ma_so_hv')) {
    $('mshvResults')?.classList.add('hidden');
  }
});

// ƒêi·ªÅu h∆∞·ªõng b·∫±ng ph√≠m cho MSHV
$('q_ma_so_hv').addEventListener('keydown', (e) => {
  const box = $('mshvResults');
  const ul  = $('mshvResultsList');
  if (!box || box.classList.contains('hidden')) return;

  const items = ul.querySelectorAll('li[data-mshv]');
  if (!items.length) return;

  let idx = ul._idx ?? -1;

  if (e.key === 'ArrowDown') {
    e.preventDefault();
    idx = (idx + 1) % items.length;
  } else if (e.key === 'ArrowUp') {
    e.preventDefault();
    idx = (idx - 1 + items.length) % items.length;
  } else if (e.key === 'Enter' && idx >= 0) {
    e.preventDefault();
    items[idx].click();
    ul._idx = -1;
    return;
  } else if (e.key === 'Escape') {
    box.classList.add('hidden');
    ul._idx = -1;
    return;
  }

  items.forEach((el, i) => el.classList.toggle('bg-blue-50', i === idx));
  if (idx >= 0) items[idx].scrollIntoView({ block: 'nearest' });
  ul._idx = idx;
});

  /* ===== In PDF (kh·ªõp BE) ===== */
  function openPdf(url){ const w = window.open(url, "_blank"); if (!w) window.location.href = url; }
  $("btnPrintLoadedA5").onclick = () => {
    const cur = window.loadedApplicant;
    if (!cur?.ma_so_hv) { showToast("Ch∆∞a t·∫£i h·ªì s∆° n√†o.", "warn"); return; }
    if (isMarkedDeleted(cur.ma_so_hv) || isSoftDeleted(cur)) { showToast("H·ªì s∆° ƒë√£ b·ªã x√≥a, kh√¥ng th·ªÉ in!", "warn"); return; }
    openPdf(makeUrl(`/applicants/${encodeURIComponent(cur.ma_so_hv)}/print-a5`));
  };
  $("btnPrintLoadedA4").onclick = () => {
    const cur = window.loadedApplicant;
    if (!cur?.ma_so_hv) { showToast("Ch∆∞a t·∫£i h·ªì s∆° n√†o!", "warn"); return; }
    if (isMarkedDeleted(cur.ma_so_hv) || isSoftDeleted(cur)) { showToast("H·ªì s∆° ƒë√£ b·ªã x√≥a, kh√¥ng th·ªÉ in!", "warn"); return; }
    openPdf(makeUrl(`/applicants/${encodeURIComponent(cur.ma_so_hv)}/print`));
  };

  // Load theo MSHV
  $('btnLoadApplicantMSHV').addEventListener('click', async ()=>{
    try{
      const mshv = $('q_ma_so_hv').value.trim();
      if(!mshv){ alert("Nh·∫≠p MSHV (MSSV) ƒë·ªÉ t·∫£i!"); return; }

      // ‚ùó Ch·∫∑n n·∫øu v·ª´a b·ªã xo√° trong phi√™n/thi·∫øt b·ªã n√†y
      if (isMarkedDeleted(mshv)) {
        $('lookupMsg').textContent = `MSHV ${mshv} ƒë√£ b·ªã x√≥a t·∫°m`;
        showToast(`MSHV ${mshv} ƒë√£ b·ªã x√≥a`, 'warn');
        window.loadedApplicant = null;
        setPrintButtonsEnabled(false);
        await clearForm();
        return;
      }

      $('lookupMsg').textContent = "ƒêang t·∫£i theo MSHV...";
      const a = await loadApplicantByMSHV(mshv);

      if (isSoftDeleted(a) || isSoftDeleted(a?.applicant)) {
        $('lookupMsg').textContent = `MSHV ${mshv} ƒë√£ b·ªã x√≥a`;
        showToast(`MSHV ${mshv} ƒë√£ b·ªã x√≥a`, 'warn');
        window.loadedApplicant = null;
        setPrintButtonsEnabled(false);
        await clearForm();
        return;
      }

      window.loadedApplicant = { ma_so_hv: a.ma_so_hv, ma_ho_so: a.ma_ho_so };
      populateFormFromApplicant(a, a.docs || []);
      setPrintButtonsEnabled(true);
      $('lookupMsg').textContent = `ƒê√£ t·∫£i h·ªì s∆°: ${a.ho_ten} ‚Ä¢ M√£ HS ${a.ma_ho_so} ‚Ä¢ MSHV ${a.ma_so_hv}`;
    }catch(e){
      $('lookupMsg').textContent = e.message;
      window.loadedApplicant = null;
      setPrintButtonsEnabled(false);
      await clearForm();
    }
  });
  $('q_ma_so_hv').addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); $('btnLoadApplicantMSHV').click(); } });

  // T√¨m theo t√™n (debounced)
  $('btnSearchByName').addEventListener('click', debounce(async ()=>{
    try{
      const name = $('q_ho_ten').value.trim(); if(name.length < 2){ alert("Nh·∫≠p t·ªëi thi·ªÉu 2 k√Ω t·ª±."); return; }
      $('lookupMsg').textContent = "ƒêang t√¨m theo t√™n...";
      let list = await searchByName(name);
      list = filterAndSortByName(list, name, 25);
      renderNameResults(list);
      $('lookupMsg').textContent = list.length ? `T√¨m th·∫•y ${list.length} k·∫øt qu·∫£.` : "Kh√¥ng t√¨m th·∫•y.";
    }catch(e){ $('lookupMsg').textContent = e.message || "L·ªói t√¨m ki·∫øm."; showToast(e.message || "L·ªói t√¨m ki·∫øm.", "error"); }
  }, 400));
  $('q_ho_ten').addEventListener('keydown', (e)=>{ if(e.key==='Enter') $('btnSearchByName').click(); });

  // Xo√° (m·ªü modal)
  $('btnDeleteApplicant').addEventListener('click', async ()=>{ try{ await deleteLoadedApplicant(); } catch(e){ $('lookupMsg').textContent = e.message; showToast(e.message, "error"); } });

  // Reload checklist
  $('btnReloadChecklist').addEventListener('click', ()=> loadChecklist());

  // Test API
  $('btnTestApi').addEventListener('click', async ()=>{
    const base = apiBase();
    const pref = await pingPrefix(base);
    if (pref === null) showToast("Kh√¥ng ping ƒë∆∞·ª£c API /health", "error");
    else { API_PREFIX = pref; localStorage.setItem(STORAGE_KEY, base); showToast(`K·∫øt n·ªëi OK (${base}${pref||""}/health)`, "success"); }
  });
  $('apiBase').addEventListener('change', async ()=>{
    const base = apiBase(); localStorage.setItem(STORAGE_KEY, base);
    const pref = await pingPrefix(base);
    if (pref === null) showToast("Kh√¥ng ping ƒë∆∞·ª£c API /health", "warn");
    else { API_PREFIX = pref; showToast("ƒê√£ c·∫≠p nh·∫≠t m√°y ch·ªß API", "success"); }
  });

  /* ===== init ===== */
  window.addEventListener('load', async () => {
    const today = new Date().toISOString().slice(0,10);
    $('ngay_nhan_hs').value = today;
    $('q_ma_so_hv')?.focus();

    await ensureApiBaseAndPrefix();
    await refreshAuthUI();
    await loadChecklist();
    await tryPreviewMaHoSo(true);
    setPrintButtonsEnabled(false);

    const url = new URL(window.location.href);
    const mshv = url.searchParams.get('mshv');
    if (mshv) { $('q_ma_so_hv').value = mshv; $('btnLoadApplicantMSHV').click(); }
  });

  document.addEventListener("DOMContentLoaded", async () => {
    try {
      const today = new Date().toISOString().split("T")[0];
      const ngayNhan = document.getElementById("ngay_nhan_hs");
      if (ngayNhan) ngayNhan.value = today;
    } catch (err) {
      console.error("‚ö†Ô∏è L·ªói khi sinh m√£ h·ªì s∆° t·ª± ƒë·ªông:", err);
    }
  });
  </script>
</body>
</html>
