<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Nh·∫≠t k√Ω h·ªá th·ªëng</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="style.css">
  <link rel="icon" type="image/png" href="hutech.png" sizes="32x32">
  <link rel="apple-touch-icon" href="hutech.png">
  <meta name="theme-color" content="#2563eb">

  <!-- Strip query/hash NGAY L√öC V√ÄO TRANG -->
  <script>
  const isJournal = /\/journal\.html$/.test(location.pathname);
  if (isJournal && (location.search || location.hash)) {
    history.replaceState(null, '', location.pathname); // gi·ªØ nguy√™n subpath, ch·ªâ b·ªè ? v√† #
  }
  </script>

  <style>
    /* Hi·ªáu ·ª©ng hover nh·∫π cho logo */
    a:hover img { transform: scale(1.05); transition: transform 0.2s ease; }

    /* ·∫®n tri·ªát ƒë·ªÉ c√°c ph·∫ßn x√≥a vƒ©nh vi·ªÖn n·∫øu kh√¥ng ph·∫£i Admin (ph√≤ng h·ªù) */
    :root[data-role="NhanVien"] #btnHardDelete,
    :root[data-role="NhanVien"] #hardDelConfirm,
    :root[data-role="NhanVien"] #btnHardDeleteGo,
    :root[data-role="NhanVien"] #btnHardDeleteCancel { display: none !important; }
  </style>
</head>
<body class="bg-gray-50">
  <div class="max-w-7xl mx-auto p-6 space-y-6">
    <header class="flex flex-wrap gap-3 items-center justify-between">
      <div class="min-w-0">
        <div class="flex items-center gap-2">
          <a href="/ams_home.html" title="V·ªÅ trang ch·ªß" class="flex items-center hover:opacity-80 transition">
            <img src="hutech.png" alt="HUTECH" class="w-8 h-8 object-contain" />
          </a>
          <h1 class="text-2xl font-bold leading-tight">Nh·∫≠t k√Ω h·ªá th·ªëng</h1>
        </div>
        <p class="text-gray-500 text-sm mt-1">L∆∞u tr·ªØ to√†n b·ªô c√°c ho·∫°t ƒë·ªông t·∫°i h·ªá th·ªëng!</p>
      </div>

      <div class="flex items-center gap-2">
        <label class="text-sm text-gray-500" for="apiBase">API Base</label>
        <input id="apiBase" class="input w-52 md:w-72" placeholder="" />
        <span class="hidden md:inline-block w-px h-6 bg-gray-200"></span>
        <!-- <a class="btn btn-outline" href="/students_list.html" title="Danh s√°ch h·ªì s∆°">üìã Danh s√°ch h·ªì s∆°</a> -->
        <a class="btn btn-outline" href="/ams_home.html" title="Trang ch·ªß">‚Üê Trang ch·ªß</a>
      </div>
    </header>

    <!-- Filters -->
    <section class="card space-y-3">
      <div class="grid grid-cols-1 lg:grid-cols-6 gap-3 items-end">
        <div class="lg:col-span-2">
          <label class="text-sm text-gray-600">T·ª´ kh√≥a</label>
          <input id="q" class="input" placeholder="actor, path, correlation, IP‚Ä¶" />
        </div>
        <div>
          <label class="text-sm text-gray-600">Thao t√°c</label>
          <select id="qActionSel" class="input">
            <option value="">(T·∫•t c·∫£)</option>
            <option value="CREATE">T·∫°o m·ªõi</option>
            <option value="UPDATE">C·∫≠p nh·∫≠t</option>
            <option value="DELETE_SOFT">X√≥a t·∫°m</option>
            <option value="DELETE">X√≥a vƒ©nh vi·ªÖn</option>
            <option value="RESTORE">Kh√¥i ph·ª•c</option>
            <option value="PRINT">In / Xu·∫•t</option>
            <option value="EXCEPTION">L·ªói h·ªá th·ªëng</option>
            <option value="READ">Tra c·ª©u</option>
          </select>
        </div>
        <div class="hidden">
          <label class="text-sm text-gray-600">Target type</label>
          <input id="qType" class="input" placeholder="Applicant / User / ‚Ä¶" />
        </div>
        <div>
          <label class="text-sm text-gray-600">M√£ s·ªë HV</label>
          <input id="qId" class="input" placeholder="2510xxxxxx" />
        </div>
        <div>
          <label class="text-sm text-gray-600">Ng∆∞·ªùi thao t√°c</label>
          <input id="qActor" class="input" placeholder="T√™n ng∆∞·ªùi th·ª±c hi·ªán" />
        </div>
      </div>

      <div class="flex flex-wrap gap-2 items-center justify-between">
        <div class="flex flex-wrap gap-2 items-end">
          <div>
            <label class="text-sm text-gray-600">T·ª´ ng√†y</label>
            <input id="qFrom" type="date" class="input w-40" />
          </div>
          <div>
            <label class="text-sm text-gray-600">ƒê·∫øn ng√†y</label>
            <input id="qTo" type="date" class="input w-40" />
          </div>
        </div>
        <div class="flex gap-2">
          <button id="btnSearch" class="btn btn-outline">üîé L·ªçc</button>
          <button id="btnClear" class="btn btn-primary">X√≥a l·ªçc</button>
        </div>
      </div>
    </section>

    <!-- Table -->
    <section class="card space-y-3">
      <div class="flex items-center justify-between flex-wrap gap-2">
        <div class="flex items-center gap-3 text-sm text-gray-600">
          <span>T·ªïng: <span id="count" class="font-semibold">0</span> log</span>
          <div class="flex items-center gap-1">
            <label for="pageSize" class="text-gray-500">Hi·ªÉn th·ªã</label>
            <select id="pageSize" class="input w-20 text-sm">
              <option selected>10</option><option>20</option><option>50</option><option>100</option>
            </select>
            <span class="text-gray-500">d√≤ng/trang</span>
          </div>
        </div>
        <div id="msg" class="text-sm text-gray-600" role="status" aria-live="polite"></div>
      </div>
      <div class="flex items-center justify-between gap-3">
        <div></div>
        <div class="flex items-center gap-1 text-sm pager" data-position="top">
          <button class="btn btn-outline btn-xs pager-first" title="Trang ƒë·∫ßu">‚èÆÔ∏è</button>
          <button class="btn btn-outline btn-xs pager-prev"  title="Trang tr∆∞·ªõc">‚è™</button>
          <span class="mx-2 min-w-[160px] text-center pager-info">Trang 1/1 ‚Ä¢ 0 m·ª•c</span>
          <button class="btn btn-outline btn-xs pager-next"  title="Trang sau">‚è©</button>
          <button class="btn btn-outline btn-xs pager-last"  title="Trang cu·ªëi">‚è≠Ô∏è</button>
        </div>
      </div>

      <div class="overflow-hidden border rounded-xl">
        <div id="emptyState" class="p-10 text-center text-gray-500 hidden">
          <div class="text-4xl mb-2">‚ùåüßæ</div>
          <div class="font-semibold">Kh√¥ng t√¨m th·∫•y trong danh s√°ch</div>
          <div class="text-sm">Nh·∫≠p t·ª´ kh√≥a kh√°c ƒë·ªÉ t√¨m ki·∫øm!</div>
        </div>

        <div id="tableWrap" class="overflow-auto hidden">
          <table class="table min-w-full">
            <thead>
              <tr>
                <th class="th-sortable text-left" data-sort="id">STT <span class="arrow">‚ñ≤‚ñº</span></th>
                <th class="th-sortable text-center" data-sort="occurred_at">Th·ªùi gian <span class="arrow">‚ñ≤‚ñº</span></th>
                <th class="th-sortable text-center" data-sort="actor_name">Ng∆∞·ªùi th·ª±c hi·ªán <span class="arrow">‚ñ≤‚ñº</span></th>
                <th class="th-sortable text-center" data-sort="action">Thao t√°c <span class="arrow">‚ñ≤‚ñº</span></th>
                <th class="th-sortable text-center" data-sort="target">MSSV <span class="arrow">‚ñ≤‚ñº</span></th>
                <th class="th-sortable text-center" data-sort="status">Tr·∫°ng th√°i <span class="arrow">‚ñ≤‚ñº</span></th>
                <th class="text-center">Chi ti·∫øt</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>

        <div id="loading" class="p-8 text-center text-gray-500 hidden">
          <span class="inline-block w-5 h-5 border-2 border-gray-300 border-t-blue-600 rounded-full animate-spin align-[-2px]"></span>
          <span class="ml-2">ƒêang t·∫£i‚Ä¶</span>
        </div>
      </div>

      <div class="flex items-center gap-1 text-sm pager" data-position="bottom">
        <button class="btn btn-outline btn-xs pager-first" title="Trang ƒë·∫ßu">‚èÆÔ∏è</button>
        <button class="btn btn-outline btn-xs pager-prev"  title="Trang tr∆∞·ªõc">‚è™</button>
        <span class="mx-2 min-w-[160px] text-center pager-info">Trang 1/1 ‚Ä¢ 0 m·ª•c</span>
        <button class="btn btn-outline btn-xs pager-next"  title="Trang sau">‚è©</button>
        <button class="btn btn-outline btn-xs pager-last"  title="Trang cu·ªëi">‚è≠Ô∏è</button>
      </div>
    </section>
  </div>

  <!-- Modal detail -->
  <div id="detail" class="fixed inset-0 z-[100] hidden items-center justify-center bg-black/50">
    <div class="bg-white w-[96vw] max-w-5xl max-h-[90vh] rounded-2xl shadow-2xl flex flex-col">
      <div class="flex items-center justify-between border-b px-4 py-3 sticky top-0 bg-white z-10">
        <strong>#Xem chi ti·∫øt ƒë·ªëi t∆∞·ª£ng   <span id="d_id"></span></strong>
        <div class="flex gap-2 flex-wrap">
          <button class="btn btn-outline btn-xs" id="btnCopy">üìã Sao ch√©p</button>
          <button class="btn btn-primary btn-xs" id="btnRestore">‚ôª Kh√¥i ph·ª•c</button>

          <!-- N√∫t m·ªü x√°c nh·∫≠n x√≥a -->
          <button class="btn btn-outline btn-xs" id="btnHardDelete" style="border-color:#dc2626;color:#dc2626">üóëÔ∏è X√≥a vƒ©nh vi·ªÖn</button>
          <!-- N√∫t OK X√≥a (·∫©n m·∫∑c ƒë·ªãnh) -->
          <button class="btn btn-primary btn-xs hidden" id="btnHardDeleteGo" style="background:#dc2626;border-color:#dc2626">OK X√≥a</button>
          <!-- N√∫t H·ªßy (·∫©n m·∫∑c ƒë·ªãnh) -->
          <button class="btn btn-outline btn-xs hidden" id="btnHardDeleteCancel">H·ªßy</button>

          <button class="btn btn-outline btn-xs" id="btnClose">ƒê√≥ng</button>
        </div>
      </div>

      <!-- √î x√°c nh·∫≠n hard delete -->
      <div id="hardDelConfirm" class="hidden px-4 pt-3">
        <div class="flex items-center gap-2">
          <select id="hardDelSelect" class="input w-56">
            <option value="">-- Ch·ªçn ƒë·ªÉ x√°c nh·∫≠n --</option>
            <option value="CONFIRM_DELETE">T√¥i x√°c nh·∫≠n x√≥a vƒ©nh vi·ªÖn</option>
          </select>
          <input id="hardDelReason" class="input flex-1" placeholder="(Tu·ª≥ ch·ªçn) L√Ω do x√≥a‚Ä¶" />
        </div>
        <p class="text-xs text-rose-600 mt-1 mb-2">H√†nh ƒë·ªông kh√¥ng th·ªÉ ho√†n t√°c. Vui l√≤ng x√°c nh·∫≠n tr∆∞·ªõc khi x√≥a!</p>
      </div>

      <!-- Modal x√°c nh·∫≠n x√≥a ƒë·∫πp -->
      <div id="confirmHardDel" class="hidden fixed inset-0 bg-black/50 z-[9999] flex items-center justify-center">
        <div class="bg-white p-6 rounded-2xl shadow-xl max-w-sm text-center space-y-4">
          <div class="text-lg font-semibold text-gray-800">X√≥a vƒ©nh vi·ªÖn h·ªì s∆° n√†y?</div>
          <div class="text-sm text-gray-500">H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.<br> B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ti·∫øp t·ª•c?</div>
          <div class="flex justify-center gap-3 pt-2">
            <button id="btnConfirmHardDelYes" class="btn btn-primary px-4 py-1.5">OK</button>
            <button id="btnConfirmHardDelNo" class="btn btn-outline px-4 py-1.5">H·ªßy</button>
          </div>
        </div>
      </div>

      <!-- Modal x√°c nh·∫≠n kh√¥i ph·ª•c -->
      <div id="confirmRestore" class="hidden fixed inset-0 bg-black/50 z-[9999] flex items-center justify-center">
        <div class="bg-white p-6 rounded-2xl shadow-xl max-w-sm text-center space-y-4">
          <div class="text-lg font-semibold text-gray-800">Kh√¥i ph·ª•c d·ªØ li·ªáu?</div>
          <div class="text-sm text-gray-500">
            X√°c nh·∫≠n kh√¥i ph·ª•c h·ªì s∆° MSSV <b id="restoreMSSV">‚Äî</b> t·ª´ th√πng r√°c.
          </div>
          <div class="flex justify-center gap-3 pt-2">
            <button id="btnConfirmRestoreYes" class="btn btn-primary px-4 py-1.5">OK</button>
            <button id="btnConfirmRestoreNo"  class="btn btn-outline px-4 py-1.5">H·ªßy</button>
          </div>
        </div>
      </div>

      <div id="d_view" class="p-4 overflow-auto flex-1"></div>
    </div>
  </div>

  <!-- Notification Toast -->
  <div id="notiBox" class="fixed inset-0 flex items-center justify-center z-[9999] pointer-events-none hidden">
    <div id="notiInner" class="px-6 py-3 rounded-xl shadow-xl text-white font-semibold text-center transition-all duration-300 scale-95 opacity-0 bg-blue-600"></div>
  </div>

<script>
  /* ====== Kho√° URL s·∫°ch ====== */
  (function lockCleanJournalURL(){
    const clean = () => { if (location.pathname !== '/journal.html' || location.search || location.hash) history.replaceState(null, '', '/journal.html'); };
    clean();
    const _replace = history.replaceState.bind(history);
    const _push    = history.pushState.bind(history);
    const toClean = (url) => {
      try {
        const u = new URL(url, location.origin);
        return (/\/journal\.html$/.test(u.pathname)) ? u.pathname : url;
      } catch { return url; }
    };
    history.replaceState = (s,t,u)=> _replace(s,t,toClean(u));
    history.pushState    = (s,t,u)=> _push(s,t,toClean(u));
    window.addEventListener('popstate', clean);
  })();

  /* ====== Basics ====== */
  const $  = (s)=>document.querySelector(s);
  const $$ = (s)=>document.querySelectorAll(s);
  const STORAGE_KEY = 'apiBase';
  const PREFIX_CANDIDATES = ['', '/api'];
  let API_PREFIX = '';
  const debounce = (fn, ms=300)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); } };

  (function initApiBase(){ const saved = localStorage.getItem(STORAGE_KEY) || window.location.origin; $('#apiBase').value = saved; })();
  const apiBase = ()=> $('#apiBase').value.trim().replace(/\/+$/,'');
  const makeUrl = (path)=> apiBase() + API_PREFIX + path;

  async function detectPrefix(){
    for(const p of PREFIX_CANDIDATES){
      try{ const r = await fetch(apiBase()+p+'/health', {credentials:'include'}); if(r.ok){ API_PREFIX=p; return; } }catch(_){}
    }
    API_PREFIX='';
  }
  async function apiFetch(path, init={}){
    const opts = {credentials:'include', ...init};
    let r = await fetch(makeUrl(path), opts).catch(()=>null);
    if (r && r.status !== 404) return r;
    const alt = (API_PREFIX === '' ? '/api' : '');
    if (alt !== API_PREFIX){
      try{ const r2 = await fetch(apiBase()+alt+path, opts); if(r2.ok){ API_PREFIX=alt; return r2; } return r2; }catch(e){ return null; }
    }
    return r;
  }

  /* ====== Labels ====== */
  const ACTION_LABELS = {
    CREATE:"T·∫°o m·ªõi", UPDATE:"C·∫≠p nh·∫≠t", DELETE_SOFT:"X√≥a t·∫°m",
    DELETE_HARD:"X√≥a vƒ©nh vi·ªÖn", DELETE:"X√≥a vƒ©nh vi·ªÖn",
    DELETE_REQUEST:"Y√™u c·∫ßu x√≥a", RESTORE:"Kh√¥i ph·ª•c",
    PRINT:"In / Xu·∫•t", READ:"Tra c·ª©u", EXCEPTION:"L·ªói h·ªá th·ªëng"
  };
  const actionVi = c => ACTION_LABELS[(c||'').toUpperCase()] || (c||'‚Äî');

  const FIELD_LABELS = {
    checklist_version_id:"Phi√™n b·∫£n checklist",
    da_tn_truoc_do:"ƒê√£ TN tr∆∞·ªõc ƒë√≥",
    deleted_at:"Th·ªùi ƒëi·ªÉm x√≥a",
    deleted_by:"Ng∆∞·ªùi x√≥a",
    deleted_reason:"L√Ω do x√≥a",
    dot:"ƒê·ª£t",
    email_hoc_vien:"Email h·ªçc vi√™n",
    ghi_chu:"Ghi ch√∫",
    ho_ten:"H·ªç t√™n",
    khoa:"Kh√≥a",
    ma_ho_so:"M√£ h·ªì s∆°",
    ma_so_hv:"M√£ s·ªë h·ªçc vi√™n",
    nganh_nhap_hoc:"Ng√†nh nh·∫≠p h·ªçc",
    ngay_nhan_hs:"Ng√†y nh·∫≠n h·ªì s∆°",
    ngay_sinh:"Ng√†y sinh",
    nguoi_nhan_ky_ten:"Ng∆∞·ªùi nh·∫≠n",
    printed:"Tr·∫°ng th√°i in",
    status:"Tr·∫°ng th√°i",
    so_dt:"S·ªë ƒëi·ªán tho·∫°i",
    gioi_tinh:"Gi·ªõi t√≠nh",
    dan_toc:"D√¢n t·ªôc",  
    update_reason: "L√Ω do c·∫≠p nh·∫≠t",
  };
  const getFieldLabel = (k) => FIELD_LABELS[k] || k;

  /* ====== State ====== */
  const state = { page:1, size:Number(localStorage.getItem('journal.pageSize')||20), total:0, sort:{key:'occurred_at', dir:'desc'}, filters:{}, currentLog:null };
  const pagesTotal = ()=> Math.max(1, Math.ceil(state.total / state.size));

  function setState({loading=false, empty=false}){
    $('#loading').classList.toggle('hidden', !loading);
    $('#emptyState').classList.toggle('hidden', !empty);
    $('#tableWrap').classList.toggle('hidden', loading || empty);
  }
  function setAriaSort(){
    $$('.th-sortable').forEach(th=> th.removeAttribute('aria-sort'));
    if (state.sort.key){
      const th = document.querySelector(`.th-sortable[data-sort="${state.sort.key}"]`);
      if (th) th.setAttribute('aria-sort', state.sort.dir==='asc'?'ascending':'descending');
    }
  }
  function toggleSort(key){
    if (state.sort.key === key) state.sort.dir = (state.sort.dir==='asc'?'desc':'asc');
    else { state.sort.key=key; state.sort.dir='asc'; }
    setAriaSort(); load();
  }

  function qs(){
    const p = new URLSearchParams();
    p.set('page', state.page);
    p.set('page_size', state.size);
    const f = state.filters;
    if (f.q) p.set('q', f.q);
    if (f.action) p.set('action', f.action);
    if (f.type) p.set('target_type', f.type);
    if (f.id) p.set('target_id', f.id);
    if (f.actor) p.set('actor', f.actor);
    if (f.from) p.set('from', f.from);
    if (f.to) p.set('to', f.to);
    if (state.sort.key) {
      const keyMap = { target: 'target_id' };
      const field = keyMap[state.sort.key] || state.sort.key;
      p.set('sort', `${field}:${state.sort.dir}`);
    }
    return p.toString();
  }

  function syncUrl(){
  if (location.pathname === '/journal.html' && (location.search || location.hash)) {
    history.replaceState(null, '', '/journal.html');
  }
  }

  async function load() {
    setState({ loading: true });
    const tb = $('#tbody');
    tb.innerHTML = `<tr><td colspan="7" class="text-center text-gray-500 py-10">ƒêang t·∫£i d·ªØ li·ªáu‚Ä¶</td></tr>`;

    try {
      const res = await apiFetch('/journal/?' + qs());
      if (!res || !res.ok) throw new Error('Kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c m√°y ch·ªß');

      // D√πng t√™n payload ƒë·ªÉ tr√°nh ƒë·ª•ng "data" ngo√†i ph·∫°m vi
      const payload = await res.json();

      // Chu·∫©n h√≥a d·ªØ li·ªáu tr·∫£ v·ªÅ
      const items = Array.isArray(payload.items)
        ? payload.items
        : (Array.isArray(payload.data) ? payload.data : []);

      const total = Number(payload.total ?? payload.count ?? items.length ?? 0);
      state.total = total;

      // N·∫øu trang hi·ªán t·∫°i v∆∞·ª£t qu√° t·ªïng trang m·ªõi -> nh·∫£y v·ªÅ trang cu·ªëi r·ªìi n·∫°p l·∫°i
      const pages = pagesTotal();
      if (state.page > pages) {
        state.page = pages;
        // D·ª´ng lu·ªìng hi·ªán t·∫°i v√† n·∫°p l·∫°i v·ªõi trang h·ª£p l·ªá
        return load();
      }

      renderTable(items);
      renderPager();
      $('#count').textContent = String(state.total);
      setState({ loading: false, empty: items.length === 0 });
      syncUrl();
    } catch (e) {
      tb.innerHTML = `<tr><td colspan="7" class="text-center text-rose-600 py-10">L·ªói: ${e.message}</td></tr>`;
      setState({ loading: false, empty: false });
    }
  }

  function displayActor(row){
    const name = (row.actor_name ?? "").toString().trim();
    return name || (row.actor_id != null ? `#${row.actor_id}` : "‚Äî");
  }

  /* ====== Date helpers (VN) ====== */
  function formatVNDateTime(input) {
    if (!input) return '';
    const d = input instanceof Date ? input : new Date(String(input));
    if (isNaN(d)) return '';
    const parts = new Intl.DateTimeFormat('vi-VN', {
      timeZone:'Asia/Ho_Chi_Minh', year:'numeric', month:'2-digit', day:'2-digit',
      hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:false
    }).formatToParts(d);
    const get = t => parts.find(p => p.type === t)?.value || '00';
    return `${get('hour')}:${get('minute')}:${get('second')} ${get('day')}/${get('month')}/${get('year')}`;
  }

  // ‚ûï H√†m r√∫t g·ªçn ch·ªâ l·∫•y ng√†y (d√†nh cho ph·∫ßn d·ªØ li·ªáu hi·ªán t·∫°i)
  function formatVNDateOnly(input) {
    if (!input) return '';
    const d = input instanceof Date ? input : new Date(String(input));
    if (isNaN(d)) return '';
    const parts = new Intl.DateTimeFormat('vi-VN', {
      timeZone: 'Asia/Ho_Chi_Minh',
      year: 'numeric',
      month: '2-digit',
      day: '2-digit'
    }).formatToParts(d);
    const get = t => parts.find(p => p.type === t)?.value || '00';
    return `${get('day')}/${get('month')}/${get('year')}`;
  }

  function maybeFormatDateLike(v) {
    if (!v) return null;
    if (v instanceof Date) return formatVNDateTime(v);
    if (typeof v === 'string' && (/^\d{4}-\d{2}-\d{2}(T.*)?$/.test(v) || /^\d{1,2}\/\d{1,2}\/\d{4}$/.test(v))) return formatVNDateTime(v);
    return null;
  }

  /* ====== Table list ====== */
  function renderTable(items){
    const tb = $('#tbody');
    if (!items.length){
      tb.innerHTML = `<tr><td colspan="7" class="text-center text-gray-500 py-10">Kh√¥ng c√≥ log n√†o</td></tr>`;
      return;
    }
    tb.innerHTML='';

    const collator = new Intl.Collator('vi', {numeric:true, sensitivity:'base'});
    const key = state.sort.key, dir = state.sort.dir;
    const actionMap = ACTION_LABELS;

    const getVal = (r)=>{
      if (key==='id') return r.id;
      if (key==='occurred_at') return r.occurred_at;
      if (key==='actor_name') return r.actor_name||'';
      if (key==='action') return actionMap[r.action] || r.action || '';
      if (key==='status') return r.status||'';
      if (key==='target') return r.target_id || '';
      return '';
    };

    const sorted = items.slice().sort((a,b)=> collator.compare(String(getVal(a)), String(getVal(b))));
    if (dir==='desc') sorted.reverse();

    sorted.forEach(row=>{
      const tr = document.createElement('tr');
      const when = row.occurred_at ? new Date(row.occurred_at) : null;
      const actionLabel = actionVi(row.action);
      tr.innerHTML = `
        <td class="text-left whitespace-nowrap">${row.id}</td>
        <td class="text-center whitespace-nowrap">${when ? formatVNDateTime(when) : ''}</td>
        <td class="text-center">${escapeHtml(displayActor(row))}</td>
        <td class="text-center"><span class="chip">${escapeHtml(actionLabel)}</span></td>
        <td class="text-center whitespace-nowrap">${escapeHtml(row.target_id ?? '‚Äî')}</td>
        <td class="text-center">
          ${row.status === 'SUCCESS' ? '<span class="status-ok">OK</span>' : '<span class="status-fail">FAIL</span>'}
        </td>
        <td class="text-center">
          <button class="btn btn-outline btn-xs" data-id="${row.id}">ViewüëÅÔ∏è‚Äçüó®Ô∏è</button>
        </td>`;
      tb.appendChild(tr);
    });

    $$('button[data-id]').forEach(b=> b.onclick=()=> openDetail(b.dataset.id));
  }

  function renderPager(){
    const pages = Math.max(1, Math.ceil(state.total/state.size));
    $$('.pager').forEach(p=>{
      p.querySelector('.pager-info').textContent = `Trang ${state.page}/${pages} ‚Ä¢ ${state.total} m·ª•c`;
      p.querySelector('.pager-first').disabled = state.page<=1;
      p.querySelector('.pager-prev').disabled  = state.page<=1;
      p.querySelector('.pager-next').disabled  = state.page>=pages;
      p.querySelector('.pager-last').disabled  = state.page>=pages;
    });
  }

  /* ====== Common helpers for detail ====== */
  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[c])); }
 
  function cellValFor(field, v) {
    // context ƒë·ªÉ bi·∫øt ƒëang render field n√†o (ph·ª•c v·ª• r√∫t g·ªçn ng√†y)
    window.currentRenderField = field || null;
    return cellVal(v);
  }

function cellVal(x) {
  if (x === null || x === undefined || x === '')
    return '<span class="text-gray-400">‚Äî</span>';

  // Gi·ªõi t√≠nh
  if (typeof x === 'string') {
    const s = x.trim().toLowerCase();
    if (s === 'm' || s === 'nam' || s === 'male' || s === '1') return 'Nam';
    if (s === 'f' || s === 'nu' || s === 'n·ªØ'  || s === 'female' || s === '0') return 'N·ªØ';
  }

  // L√Ω do c·∫≠p nh·∫≠t
  if (typeof x === 'object' && x && ('key' in x || 'text' in x)) {
    const key  = (x.key  || '').toString();
    const text = (x.text || '').toString();
    const MAP = {
      capnhat_thongtin: 'C·∫≠p nh·∫≠t th√¥ng tin h·ªçc vi√™n',
      capnhat_hoso_moi: 'C·∫≠p nh·∫≠t h·ªì s∆° m·ªõi',
      bosung_hoso:      'B·ªï sung h·ªì s∆°',
      capnhat_chungchi: 'C·∫≠p nh·∫≠t ch·ª©ng ch·ªâ',
      chinhsua_hoso:    'Ch·ªânh s·ª≠a h·ªì s∆°',
      khac:             `L√Ω do kh√°c${text ? ': ' + text : ''}`
    };
    if (key) return escapeHtml(MAP[key] || key);
  }
  if (typeof x === 'string') {
    const MAP = {
      capnhat_thongtin: 'C·∫≠p nh·∫≠t th√¥ng tin h·ªçc vi√™n',
      capnhat_hoso_moi: 'C·∫≠p nh·∫≠t h·ªì s∆° m·ªõi',
      bosung_hoso:      'B·ªï sung h·ªì s∆°',
      capnhat_chungchi: 'C·∫≠p nh·∫≠t ch·ª©ng ch·ªâ',
      chinhsua_hoso:    'Ch·ªânh s·ª≠a h·ªì s∆°',
      khac:             'L√Ω do kh√°c'
    };
    const k = x.trim();
    if (MAP[k]) return MAP[k];
  }

  // Ng√†y: n·∫øu l√† ng√†y/ISO -> r√∫t g·ªçn tu·ª≥ ng·ªØ c·∫£nh
  const maybe = maybeFormatDateLike(x);
  if (maybe) {
    const field = (window.currentRenderField || '').toLowerCase();

    // deleted_at: lu√¥n hi·ªÉn th·ªã ƒë·∫ßy ƒë·ªß theo gi·ªù VN
    if (field === 'deleted_at') {
      const d = new Date(x);
      if (!isNaN(d)) {
        const vn = new Intl.DateTimeFormat('vi-VN', {
          timeZone: 'Asia/Ho_Chi_Minh',
          year: 'numeric', month: '2-digit', day: '2-digit',
          hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
        }).format(d);
        return escapeHtml(vn);
      }
    }

    // C√°c field ng√†y ‚Äúngay_nhan_hs/ngay_sinh‚Äù ch·ªâ l·∫•y ng√†y
    if (/^ngay_(nhan_hs|sinh)$/.test(field)) {
      return escapeHtml(formatVNDateOnly(x));
    }
    return escapeHtml(maybe);
  }

  if (typeof x === 'object') {
    return `<pre class="bg-white border border-dashed border-gray-200 rounded-lg p-2 overflow-auto text-xs">${escapeHtml(JSON.stringify(x, null, 2))}</pre>`;
  }
  return escapeHtml(String(x));
}

  function diffKeysFiltered(prev={}, next={}){
    const ignore = new Set(['docs_before','docs_after','docs_diff']);
    const set = new Set([...Object.keys(prev||{}), ...Object.keys(next||{})]);
    const changes=[];
    set.forEach(k=>{
      if (ignore.has(k)) return;
      const a=(prev||{})[k]; const b=(next||{})[k];
      if (JSON.stringify(a)!==JSON.stringify(b)) changes.push({field:k, from:a, to:b});
    });
    return changes;
  }

  function snapshotGrid(obj, picks){
    const rows = (picks||[]).map(([label, key])=>{
      const v = obj ? obj[key] : null;
      return `
        <div class="bg-slate-50 font-semibold p-2">${escapeHtml(label)}</div>
        <div class="p-2">${cellValFor(key, v)}</div>`;
    }).join('');
    return `
      <div class="grid grid-cols-[220px_1fr] border border-gray-200 rounded-xl overflow-hidden">
        ${rows || '<div class="p-3 text-gray-500 col-span-2">Kh√¥ng c√≥ d·ªØ li·ªáu.</div>'}
      </div>`;
  }


  /* ====== L·∫•y map code -> t√™n danh m·ª•c checklist (cache) ====== */
  let __NAME_MAP_CACHE = null;
  async function getChecklistNameMap(){
    if (__NAME_MAP_CACHE) return __NAME_MAP_CACHE;
    try{
      const r = await apiFetch('/checklist/active');
      if (r && r.ok){
        const j = await r.json();
        const map = {};
        const arr = Array.isArray(j?.items) ? j.items : (Array.isArray(j) ? j : []);
        arr.forEach(it => { if (it?.code) map[it.code] = it.display_name || it.name || it.code; });
        __NAME_MAP_CACHE = map;
        return map;
      }
    }catch(_){}
    __NAME_MAP_CACHE = {};
    return {};
  }

  /* ====== Render b·∫£ng danh m·ª•c hi·ªán t·∫°i ====== */
  function renderDocsCurrentTable(docsObj={}, nameMap={}){
    const safe = (docsObj && typeof docsObj === 'object') ? docsObj : {};
    const entries = Object.entries(safe).map(([code, n])=>({
      code, name: nameMap[code] || code, qty: Number(n)||0
    })).filter(x=>x.qty>0);

    if (!entries.length) return `<div class="text-gray-500">Kh√¥ng c√≥ danh m·ª•c h·ªì s∆°.</div>`;

    entries.sort((a,b)=> a.name.localeCompare(b.name,'vi',{sensitivity:'base'}));

    return `
      <table class="w-full text-sm border border-gray-200 rounded-xl overflow-hidden">
        <thead class="bg-slate-50">
          <tr>
            <th class="p-2 text-left font-semibold text-gray-800">T√™n danh m·ª•c</th>
            <th class="p-2 text-center font-semibold text-gray-800">S·ªë l∆∞·ª£ng</th>
          </tr>
        </thead>
        <tbody>
          ${entries.map(x=>`
            <tr class="border-t">
              <td class="p-2 font-semibold text-gray-800">${escapeHtml(x.name)}</td>
              <td class="p-2 text-center">${escapeHtml(String(x.qty))}</td>
            </tr>`).join('')}
        </tbody>
      </table>`;
  }

  /* ====== Render b·∫£ng danh m·ª•c thay ƒë·ªïi (ch·ªâ t√™n + tr∆∞·ªõc/sau/¬±) ====== */
  function renderDocsDiffTable(diffs=[], nameMap={}){
    if (!Array.isArray(diffs) && diffs && typeof diffs === 'object') {
      diffs = Object.entries(diffs).map(([code, v]) => {
        const from = Number(v?.from ?? 0);
        const to   = Number(v?.to   ?? (typeof v === 'number' ? v : 0));
        return { code, from, to };
      });
    }
    if (!Array.isArray(diffs) || diffs.length === 0) {
      return `<div class="text-gray-500">Kh√¥ng c√≥ thay ƒë·ªïi v·ªÅ danh m·ª•c h·ªì s∆°.</div>`;
    }

    const rows = diffs.map(x=>{
      const delta = Number(x.to) - Number(x.from);
      const sign  = delta>0 ? '‚Üë' : (delta<0 ? '‚Üì' : '‚Äî');
      return {
        name: nameMap[x.code] || x.code,
        from: Number(x.from)||0,
        to:   Number(x.to)||0,
        delta, sign
      };
    }).sort((a,b)=> a.name.localeCompare(b.name,'vi',{sensitivity:'base'}));

    return `
      <table class="w-full text-sm border border-gray-200 rounded-xl overflow-hidden">
        <thead class="bg-slate-50">
          <tr>
            <th class="p-2 text-left font-semibold text-gray-800">T√™n danh m·ª•c</th>
            <th class="p-2 text-center font-semibold text-gray-800">Tr∆∞·ªõc</th>
            <th class="p-2 text-center font-semibold text-gray-800">Sau</th>
            <th class="p-2 text-center font-semibold text-gray-800">¬±</th>
          </tr>
        </thead>
        <tbody>
          ${rows.map(r=>`
            <tr class="border-t">
              <td class="p-2 font-semibold text-gray-800">${escapeHtml(r.name)}</td>
              <td class="p-2 text-center">${escapeHtml(String(r.from))}</td>
              <td class="p-2 text-center">${escapeHtml(String(r.to))}</td>
              <td class="p-2 text-center">${r.sign} ${r.delta}</td>
            </tr>`).join('')}
        </tbody>
      </table>`;
  }

/* ====== OPEN DETAIL ====== */
async function openDetail(id) {
  try {
    const r = await apiFetch('/journal/detail/' + id);
    if (!r || !r.ok) throw new Error('Kh√¥ng t·∫£i ƒë∆∞·ª£c chi ti·∫øt');
    const d = await r.json();
    state.currentLog = d;

  // ‚öôÔ∏è Hi·ªÉn th·ªã MSSV thay cho STT
  const label = d?.target_id
    ? `MSSV: ${String(d.target_id)}`
    : `STT: ${String(id)}`;
  $('#d_id').textContent = label;

    // ·∫®n n√∫t m·ªü h·ªì s∆° (v√¨ anh kh√¥ng c·∫ßn)
    const btnOpenApplicant = document.getElementById('btnOpenApplicant');
    if (btnOpenApplicant) btnOpenApplicant.style.display = 'none';

    // ===== Quy t·∫Øc hi·ªÉn th·ªã n√∫t theo ng·ªØ c·∫£nh =====
    const canTarget = !!(d?.target_id);
    const isApplicant = (d?.target_type === 'Applicant');
    const isHardDeleted = (d?.action === 'DELETE_HARD') || (d?.new_values?.hard_deleted === true);
    const isSoftDeleteAction = (d?.action === 'DELETE_SOFT' || d?.action === 'DELETE');
    const hasSnapshot = !!(d?.prev_values) || !!(d?.new_values);

    // Kh√¥i ph·ª•c: ch·ªâ cho Applicant, c√≥ target_id, KH√îNG hard-deleted
    const btnRestore = document.getElementById('btnRestore');
    if (!isApplicant || !canTarget || isHardDeleted) {
      btnRestore.disabled = true;
      btnRestore.title = isHardDeleted
        ? 'D·ªØ li·ªáu ƒë√£ b·ªã x√≥a vƒ©nh vi·ªÖn, kh√¥ng th·ªÉ kh√¥i ph·ª•c!'
        : (!hasSnapshot ? 'Log n√†y kh√¥ng c√≥ snapshot ƒë·ªÉ kh√¥i ph·ª•c.' : 'Kh√¥ng th·ªÉ kh√¥i ph·ª•c v·ªõi log n√†y!');
    } else {
      btnRestore.disabled = false;
      btnRestore.title = 'Kh√¥i ph·ª•c t·ª´ snapshot';
    }

    // X√≥a vƒ©nh vi·ªÖn: ch·ªâ Admin + log DELETE/DELETE_SOFT + Applicant + c√≥ target
    const btnHardDelete = document.getElementById('btnHardDelete');
    const showHardDel = IS_ADMIN && isApplicant && canTarget && isSoftDeleteAction && !isHardDeleted;
    btnHardDelete.style.display = showHardDel ? '' : 'none';

    // üß† Gi·ªØ nguy√™n logic ph√≠a sau
    const nameMap = await getChecklistNameMap();
    const isObj = (x) => x && typeof x === 'object' && !Array.isArray(x);
    const asObj = (x) => (isObj(x) ? x : {});
    const prev = asObj(d.prev_values);
    const next = asObj(d.new_values);
    const current = Object.keys(next).length ? next : prev;
      // H√†nh ƒë·ªông xo√°?
      const isDeleteAction = ['DELETE_SOFT', 'DELETE', 'DELETE_HARD'].includes(String(d?.action || '').toUpperCase());

      // Ch·ªçn snapshot & docs cho ph·∫ßn ‚ÄúD·ªØ li·ªáu ‚Ä¶‚Äù
      const snapshotForView = isDeleteAction
        ? prev
        : (Object.keys(next).length ? next : prev);

      const asDict = (x) => (isObj(x) ? x : {});
      const docsBefore = asDict(prev.docs_before) || asDict(prev.docs);
      const docsAfter  = asDict(next.docs_after)  || asDict(next.docs);

      const docsForView = isDeleteAction
        ? (Object.keys(docsBefore).length ? docsBefore : docsAfter)
        : (Object.keys(docsAfter).length  ? docsAfter  : docsBefore);

      // T√≠nh diff th∆∞·ªùng (b·ªè qua docs*)
      const diffs = diffKeysFiltered(prev, next);

      // docs_diff c√≥ th·ªÉ l√† array/object/null ‚Äî chu·∫©n h√≥a
      let docsDiff = Array.isArray(next.docs_diff)
        ? next.docs_diff
        : (Array.isArray(d.docs_diff) ? d.docs_diff : []);
      if (!Array.isArray(docsDiff) || docsDiff.length === 0) {
        const beforeKeys = Object.keys(asDict(docsBefore));
        const afterKeys  = Object.keys(asDict(docsAfter));
        const all = new Set([...beforeKeys, ...afterKeys]);
        docsDiff = Array.from(all)
          .map(code => ({
            code,
            from: Number((docsBefore || {})[code] || 0),
            to:   Number((docsAfter  || {})[code] || 0)
          }))
          .filter(x => x.from !== x.to);
      }

      /* Th√¥ng tin chung */
      const infoHtml = `
        <h4 class="mt-1 mb-2 font-bold text-blue-800">Th√¥ng tin chung</h4>
        <div class="grid grid-cols-[220px_1fr] border border-gray-200 rounded-xl overflow-hidden">
          <div class="bg-slate-50 font-semibold p-2">Th·ªùi gian</div>     <div class="p-2">${cellVal(d.occurred_at)}</div>
          <div class="bg-slate-50 font-semibold p-2">Ng∆∞·ªùi thao t√°c</div><div class="p-2">${escapeHtml(d.actor_name || d.actor_id || '‚Äî')}</div>
          <div class="bg-slate-50 font-semibold p-2">H√†nh ƒë·ªông</div>     <div class="p-2">${escapeHtml(actionVi(d.action))}</div>
          <div class="bg-slate-50 font-semibold p.2">Tr·∫°ng th√°i</div>    <div class="p-2">${escapeHtml(d.status || '')}</div>
          <div class="bg-slate-50 font-semibold p-2">ƒê·ªëi t∆∞·ª£ng (MSSV)</div><div class="p-2">${escapeHtml(d.target_id || '‚Äî')}</div>
          <div class="bg-slate-50 font-semibold p-2">ƒê∆∞·ªùng d·∫´n</div>     <div class="p-2">${escapeHtml(d.path || '')}</div>
          <div class="bg-slate-50 font-semibold p-2">IP</div>             <div class="p-2">${escapeHtml(d.ip_address || '')}</div>
          <div class="bg-slate-50 font-semibold p-2">Correlation ID</div><div class="p-2">${escapeHtml(d.correlation_id || '')}</div>
        </div>`;

      /* D·ªØ li·ªáu (snapshot) */
      const currentPicks = [
        ["M√£ h·ªì s∆°","ma_ho_so"],
        ["Ng√†y nh·∫≠n h·ªì s∆°","ngay_nhan_hs"],
        ["M√£ s·ªë h·ªçc vi√™n","ma_so_hv"],
        ["H·ªç t√™n","ho_ten"],
        ["Ng√†y sinh","ngay_sinh"],
        ["Gi·ªõi t√≠nh","gioi_tinh"],
        ["D√¢n t·ªôc","dan_toc"],
        ["S·ªë ƒëi·ªán tho·∫°i","so_dt"],
        ["Email h·ªçc vi√™n","email_hoc_vien"],
        ["Ng√†nh nh·∫≠p h·ªçc","nganh_nhap_hoc"],
        ["ƒê·ª£t","dot"],
        ["Kh√≥a","khoa"],
        ["ƒê√£ TN tr∆∞·ªõc ƒë√≥","da_tn_truoc_do"],
        ["Ghi ch√∫","ghi_chu"],
        ["Ng∆∞·ªùi nh·∫≠n","nguoi_nhan_ky_ten"],
        ["Tr·∫°ng th√°i","status"],
        ["Th·ªùi ƒëi·ªÉm x√≥a","deleted_at"],
        ["Ng∆∞·ªùi x√≥a","deleted_by"],
        ["L√Ω do x√≥a","deleted_reason"]
      ];

      const snapshotTitle = isDeleteAction ? 'D·ªØ li·ªáu tr∆∞·ªõc khi x√≥a' : 'D·ªØ li·ªáu hi·ªán t·∫°i';
      console.log('dan_toc snapshot', snapshotForView?.dan_toc, 'prev', prev?.dan_toc, 'next', next?.dan_toc);


      window.currentRenderSection = 'snapshot';
      window.currentRenderField   = null;

      const currentHtml = `
        <h4 class="mt-6 mb-2 font-bold text-blue-800">${snapshotTitle}</h4>
        ${snapshotGrid(snapshotForView, currentPicks)}

        <h4 class="mt-6 mb-2 font-bold text-blue-800">Danh m·ª•c h·ªì s∆° (${isDeleteAction ? 'tr∆∞·ªõc khi x√≥a' : 'hi·ªán t·∫°i'})</h4>
        ${renderDocsCurrentTable(docsForView, nameMap)}
      `;

     /* Tr∆∞·ªùng thay ƒë·ªïi */
    const diffHtml = diffs.length
      ? `<h4 class="mt-6 mb-2 font-bold text-blue-800">Tr∆∞·ªùng thay ƒë·ªïi</h4>
        <table class="w-full text-sm border border-gray-200 rounded-xl overflow-hidden">
          <thead class="bg-slate-50">
            <tr>
              <th class="p-2 text-left">Tr∆∞·ªùng</th>
              <th class="p-2 text-left">Gi√° tr·ªã c≈©</th>
              <th class="p-2 text-left">Gi√° tr·ªã m·ªõi</th>
            </tr>
          </thead>
          <tbody>
            ${diffs.map(x => `
              <tr class="border-t">
                <td class="p-2 font-semibold">${escapeHtml(getFieldLabel(x.field))}</td>
                <td class="p-2">${cellValFor(x.field, x.from)}</td>
                <td class="p-2">${cellValFor(x.field, x.to)}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>`
      : `<div class="text-gray-500 mt-4">Kh√¥ng c√≥ tr∆∞·ªùng thay ƒë·ªïi.</div>`;

      /* Danh m·ª•c h·ªì s∆° thay ƒë·ªïi */
      const docsHtml = `
        <h4 class="mt-6 mb-2 font-bold text-blue-800">Danh m·ª•c h·ªì s∆° thay ƒë·ªïi</h4>
        ${renderDocsDiffTable(docsDiff, nameMap)}
      `;

      // Render
      $('#d_view').innerHTML = infoHtml + currentHtml + diffHtml + docsHtml;

      // Admin-only hard delete button (ph√≤ng h·ªù)
      const isDel = ['DELETE','DELETE_SOFT'].includes(String(d.action).toUpperCase());
      $('#btnHardDelete').style.display = (isDel && IS_ADMIN) ? '' : 'none';
      $('#detail').style.display = 'flex';
    }catch(e){
      showNoti('Kh√¥ng t·∫£i ƒë∆∞·ª£c chi ti·∫øt: ' + (e.message||'unknown'), 'error');
    } finally {
      // reset marker d√πng cho cellVal
      window.currentRenderSection = null;
      window.currentRenderField   = null;
    }
  }

  // ƒê√≥ng modal b·∫±ng ESC v√† click ra ngo√†i
  (function bindDetailDismiss(){
    const overlay = document.getElementById('detail');
    overlay.addEventListener('click', (e)=> { if (e.target === overlay) overlay.style.display = 'none'; });
    document.addEventListener('keydown', (e)=>{ if (e.key === 'Escape' && overlay.style.display === 'flex') overlay.style.display = 'none'; });
  })();

  /* ====== Restore ====== */
  async function restore(){
    const log = state.currentLog;
    const logId = log?.id;
    const mssv  = log?.target_id || '‚Äî';
    if (!logId) return;

    // M·ªü popup x√°c nh·∫≠n
    const box = document.getElementById('confirmRestore');
    const yes = document.getElementById('btnConfirmRestoreYes');
    const no  = document.getElementById('btnConfirmRestoreNo');
    const lbl = document.getElementById('restoreMSSV');

    if (lbl) lbl.textContent = String(mssv);
    box.classList.remove('hidden');

    const closeBox = ()=> box.classList.add('hidden');

    const doRestore = async () => {
      closeBox();
      try{
        const r = await apiFetch('/journal/restore/' + logId, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:'{}'
        });
        if (!r) throw new Error('Kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c m√°y ch·ªß.');
        if (!r.ok){
          let msg = 'Kh√¥i ph·ª•c th·∫•t b·∫°i.', reason='';
          try{
            const ct = r.headers?.get?.('content-type') || '';
            if (ct.includes('application/json')){
              const dataErr = await r.json().catch(()=>null);
              if (dataErr){ reason=dataErr.reason||dataErr.code||''; if (dataErr.message) msg=dataErr.message; }
            }else{
              const t = await r.text().catch(()=> '');
              if (/hard[_\s-]?deleted/i.test(t)) reason='hard_deleted';
            }
          }catch(_){}
          if (r.status===410 || reason==='hard_deleted' || reason==='HARD_DELETED') msg='D·ªØ li·ªáu ƒë√£ b·ªã x√≥a vƒ©nh vi·ªÖn, kh√¥ng th·ªÉ kh√¥i ph·ª•c!';
          else if (r.status===404) msg='Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu ƒë·ªÉ kh√¥i ph·ª•c.';
          throw new Error(msg);
        }

        // ƒê·ªçc payload ƒë·ªÉ l·∫•y item (n·∫øu BE tr·∫£ v·ªÅ)
        let data = null;
        try {
          const ctOk = r.headers?.get?.('content-type') || '';
          if (ctOk.includes('application/json')) {
            data = await r.json().catch(()=>null);
          }
        } catch(_) {}

        showNoti(`ƒê√£ kh√¥i ph·ª•c cho MSSV ${mssv} t·ª´ th√πng r√°c!`, 'success');
        document.getElementById('detail').style.display='none';

        // üëâ B·ªè l·ªçc thao t√°c n·∫øu ƒëang ch·ªçn X√≥a‚Ä¶ ƒë·ªÉ th·∫•y log RESTORE
        const actionSel = document.getElementById('qActionSel');
        if (actionSel) actionSel.value = '';

        // üëâ V·ªÅ trang 1 r·ªìi ƒë·ªçc l·∫°i filter hi·ªán t·∫°i tr∆∞·ªõc khi load (Journal list)
        state.page = 1;
        grabFilters();
        load();

        // üîî Ph√°t t√≠n hi·ªáu cho trang Danh s√°ch h·ªì s∆° (n·∫øu trang kia c√≥ l·∫Øng nghe)
        try {
          const focusMssv = String(data?.item?.ma_so_hv || mssv || '');
          if (focusMssv) {
            // Broadcast realtime
            try {
              const bc = new BroadcastChannel('app-events');
              bc.postMessage({ type:'APPLICANT_RESTORED', mssv: focusMssv, item: data?.item || null });
              bc.close?.();
            } catch(_) {}
            // D·ª± ph√≤ng: localStorage
            localStorage.setItem('restored.mssv', focusMssv);
          }
        } catch(_) {}

      }catch(e){
        showNoti('L·ªói kh√¥i ph·ª•c: ' + (e.message || 'unknown'), 'error');
      }finally{
        // cleanup listeners
        yes.removeEventListener('click', onYes);
        no.removeEventListener('click', onNo);
      }
    };

    const onYes = () => doRestore();
    const onNo  = () => {
      closeBox();
      yes.removeEventListener('click', onYes);
      no.removeEventListener('click', onNo);
    };

    yes.addEventListener('click', onYes, { once:true });
    no.addEventListener('click', onNo,   { once:true });
  }


  /* ====== Filters / UI ====== */
  function grabFilters(){
    state.filters = {
      q:$('#q').value.trim(), action:$('#qActionSel').value, id:$('#qId').value.trim(),
      actor:$('#qActor').value.trim(), from:$('#qFrom').value, to:$('#qTo').value
    };
    state.size = Number($('#pageSize').value)||20;
    localStorage.setItem('journal.pageSize', String(state.size));
  }

  function showNoti(msg, type="info", timeout=2500){
    let box = document.getElementById("notiBox");
    let inner = document.getElementById("notiInner");
    const colors={info:"bg-blue-600",success:"bg-green-600",warning:"bg-amber-600",error:"bg-rose-600"};
    inner.className = `px-6 py-3 rounded-xl shadow-xl text-white font-semibold text-center transition-all duration-300 scale-95 opacity-0 ${colors[type]||colors.info}`;
    inner.textContent = msg; box.classList.remove("hidden");
    requestAnimationFrame(()=>{ inner.classList.replace("scale-95","scale-100"); inner.classList.replace("opacity-0","opacity-100"); });
    setTimeout(()=>{ inner.classList.replace("scale-100","scale-95"); inner.classList.replace("opacity-100","opacity-0"); setTimeout(()=> box.classList.add("hidden"), 300); }, timeout);
  }

  const triggerSearch = debounce(()=>{ state.page=1; grabFilters(); load(); }, 300);
  $('#btnSearch').onclick = ()=>{ state.page=1; grabFilters(); load(); };
  $('#btnClear').onclick  = ()=>{ ['#q','#qType','#qId','#qActor','#qFrom','#qTo'].forEach(s=>$(s).value=''); $('#qActionSel').value=''; state.page=1; grabFilters(); load(); };
  ;['#q','#qType','#qId','#qActor','#qFrom','#qTo'].forEach(sel=>{
    $(sel).addEventListener('input', triggerSearch);
    $(sel).addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); state.page=1; grabFilters(); load(); } });
  });
  $('#qActionSel').addEventListener('change', triggerSearch);
  $('#pageSize').addEventListener('change', ()=>{ state.page=1; grabFilters(); load(); });

  function bindPager(container){
    container.querySelector('.pager-first').onclick = ()=>{ state.page=1; load(); };
    container.querySelector('.pager-prev').onclick  = ()=>{ if(state.page>1){ state.page--; load(); } };
    container.querySelector('.pager-next').onclick  = ()=>{ state.page++; load(); };
    container.querySelector('.pager-last').onclick  = ()=>{ state.page = pagesTotal(); load(); };
  }
  $$('.pager').forEach(bindPager);

  function bindSortHandlers(){
    $$('.th-sortable').forEach(th=>{
      const key = th.getAttribute('data-sort');
      const h = ()=> toggleSort(key);
      th.addEventListener('click', h);
      th.addEventListener('keydown', e=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); h(); } });
    });
    setAriaSort();
  }

  $('#btnClose').onclick = ()=> $('#detail').style.display='none';
  $('#btnCopy').onclick  = ()=>{ if(!state.currentLog) return; const text = JSON.stringify(state.currentLog, null, 2); navigator.clipboard.writeText(text).then(()=> showNoti('ƒê√£ sao ch√©p JSON chi ti·∫øt','success')); };
  $('#btnRestore').onclick = restore;

  /* ====== ROLE ====== */
  let CURRENT_ROLE = null;
  let IS_ADMIN = false;

  window.addEventListener('load', async ()=>{
    try {
      const meRes = await apiFetch('/me');
      if (meRes?.ok) {
        const me = await meRes.json();
        if (!['Admin','NhanVien'].includes(me.role)) { alert('Quy·ªÅn t√†i kho·∫£n kh√¥ng ƒë∆∞·ª£c ph√©p truy c·∫≠p trang Nh·∫≠t k√Ω.'); location.href = '/students_list.html'; return; }
        CURRENT_ROLE = me.role || null; IS_ADMIN = CURRENT_ROLE === 'Admin';
        document.documentElement.dataset.role = CURRENT_ROLE;
      } else { location.href = '/login'; return; }
    } catch (_) { alert('Kh√¥ng ki·ªÉm tra ƒë∆∞·ª£c quy·ªÅn truy c·∫≠p.'); location.href = '/students_list.html'; return; }

    await detectPrefix();
    $('#pageSize').value = String(state.size);
    bindSortHandlers();
    grabFilters();
    load();
  });

  $('#apiBase').addEventListener('change', ()=>{ localStorage.setItem(STORAGE_KEY, $('#apiBase').value.trim()); });

  /* ====== Hard delete (Admin only) ====== */
  const btnHardDelete = document.getElementById('btnHardDelete');
  const btnHardDeleteGo = document.getElementById('btnHardDeleteGo');
  const btnHardDeleteCancel = document.getElementById('btnHardDeleteCancel');
  const hardDelBox = document.getElementById('hardDelConfirm');
  const hardDelSel = document.getElementById('hardDelSelect');
  const hardDelReason = document.getElementById('hardDelReason');

  btnHardDelete.onclick = () => {
    if (!IS_ADMIN) { showNoti('Ch·ªâ Admin m·ªõi ƒë∆∞·ª£c x√≥a vƒ©nh vi·ªÖn.', 'error'); return; }
    hardDelBox.classList.remove('hidden');
    btnHardDeleteGo.classList.remove('hidden');
    btnHardDeleteCancel.classList.remove('hidden');
    btnHardDeleteGo.disabled = (hardDelSel.value !== 'CONFIRM_DELETE');
  };
  hardDelSel?.addEventListener('change', () => { btnHardDeleteGo.disabled = (hardDelSel.value !== 'CONFIRM_DELETE'); });
  btnHardDeleteCancel.onclick = () => {
    hardDelBox.classList.add('hidden');
    btnHardDeleteGo.classList.add('hidden');
    btnHardDeleteCancel.classList.add('hidden');
    if (hardDelSel) hardDelSel.value = '';
    if (hardDelReason) hardDelReason.value = '';
  };
  btnHardDeleteGo.onclick = async () => {
    if (!IS_ADMIN) { showNoti('Ch·ªâ Admin m·ªõi ƒë∆∞·ª£c x√≥a vƒ©nh vi·ªÖn.', 'error'); return; }
    const log = state.currentLog; if (!log) return;
    if (hardDelSel.value !== 'CONFIRM_DELETE'){ showNoti('B·∫°n ch∆∞a x√°c nh·∫≠n x√≥a vƒ©nh vi·ªÖn.', 'warning'); return; }

    const confirmBox = document.getElementById('confirmHardDel');
    const yesBtn = document.getElementById('btnConfirmHardDelYes');
    const noBtn  = document.getElementById('btnConfirmHardDelNo');
    confirmBox.classList.remove('hidden');
    const onNo = () => { confirmBox.classList.add('hidden'); };
    const onYes = async () => {
      confirmBox.classList.add('hidden'); btnHardDeleteGo.disabled = true;
      try{
        const r = await apiFetch('/journal/hard-delete', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({
            log_id: log.id, target_type: log.target_type, target_id: log.target_id,
            confirm: 'CONFIRM_DELETE', reason: (hardDelReason?.value || '').trim()
          })
        });
        if (!r) throw new Error('Kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c m√°y ch·ªß.');
        if (!r.ok) {
          let msg = `Hard-delete th·∫•t b·∫°i (HTTP ${r.status})`;
          try {
            const ct = r.headers?.get?.('content-type') || '';
            if (ct.includes('application/json')) {
              const j = await r.json().catch(()=>null);
              if (j?.detail) msg = j.detail;
            } else {
              const t = await r.text().catch(()=> '');
              if (t) msg = t;
            }
          } catch(_) {}
          showNoti(msg, 'error');
          return;
        }
        showNoti('ƒê√£ x√≥a vƒ©nh vi·ªÖn.','success');
        btnHardDeleteCancel.click();
        document.getElementById('detail').style.display = 'none';
        load();
      }catch(e){ showNoti('Hard-delete l·ªói: '+(e.message||'unknown'),'error'); }
      finally{ btnHardDeleteGo.disabled = false; }
      yesBtn.removeEventListener('click', onYes); noBtn.removeEventListener('click', onNo);
    };
    noBtn.addEventListener('click', onNo, { once:true });
    yesBtn.addEventListener('click', onYes, { once:true });
  };
</script>

</body>
</html>
