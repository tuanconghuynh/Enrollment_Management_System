<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>V-HT&PTƒêT - Qu·∫£n l√Ω ng∆∞·ªùi d√πng</title>
  <link rel="stylesheet" href="style.css">
  <link rel="icon" type="image/png" href="hutech.png" sizes="32x32">
  <link rel="apple-touch-icon" href="hutech.png">
  <meta name="theme-color" content="#2563eb">
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen p-6">
  <div class="max-w-5xl mx-auto space-y-6">

  <!-- Header -->
  <header class="flex flex-wrap items-center justify-between gap-3">
    <div class="flex items-center gap-3 min-w-0">
      <a href="/ams_home.html" title="V·ªÅ trang ch·ªß" class="flex items-center hover:opacity-80 transition">
        <img src="hutech.png" alt="HUTECH" class="h-8 w-8 object-contain select-none" />
      </a>
      <h1 class="text-2xl font-bold leading-none truncate">QU·∫¢N L√ù NG∆Ø·ªúI D√ôNG</h1>
    </div>

    <div class="flex items-center gap-2 text-sm text-gray-700">
      <span>‚úåÔ∏è Xin ch√†o: <b>{{ me.full_name or me.username }}</b> (<span class="text-gray-500">{{ me.role }}</span>)</span>
      <a class="btn btn-outline" href="/ams_home.html" title="Trang ch·ªß">‚Üê Trang ch·ªß</a>
    </div>
  </header>

  <!-- T·∫°o t√†i kho·∫£n -->
  <section class="card">
    <h2 class="font-semibold mb-3">T·∫°o t√†i kho·∫£n</h2>
    <form class="grid md:grid-cols-6 gap-3" method="post" action="/admin/users/create">
      <div class="md:col-span-2">
        <div class="label">Username</div>
        <input class="input" name="username" placeholder="M√£ Nh√¢n vi√™n" required>
      </div>
      <div class="md:col-span-2">
        <div class="label">H·ªç v√† t√™n</div>
        <input class="input" name="full_name" placeholder="H·ªç t√™n ƒë·∫ßy ƒë·ªß">
      </div>
      <div class="md:col-span-2">
        <div class="label">Ng√†y sinh</div>
        <input class="input" type="date" name="dob" placeholder="dd/mm/yyyy">
      </div>
      <div class="md:col-span-2">
        <div class="label">Email li√™n h·ªá</div>
        <input class="input" type="email" name="email" placeholder="Email n·ªôi b·ªô ho·∫∑c c√° nh√¢n">
      </div>
      <div class="relative md:col-span-2">
        <div class="label">M·∫≠t kh·∫©u (t·ªëi thi·ªÉu 6 k√Ω t·ª±)</div>
        <input id="admin-create-pass" type="password" class="input pr-10" name="password" minlength="6" autocomplete="new-password" required>
        <button type="button" class="absolute inset-y-0 right-2 flex items-center text-gray-500"
                aria-label="Hi·ªán/·∫©n m·∫≠t kh·∫©u" data-toggle-eye="#admin-create-pass">üëÅÔ∏è</button>
      </div>
      <div class="md:col-span-2">
        <div class="label">Ph√¢n quy·ªÅn</div>
        <select class="input" name="role">
          <option value="Admin">Admin</option>
          <option value="NhanVien">Nh√¢n vi√™n</option>
          <option value="CongTacVien">C·ªông t√°c vi√™n</option>
        </select>
      </div>
      <div class="md:col-span-6 flex justify-end">
        <button class="btn btn-primary">T·∫°o t√†i kho·∫£n</button>
      </div>
    </form>
  </section>

  <!-- Danh s√°ch ng∆∞·ªùi d√πng -->
  <section class="card space-y-3">
    <h2 class="font-semibold">Danh s√°ch ng∆∞·ªùi d√πng</h2>
    <div class="overflow-auto">
      <table class="table min-w-full border rounded-xl overflow-hidden">
        <thead>
          <tr>
            <th class="text-center">ID</th>
            <th class="text-left">Username</th>
            <th class="text-left">H·ªç t√™n</th>
            <th class="text-left">Ng√†y sinh</th>
            <th class="text-center">Role</th>
            <th class="text-center">Active</th>
            <th class="text-center">H√†nh ƒë·ªông</th>
          </tr>
        </thead>
        <tbody>
          {% for u in users %}
          <tr class="odd:bg-gray-50">
            <td class="p-2 border-b text-center">{{u.id}}</td>
            <td class="p-2 border-b">{{u.username}}</td>
            <td class="p-2 border-b">{{u.full_name or ""}}</td>
            <td class="p-2 border-b" data-dateonly>{{ u.dob or "‚Äî" }}</td>
            <td class="p-2 border-b text-center">{{u.role}}</td>
            <td class="p-2 border-b text-center">{{ "‚úÖ" if u.is_active else "‚õî" }}</td>
            <td class="p-2 border-b text-center space-x-1">
              <!-- B·∫≠t / T·∫Øt -->
              <form class="inline" method="post" action="/admin/users/toggle" onsubmit="return confirm('X√°c nh·∫≠n ƒë·ªïi tr·∫°ng th√°i t√†i kho·∫£n n√†y?');">
                <input type="hidden" name="user_id" value="{{u.id}}">
                <button class="btn btn-outline btn-xs"
                        {% if u.id == me.id %}disabled title="Kh√¥ng th·ªÉ t·ª± kh√≥a t√†i kho·∫£n c·ªßa b·∫°n"{% endif %}>
                  B·∫≠t/T·∫Øt
                </button>
              </form>

              <!-- S·ª≠a -->
              <button type="button"
                      class="btn btn-outline btn-xs"
                      data-edit='{
                        "id": "{{u.id}}",
                        "username": "{{u.username}}",
                        "full_name": "{{u.full_name or ""}}",
                        "email": "{{u.email or ""}}",
                        "dob": "{{ (u.dob|string)[:10] if u.dob else "" }}",
                        "role": "{{u.role}}",
                        "is_active": "{{ "1" if u.is_active else "0" }}"
                      }'>
                S·ª≠a
              </button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>
  </div>

  <!-- Modal s·ª≠a user (k√®m Reset m·∫≠t kh·∫©u b√™n trong) -->
  <div class="overlay" id="editUserModal">
    <div class="modal">
      <div class="hd">S·ª≠a t√†i kho·∫£n</div>

      <!-- C·∫≠p nh·∫≠t th√¥ng tin c∆° b·∫£n -->
      <form class="bd grid md:grid-cols-6 gap-3" method="post" action="/admin/users/update" id="updateForm">
        <input type="hidden" name="user_id" id="e_id">

        <div class="md:col-span-3">
          <div class="label">Username</div>
          <input class="input" id="e_username" readonly>
        </div>
        <div class="md:col-span-3">
          <div class="label">H·ªç v√† t√™n</div>
          <input class="input" name="full_name" id="e_full_name">
        </div>
        <div class="md:col-span-3">
          <div class="label">Email</div>
          <input class="input" type="email" name="email" id="e_email">
        </div>
        <div class="md:col-span-3">
          <div class="label">Ng√†y sinh</div>
          <input class="input" type="date" name="dob" id="e_dob">
        </div>
        <div class="md:col-span-3">
          <div class="label">Quy·ªÅn</div>
          <select class="input" name="role" id="e_role">
            <option value="Admin">Admin</option>
            <option value="NhanVien">Nh√¢n vi√™n</option>
            <option value="CongTacVien">C·ªông t√°c vi√™n</option>
          </select>
        </div>
        <div class="md:col-span-3">
          <div class="label">Tr·∫°ng th√°i</div>
          <label class="inline-flex items-center gap-2">
            <input type="checkbox" name="is_active" id="e_is_active">
            <span>K√≠ch ho·∫°t</span>
          </label>
        </div>

        <div class="md:col-span-6 flex justify-end gap-2">
          <button type="button" class="btn btn-outline" id="e_cancel">ƒê√≥ng</button>
          <button class="btn btn-primary">L∆∞u thay ƒë·ªïi</button>
        </div>
      </form>

      <!-- NgƒÉn c√°ch -->
      <div class="bd" style="padding-top:0">
        <hr style="border-color:#e5e7eb;margin:8px 0 14px;">
        <h4 class="section-h4">ƒê·∫∑t l·∫°i m·∫≠t kh·∫©u</h4>
        <form class="grid md:grid-cols-6 gap-3" method="post" action="/admin/users/reset-pass" id="resetForm"
              onsubmit="return confirm('X√°c nh·∫≠n ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u ng∆∞·ªùi d√πng n√†y?');">
          <input type="hidden" name="user_id" id="rp_id">
          <div class="md:col-span-4 relative">
            <input id="rp_new" type="password" class="input pr-10"
                   name="new_password" placeholder="M·∫≠t kh·∫©u m·ªõi (‚â•6 k√Ω t·ª±)"
                   minlength="6" autocomplete="new-password" required>
            <button type="button" class="absolute inset-y-0 right-2 flex items-center text-gray-500"
                    data-toggle-eye="#rp_new">üëÅÔ∏è</button>
          </div>
          <div class="md:col-span-2">
            <button class="btn btn-primary w-full">Reset m·∫≠t kh·∫©u</button>
          </div>
          <div class="md:col-span-6 text-muted text-sm">
            Sau khi reset, t√†i kho·∫£n s·∫Ω ƒë∆∞·ª£c y√™u c·∫ßu ƒë·ªïi m·∫≠t kh·∫©u ·ªü l·∫ßn ƒëƒÉng nh·∫≠p ti·∫øp theo.
          </div>
        </form>
      </div>
    </div>
  </div>

<footer class="max-w-6xl mx-auto px-6 pb-4 text-right text-xs text-gray-500">
  ¬© <span class="font-semibold">
    <a href="https://hutech.edu.vn/e-hutech" target="_blank" rel="noopener noreferrer">
      V-HT.PTƒêT HUTECH
    </a>
  </span>
  ‚ûñ Code by:
  <span class="font-semibold">
    <a href="http://zalo.me/tuanconghuynh" target="_blank" rel="noopener noreferrer">
      HC- Tuan
    </a>
  </span>
</footer>

<script>
  // Toggle m·∫Øt
  document.querySelectorAll('[data-toggle-eye]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const input=document.querySelector(btn.getAttribute('data-toggle-eye'));
      if(!input) return;
      input.type=(input.type==='password')?'text':'password';
      btn.textContent=(input.type==='password')?'üëÅÔ∏è':'üôà';
    });
  });

  // ƒê·ªãnh d·∫°ng ng√†y sinh dd/mm/yyyy (VN)
  function formatVNDate(selector) {
    document.querySelectorAll(selector).forEach(el=>{
      const raw=(el.textContent||'').trim();
      if(!raw || raw==='‚Äî') return;
      const m=raw.match(/^(\d{4})-(\d{2})-(\d{2})$/);
      let d;
      if(m){ d=new Date(+m[1],+m[2]-1,+m[3]); }
      else { const t=new Date(raw); if(isNaN(t)) return; d=t; }
      el.textContent=new Intl.DateTimeFormat('vi-VN',{day:'2-digit',month:'2-digit',year:'numeric'}).format(d);
    });
  }
  window.addEventListener('DOMContentLoaded', ()=>{ formatVNDate('[data-dateonly]'); });

  // Modal: m·ªü/ƒë√≥ng + fill d·ªØ li·ªáu
  const modal = document.getElementById('editUserModal');
  document.querySelectorAll('[data-edit]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const data = JSON.parse(btn.getAttribute('data-edit'));
      modal.classList.add('show');
      // Update form
      document.getElementById('e_id').value = data.id || '';
      document.getElementById('e_username').value = data.username || '';
      document.getElementById('e_full_name').value = data.full_name || '';
      document.getElementById('e_email').value = data.email || '';
      document.getElementById('e_dob').value = (data.dob || '').substring(0,10);
      document.getElementById('e_role').value = data.role || 'CongTacVien';
      document.getElementById('e_is_active').checked = data.is_active === "1";
      // Reset form (sync user_id)
      document.getElementById('rp_id').value = data.id || '';
      document.getElementById('rp_new').value = '';
    });
  });
  document.getElementById('e_cancel').addEventListener('click', ()=> modal.classList.remove('show'));
  modal.addEventListener('click', (e)=>{ if(e.target.id==='editUserModal') modal.classList.remove('show'); });

  // Logout (n·∫øu c√≥ n√∫t)
  const btnLogout = document.getElementById('btnLogout');
  if (btnLogout) {
    btnLogout.addEventListener('click', async () => {
      try { await fetch('/api/logout', { method: 'POST' }); } catch(e) {}
      location.href = '/login';
    });
  }
</script>
</body>
</html>
