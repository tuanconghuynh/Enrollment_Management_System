<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>V-HT&PTƒêT - Qu·∫£n l√Ω ng∆∞·ªùi d√πng</title>
  <link rel="stylesheet" href="style.css">
  <link rel="icon" type="image/png" href="hutech.png" sizes="32x32">
  <meta name="theme-color" content="#2563eb">
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen p-6">
  <div class="max-w-5xl mx-auto space-y-6">

  <!-- Header -->
  <header class="flex flex-wrap items-center justify-between gap-3">
    <div class="flex items-center gap-3 min-w-0">
      <a href="/ams_home.html" title="V·ªÅ trang ch·ªß" class="flex items-center hover:opacity-80 transition">
        <img src="hutech.png" alt="HUTECH" class="h-8 w-8 object-contain select-none" />
      </a>
      <h1 class="text-2xl font-bold leading-none truncate">QU·∫¢N L√ù NG∆Ø·ªúI D√ôNG</h1>
    </div>

    <div class="flex items-center gap-2 text-sm text-gray-700">
      <span>‚úåÔ∏è Hi <b>{{ me.full_name or me.username }}</b> (<span class="text-gray-500">{{ me.role }}</span>)</span>
      <a class="btn btn-outline" href="/ams_home.html" title="Trang ch·ªß">‚Üê Trang ch·ªß</a>
    </div>
  </header>

  <!-- T·∫°o t√†i kho·∫£n -->
  <section class="card">
    <h2 class="font-semibold mb-3">T·∫°o t√†i kho·∫£n</h2>
    <form class="grid md:grid-cols-6 gap-3" method="post" action="/admin/users/create">
      <div class="md:col-span-2">
        <div class="label">Username</div>
        <input class="input" name="username" placeholder="M√£ Nh√¢n vi√™n" required>
      </div>
      <div class="md:col-span-2">
        <div class="label">H·ªç v√† t√™n</div>
        <input class="input" name="full_name" placeholder="H·ªç t√™n ƒë·∫ßy ƒë·ªß">
      </div>
      <div class="md:col-span-2">
        <div class="label">Ng√†y sinh</div>
        <input class="input" type="date" name="dob" placeholder="dd/mm/yyyy">
      </div>
      <div class="md:col-span-2">
        <div class="label">Email li√™n h·ªá</div>
        <input class="input" type="email" name="email" placeholder="Email n·ªôi b·ªô ho·∫∑c c√° nh√¢n">
      </div>
      <div class="relative md:col-span-2">
        <div class="label">M·∫≠t kh·∫©u (t·ªëi thi·ªÉu 6 k√Ω t·ª±)</div>
        <input id="admin-create-pass" type="password" class="input pr-10" name="password" minlength="6" autocomplete="new-password" required>
        <button type="button" class="absolute inset-y-0 right-2 flex items-center text-gray-500"
                aria-label="Hi·ªán/·∫©n m·∫≠t kh·∫©u" data-toggle-eye="#admin-create-pass">üëÅÔ∏è</button>
      </div>
      <div class="md:col-span-2">
        <div class="label">Ph√¢n quy·ªÅn</div>
        <select class="input" name="role">
          <option value="Admin">Admin</option>
          <option value="NhanVien">Nh√¢n vi√™n</option>
          <option value="CongTacVien">C·ªông t√°c vi√™n</option>
        </select>
      </div>
      <div class="md:col-span-6 flex justify-end">
        <button class="btn btn-primary">T·∫°o m·ªõi</button>
      </div>
    </form>
  </section>

  <!-- Danh s√°ch ng∆∞·ªùi d√πng -->
  <section class="card space-y-3">
    <h2 class="font-semibold">Danh s√°ch ng∆∞·ªùi d√πng</h2>
    <div class="overflow-auto">
      <table class="table min-w-full border rounded-xl overflow-hidden">
        <thead>
          <tr>
            <th class="text-center">ID</th>
            <th class="text-left">Username</th>
            <th class="text-left">H·ªç t√™n</th>
            <th class="text-left">Ng√†y sinh</th>
            <th class="text-center">Role</th>
            <th class="text-center">Active</th>
            <th class="text-center">H√†nh ƒë·ªông</th>
          </tr>
        </thead>
        <tbody>
          {% for u in users %}
          <tr class="odd:bg-gray-50">
            <td class="p-2 border-b text-center">{{u.id}}</td>
            <td class="p-2 border-b">{{u.username}}</td>
            <td class="p-2 border-b">{{u.full_name or ""}}</td>
            <td class="p-2 border-b" data-dateonly>{{ u.dob or "‚Äî" }}</td>
            <td class="p-2 border-b text-center">{{u.role}}</td>
            <td class="p-2 border-b text-center">{{ "‚úÖ" if u.is_active else "‚õî" }}</td>
            <td class="p-2 border-b text-center space-x-1">
              <!-- B·∫≠t / T·∫Øt -->
              <form class="inline" method="post" action="/admin/users/toggle" onsubmit="return confirm('X√°c nh·∫≠n ƒë·ªïi tr·∫°ng th√°i t√†i kho·∫£n n√†y?');">
                <input type="hidden" name="user_id" value="{{u.id}}">
                <button class="btn btn-outline btn-xs"
                        {% if u.id == me.id %}disabled title="Kh√¥ng th·ªÉ t·ª± kh√≥a t√†i kho·∫£n c·ªßa b·∫°n"{% endif %}>
                  B·∫≠t/T·∫Øt
                </button>
              </form>

              <!-- View (v·∫´n cho ph√©p ch·ªânh s·ª≠a trong modal) -->
              <button type="button"
                class="btn btn-outline btn-xs"
                data-edit='{
                  "id": "{{u.id}}",
                  "username": "{{u.username}}",
                  "full_name": "{{u.full_name or ""}}",
                  "email": "{{u.email or ""}}",
                  "dob": "{{ (u.dob|string)[:10] if u.dob else "" }}",
                  "role": "{{u.role}}",
                  "is_active": "{{ "1" if u.is_active else "0" }}",
                  "last_login_at": "{{u.last_login_at or ""}}",
                  "password_changed_at": "{{u.password_changed_at or ""}}"
                }'>
                View üëÅÔ∏è‚Äçüó®Ô∏è
              </button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>
  </div>

  <!-- Modal xem/ch·ªânh s·ª≠a user -->
  <div class="overlay" id="editUserModal">
    <div class="modal">
      <div class="hd">Chi ti·∫øt & ch·ªânh s·ª≠a t√†i kho·∫£n</div>

      <form class="bd grid md:grid-cols-6 gap-3" method="post" action="/admin/users/update" id="updateForm">
        <input type="hidden" name="user_id" id="e_id">

        <div class="md:col-span-3">
          <div class="label">Username</div>
          <input class="input" id="e_username" readonly>
        </div>
        <div class="md:col-span-3">
          <div class="label">H·ªç v√† t√™n</div>
          <input class="input" name="full_name" id="e_full_name">
        </div>
        <div class="md:col-span-3">
          <div class="label">Email</div>
          <input class="input" type="email" name="email" id="e_email">
        </div>
        <div class="md:col-span-3">
          <div class="label">Ng√†y sinh</div>
          <input class="input" type="date" name="dob" id="e_dob">
        </div>
        <div class="md:col-span-3">
          <div class="label">Quy·ªÅn</div>
          <select class="input" name="role" id="e_role">
            <option value="Admin">Admin</option>
            <option value="NhanVien">Nh√¢n vi√™n</option>
            <option value="CongTacVien">C·ªông t√°c vi√™n</option>
          </select>
        </div>
        <div class="md:col-span-3">
          <div class="label">Tr·∫°ng th√°i</div>
          <label class="inline-flex items-center gap-2">
            <input type="checkbox" name="is_active" id="e_is_active">
            <span>K√≠ch ho·∫°t</span>
          </label>
        </div>

        <!-- Th√¥ng tin th·ªùi gian -->
        <div class="md:col-span-3">
          <div class="label">L·∫ßn ƒëƒÉng nh·∫≠p g·∫ßn nh·∫•t</div>
          <input class="input bg-gray-100" id="e_last_login" readonly>
        </div>
        <div class="md:col-span-3">
          <div class="label">Th·ªùi ƒëi·ªÉm ƒë·ªïi m·∫≠t kh·∫©u</div>
          <input class="input bg-gray-100" id="e_pw_changed" readonly>
        </div>

        <div class="md:col-span-6 flex justify-end gap-2">
          <button type="button" class="btn btn-outline" id="e_cancel">ƒê√≥ng</button>
          <button class="btn btn-primary">L∆∞u thay ƒë·ªïi</button>
        </div>
      </form>

      <!-- Reset m·∫≠t kh·∫©u -->
      <div class="bd" style="padding-top:0">
        <hr style="border-color:#e5e7eb;margin:8px 0 14px;">
        <h4 class="section-h4">ƒê·∫∑t l·∫°i m·∫≠t kh·∫©u</h4>
        <form class="grid md:grid-cols-6 gap-3" method="post" action="/admin/users/reset-pass" id="resetForm"
              onsubmit="return confirm('X√°c nh·∫≠n ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u ng∆∞·ªùi d√πng n√†y?');">
          <input type="hidden" name="user_id" id="rp_id">
          <div class="md:col-span-4 relative">
            <input id="rp_new" type="password" class="input pr-10"
                   name="new_password" placeholder="M·∫≠t kh·∫©u m·ªõi (‚â•6 k√Ω t·ª±)"
                   minlength="6" autocomplete="new-password" required>
            <button type="button" class="absolute inset-y-0 right-2 flex items-center text-gray-500"
                    data-toggle-eye="#rp_new">üëÅÔ∏è</button>
          </div>
          <div class="md:col-span-2">
            <button class="btn btn-primary w-full">Reset m·∫≠t kh·∫©u</button>
          </div>
          <div class="md:col-span-6 text-muted text-sm">
            Sau khi reset, t√†i kho·∫£n s·∫Ω ƒë∆∞·ª£c y√™u c·∫ßu ƒë·ªïi m·∫≠t kh·∫©u ·ªü l·∫ßn ƒëƒÉng nh·∫≠p ti·∫øp theo.
          </div>
        </form>
      </div>
    </div>
  </div>

<footer class="max-w-6xl mx-auto px-6 pb-4 text-right text-xs text-gray-500">
  ¬© <span class="font-semibold"><a href="https://hutech.edu.vn/e-hutech" target="_blank" rel="noopener noreferrer">V-HT.PTƒêT HUTECH</a></span> ‚ûñ Code by: <span class="font-semibold"><a href="http://zalo.me/tuanconghuynh" target="_blank" rel="noopener noreferrer">HC- Tuan</a></span>
</footer>

<script>
/* ========= Helpers format th·ªùi gian theo VN (+07:00) ========= */
// Parse an to√†n: n·∫øu chu·ªói kh√¥ng c√≥ timezone ‚Üí coi l√† UTC
function parseToDate(raw) {
  if (!raw) return null;
  let s = String(raw).trim();
  if (/^\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}:\d{2}/.test(s)) s = s.replace(' ', 'T');
  const m = s.match(/^(\d{4})-(\d{2})-(\d{2})(?:[T ](\d{2}):(\d{2}):(\d{2})(?:\.(\d+))?)?(Z|[+\-]\d{2}:?\d{2})?$/);
  if (m) {
    const [_, Y, M, D, h='00', mi='00', se='00', ms='0', tz] = m;
    if (!tz) return new Date(Date.UTC(+Y, +M-1, +D, +h, +mi, +se, +ms));
    return new Date(s);
  }
  const d = new Date(s);
  return isNaN(d) ? null : d;
}

function toVNDateText(raw) {
  if (!raw) return '‚Äî';
  const onlyDate = String(raw).match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if (onlyDate) {
    const d = new Date(Date.UTC(+onlyDate[1], +onlyDate[2]-1, +onlyDate[3]));
    return new Intl.DateTimeFormat('vi-VN', {
      timeZone: 'Asia/Ho_Chi_Minh',
      day:'2-digit', month:'2-digit', year:'numeric'
    }).format(d);
  }
  const d = parseToDate(raw);
  if (!d) return raw;
  return new Intl.DateTimeFormat('vi-VN', {
    timeZone: 'Asia/Ho_Chi_Minh',
    day:'2-digit', month:'2-digit', year:'numeric'
  }).format(d);
}

function toVNDateTimeText(raw) {
  if (!raw) return '‚Äî';
  const d = parseToDate(raw);
  if (!d) return raw;
  return new Intl.DateTimeFormat('vi-VN', {
    timeZone: 'Asia/Ho_Chi_Minh',
    day:'2-digit', month:'2-digit', year:'numeric',
    hour:'2-digit', minute:'2-digit', second:'2-digit'
  }).format(d).replace(',', '');
}

function formatVNDate(selector='[data-dateonly]') {
  document.querySelectorAll(selector).forEach(el => {
    const raw = (el.textContent || '').trim();
    if (!raw || raw === '‚Äî') return;
    el.textContent = toVNDateText(raw);
  });
}

/* ========= Toggle hi·ªán/·∫©n m·∫≠t kh·∫©u ========= */
document.querySelectorAll('[data-toggle-eye]').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const input = document.querySelector(btn.getAttribute('data-toggle-eye'));
    if (!input) return;
    input.type = (input.type === 'password') ? 'text' : 'password';
    btn.textContent = (input.type === 'password') ? 'üëÅÔ∏è' : 'üôà';
  });
});

/* ========= Modal View (v·∫´n cho ch·ªânh s·ª≠a) ========= */
function boolLikeTrue(v){
  return v === true || v === 1 || v === '1' || String(v).toLowerCase() === 'true';
}
function safeSubDate(s){ return (s||'').substring(0,10); }

const modal = document.getElementById('editUserModal');
document.querySelectorAll('[data-edit]').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const data = JSON.parse(btn.getAttribute('data-edit'));
    modal.classList.add('show');

    document.getElementById('e_id').value = data.id || '';
    document.getElementById('e_username').value = data.username || '';
    document.getElementById('e_full_name').value = data.full_name || '';
    document.getElementById('e_email').value = data.email || '';
    document.getElementById('e_dob').value = safeSubDate(data.dob);
    document.getElementById('e_role').value = data.role || 'CongTacVien';
    document.getElementById('e_is_active').checked = boolLikeTrue(data.is_active);

    // Hai tr∆∞·ªùng th·ªùi gian hi·ªÉn th·ªã theo VN
    document.getElementById('e_last_login').value = toVNDateTimeText(data.last_login_at);
    document.getElementById('e_pw_changed').value = toVNDateTimeText(data.password_changed_at);

    // Reset form reset-pass
    document.getElementById('rp_id').value = data.id || '';
    document.getElementById('rp_new').value = '';
  });
});

document.getElementById('e_cancel').addEventListener('click',()=> modal.classList.remove('show'));
modal.addEventListener('click',e=>{ if(e.target.id==='editUserModal') modal.classList.remove('show'); });

/* ========= Boot: format c·ªôt ng√†y sinh trong b·∫£ng ========= */
window.addEventListener('DOMContentLoaded', () => {
  formatVNDate('[data-dateonly]');
});

(function () {
  // ∆Øu ti√™n query expired=1 (khi b·ªã redirect)
  const params = new URLSearchParams(location.search);
  const byQuery = params.get('expired') === '1';

  // Ho·∫∑c cookie c·ªù do BE set
  const byCookie = document.cookie.split(';').some(c => c.trim().startsWith('__session_expired=1'));

  if (byQuery || byCookie) {
    // Hi·ªán th√¥ng b√°o r·ªông r√£i
    if (typeof showToast === 'function') {
      showToast('Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n, vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.', 'warn', 4500);
    } else {
      // Fallback n·∫øu trang kh√¥ng c√≥ showToast
      alert('Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n, vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.');
    }
    // X√≥a cookie c·ªù ƒë·ªÉ kh·ªèi l·∫∑p l·∫°i
    document.cookie = '__session_expired=; Max-Age=0; Path=/; SameSite=Lax';
  }
})();

// ===== Toast helper =====
function showToast(msg, type='info', ms=3000){
  const wrap = document.getElementById('toast-wrap'); if(!wrap) return alert(msg);
  const el = document.createElement('div');
  el.className = `toast ${type}`;
  el.textContent = String(msg);
  wrap.appendChild(el);
  requestAnimationFrame(()=> el.classList.add('show'));
  const timer = setTimeout(()=>{ el.classList.remove('show'); el.addEventListener('transitionend',()=>el.remove(),{once:true}); }, ms);
  el.addEventListener('click', ()=>{ clearTimeout(timer); el.classList.remove('show'); el.addEventListener('transitionend',()=>el.remove(),{once:true}); });
}

// ===== B·∫Øt submit form t·∫°o user ƒë·ªÉ hi·ªÉn th·ªã noti ƒë·∫πp =====
(function(){
  const form = document.querySelector('form[action="/admin/users/create"][method="post"]');
  if(!form) return;

  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const btn = form.querySelector('button[type="submit"], .btn.btn-primary');
    const old = btn ? btn.innerHTML : null;
    if(btn){ btn.disabled = true; btn.innerHTML = 'ƒêang t·∫°o‚Ä¶'; }

    try{
      const fd = new FormData(form);
      const r = await fetch('/admin/users/create', { method:'POST', body: fd, credentials:'include' });

      // Th·ª≠ ƒë·ªçc JSON n·∫øu c√≥
      const ct = r.headers.get('content-type')||'';
      let payload = null;
      if (ct.includes('application/json')) {
        try { payload = await r.json(); } catch {}
      } else {
        // Fallback text (BE c√≥ th·ªÉ tr·∫£ string)
        try { const t = await r.text(); payload = t ? JSON.parse(t) : null; } catch {}
      }

      if (r.ok) {
        showToast('T·∫°o t√†i kho·∫£n th√†nh c√¥ng ‚úÖ', 'success', 2200);
        // Xo√° form/refresh danh s√°ch:
        form.reset();
        // Reload nh·∫π ƒë·ªÉ b·∫£ng c·∫≠p nh·∫≠t:
        setTimeout(()=> location.reload(), 900);
        return;
      }

      // C√°c case l·ªói th∆∞·ªùng g·∫∑p
      const msg = (payload && (payload.detail || payload.message)) 
                  || (r.status===409 ? 'Username/Email ƒë√£ t·ªìn t·∫°i' : '')
                  || `L·ªói t·∫°o t√†i kho·∫£n (HTTP ${r.status})`;
      showToast(msg, 'error', 4000);
    } catch (err){
      showToast('Kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c m√°y ch·ªß. Vui l√≤ng th·ª≠ l·∫°i.', 'error', 3500);
    } finally{
      if(btn){ btn.disabled = false; btn.innerHTML = old || 'T·∫°o m·ªõi'; }
    }
  });
})();
// ===== B·∫Øt s·ª± ki·ªán L∆∞u thay ƒë·ªïi trong modal ch·ªânh s·ª≠a =====
(function(){
  const form = document.getElementById('updateForm');
  if (!form) return;

  form.addEventListener('submit', async (e)=>{
    e.preventDefault();

    const btn = form.querySelector('button.btn.btn-primary');
    const old = btn?.innerHTML;
    if (btn) { btn.disabled = true; btn.innerHTML = 'ƒêang l∆∞u...'; }

    try {
      const fd = new FormData(form);
      const r = await fetch(form.action, { method: 'POST', body: fd, credentials: 'include' });

      const ct = r.headers.get('content-type') || '';
      let data = null;
      if (ct.includes('application/json')) {
        try { data = await r.json(); } catch {}
      } else {
        try { const t = await r.text(); data = t ? JSON.parse(t) : null; } catch {}
      }

      if (r.ok) {
        showToast('C·∫≠p nh·∫≠t th√†nh c√¥ng ‚úÖ', 'success', 2500);
        // ·∫®n modal & reload danh s√°ch nh·∫π
        document.getElementById('editUserModal')?.classList.remove('show');
        setTimeout(()=> location.reload(), 1000);
        return;
      }

      const msg = (data && (data.detail || data.message)) || `L·ªói c·∫≠p nh·∫≠t (HTTP ${r.status})`;
      showToast(msg, 'error', 4000);
    } catch (err) {
      console.error(err);
      showToast('Kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c m√°y ch·ªß. Vui l√≤ng th·ª≠ l·∫°i.', 'error', 4000);
    } finally {
      if (btn) { btn.disabled = false; btn.innerHTML = old || 'L∆∞u thay ƒë·ªïi'; }
    }
  });
})();
</script>
</body>
</html>
