<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>V-HT&PTÄT - Quáº£n lÃ½ ngÆ°á»i dÃ¹ng</title>
  <link rel="stylesheet" href="style.css">
  <link rel="icon" type="image/png" href="hutech.png" sizes="32x32">
  <meta name="theme-color" content="#2563eb">
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen p-6">
  <div class="max-w-5xl mx-auto space-y-6">

  <!-- Header -->
  <header class="flex flex-wrap items-center justify-between gap-3">
    <div class="flex items-center gap-3 min-w-0">
      <a href="/ams_home.html" title="Vá» trang chá»§" class="flex items-center hover:opacity-80 transition">
        <img src="hutech.png" alt="HUTECH" class="h-8 w-8 object-contain select-none" />
      </a>
      <h1 class="text-2xl font-bold leading-none truncate">QUáº¢N LÃ NGÆ¯á»œI DÃ™NG</h1>
    </div>

    <div class="flex items-center gap-2 text-sm text-gray-700">
      <span>âœŒï¸ Hi <b>{{ me.full_name or me.username }}</b> (<span class="text-gray-500">{{ me.role }}</span>)</span>
      <a class="btn btn-outline" href="/ams_home.html" title="Trang chá»§">â† Trang chá»§</a>
    </div>
  </header>

  <!-- Táº¡o tÃ i khoáº£n -->
  <section class="card">
    <h2 class="font-semibold mb-3">Táº¡o tÃ i khoáº£n</h2>
    <form class="grid md:grid-cols-6 gap-3" method="post" action="/admin/users/create">
      <div class="md:col-span-2">
        <div class="label">Username</div>
        <input class="input" name="username" placeholder="MÃ£ NhÃ¢n viÃªn" required>
      </div>
      <div class="md:col-span-2">
        <div class="label">Há» vÃ  tÃªn</div>
        <input class="input" name="full_name" placeholder="Há» tÃªn Ä‘áº§y Ä‘á»§">
      </div>
      <div class="md:col-span-2">
        <div class="label">NgÃ y sinh</div>
        <input class="input" type="date" name="dob" placeholder="dd/mm/yyyy">
      </div>
      <div class="md:col-span-2">
        <div class="label">Email liÃªn há»‡</div>
        <input class="input" type="email" name="email" placeholder="Email ná»™i bá»™ hoáº·c cÃ¡ nhÃ¢n">
      </div>
      <div class="relative md:col-span-2">
        <div class="label">Máº­t kháº©u (tá»‘i thiá»ƒu 6 kÃ½ tá»±)</div>
        <input id="admin-create-pass" type="password" class="input pr-10" name="password" minlength="6" autocomplete="new-password" required>
        <button type="button" class="absolute inset-y-0 right-2 flex items-center text-gray-500"
                aria-label="Hiá»‡n/áº©n máº­t kháº©u" data-toggle-eye="#admin-create-pass">ğŸ‘ï¸</button>
      </div>
      <div class="md:col-span-2">
        <div class="label">PhÃ¢n quyá»n</div>
        <select class="input" name="role">
          <option value="Admin">Admin</option>
          <option value="NhanVien">NhÃ¢n viÃªn</option>
          <option value="CongTacVien">Cá»™ng tÃ¡c viÃªn</option>
        </select>
      </div>
      <div class="md:col-span-6 flex justify-end">
        <button class="btn btn-primary">Táº¡o má»›i</button>
      </div>
    </form>
  </section>

  <!-- Danh sÃ¡ch ngÆ°á»i dÃ¹ng -->
  <section class="card space-y-3">
    <h2 class="font-semibold">Danh sÃ¡ch ngÆ°á»i dÃ¹ng</h2>
    <div class="overflow-auto">
      <table class="table min-w-full border rounded-xl overflow-hidden">
        <thead>
          <tr>
            <th class="text-center">ID</th>
            <th class="text-left">Username</th>
            <th class="text-left">Há» tÃªn</th>
            <th class="text-left">NgÃ y sinh</th>
            <th class="text-center">Role</th>
            <th class="text-center">Active</th>
            <th class="text-center">HÃ nh Ä‘á»™ng</th>
          </tr>
        </thead>
        <tbody>
          {% for u in users %}
          <tr class="odd:bg-gray-50">
            <td class="p-2 border-b text-center">{{u.id}}</td>
            <td class="p-2 border-b">{{u.username}}</td>
            <td class="p-2 border-b">{{u.full_name or ""}}</td>
            <td class="p-2 border-b" data-dateonly>{{ u.dob or "â€”" }}</td>
            <td class="p-2 border-b text-center">{{u.role}}</td>
            <td class="p-2 border-b text-center">{{ "âœ…" if u.is_active else "â›”" }}</td>
            <td class="p-2 border-b text-center space-x-1">
              <!-- Báº­t / Táº¯t -->
              <form class="inline" method="post" action="/admin/users/toggle" onsubmit="return confirm('XÃ¡c nháº­n Ä‘á»•i tráº¡ng thÃ¡i tÃ i khoáº£n nÃ y?');">
                <input type="hidden" name="user_id" value="{{u.id}}">
                <button class="btn btn-outline btn-xs"
                        {% if u.id == me.id %}disabled title="KhÃ´ng thá»ƒ tá»± khÃ³a tÃ i khoáº£n cá»§a báº¡n"{% endif %}>
                  Báº­t/Táº¯t
                </button>
              </form>

              <!-- View (váº«n cho phÃ©p chá»‰nh sá»­a trong modal) -->
              <button type="button"
                class="btn btn-outline btn-xs"
                data-edit='{
                  "id": "{{u.id}}",
                  "username": "{{u.username}}",
                  "full_name": "{{u.full_name or ""}}",
                  "email": "{{u.email or ""}}",
                  "dob": "{{ (u.dob|string)[:10] if u.dob else "" }}",
                  "role": "{{u.role}}",
                  "is_active": "{{ "1" if u.is_active else "0" }}",
                  "last_login_at": "{{u.last_login_at or ""}}",
                  "password_changed_at": "{{u.password_changed_at or ""}}"
                }'>
                View ğŸ‘ï¸â€ğŸ—¨ï¸
              </button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>
  </div>

  <!-- Modal xem/chá»‰nh sá»­a user -->
  <div class="overlay" id="editUserModal">
    <div class="modal">
      <div class="hd">Chi tiáº¿t & chá»‰nh sá»­a tÃ i khoáº£n</div>

      <form class="bd grid md:grid-cols-6 gap-3" method="post" action="/admin/users/update" id="updateForm">
        <input type="hidden" name="user_id" id="e_id">

        <div class="md:col-span-3">
          <div class="label">Username</div>
          <input class="input" id="e_username" readonly>
        </div>
        <div class="md:col-span-3">
          <div class="label">Há» vÃ  tÃªn</div>
          <input class="input" name="full_name" id="e_full_name">
        </div>
        <div class="md:col-span-3">
          <div class="label">Email</div>
          <input class="input" type="email" name="email" id="e_email">
        </div>
        <div class="md:col-span-3">
          <div class="label">NgÃ y sinh</div>
          <input class="input" type="date" name="dob" id="e_dob">
        </div>
        <div class="md:col-span-3">
          <div class="label">Quyá»n</div>
          <select class="input" name="role" id="e_role">
            <option value="Admin">Admin</option>
            <option value="NhanVien">NhÃ¢n viÃªn</option>
            <option value="CongTacVien">Cá»™ng tÃ¡c viÃªn</option>
          </select>
        </div>
        <div class="md:col-span-3">
          <div class="label">Tráº¡ng thÃ¡i</div>
          <label class="inline-flex items-center gap-2">
            <input type="checkbox" name="is_active" id="e_is_active">
            <span>KÃ­ch hoáº¡t</span>
          </label>
        </div>

        <!-- ThÃ´ng tin thá»i gian -->
        <div class="md:col-span-3">
          <div class="label">Láº§n Ä‘Äƒng nháº­p gáº§n nháº¥t</div>
          <input class="input bg-gray-100" id="e_last_login" readonly>
        </div>
        <div class="md:col-span-3">
          <div class="label">Thá»i Ä‘iá»ƒm Ä‘á»•i máº­t kháº©u</div>
          <input class="input bg-gray-100" id="e_pw_changed" readonly>
        </div>

        <div class="md:col-span-6 flex justify-end gap-2">
          <button type="button" class="btn btn-outline" id="e_cancel">ÄÃ³ng</button>
          <button class="btn btn-primary">LÆ°u thay Ä‘á»•i</button>
        </div>
      </form>

      <!-- Reset máº­t kháº©u -->
      <div class="bd" style="padding-top:0">
        <hr style="border-color:#e5e7eb;margin:8px 0 14px;">
        <h4 class="section-h4">Äáº·t láº¡i máº­t kháº©u</h4>
        <form class="grid md:grid-cols-6 gap-3" method="post" action="/admin/users/reset-pass" id="resetForm"
              onsubmit="return confirm('XÃ¡c nháº­n Ä‘áº·t láº¡i máº­t kháº©u ngÆ°á»i dÃ¹ng nÃ y?');">
          <input type="hidden" name="user_id" id="rp_id">
          <div class="md:col-span-4 relative">
            <input id="rp_new" type="password" class="input pr-10"
                   name="new_password" placeholder="Máº­t kháº©u má»›i (â‰¥6 kÃ½ tá»±)"
                   minlength="6" autocomplete="new-password" required>
            <button type="button" class="absolute inset-y-0 right-2 flex items-center text-gray-500"
                    data-toggle-eye="#rp_new">ğŸ‘ï¸</button>
          </div>
          <div class="md:col-span-2">
            <button class="btn btn-primary w-full">Reset máº­t kháº©u</button>
          </div>
          <div class="md:col-span-6 text-muted text-sm">
            Sau khi reset, tÃ i khoáº£n sáº½ Ä‘Æ°á»£c yÃªu cáº§u Ä‘á»•i máº­t kháº©u á»Ÿ láº§n Ä‘Äƒng nháº­p tiáº¿p theo.
          </div>
        </form>
      </div>
    </div>
  </div>

<footer class="max-w-6xl mx-auto px-6 pb-4 text-right text-xs text-gray-500">
  Â© <span class="font-semibold"><a href="https://hutech.edu.vn/e-hutech" target="_blank" rel="noopener noreferrer">V-HT.PTÄT HUTECH</a></span> â– Code by: <span class="font-semibold"><a href="http://zalo.me/tuanconghuynh" target="_blank" rel="noopener noreferrer">HC- Tuan</a></span>
</footer>

<script>
/* ========= Helpers format thá»i gian theo VN (+07:00) ========= */
// Parse an toÃ n: náº¿u chuá»—i khÃ´ng cÃ³ timezone â†’ coi lÃ  UTC
function parseToDate(raw) {
  if (!raw) return null;
  let s = String(raw).trim();
  if (/^\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}:\d{2}/.test(s)) s = s.replace(' ', 'T');
  const m = s.match(/^(\d{4})-(\d{2})-(\d{2})(?:[T ](\d{2}):(\d{2}):(\d{2})(?:\.(\d+))?)?(Z|[+\-]\d{2}:?\d{2})?$/);
  if (m) {
    const [_, Y, M, D, h='00', mi='00', se='00', ms='0', tz] = m;
    if (!tz) return new Date(Date.UTC(+Y, +M-1, +D, +h, +mi, +se, +ms));
    return new Date(s);
  }
  const d = new Date(s);
  return isNaN(d) ? null : d;
}

function toVNDateText(raw) {
  if (!raw) return 'â€”';
  const onlyDate = String(raw).match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if (onlyDate) {
    const d = new Date(Date.UTC(+onlyDate[1], +onlyDate[2]-1, +onlyDate[3]));
    return new Intl.DateTimeFormat('vi-VN', {
      timeZone: 'Asia/Ho_Chi_Minh',
      day:'2-digit', month:'2-digit', year:'numeric'
    }).format(d);
  }
  const d = parseToDate(raw);
  if (!d) return raw;
  return new Intl.DateTimeFormat('vi-VN', {
    timeZone: 'Asia/Ho_Chi_Minh',
    day:'2-digit', month:'2-digit', year:'numeric'
  }).format(d);
}

function toVNDateTimeText(raw) {
  if (!raw) return 'â€”';
  const d = parseToDate(raw);
  if (!d) return raw;
  return new Intl.DateTimeFormat('vi-VN', {
    timeZone: 'Asia/Ho_Chi_Minh',
    day:'2-digit', month:'2-digit', year:'numeric',
    hour:'2-digit', minute:'2-digit', second:'2-digit'
  }).format(d).replace(',', '');
}

function formatVNDate(selector='[data-dateonly]') {
  document.querySelectorAll(selector).forEach(el => {
    const raw = (el.textContent || '').trim();
    if (!raw || raw === 'â€”') return;
    el.textContent = toVNDateText(raw);
  });
}

/* ========= Toggle hiá»‡n/áº©n máº­t kháº©u ========= */
document.querySelectorAll('[data-toggle-eye]').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const input = document.querySelector(btn.getAttribute('data-toggle-eye'));
    if (!input) return;
    input.type = (input.type === 'password') ? 'text' : 'password';
    btn.textContent = (input.type === 'password') ? 'ğŸ‘ï¸' : 'ğŸ™ˆ';
  });
});

/* ========= Modal View (váº«n cho chá»‰nh sá»­a) ========= */
function boolLikeTrue(v){
  return v === true || v === 1 || v === '1' || String(v).toLowerCase() === 'true';
}
function safeSubDate(s){ return (s||'').substring(0,10); }

const modal = document.getElementById('editUserModal');
document.querySelectorAll('[data-edit]').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const data = JSON.parse(btn.getAttribute('data-edit'));
    modal.classList.add('show');

    document.getElementById('e_id').value = data.id || '';
    document.getElementById('e_username').value = data.username || '';
    document.getElementById('e_full_name').value = data.full_name || '';
    document.getElementById('e_email').value = data.email || '';
    document.getElementById('e_dob').value = safeSubDate(data.dob);
    document.getElementById('e_role').value = data.role || 'CongTacVien';
    document.getElementById('e_is_active').checked = boolLikeTrue(data.is_active);

    // Hai trÆ°á»ng thá»i gian hiá»ƒn thá»‹ theo VN
    document.getElementById('e_last_login').value = toVNDateTimeText(data.last_login_at);
    document.getElementById('e_pw_changed').value = toVNDateTimeText(data.password_changed_at);

    // Reset form reset-pass
    document.getElementById('rp_id').value = data.id || '';
    document.getElementById('rp_new').value = '';
  });
});

document.getElementById('e_cancel').addEventListener('click',()=> modal.classList.remove('show'));
modal.addEventListener('click',e=>{ if(e.target.id==='editUserModal') modal.classList.remove('show'); });

/* ========= Boot: format cá»™t ngÃ y sinh trong báº£ng ========= */
window.addEventListener('DOMContentLoaded', () => {
  formatVNDate('[data-dateonly]');
});

(function () {
  // Æ¯u tiÃªn query expired=1 (khi bá»‹ redirect)
  const params = new URLSearchParams(location.search);
  const byQuery = params.get('expired') === '1';

  // Hoáº·c cookie cá» do BE set
  const byCookie = document.cookie.split(';').some(c => c.trim().startsWith('__session_expired=1'));

  if (byQuery || byCookie) {
    // Hiá»‡n thÃ´ng bÃ¡o rá»™ng rÃ£i
    if (typeof showToast === 'function') {
      showToast('PhiÃªn Ä‘Äƒng nháº­p Ä‘Ã£ háº¿t háº¡n, vui lÃ²ng Ä‘Äƒng nháº­p láº¡i.', 'warn', 4500);
    } else {
      // Fallback náº¿u trang khÃ´ng cÃ³ showToast
      alert('PhiÃªn Ä‘Äƒng nháº­p Ä‘Ã£ háº¿t háº¡n, vui lÃ²ng Ä‘Äƒng nháº­p láº¡i.');
    }
    // XÃ³a cookie cá» Ä‘á»ƒ khá»i láº·p láº¡i
    document.cookie = '__session_expired=; Max-Age=0; Path=/; SameSite=Lax';
  }
})();
</script>
</body>
</html>
