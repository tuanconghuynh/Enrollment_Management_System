<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Danh s√°ch h·ªì s∆° | Admission Check</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
    .card { background:#fff; border-radius:1rem; box-shadow:0 15px 30px rgba(2,6,23,.06); padding:1.25rem; }
    .input { width:100%; border:1px solid #e5e7eb; border-radius:.75rem; padding:.6rem .85rem; outline:none; background:#fff; }
    .input:focus { box-shadow:0 0 0 3px rgba(59,130,246,.25); border-color:#93c5fd; }
    .btn { padding:.55rem 1rem; border-radius:.75rem; box-shadow:0 1px 2px rgba(0,0,0,.06); font-weight:600; transition: transform .05s ease; }
    .btn:hover { transform: translateY(-1px); }
    .btn[disabled] { opacity:.6; cursor:not-allowed; transform:none; }
    .btn-primary { background:#1d4ed8; color:#fff; }
    .btn-outline { background:#fff; border:1px solid #d1d5db; }
    .btn-soft { background:#eff6ff; color:#1e3a8a; }
    .btn-xs { padding:.25rem .5rem; border-radius:.5rem; font-size:.75rem; }
    .btn-pill { border-radius:999px; }
    .table { width:100%; border-collapse: separate; border-spacing:0; }
    .table th, .table td { border-bottom:1px solid #e5e7eb; padding:.6rem .75rem; }
    .table thead th { background:#f8fafc; font-weight:700; position:sticky; top:0; z-index:1; user-select:none; }
    .row-alt:nth-child(odd) td { background:#fafafa; }
    .badge { display:inline-block; padding:.1rem .5rem; border-radius:.5rem; background:#eef2ff; color:#3730a3; font-size:.75rem; }
    .text-muted { color:#9ca3af; }
    .th-sortable { cursor:pointer; }
    .th-sortable .arrow { opacity:.4; margin-left:.25rem; }
    .th-sortable.active .arrow { opacity:1; }
    /* Modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(15,23,42,.45);display:none;align-items:center;justify-content:center;z-index:50}
    .modal{background:#fff;border-radius:1rem;box-shadow:0 30px 60px rgba(0,0,0,.3);max-width:720px;width:calc(100% - 2rem)}
  </style>
  <link rel="icon" type="image/png" href="hutech.png" sizes="32x32">
  <link rel="apple-touch-icon" href="hutech.png">
  <meta name="theme-color" content="#2563eb">
</head>
<body class="bg-gray-50">
  <div class="max-w-7xl mx-auto p-6 space-y-6">
    <!-- Header -->
    <header class="flex flex-wrap gap-3 items-center justify-between">
      <div class="min-w-0">
        <h1 class="text-2xl font-bold leading-tight">Danh s√°ch h·ªì s∆°</h1>
        <p class="text-sm text-gray-500">Tra c·ª©u nhanh & thao t√°c in/xu·∫•t.</p>
      </div>
      <div class="flex items-center gap-2">
        <label class="text-sm text-gray-500">API Base</label>
        <input id="apiBase" class="input w-52 md:w-72" placeholder="http://192.168.2.82:8000" />
        <span class="hidden md:inline-block w-px h-6 bg-gray-200"></span>

        <!-- User status -->
        <div id="userBox" class="text-sm text-gray-600 flex items-center gap-2">
          <span id="meText" class="hidden">
           ‚úåÔ∏è Xin ch√†o: <b id="meName"></b> (<span id="meRole"></span>)
          </span>
          <a id="loginLink" href="/login" class="btn btn-outline">ƒêƒÉng nh·∫≠p</a>
          <button id="btnLogout" class="btn btn-outline hidden">ƒêƒÉng xu·∫•t</button>
        </div>

        <a class="btn btn-outline" href="/" title="Trang ch√≠nh">‚Üê Trang ch√≠nh</a>
      </div>
    </header>

    <!-- Toolbar -->
    <section class="card space-y-4">
      <!-- H√†ng 1: T√¨m ki·∫øm + L·ªçc ƒë·ª£t/kh√≥a -->
      <div class="grid grid-cols-1 xl:grid-cols-3 gap-3 items-end">
        <!-- √î t√¨m chung -->
        <div class="xl:col-span-2">
          <div class="flex items-center gap-2">
            <div class="relative flex-1 min-w-[240px]">
              <input id="q" class="input w-full pl-10" placeholder="Nh·∫≠p h·ªç t√™n ho·∫∑c MSHV..." />
              <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">üîé</span>
            </div>
            <div class="grid grid-cols-2 gap-2">
              <input id="filterDot"  class="input" placeholder="L·ªçc theo ƒê·ª£t"  title="VD: 1 ho·∫∑c 1/2025" />
              <input id="filterKhoa" class="input" placeholder="L·ªçc theo Kh√≥a" title="VD: 27" />
            </div>
            <button id="btnSearch" class="btn btn-outline shrink-0">üîé T√¨m</button>
          </div>
        </div>
      </div>
      <h2 class="font-bold">IN / XU·∫§T D·ªÆ LI·ªÜU</h2>
      <!-- H√†ng 2: Theo ng√†y + Theo ƒë·ª£t -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <!-- Theo ng√†y -->
        <div class="flex flex-wrap items-center gap-2 min-w-0">
          <input id="day" type="date" class="input w-36 sm:w-40 md:w-44 lg:w-48 flex-none" />
          <button id="btnExportDay" class="btn btn-outline shrink-0" title="Xu·∫•t Excel theo ng√†y">‚¨áÔ∏è Excel</button>
          <button id="btnPrintDay"  class="btn btn-primary shrink-0" title="In PDF g·ªôp theo ng√†y">üñ®Ô∏è PDF</button>
          <p class="w-full text-xs text-gray-500">G·ª≠i in theo ng√†y nh·∫≠n h·ªì s∆°.</p>
        </div>

        <!-- Theo ƒë·ª£t (+Kh√≥a) server-side -->
        <div class="flex flex-wrap items-center gap-2 min-w-0">
          <input id="dot" class="input w-24 sm:w-28 md:w-32 flex-none" placeholder="Nh·∫≠p t√™n ƒë·ª£t" title="VD: 1" />
          <input id="dotKhoa" class="input w-24 sm:w-28 md:w-32 flex-none" placeholder="Nh·∫≠p Kh√≥a" title="VD: 25" />
          <button id="btnExportDot" class="btn btn-outline shrink-0" title="Xu·∫•t Excel theo ƒë·ª£t + kh√≥a">‚¨áÔ∏è Excel</button>
          <button id="btnPrintDot"  class="btn btn-primary shrink-0" title="In PDF g·ªôp theo ƒë·ª£t + kh√≥a">üñ®Ô∏è PDF</button>
          <p class="w-full text-xs text-gray-500">G·ª≠i in/xu·∫•t theo <b>ƒë·ª£t</b>;ho·∫∑c nh·∫≠p th√™m <b>Kh√≥a</b> n·∫øu c·∫ßn.</p>
        </div>
      </div>
    </section>

    <!-- Results -->
    <section class="card space-y-3">
      <div class="flex items-center justify-between flex-wrap gap-2">
        <div class="text-sm text-gray-600">K·∫øt qu·∫£: <span id="count" class="badge">0</span></div>
        <div id="msg" class="text-sm text-gray-600"></div>
      </div>

      <!-- Pagination toolbar -->
      <div class="flex items-center justify-between gap-3">
        <div class="flex items-center gap-2 text-sm">
          <span>Hi·ªÉn th·ªã</span>
          <select id="pageSize" class="input w-24">
            <option>10</option><option selected>20</option><option>50</option><option>100</option>
          </select>
          <span>d√≤ng/trang</span>
        </div>
        <div class="flex items-center gap-1 text-sm">
          <button id="btnFirst" class="btn btn-outline btn-xs" title="Trang ƒë·∫ßu">‚èÆÔ∏è</button>
          <button id="btnPrev"  class="btn btn-outline btn-xs" title="Trang tr∆∞·ªõc">‚è™</button>
          <span id="pageInfo" class="mx-2 min-w-[160px] text-center">Trang 1/1 ‚Ä¢ 0 m·ª•c</span>
          <button id="btnNext"  class="btn btn-outline btn-xs" title="Trang sau">‚è©</button>
          <button id="btnLast"  class="btn btn-outline btn-xs" title="Trang cu·ªëi">‚è≠Ô∏è</button>
        </div>
      </div>

      <div class="overflow-hidden border rounded-xl">
        <div id="emptyState" class="p-10 text-center text-gray-500 hidden">
          <div class="text-4xl mb-2">üìÑ</div>
          <div class="font-semibold">Ch∆∞a c√≥ d·ªØ li·ªáu</div>
          <div class="text-sm">Nh·∫≠p ƒëi·ªÅu ki·ªán v√† b·∫•m <b>T√¨m</b>.</div>
        </div>

        <div id="tableWrap" class="overflow-auto hidden">
          <table class="table min-w-full">
            <thead>
              <tr>
                <th class="text-left">M√£ HS</th>
                <th class="text-left">H·ªç t√™n</th>
                <th class="text-left th-sortable" data-sort="ma_so_hv">MSHV <span class="arrow"></span></th>
                <th>Email</th>
                <th class="th-sortable" data-sort="ngay_nhan_hs">Ng√†y nh·∫≠n <span class="arrow"></span></th>
                <th class="th-sortable" data-sort="nganh">Ng√†nh <span class="arrow"></span></th>
                <th class="th-sortable" data-sort="dot">ƒê·ª£t <span class="arrow"></span></th>
                <th class="th-sortable" data-sort="khoa">Kh√≥a <span class="arrow"></span></th>
                <th class="th-sortable" data-sort="nguoi_nhan">Ng∆∞·ªùi nh·∫≠n <span class="arrow"></span></th>
                <th class="text-center">In</th>
                <th class="text-center">S·ª≠a/X√≥a</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>

        <div id="loading" class="p-8 text-center text-gray-500 hidden">
          <span class="inline-block w-5 h-5 border-2 border-gray-300 border-t-blue-600 rounded-full animate-spin align-[-2px]"></span>
          <span class="ml-2">ƒêang t·∫£i‚Ä¶</span>
        </div>
      </div>
        <div class="flex items-center gap-1 text-sm">
          <button id="btnFirst" class="btn btn-outline btn-xs" title="Trang ƒë·∫ßu">‚èÆÔ∏è</button>
          <button id="btnPrev"  class="btn btn-outline btn-xs" title="Trang tr∆∞·ªõc">‚è™</button>
          <span id="pageInfo" class="mx-2 min-w-[160px] text-center">Trang 1/1 ‚Ä¢ 0 m·ª•c</span>
          <button id="btnNext"  class="btn btn-outline btn-xs" title="Trang sau">‚è©</button>
          <button id="btnLast"  class="btn btn-outline btn-xs" title="Trang cu·ªëi">‚è≠Ô∏è</button>
        </div>
    </section>
  </div>

  <!-- Modal Edit -->
  <div id="editModal" class="modal-backdrop">
    <div class="modal p-6">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold">Ch·ªânh s·ª≠a h·ªì s∆°</h3>
        <button id="btnCloseModal" class="btn btn-outline btn-xs">‚úï</button>
      </div>
      <form id="editForm" class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div><label class="text-sm text-gray-600">MSHV (kh√≥a)</label><input id="e_mshv" class="input bg-gray-100" readonly></div>
        <div><label class="text-sm text-gray-600">M√£ h·ªì s∆°</label><input id="e_ma_ho_so" class="input"></div>
        <div><label class="text-sm text-gray-600">H·ªç t√™n</label><input id="e_ho_ten" class="input"></div>
        <div><label class="text-sm text-gray-600">Email h·ªçc vi√™n</label><input id="e_email" class="input" type="email"></div>
        <div><label class="text-sm text-gray-600">S·ªë ƒêT</label><input id="e_so_dt" class="input"></div>
        <div><label class="text-sm text-gray-600">Ng√†nh nh·∫≠p h·ªçc</label><input id="e_nganh" class="input"></div>
        <div><label class="text-sm text-gray-600">ƒê·ª£t</label><input id="e_dot" class="input"></div>
        <div><label class="text-sm text-gray-600">Kh√≥a</label><input id="e_khoa" class="input"></div>
        <div><label class="text-sm text-gray-600">Ng√†y nh·∫≠n HS</label><input id="e_ngay_nhan" class="input" type="date"></div>
        <div><label class="text-sm text-gray-600">Ng√†y sinh</label><input id="e_ngay_sinh" class="input" type="date"></div>
        <div class="md:col-span-2"><label class="text-sm text-gray-600">Ghi ch√∫</label><input id="e_ghi_chu" class="input"></div>
        <div class="md:col-span-2 flex items-center justify-end gap-2 pt-2">
          <button type="button" id="btnCancelEdit" class="btn btn-outline">H·ªßy</button>
          <button type="submit" id="btnSaveEdit" class="btn btn-primary">L∆∞u thay ƒë·ªïi</button>
        </div>
      </form>
    </div>
  </div>

  <footer class="max-w-6xl mx-auto px-6 pb-4 text-right text-xs text-gray-500">
    ¬© <span class="font-semibold">
      <a href="https://hutech.edu.vn/e-hutech" target="_blank" rel="noopener noreferrer">
        V-HT.PTƒêT HUTECH
      </a>
    </span>
    ‚ûñ Code by:
    <span class="font-semibold">
      <a href="http://zalo.me/tuanconghuynh" target="_blank" rel="noopener noreferrer">
        HC- Tuan
      </a>
    </span>
  </footer>

  <script>
    // ·∫®n l√∫c ki·ªÉm tra login
    document.documentElement.style.visibility = 'hidden';

    // ===== helpers =====
    const $ = id => document.getElementById(id);
    const STORAGE_KEY = "apiBase";
    const PREFIX_CANDIDATES = ["", "/api"];
    let API_PREFIX = "";

    (function initApiBase(){
      const saved = localStorage.getItem(STORAGE_KEY) || window.location.origin;
      $("apiBase").value = saved;
    })();

    const apiBase = () => $("apiBase").value.trim().replace(/\/+$/,'');
    const makeUrl = (path) => apiBase() + API_PREFIX + path;

    async function detectPrefix() {
      for (const p of PREFIX_CANDIDATES) {
        try { const r = await fetch(apiBase() + p + "/health", {credentials:"include"}); if (r.ok) { API_PREFIX = p; return; } } catch(_){}
      }
      API_PREFIX = ""; // fallback
    }

    async function apiFetch(path, init={}){
      const opts = {credentials:"include", ...init};
      let r = await fetch(makeUrl(path), opts).catch(()=>null);
      if (r && r.status !== 404) return r;
      // th·ª≠ prefix c√≤n l·∫°i n·∫øu 404
      const alt = (API_PREFIX === "" ? "/api" : "");
      if (alt !== API_PREFIX) {
        try { const r2 = await fetch(apiBase() + alt + path, opts); if (r2.ok) { API_PREFIX = alt; return r2; } return r2; } catch(e){ return null; }
      }
      return r;
    }

    function fmtDMY(s){
      if(!s) return "";
      const t = String(s).trim();
      if (/^\d{2}\/\d{2}\/\d{4}$/.test(t)) return t;
      const m = t.match(/^(\d{4})-(\d{2})-(\d{2})/);
      if (m) return `${m[3]}/${m[2]}/${m[1]}`;
      const d = new Date(t); if (!isNaN(d)) {
        const dd = String(d.getDate()).padStart(2,"0");
        const mm = String(d.getMonth()+1).padStart(2,"0");
        const yy = d.getFullYear();
        return `${dd}/${mm}/${yy}`;
      }
      return t;
    }
    const dash = (x)=> (x && String(x).trim()!=="") ? x : '<span class="text-muted">‚Äî</span>';

    function setState({loading=false, empty=false}){
      $("loading").classList.toggle("hidden", !loading);
      $("emptyState").classList.toggle("hidden", !empty);
      $("tableWrap").classList.toggle("hidden", loading || empty);
    }

    // ===== Auth check (/me) =====
    async function ensureLoggedIn(){
      await detectPrefix();
      try{
        const r = await apiFetch("/me");
        if (!r || !r.ok) throw new Error();
        const me = await r.json();
        $("meName").textContent = me.full_name || me.username || "";
        $("meRole").textContent = me.role || "";
        $("meText").classList.remove("hidden");
        $("loginLink").classList.add("hidden");
        $("btnLogout").classList.remove("hidden");
        document.documentElement.style.visibility = '';
      }catch{
        const next = encodeURIComponent(location.pathname + location.search);
        location.replace(`/login?next=${next}`);
      }
    }
    $("btnLogout")?.addEventListener("click", async ()=>{
      try{ await apiFetch("/logout", {method:"POST"}); }catch(_) {}
      location.href = "/login";
    });

    // ===== Data/paging/sort state =====
    const state = {
      q: "",
      page: 1,
      size: Number(localStorage.getItem("students.pageSize") || 20),
      total: 0,
      cachedAllForFilter: [],
      sort: { key: null, dir: 'asc' }, // key: 'ma_so_hv' | 'dot' | 'khoa'
      lastRendered: [] // gi·ªØ items ƒëang render ƒë·ªÉ s·∫Øp x·∫øp l·∫°i
    };
    function pagesTotal(){ return Math.max(1, Math.ceil(state.total / state.size)); }

    function renderRows(items){
      state.lastRendered = items.slice();
      const tbody = $("tbody"); tbody.innerHTML = "";
      (items||[]).forEach((it) => {
        const nganh = it.nganh_nhap_hoc ?? it.nganh ?? "";
        const khoa  = it.khoa ?? it.khoa_hoc ?? it.khoahoc ?? "";
        const dot   = it.dot ?? it.dot_tuyen ?? "";
        const nguoi = it.nguoi_nhan_ky_ten ?? it.nguoi_nhan ?? it.nguoi_ky ?? "";
        const mail  = it.email_hoc_vien ?? "";

        const mshv = it.ma_so_hv;
        const tr = document.createElement("tr");
        tr.className = "row-alt";
        tr.innerHTML = `
          <td class="border-b whitespace-nowrap font-medium">${dash(it.ma_ho_so)}</td>
          <td class="border-b">${dash(it.ho_ten)}</td>
          <td class="border-b">${dash(mshv)}</td>
          <td class="border-b">${dash(mail)}</td>
          <td class="border-b text-center whitespace-nowrap">${dash(fmtDMY(it.ngay_nhan_hs))}</td>
          <td class="border-b">${dash(nganh)}</td>
          <td class="border-b text-center">${dash(dot)}</td>
          <td class="border-b text-center">${dash(khoa)}</td>
          <td class="border-b">${dash(nguoi)}</td>
          <td class="border-b text-center whitespace-nowrap">
            <div class="inline-flex gap-2">
              <a class="btn btn-soft btn-xs btn-pill" href="${makeUrl(`/print/a5/${encodeURIComponent(mshv)}`)}" target="_blank" rel="noopener">A5</a>
              <a class="btn btn-primary btn-xs btn-pill" href="${makeUrl(`/print/a4-two-up/${encodeURIComponent(mshv)}`)}" target="_blank" rel="noopener">A4</a>
            </div>
          </td>
          <td class="border-b text-center whitespace-nowrap">
            <div class="inline-flex gap-2">
              <a class="btn btn-outline btn-xs btn-pill" href="/?mshv=${encodeURIComponent(mshv)}">S·ª≠a</a>
              <button class="btn btn-outline btn-xs btn-pill btn-del"  data-mshv="${encodeURIComponent(mshv)}">X√≥a</button>
            </div>
          </td>`;
        tbody.appendChild(tr);
      });

      // bind delete
      document.querySelectorAll(".btn-del").forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          const mshv = decodeURIComponent(btn.getAttribute("data-mshv")||"");
          if (!mshv) return;
          if (!confirm(`X√≥a h·ªì s∆° MSHV ${mshv}?`)) return;
          const r = await apiFetch(`/applicants/${encodeURIComponent(mshv)}`, {method:"DELETE"});
          if (!r || (r.status!==204 && !r.ok)) {
            alert(`X√≥a th·∫•t b·∫°i (HTTP ${r ? r.status : '???'})`);
            return;
          }
          await runSearch();
        });
      });

      // bind edit (open modal)
      document.querySelectorAll(".btn-edit").forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          const mshv = decodeURIComponent(btn.getAttribute("data-mshv")||"");
          if (!mshv) return;
          await openEditModal(mshv);
        });
      });
    }

    function updatePagerUI(total, page, size){
      $("count").textContent = String(total);
      $("pageInfo").textContent = `Trang ${page}/${Math.max(1, Math.ceil(total/size))} ‚Ä¢ ${total} m·ª•c`;

      $("btnFirst").disabled = page <= 1;
      $("btnPrev").disabled  = page <= 1;
      $("btnNext").disabled  = page >= Math.max(1, Math.ceil(total/size));
      $("btnLast").disabled  = page >= Math.max(1, Math.ceil(total/size));
    }

    // s·∫Øp x·∫øp client-side tr√™n items ƒëang hi·ªÉn th·ªã (ho·∫∑c cachedAll khi ƒëang l·ªçc)
    function applySort(list){
      const {key, dir} = state.sort;
      if (!key) return list;
      const getVal = (it)=>{
        if (key === 'ma_so_hv') return (it.ma_so_hv || "").toString();
        if (key === 'dot')     return (it.dot || it.dot_tuyen || "").toString();
        if (key === 'khoa')    return (it.khoa || it.khoa_hoc || it.khoahoc || "").toString();
        return "";
      };
      const collator = new Intl.Collator('vi', {numeric:true, sensitivity:'base'});
      const arr = list.slice().sort((a,b)=> collator.compare(getVal(a), getVal(b)));
      return dir === 'asc' ? arr : arr.reverse();
    }
    function toggleSort(key){
      const ths = document.querySelectorAll('.th-sortable');
      ths.forEach(th=> th.classList.remove('active'));
      if (state.sort.key === key){
        state.sort.dir = (state.sort.dir === 'asc' ? 'desc' : 'asc');
      } else {
        state.sort.key = key; state.sort.dir = 'asc';
      }
      const th = document.querySelector(`.th-sortable[data-sort="${key}"]`);
      if (th) th.classList.add('active');
      // re-render v·ªõi sort
      const source = ( $("filterDot").value.trim() || $("filterKhoa").value.trim() )
        ? state.cachedAllForFilter
        : state.lastRendered;
      const sorted = applySort(source);
      renderRows(sorted);
      updatePagerUI(sorted.length || state.total, 1, (sorted.length||state.size));
      setState({loading:false, empty: (sorted.length===0)});
    }

    // l·∫•y 1 trang server
    async function fetchPageServer(q, page, size){
      const url = `/applicants/search?q=${encodeURIComponent(q)}&page=${page}&size=${size}`;
      const r = await apiFetch(url).catch(()=>null);
      if (!r || !r.ok) throw new Error(`L·ªói t·∫£i d·ªØ li·ªáu (HTTP ${r ? r.status : "???"})`);
      return r.json(); // {items, page, size, total}
    }

    // l·∫•y nhi·ªÅu (ƒë·ªÉ l·ªçc client theo ƒë·ª£t/kh√≥a)
    async function fetchUpTo(limit=1000){
      const out = [];
      let page = 1;
      const size = 200;
      for(;;){
        const data = await fetchPageServer(state.q, page, size);
        (data.items||[]).forEach(x=>out.push(x));
        if (out.length >= (data.total||0) || out.length >= limit) break;
        page += 1;
      }
      return out.slice(0, limit);
    }

    function applyClientFilters(list){
      const dot  = $("filterDot").value.trim().toLowerCase();
      const khoa = $("filterKhoa").value.trim().toLowerCase();
      return (list||[]).filter(it=>{
        const _dot  = String(it.dot ?? it.dot_tuyen ?? "").toLowerCase();
        const _khoa = String(it.khoa ?? it.khoa_hoc ?? it.khoahoc ?? "").toLowerCase();
        const okDot  = !dot  || _dot.includes(dot);
        const okKhoa = !khoa || _khoa === khoa || _khoa.includes(khoa);
        return okDot && okKhoa;
      });
    }

    async function runSearch(){
      setState({loading:true});
      const wantFilter = $("filterDot").value.trim() !== "" || $("filterKhoa").value.trim() !== "";
      try{
        let items=[], total;
        if (wantFilter){
          // l·∫•y nhi·ªÅu r·ªìi l·ªçc client
          state.cachedAllForFilter = await fetchUpTo(1000);
          let filtered = applyClientFilters(state.cachedAllForFilter);
          filtered = applySort(filtered);
          total = filtered.length;
          renderRows(filtered);
          updatePagerUI(total, 1, total || 1);
        }else{
          // ph√¢n trang b√¨nh th∆∞·ªùng
          const data = await fetchPageServer(state.q, state.page, state.size);
          items = applySort(data.items || []);
          total = data.total || 0;
          renderRows(items);
          updatePagerUI(total, state.page, state.size);
        }
        setState({loading:false, empty: total===0});
      }catch(e){
        setState({loading:false, empty:true});
        $("msg").textContent = e.message || "L·ªói kh√¥ng x√°c ƒë·ªãnh";
      }
    }

    // ===== Export/In ·∫•n theo ng√†y/ƒë·ª£t =====
    $("day").value = new Date().toISOString().slice(0,10);

    $("btnExportDay").onclick = async ()=>{
      const d = $("day").value; if(!d){ alert("Ch·ªçn ng√†y"); return; }
      const resp = await fetch(makeUrl(`/export/excel?day=${d}`), {credentials:"include"});
      if(!resp.ok){ alert(`L·ªói xu·∫•t Excel: HTTP ${resp.status}`); return; }
      const blob = await resp.blob(); const a = document.createElement('a');
      a.href = URL.createObjectURL(blob); a.download = `tong_ngay_${d}.xlsx`;
      document.body.appendChild(a); a.click(); a.remove();
      setTimeout(()=>URL.revokeObjectURL(a.href), 60000);
    };

    $("btnPrintDay").onclick = ()=>{
      const d = $("day").value; if(!d){ alert("Ch·ªçn ng√†y"); return; }
      window.open(makeUrl(`/batch/print?day=${d}`), "_blank");
    };

    $("btnPrintDot").onclick = async () => {
      const dot  = $("dot").value.trim();
      const khoa = $("dotKhoa").value.trim();
      if (!dot) { alert("Nh·∫≠p t√™n ƒë·ª£t tr∆∞·ªõc ƒë√£"); return; }
      let url = `/batch/print-dot?dot=${encodeURIComponent(dot)}`;
      if (khoa) url += `&khoa=${encodeURIComponent(khoa)}`;
      const resp = await fetch(makeUrl(url), {credentials:"include"});
      if (!resp.ok) { alert(`Kh√¥ng th·ªÉ in theo ƒë·ª£t (HTTP ${resp.status})`); return; }
      const blob = await resp.blob();
      const u = URL.createObjectURL(blob);
      window.open(u, "_blank"); setTimeout(()=>URL.revokeObjectURL(u), 60000);
    };

    $("btnExportDot").onclick = async () => {
      const dot  = $("dot").value.trim();
      const khoa = $("dotKhoa").value.trim();
      if (!dot) { alert("Nh·∫≠p t√™n ƒë·ª£t tr∆∞·ªõc ƒë√£"); return; }
      let url = `/export/excel-dot?dot=${encodeURIComponent(dot)}`;
      if (khoa) url += `&khoa=${encodeURIComponent(khoa)}`;
      const resp = await fetch(makeUrl(url), {credentials:"include"});
      if (!resp.ok) { alert(`Kh√¥ng th·ªÉ xu·∫•t Excel theo ƒë·ª£t (HTTP ${resp.status})`); return; }
      const blob = await resp.blob();
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `tong_dot_${dot}${khoa ? `_khoa_${khoa}` : ""}.xlsx`;
      document.body.appendChild(a); a.click(); a.remove();
      setTimeout(()=>URL.revokeObjectURL(a.href), 60000);
    };

    // ===== Sort header bindings =====
    document.addEventListener('click', (e)=>{
      const th = e.target.closest('.th-sortable');
      if (!th) return;
      const key = th.getAttribute('data-sort');
      if (!key) return;
      toggleSort(key);
    });

    // ===== Bind search/paging =====
    $("btnSearch").onclick = ()=>{
      state.q = $("q").value.trim();
      state.page = 1;
      runSearch();
    };
    $("q").addEventListener("keydown", e=>{ if(e.key==="Enter") $("btnSearch").click(); });

    $("pageSize").value = String(state.size);
    $("pageSize").addEventListener("change", ()=>{
      state.size = Number($("pageSize").value) || 20;
      localStorage.setItem("students.pageSize", String(state.size));
      state.page = 1;
      runSearch();
    });

    $("btnFirst").onclick = ()=>{ state.page = 1; runSearch(); };
    $("btnPrev").onclick  = ()=>{ if(state.page>1){ state.page--; runSearch(); } };
    $("btnNext").onclick  = ()=>{ state.page++; runSearch(); };
    $("btnLast").onclick  = ()=>{ state.page = pagesTotal(); runSearch(); };

    // l·ªçc client theo ƒë·ª£t/kh√≥a (g√µ l√† l·ªçc ngay n·∫øu ƒë√£ c√≥ cache)
    ["filterDot","filterKhoa"].forEach(id=>{
      $(id).addEventListener("input", ()=>{
        const has = $("filterDot").value.trim()!=="" || $("filterKhoa").value.trim()!=="";
        if (has && state.cachedAllForFilter.length>0){
          let filtered = applyClientFilters(state.cachedAllForFilter);
          filtered = applySort(filtered);
          renderRows(filtered);
          updatePagerUI(filtered.length, 1, filtered.length||1);
          setState({loading:false, empty: filtered.length===0});
        }
      });
    });
    

    // ===== Modal Edit logic =====
    const modal = $("editModal");
    const openModal = ()=>{ modal.style.display='flex'; };
    const closeModal = ()=>{ modal.style.display='none'; };
    $("btnCloseModal").onclick = closeModal;
    $("btnCancelEdit").onclick = closeModal;

    async function openEditModal(mshv){
      // t·∫£i chi ti·∫øt
      const r = await apiFetch(`/applicants/by-mshv/${encodeURIComponent(mshv)}`).catch(()=>null);
      if (!r || !r.ok){ alert(`Kh√¥ng t·∫£i ƒë∆∞·ª£c h·ªì s∆° (HTTP ${r ? r.status : '???'})`); return; }
      const data = await r.json();
      const a = data.applicant || data;

      // ƒë·ªï form
      $("e_mshv").value    = a.ma_so_hv || mshv;
      $("e_ma_ho_so").value= a.ma_ho_so || "";
      $("e_ho_ten").value  = a.ho_ten || "";
      $("e_email").value   = a.email_hoc_vien || "";
      $("e_so_dt").value   = a.so_dt || "";
      $("e_nganh").value   = a.nganh_nhap_hoc || a.nganh || "";
      $("e_dot").value     = a.dot || a.dot_tuyen || "";
      $("e_khoa").value    = a.khoa || a.khoa_hoc || a.khoahoc || "";
      $("e_ngay_nhan").value = (a.ngay_nhan_hs_iso || a.ngay_nhan_hs || "").slice(0,10);
      $("e_ngay_sinh").value  = (a.ngay_sinh_iso || a.ngay_sinh || "").slice(0,10);
      $("e_ghi_chu").value    = a.ghi_chu || "";

      openModal();
    }

    $("editForm").addEventListener("submit", async (e)=>{
      e.preventDefault();
      const mshv = $("e_mshv").value.trim();
      const body = {
        ma_ho_so: $("e_ma_ho_so").value.trim(),
        ho_ten: $("e_ho_ten").value.trim(),
        email_hoc_vien: $("e_email").value.trim() || null,
        so_dt: $("e_so_dt").value.trim() || null,
        nganh_nhap_hoc: $("e_nganh").value.trim() || null,
        dot: $("e_dot").value.trim() || null,
        khoa: $("e_khoa").value.trim() || null,
        ngay_nhan_hs: $("e_ngay_nhan").value || null, // YYYY-MM-DD
        ngay_sinh: $("e_ngay_sinh").value || null,    // YYYY-MM-DD
        ghi_chu: $("e_ghi_chu").value.trim() || null
      };
      if (!body.ma_ho_so || !body.ho_ten){
        alert("Thi·∫øu M√£ h·ªì s∆° / H·ªç t√™n.");
        return;
      }
      const btn = $("btnSaveEdit");
      btn.disabled = true; btn.textContent = "ƒêang l∆∞u...";
      const r = await apiFetch(`/applicants/${encodeURIComponent(mshv)}`, {
        method:"PUT",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(body)
      }).catch(()=>null);
      btn.disabled = false; btn.textContent = "L∆∞u thay ƒë·ªïi";
      if (!r || !r.ok){
        const t = r ? await r.text() : "(kh√¥ng ph·∫£n h·ªìi)";
        alert(`C·∫≠p nh·∫≠t th·∫•t b·∫°i (HTTP ${r ? r.status : '???'})\n${t}`);
        return;
      }
      closeModal();
      await runSearch();
    });

    // ===== init =====
    window.addEventListener('load', async ()=>{
      await ensureLoggedIn();
      $("q").focus();
      runSearch(); // l·∫ßn ƒë·∫ßu: l·∫•y r·ªóng
    });

    // l∆∞u base khi s·ª≠a
    $("apiBase").addEventListener("change", ()=>{
      localStorage.setItem(STORAGE_KEY, $("apiBase").value.trim());
    });

    // --- ENTER to search for ƒê·ª£t / Kh√≥a ---
  (function bindEnterForFilters(){
    // ch·ªçn input theo id ho·∫∑c theo placeholder (ƒë·ªÉ kh·ªèi l·ªá thu·ªôc t√™n c·ª• th·ªÉ)
    const dotInput  = document.querySelector('#filterDot, #qDot, input[placeholder="L·ªçc theo ƒê·ª£t"]');
    const khoaInput = document.querySelector('#filterKhoa, #qKhoa, input[placeholder="L·ªçc theo Kh√≥a"]');

    // H√†m k√≠ch ho·∫°t t√¨m ki·∫øm hi·ªán c√≥ c·ªßa trang
    function triggerSearch(){
      // ∆∞u ti√™n g·ªçi h√†m c√≥ s·∫µn
      if (typeof loadList === 'function')         return loadList();       // n·∫øu trang d√πng loadList()
      if (typeof applyFilters === 'function')     return applyFilters();   // n·∫øu trang d√πng applyFilters()
      // n·∫øu kh√¥ng c√≥, gi·∫£ l·∫≠p b·∫•m n√∫t "T√¨m"
      const btn = document.getElementById('btnSearch')
              || document.querySelector('button[data-action="search"]')
              || document.querySelector('button:contains("T√¨m")'); // optional
      btn && btn.click();
    }

    function bindEnter(el){
      if (!el) return;
      el.addEventListener('keydown', (e)=>{
        if (e.key === 'Enter'){
          e.preventDefault();
          triggerSearch();
        }
      });
    }

    bindEnter(dotInput);
    bindEnter(khoaInput);
  })();
  </script>
</body>
</html>
