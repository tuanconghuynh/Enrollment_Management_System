<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Danh s√°ch h·ªì s∆° | Admission_Management_System</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="icon" type="image/png" href="hutech.png" sizes="32x32">
  <link rel="apple-touch-icon" href="hutech.png">
  <meta name="theme-color" content="#2563eb">
  <link rel="stylesheet" href="style.css">
</head>
<body class="bg-gray-50">
  <div class="max-w-7xl mx-auto p-6 space-y-6">
    <!-- Header -->
    <header class="flex flex-wrap gap-3 items-center justify-between">
      <div class="flex items-center gap-3 min-w-0">
        <a href="/ams_home.html" title="V·ªÅ trang ch·ªß" class="flex items-center gap-3 hover:opacity-80 transition">
          <img src="hutech.png" alt="HUTECH" class="h-8 w-8 object-contain select-none" />
        </a>
        <div>
          <h1 class="text-2xl font-bold leading-none truncate">Danh s√°ch h·ªì s∆°</h1>
          <p class="text-sm text-gray-500">Tra c·ª©u nhanh & thao t√°c in/xu·∫•t.</p>
        </div>
      </div>

      <div class="flex items-center gap-2">
        <label for="apiBase" class="text-sm text-gray-500">API Base</label>
        <input id="apiBase" class="input w-52 md:w-72" placeholder="" />
        <span class="hidden md:inline-block w-px h-6 bg-gray-200"></span>

        <!-- User status -->
        <div id="userBox" class="text-sm text-gray-600 flex items-center gap-2">
          <span id="meText" class="hidden">
            ‚úåÔ∏è Xin ch√†o: <b id="meName"></b> (<span id="meRole"></span>)
          </span>
          <a id="loginLink" href="/login" class="btn btn-outline">ƒêƒÉng nh·∫≠p</a>
          <button id="btnLogout" class="btn btn-outline hidden">LogOut</button>
        </div>

        <!-- <a class="btn btn-outline" href="/" title="Bi√™n so·∫°n H·ªì S∆°">So·∫°n H·ªì S∆°</a>
        <a id="journalLink" class="btn btn-outline" href="/journal.html" title="Nh·∫≠t k√Ω" hidden>üßæNh·∫≠t k√Ω</a> -->
        <a class="btn btn-outline" href="/ams_home.html" title="Trang ch·ªß">‚Üê Trang ch·ªß</a>
      </div>
    </header>

    <!-- Toolbar -->
    <section class="card space-y-4">
      <!-- H√†ng 1: T√¨m ki·∫øm + L·ªçc ƒë·ª£t/kh√≥a -->
      <div class="grid grid-cols-1 xl:grid-cols-3 gap-3 items-end">
        <!-- √î t√¨m chung -->
        <div class="xl:col-span-2">
          <div class="flex items-center gap-2">
            <div class="relative flex-1 min-w-[240px]">
              <input id="q" class="input w-full pl-10" placeholder="Nh·∫≠p h·ªç t√™n ho·∫∑c MSHV..." aria-label="T·ª´ kh√≥a" />
              <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" aria-hidden="true">üîé</span>
            </div>
            <div class="grid grid-cols-2 gap-2">
              <input id="filterDot"  class="input" placeholder="L·ªçc theo ƒê·ª£t"  title="VD: 1 ho·∫∑c 1/2025" />
              <input id="filterKhoa" class="input" placeholder="L·ªçc theo Kh√≥a" title="VD: 27" />
            </div>
            <button id="btnSearch" class="btn btn-outline shrink-0" aria-label="T√¨m">üîé T√¨m</button>
          </div>
        </div>
      </div>
      <h2 class="font-bold">IN / XU·∫§T D·ªÆ LI·ªÜU</h2>
      <!-- H√†ng 2: Theo ng√†y + Theo ƒë·ª£t -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <!-- Theo ng√†y -->
        <div class="flex flex-wrap items-center gap-2 min-w-0">
          <input id="day" type="date" class="input w-36 sm:w-40 md:w-44 lg:w-48 flex-none" />
          <button id="btnExportDay" class="btn btn-outline shrink-0" title="Xu·∫•t Excel theo ng√†y">‚¨áÔ∏è Excel</button>
          <button id="btnPrintDay"  class="btn btn-primary shrink-0" title="In PDF g·ªôp theo ng√†y">üñ®Ô∏è PDF</button>
          <p class="w-full text-xs text-gray-500">G·ª≠i in theo ng√†y nh·∫≠n h·ªì s∆°.</p>
        </div>

        <!-- Theo ƒë·ª£t (+Kh√≥a) server-side -->
        <div class="flex flex-wrap items-center gap-2 min-w-0">
          <input id="dot" class="input w-24 sm:w-28 md:w-32 flex-none" placeholder="Nh·∫≠p t√™n ƒë·ª£t" title="VD: 1" />
          <input id="dotKhoa" class="input w-24 sm:w-28 md:w-32 flex-none" placeholder="Nh·∫≠p Kh√≥a" title="VD: 25" />
          <button id="btnExportDot" class="btn btn-outline shrink-0" title="Xu·∫•t Excel theo ƒë·ª£t + kh√≥a">‚¨áÔ∏è Excel</button>
          <button id="btnPrintDot"  class="btn btn-primary shrink-0" title="In PDF g·ªôp theo ƒë·ª£t + kh√≥a">üñ®Ô∏è PDF</button>
          <p class="w-full text-xs text-gray-500">G·ª≠i in/xu·∫•t theo <b>ƒë·ª£t</b>; ho·∫∑c nh·∫≠p th√™m <b>Kh√≥a</b> n·∫øu c·∫ßn.</p>
        </div>
      </div>
    </section>

    <!-- Results -->
    <section class="card space-y-3">
      <div class="flex items-center justify-between flex-wrap gap-2">
        <div class="text-sm text-gray-600">K·∫øt qu·∫£: <span id="count" class="badge">0</span></div>
        <div id="msg" class="text-sm text-gray-600" role="status" aria-live="polite"></div>
      </div>

      <!-- Pagination toolbar (top) -->
      <div class="flex items-center justify-between gap-3">
        <div class="flex items-center gap-2 text-sm">
          <span>Hi·ªÉn th·ªã</span>
          <select id="pageSize" class="input w-24">
            <option selected>10</option><option>20</option><option>50</option><option>100</option>
          </select>
          <span>d√≤ng/trang</span>
        </div>
        <div class="flex items-center gap-1 text-sm pager" data-position="top">
          <button class="btn btn-outline btn-xs pager-first"  title="Trang ƒë·∫ßu">‚èÆÔ∏è</button>
          <button class="btn btn-outline btn-xs pager-prev"   title="Trang tr∆∞·ªõc">‚è™</button>
          <span class="mx-2 min-w-[160px] text-center pager-info">Trang 1/1 ‚Ä¢ 0 m·ª•c</span>
          <button class="btn btn-outline btn-xs pager-next"   title="Trang sau">‚è©</button>
          <button class="btn btn-outline btn-xs pager-last"   title="Trang cu·ªëi">‚è≠Ô∏è</button>
        </div>
      </div>

      <div class="overflow-hidden border rounded-xl">
        <div id="emptyState" class="p-10 text-center text-gray-500 hidden">
          <div class="text-4xl mb-2">‚ùåüßæ</div>
          <div class="font-semibold">Kh√¥ng t√¨m th·∫•y trong danh s√°ch</div>
          <div class="text-sm">Nh·∫≠p t·ª´ kh√≥a kh√°c ƒë·ªÉ t√¨m ki·∫øm!</div>
        </div>

        <div id="tableWrap" class="overflow-auto hidden">
          <table class="table min-w-full">
            <thead>
              <tr>
                <th class="text-left">M√£ HS</th>
                <th class="text-left">H·ªç t√™n</th>
                <th class="text-left th-sortable" data-sort="ma_so_hv" role="button" tabindex="0" aria-label="S·∫Øp x·∫øp theo MSHV">MSHV <span class="arrow">‚ñ≤‚ñº</span></th>
                <th class="th-sortable" data-sort="ngay_nhan_hs" role="button" tabindex="0" aria-label="S·∫Øp x·∫øp theo Ng√†y nh·∫≠n">Ng√†y nh·∫≠n <span class="arrow">‚ñ≤‚ñº</span></th>
                <th class="th-sortable" data-sort="nganh" role="button" tabindex="0" aria-label="S·∫Øp x·∫øp theo Ng√†nh">Ng√†nh <span class="arrow">‚ñ≤‚ñº</span></th>
                <th class="th-sortable" data-sort="dot" role="button" tabindex="0" aria-label="S·∫Øp x·∫øp theo ƒê·ª£t">ƒê·ª£t <span class="arrow">‚ñ≤‚ñº</span></th>
                <th class="th-sortable" data-sort="khoa" role="button" tabindex="0" aria-label="S·∫Øp x·∫øp theo Kh√≥a">Kh√≥a <span class="arrow">‚ñ≤‚ñº</span></th>
                <th class="th-sortable" data-sort="nguoi_nhan" role="button" tabindex="0" aria-label="S·∫Øp x·∫øp theo Ng∆∞·ªùi nh·∫≠n">Ng∆∞·ªùi nh·∫≠n <span class="arrow">‚ñ≤‚ñº</span></th>
                <th class="text-center">In</th>
                <th class="text-center">S·ª≠a/X√≥a</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>

        <div id="loading" class="p-8 text-center text-gray-500 hidden">
          <span class="inline-block w-5 h-5 border-2 border-gray-300 border-t-blue-600 rounded-full animate-spin align-[-2px]" aria-hidden="true"></span>
          <span class="ml-2">ƒêang t·∫£i‚Ä¶</span>
        </div>
      </div>

      <!-- Pagination toolbar (bottom) -->
      <div class="flex items-center gap-1 text-sm pager" data-position="bottom">
        <button class="btn btn-outline btn-xs pager-first" title="Trang ƒë·∫ßu">‚èÆÔ∏è</button>
        <button class="btn btn-outline btn-xs pager-prev"  title="Trang tr∆∞·ªõc">‚è™</button>
        <span class="mx-2 min-w-[160px] text-center pager-info">Trang 1/1 ‚Ä¢ 0 m·ª•c</span>
        <button class="btn btn-outline btn-xs pager-next"  title="Trang sau">‚è©</button>
        <button class="btn btn-outline btn-xs pager-last"  title="Trang cu·ªëi">‚è≠Ô∏è</button>
      </div>
    </section>
  </div>

  <!-- Modal Edit (ƒë√É b·ªè - ph·∫ßn HTML gi·ªØ comment ƒë·ªÉ tham kh·∫£o)
  <div id="editModal" class="modal-backdrop" aria-hidden="true">...</div> -->

  <!-- Modal nh·∫≠p l√Ω do xo√° -->
  <div id="delModal" class="overlay" aria-modal="true" role="dialog">
    <div class="modal">
      <div class="hd">X√≥a h·ªì s∆°</div>
      <div class="bd">
        <p id="delMsg" class="mb-2 text-sm text-gray-700"></p>
        <label class="text-sm text-gray-800 font-semibold block mb-1">L√Ω do xo√° (b·∫Øt bu·ªôc)</label>
        <textarea id="delReason" placeholder="Nh·∫≠p l√Ω do‚Ä¶"></textarea>
        <p id="delErr" class="mt-1 text-xs text-rose-600 hidden">Vui l√≤ng nh·∫≠p l√Ω do!</p>
      </div>
      <div class="ft">
        <button id="delCancel" class="btn btn-outline">H·ªßy</button>
        <button id="delOk" class="btn btn-primary">OK</button>
      </div>
    </div>
  </div>

  <footer class="max-w-6xl mx-auto px-6 pb-4 text-right text-xs text-gray-500">
    ¬© <span class="font-semibold">
      <a href="https://hutech.edu.vn/e-hutech" target="_blank" rel="noopener noreferrer">V-HT.PTƒêT HUTECH</a>
    </span>
    ‚ûñ Code by:
    <span class="font-semibold">
      <a href="http://zalo.me/tuanconghuynh" target="_blank" rel="noopener noreferrer">HC- Tuan</a>
    </span>
  </footer>

  <script>
    // ·∫®n l√∫c ki·ªÉm tra login
    document.documentElement.style.visibility = 'hidden';

    // ===== helpers =====
    const $ = id => document.getElementById(id);
    const STORAGE_KEY = "apiBase";
    const PREFIX_CANDIDATES = ["", "/api"];
    let API_PREFIX = "";

    // ===== Compose / Editor detection =====
    const COMPOSE_CANDIDATES = ["/compilation.html", "/compose.html", "/editor.html", "/"];
    let COMPOSE_BASE = "/compilation.html"; // m·∫∑c ƒë·ªãnh an to√†n

    async function detectComposePage(){
      for (const p of COMPOSE_CANDIDATES) {
        try {
          const r = await fetch(p, { method: "GET", credentials: "include" });
          if (r.ok) {
            if (p !== "/ams_home.html") { // tr√°nh nh·∫ßm trang ch·ªß
              COMPOSE_BASE = p;
              break;
            }
          }
        } catch(_) {}
      }
      // C·∫≠p nh·∫≠t link "So·∫°n H·ªì S∆°" tr√™n header
      const soan = document.querySelector('a[title="Bi√™n so·∫°n H·ªì S∆°"]');
      if (soan) soan.href = COMPOSE_BASE;
    }

    const debounce = (fn, ms=300) => { let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); }; };

    (function initApiBase(){
      const saved = localStorage.getItem(STORAGE_KEY) || window.location.origin;
      $("apiBase").value = saved;
    })();

    const apiBase = () => $("apiBase").value.trim().replace(/\/+$/,'');
    const makeUrl = (path) => apiBase() + API_PREFIX + path;

    async function detectPrefix() {
      for (const p of PREFIX_CANDIDATES) {
        try { const r = await fetch(apiBase() + p + "/health", {credentials:"include"}); if (r.ok) { API_PREFIX = p; return; } } catch(_){}
      }
      API_PREFIX = ""; // fallback
    }

    async function apiFetch(path, init={}){
      const opts = {credentials:"include", ...init};
      let r = await fetch(makeUrl(path), opts).catch(()=>null);
      if (r && r.status !== 404) return r;
      // th·ª≠ prefix c√≤n l·∫°i n·∫øu 404
      const alt = (API_PREFIX === "" ? "/api" : "");
      if (alt !== API_PREFIX) {
        try { const r2 = await fetch(apiBase() + alt + path, opts); if (r2.ok) { API_PREFIX = alt; return r2; } return r2; } catch(e){ return null; }
      }
      return r;
    }

    function fmtDMY(s) {
      if (!s) return "";
      const t = String(s).trim();
      if (/^\d{2}\/\d{2}\/\d{4}$/.test(t)) return t;
      const m = t.match(/^(\d{4})-(\d{2})-(\d{2})/);
      if (m) return `${m[3]}/${m[2]}/${m[1]}`;
      const d = new Date(t);
      if (!isNaN(d)) {
        const dd = String(d.getDate()).padStart(2, "0");
        const mm = String(d.getMonth() + 1).padStart(2, "0");
        const yy = d.getFullYear();
        return `${dd}/${mm}/${yy}`;
      }
      return t;
    }

    const dash = (x)=> (x && String(x).trim()!=="") ? x : '<span class="text-muted">‚Äî</span>';

    function setState({loading=false, empty=false}){
      $("loading").classList.toggle("hidden", !loading);
      $("emptyState").classList.toggle("hidden", !empty);
      $("tableWrap").classList.toggle("hidden", loading || empty);
    }

    // ===== Auth check (/me) =====
    async function ensureLoggedIn(){
      await detectPrefix();
      try{
        const r = await apiFetch("/me");
        if (!r || !r.ok) throw new Error();
        const me = await r.json();
        $("meName").textContent = me.full_name || me.username || "";
        $("meRole").textContent = me.role || "";
        $("meText").classList.remove("hidden");
        $("loginLink").classList.add("hidden");
        $("btnLogout").classList.remove("hidden");
        document.documentElement.style.visibility = '';
      }catch{
        const next = encodeURIComponent(location.pathname + location.search);
        location.replace(`/login?next=${next}`);
      }
    }
    $("btnLogout")?.addEventListener("click", async ()=>{
      try{ await apiFetch("/logout", {method:"POST"}); }catch(_) {}
      location.href = "/login";
    });

    // ===== Data/paging/sort state =====
    const state = {
      q: "",
      page: 1,
      size: 10,
      total: 0,
      cachedAllForFilter: [],
      sort: { key: null, dir: 'asc' },
      cacheAll: []
    };
    function pagesTotal(){ return Math.max(1, Math.ceil(state.total / state.size)); }

    // ===== Xo√° m·ªÅm (client blacklist theo session) =====
    function isDeletedFlag(it){
      return !!(it?.deleted || it?.is_deleted || it?.deleted_at || it?.status === 'deleted');
    }
    const deletedMshv = new Set(JSON.parse(sessionStorage.getItem('deletedMshv') || '[]'));
    function persistDeletedMshv(){
      try { sessionStorage.setItem('deletedMshv', JSON.stringify([...deletedMshv])); } catch(_){}
    }

    function clearDeletedIfExists(items){
      (items || []).forEach(it => {
        const id = String(it?.ma_so_hv || '');
        const serverSoftDeleted = isDeletedFlag(it); // true n·∫øu b·∫£n ghi c√≤n ƒëang soft-delete tr√™n BE
        // N·∫øu server tr·∫£ v·ªÅ v√† KH√îNG soft-delete -> g·ª° kh·ªèi blacklist c·ªßa FE
        if (id && deletedMshv.has(id) && !serverSoftDeleted){
          deletedMshv.delete(id);
        }
      });
      persistDeletedMshv();
    }

    function notDeleted(it){
      const id = String(it?.ma_so_hv || '');
      return id && !deletedMshv.has(id) && !isDeletedFlag(it);
    }

    function renderRows(items){
      const tbody = $("tbody"); tbody.innerHTML = "";
      (items||[]).forEach((it) => {
        const nganh = it.nganh_nhap_hoc ?? it.nganh ?? "";
        const khoa  = it.khoa ?? it.khoa_hoc ?? it.khoahoc ?? "";
        const dot   = it.dot ?? it.dot_tuyen ?? "";
        const nguoi = it.nguoi_nhan_ky_ten ?? it.nguoi_nhan ?? it.nguoi_ky ?? "";
        const mshv = it.ma_so_hv;
        const tr = document.createElement("tr");
        tr.className = "row-alt";
        tr.innerHTML = `
          <td class="border-b whitespace-nowrap font-medium">${dash(it.ma_ho_so)}</td>
          <td class="border-b">${dash(it.ho_ten)}</td>
          <td class="border-b">${dash(mshv)}</td>
          <td class="border-b text-center whitespace-nowrap">${dash(fmtDMY(it.ngay_nhan_hs))}</td>
          <td class="border-b">${dash(nganh)}</td>
          <td class="border-b text-center">${dash(dot)}</td>
          <td class="border-b text-center">${dash(khoa)}</td>
          <td class="border-b">${dash(nguoi)}</td>
          <td class="border-b text-center whitespace-nowrap">
            <div class="inline-flex gap-2">
              <button class="btn btn-soft btn-xs btn-pill btn-print-a5" data-mshv="${encodeURIComponent(mshv)}">A5</button>
              <button class="btn btn-primary btn-xs btn-pill btn-print-a4" data-mshv="${encodeURIComponent(mshv)}">A4</button>
            </div>
          </td>
          <td class="border-b text-center whitespace-nowrap">
            <div class="inline-flex gap-2">
              <button class="btn btn-outline btn-xs btn-pill btn-edit" data-mshv="${encodeURIComponent(mshv)}">S·ª≠a</button>
              <button class="btn btn-outline btn-xs btn-pill btn-del"  data-mshv="${encodeURIComponent(mshv)}">X√≥a</button>
            </div>
          </td>`;
        tbody.appendChild(tr);
      });
    }

    // ===== Toast helper =====
    function showToast(msg, maybeOpts){
      let type = 'danger', timeout = 2200;
      if (typeof maybeOpts === 'object' && maybeOpts !== null) {
        type = maybeOpts.type || 'danger';
        timeout = Number(maybeOpts.timeout || 2200);
      } else if (typeof maybeOpts === 'string') {
        type = maybeOpts;
        if (typeof arguments[2] !== 'undefined') {
          const t = Number(arguments[2]);
          if (!Number.isNaN(t)) timeout = t;
        }
      }

      let toast = document.getElementById('toast');
      let inner = document.getElementById('toastInner');

      if (!toast) {
        toast = document.createElement('div');
        toast.id = 'toast';
        toast.className = 'fixed top-8 left-1/2 -translate-x-1/2 z-[9999] pointer-events-none hidden';
        document.body.appendChild(toast);
      }
      if (!inner) {
        inner = document.createElement('div');
        inner.id = 'toastInner';
        inner.className = 'px-5 py-3 rounded-xl shadow-xl text-white font-semibold backdrop-blur transition-all duration-300 scale-95 opacity-0 max-w-[90vw] sm:max-w-md text-center';
        toast.appendChild(inner);
      }

      const colors = {
        info: 'bg-blue-600/95',
        success: 'bg-green-600/95',
        warn: 'bg-amber-600/95',
        warning: 'bg-amber-600/95',
        error: 'bg-rose-600/95',
        danger: 'bg-rose-600/95'
      };

      inner.className = `px-5 py-3 rounded-xl shadow-xl text-white font-semibold backdrop-blur transition-all duration-300 scale-95 opacity-0 max-w-[90vw] sm:max-w-md text-center ${colors[type] || colors.danger}`;
      inner.textContent = String(msg || '');

      toast.classList.remove('hidden');
      requestAnimationFrame(() => {
        inner.classList.replace('scale-95', 'scale-100');
        inner.classList.replace('opacity-0', 'opacity-100');
      });

      clearTimeout(showToast._t);
      showToast._t = setTimeout(() => {
        inner.classList.replace('scale-100', 'scale-95');
        inner.classList.replace('opacity-100', 'opacity-0');
        setTimeout(() => toast.classList.add('hidden'), 300);
      }, timeout);
    }

    // ===== Modal nh·∫≠p l√Ω do (Promise) =====
    function askDeleteReason(message, placeholder=''){
      const overlay = document.getElementById('delModal');
      const msg = document.getElementById('delMsg');
      const txt = document.getElementById('delReason');
      const err = document.getElementById('delErr');
      const ok = document.getElementById('delOk');
      const cancel = document.getElementById('delCancel');

      msg.textContent = message || 'X√≥a b·∫£n ghi n√†y?';
      txt.value = placeholder || '';
      err.classList.add('hidden');
      overlay.classList.add('show');
      txt.focus();

      return new Promise(resolve=>{
        const done = (val)=>{
          overlay.classList.remove('show');
          ok.removeEventListener('click', onOk);
          cancel.removeEventListener('click', onCancel);
          overlay.removeEventListener('click', onBackdrop);
          document.removeEventListener('keydown', onEsc);
          resolve(val);
        };
        const onOk = ()=>{
          const v = (txt.value||'').trim();
          if(!v){ err.classList.remove('hidden'); txt.focus(); return; }
          done(v);
        };
        const onCancel = ()=> done(null);
        const onBackdrop = (e)=>{ if(e.target===overlay) done(null); };
        const onEsc = (e)=>{ if(e.key==='Escape') done(null); };

        ok.addEventListener('click', onOk);
        cancel.addEventListener('click', onCancel);
        overlay.addEventListener('click', onBackdrop);
        document.addEventListener('keydown', onEsc);
      });
    }

    // ===== B·∫Øt s·ª± ki·ªán trong b·∫£ng (In / S·ª≠a / Xo√°) =====
    document.addEventListener('DOMContentLoaded', () => {
      const tbody = document.getElementById('tbody');
      if (!tbody) return;

      tbody.addEventListener('click', async (e) => {
        // --- S·ª≠a: ƒëi·ªÅu h∆∞·ªõng sang trang bi√™n so·∫°n ---
        const editBtn = e.target.closest('.btn-edit');
        if (editBtn) {
          const mshv = decodeURIComponent(editBtn.dataset.mshv || '');
          if (!mshv) return;
          location.href = `${COMPOSE_BASE}?mshv=${encodeURIComponent(mshv)}&action=edit`;
          return;
        }

        // In A5/A4
        const a5 = e.target.closest('.btn-print-a5');
        const a4 = e.target.closest('.btn-print-a4');
        if (a5 || a4) {
          const mshv = decodeURIComponent((a5 || a4).dataset.mshv || '');
          if (!mshv) return;
          const url = a5 ? `/print/a5/${encodeURIComponent(mshv)}`
                         : `/print/a4/${encodeURIComponent(mshv)}`;
          await openPdfOrAlert(url);
          return;
        }

        // Xo√° m·ªÅm
        const btn = e.target.closest('.btn-del');
        if (!btn) return;

        if (btn.disabled) { showToast('B·∫°n kh√¥ng c√≥ quy·ªÅn xo√°.', {type:'warn'}, 2000); return; }

        const mshv = decodeURIComponent(btn.dataset.mshv || '');
        if (!mshv) return;

        const reason = await askDeleteReason(`X√≥a h·ªì s∆° MSHV ${mshv} ?`, '');
        if (reason === null) return;

        const original = btn.textContent;
        btn.disabled = true;
        btn.textContent = 'ƒêang xo√°‚Ä¶';

        let resp = null;
        try {
          resp = await apiFetch(`/applicants/${encodeURIComponent(mshv)}`, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ reason })
          });
        } catch (_) {}

        if (!resp) {
          showToast('Kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c m√°y ch·ªß.', {type:'error', timeout:2200});
        } else if (resp.status === 204 || resp.status === 410) {
          deletedMshv.add(String(mshv));
          persistDeletedMshv();

          const tr = btn.closest('tr'); if (tr) tr.remove();
          showToast(`ƒê√£ x√≥a MSHV ${mshv}`, {type:'danger'});

          await runSearch();
        } else {
          let msg = `X√≥a th·∫•t b·∫°i (HTTP ${resp.status})`;
          try { const t = await resp.text(); const j = JSON.parse(t); if (j?.detail) msg = j.detail; } catch {}
          showToast(msg, {type:'error', timeout:2600});
        }

        btn.textContent = original;
        btn.disabled = false;
      });
    });

    (function colorDeleteButtons(){
      const btns = Array.from(document.querySelectorAll('button, a'));
      btns.forEach(b => {
        const t = b.textContent?.trim();
        if (t === 'X√≥a' || t === 'Xo√°') {
          b.classList.add(
            'border', 'border-rose-600', 'text-rose-600',
            'hover:bg-rose-600', 'hover:text-white',
            'focus:ring-2','focus:ring-rose-400','focus:outline-none'
          );
          b.classList.remove('btn-primary','text-gray-700','border-gray-300');
          b.classList.add('rounded-lg');
        }
      });
    })();

    function updatePagerUI(total, page, size){
      $("count").textContent = String(total);
      document.querySelectorAll('.pager').forEach(p => {
        p.querySelector('.pager-info').textContent = `Trang ${page}/${Math.max(1, Math.ceil(total/size))} ‚Ä¢ ${total} m·ª•c`;
        const totalPages = Math.max(1, Math.ceil(total/size));
        p.querySelector('.pager-first').disabled = page <= 1;
        p.querySelector('.pager-prev').disabled  = page <= 1;
        p.querySelector('.pager-next').disabled  = page >= totalPages;
        p.querySelector('.pager-last').disabled  = page >= totalPages;
      });
    }

    // s·∫Øp x·∫øp client-side (tr√™n to√†n t·∫≠p)
    function applySort(list){
      const {key, dir} = state.sort;
      if (!key) return list;
      const getVal = (it)=>{
        if (key === 'ma_so_hv')   return (it.ma_so_hv || "").toString();
        if (key === 'dot')        return (it.dot || it.dot_tuyen || "").toString();
        if (key === 'khoa')       return (it.khoa || it.khoa_hoc || it.khoahoc || "").toString();
        if (key === 'nganh')      return (it.nganh_nhap_hoc || it.nganh || "").toString();
        if (key === 'nguoi_nhan') return (it.nguoi_nhan_ky_ten || it.nguoi_nhan || it.nguoi_ky || "").toString();
        if (key === 'ngay_nhan_hs') return (it.ngay_nhan_hs || "");
        return "";
      };
      const collator = new Intl.Collator('vi', {numeric:true, sensitivity:'base'});
      const arr = list.slice().sort((a,b)=> collator.compare(getVal(a), getVal(b)));
      return dir === 'asc' ? arr : arr.reverse();
    }

    function setAriaSort(){
      document.querySelectorAll('.th-sortable').forEach(th=> th.removeAttribute('aria-sort'));
      if (state.sort.key){
        const th = document.querySelector(`.th-sortable[data-sort="${state.sort.key}"]`);
        if (th) th.setAttribute('aria-sort', state.sort.dir === 'asc' ? 'ascending' : 'descending');
      }
    }

    async function toggleSort(key){
      if (state.sort.key === key){
        state.sort.dir = (state.sort.dir === 'asc' ? 'desc' : 'asc');
      } else {
        state.sort.key = key; state.sort.dir = 'asc';
      }
      setAriaSort();
      await runSearch();
    }

    // --- Helpers chu·∫©n ho√° v√† fetch ---
    function normalizePaged(data) {
      if (!data) return { items: [], total: 0, page: 1, size: 0 };
      if (Array.isArray(data.items)) {
        return { items: data.items, total: Number(data.total ?? data.items.length ?? 0), page: Number(data.page ?? 1), size: Number(data.size ?? data.items.length ?? 0) };
      }
      if (Array.isArray(data.results)) {
        return { items: data.results, total: Number(data.total ?? data.results.length ?? 0), page: Number(data.page ?? 1), size: Number(data.size ?? data.results.length ?? 0) };
      }
      if (Array.isArray(data)) { return { items: data, total: data.length, page: 1, size: data.length }; }
      return { items: [], total: 0, page: 1, size: 0 };
    }
    async function tryJson(url) {
      const r = await apiFetch(url).catch(()=>null);
      if (!r || !r.ok) return null;
      try { return await r.json(); } catch { return null; }
    }

    function isLikelyNameQuery(q){
      const s = (q||"").trim();
      if (!s) return false;
      const hasLetter = /[A-Za-z√Ä-·ª¥√†-·ªµ]/.test(s);
      const manyDigits = /^\d{4,}$/.test(s);
      return hasLetter && !manyDigits;
    }

    function vnNorm(s){
      return (s||"")
        .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
        .replace(/ƒë/g,"d").replace(/ƒê/g,"D")
        .trim().toLowerCase();
    }
    function matchScore(name, query){
      const a = vnNorm(name), b = vnNorm(query);
      if (!a || !b) return 0;
      if (a === b) return 100;
      if (a.startsWith(b)) return 90;
      if (a.includes(b)) return 70;
      const tokens = b.split(/\s+/).filter(Boolean);
      return tokens.every(t => a.includes(t)) ? 60 : 0;
    }
    function filterAndSortByName(list, q, limit=5000){
      const scored = (list||[]).map(it=>{
        const name = it.ho_ten || it.full_name || it.ten || "";
        return {it, score: matchScore(name, q)};
      }).filter(x => x.score > 0);
      scored.sort((p,q)=> q.score - p.score);
      return scored.slice(0, limit).map(x=>x.it);
    }

    // l·∫•y 1 trang server
    async function fetchPageServer(q, page, size){
      for (const k of ["q","name","full_name"]) {
        const j = await tryJson(`/applicants/search?${k}=${encodeURIComponent(q)}&page=${page}&size=${size}`);
        if (j) {
          const norm = normalizePaged(j);

          // ‚úÖ G·ª° MSHV kh·ªèi blacklist n·∫øu server ƒë√£ tr·∫£ v·ªÅ (v√† kh√¥ng c√≤n soft-delete)
          clearDeletedIfExists(norm.items);

          // Sau ƒë√≥ m·ªõi l·ªçc notDeleted
          norm.items = (norm.items || []).filter(notDeleted);
          return norm;
        }
      }

      let j = await tryJson(`/applicants/search?page=${page}&size=${size}`);
      if (j) {
        const norm = normalizePaged(j);
        clearDeletedIfExists(norm.items);
        norm.items = (norm.items || []).filter(notDeleted);
        return norm;
      }

      j = await tryJson(`/applicants?page=${page}&size=${size}`);
      if (j) {
        const norm = normalizePaged(j);
        clearDeletedIfExists(norm.items);
        norm.items = (norm.items || []).filter(notDeleted);
        return norm;
      }

      return { items: [], total: 0, page: 1, size: size };
    }

    // l·∫•y nhi·ªÅu trang (ƒë·ªÉ sort/loc client)
    async function fetchUpTo(limit=5000){
      const out = [];
      let page = 1;
      const size = 200;
      for(;;){
        const data = await fetchPageServer(state.q, page, size);
        (data.items||[]).forEach(x => { if (notDeleted(x)) out.push(x); });
        const total = data.total ?? out.length;
        if (out.length >= total || out.length >= limit || (data.items||[]).length === 0 || (data.items||[]).length < size) break;
        page += 1;
      }
      return out.slice(0, limit);
    }

    function applyClientFilters(list){
      const dot  = $("filterDot").value.trim().toLowerCase();
      const khoa = $("filterKhoa").value.trim().toLowerCase();
      return (list||[]).filter(it=>{
        const _dot  = String(it.dot ?? it.dot_tuyen ?? "").toLowerCase();
        const _khoa = String(it.khoa ?? it.khoa_hoc ?? it.khoahoc ?? "").toLowerCase();
        const okDot  = !dot  || _dot.includes(dot);
        const okKhoa = !khoa || _khoa === khoa || _khoa.includes(khoa);
        return okDot && okKhoa;
      });
    }

    async function buildSourceFull(){
      state.cacheAll = (await fetchUpTo(5000)).filter(notDeleted);
      const wantFilter = $("filterDot").value.trim() !== "" || $("filterKhoa").value.trim() !== "";
      let list = wantFilter ? applyClientFilters(state.cacheAll) : state.cacheAll.slice();
      list = applySort(list);
      return list;
    }

    async function runSearch(){
      setState({loading:true});
      try{
        const full = await buildSourceFull();
        clearDeletedIfExists(full);
        state.total = full.length;

        const totalPages = Math.max(1, Math.ceil(state.total / state.size));
        if (state.page > totalPages) state.page = totalPages;

        const start = (state.page - 1) * state.size;
        renderRows(full.slice(start, start + state.size));
        updatePagerUI(state.total, state.page, state.size);
        setState({loading:false, empty: state.total === 0});
      }catch(e){
        setState({loading:false, empty:true});
        $("msg").textContent = e.message || "L·ªói kh√¥ng x√°c ƒë·ªãnh";
      }
    }

    (function listenRestoreBroadcast(){
      try {
        const bc = new BroadcastChannel('app-events');
        bc.onmessage = (ev) => {
          const t = ev?.data?.type;
          const id = String(ev?.data?.mssv || '');
          if (!id) return;

          if (t === 'APPLICANT_RESTORED') {
            deletedMshv.delete(id);
            persistDeletedMshv();
            state.page = 1;
            runSearch();
          }

          // üßπ Khi xo√° vƒ©nh vi·ªÖn: g·ª° lu√¥n kh·ªèi blacklist xo√° m·ªÅm ƒë·ªÉ sau n√†y t·∫°o l·∫°i s·∫Ω hi·ªán
          if (t === 'APPLICANT_DELETED_PERMANENT') {
            deletedMshv.delete(id);
            persistDeletedMshv();
            state.page = 1;
            runSearch();
          }
        };
      } catch(_) {}
    })();

    // ===== File helpers =====
    async function fetchFileOrAlert(url, filename, type = "excel"){
      const resp = await fetch(makeUrl(url), { credentials: "include" });
      if (!resp.ok){
        let msg = `Kh√¥ng th·ªÉ ${type === "pdf" ? "in" : "xu·∫•t"} (HTTP ${resp.status})`;
        try { const t = await resp.text(); const j = JSON.parse(t); if (j?.detail) msg = j.detail; } catch(_){}
        alert(msg);
        return;
      }
      const blob = await resp.blob();
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      document.body.appendChild(a); a.click(); a.remove();
      setTimeout(()=>URL.revokeObjectURL(a.href), 60000);
    }

    async function openPdfOrAlert(url){
      const resp = await fetch(makeUrl(url), { credentials: "include" });
      if (!resp.ok){
        let msg = `Kh√¥ng th·ªÉ in (HTTP ${resp.status})`;
        try { const t = await resp.text(); const j = JSON.parse(t); if (j?.detail) msg = j.detail; } catch(_){}
        alert(msg);
        return;
      }
      const blob = await resp.blob();
      const u = URL.createObjectURL(blob);
      window.open(u, "_blank");
      setTimeout(()=>URL.revokeObjectURL(u), 60000);
    }

    // ===== Export/In ·∫•n theo ng√†y/ƒë·ª£t =====
    $("day").value = new Date().toISOString().slice(0,10);

    $("btnExportDay").onclick = async ()=>{
      const d = $("day").value;
      if (!d){ alert("Ch·ªçn ng√†y tr∆∞·ªõc ƒë√£"); return; }
      await fetchFileOrAlert(`/export/excel?day=${encodeURIComponent(d)}`, `tong_ngay_${d}.xlsx`, "excel");
    };
    $("btnPrintDay").onclick = async ()=>{
      const d = $("day").value;
      if (!d){ alert("Ch·ªçn ng√†y tr∆∞·ªõc ƒë√£"); return; }
      await openPdfOrAlert(`/batch/print?day=${encodeURIComponent(d)}`);
    };
    $("btnExportDot").onclick = async ()=>{
      const dot  = $("dot").value.trim();
      const khoa = $("dotKhoa").value.trim();
      if (!dot){ alert("Nh·∫≠p t√™n ƒë·ª£t tr∆∞·ªõc ƒë√£"); return; }
      let url = `/export/excel-dot?dot=${encodeURIComponent(dot)}`;
      if (khoa) url += `&khoa=${encodeURIComponent(khoa)}`;
      const fname = `tong_dot_${dot}${khoa ? `_khoa_${khoa}` : ""}.xlsx`;
      await fetchFileOrAlert(url, fname, "excel");
    };
    $("btnPrintDot").onclick = async ()=>{
      const dot  = $("dot").value.trim();
      const khoa = $("dotKhoa").value.trim();
      if (!dot){ alert("Nh·∫≠p t√™n ƒë·ª£t tr∆∞·ªõc ƒë√£"); return; }
      let url = `/batch/print-dot?dot=${encodeURIComponent(dot)}`;
      if (khoa) url += `&khoa=${encodeURIComponent(khoa)}`;
      await openPdfOrAlert(url);
    };

    // ===== Sort header bindings =====
    function bindSortHandlers(){
      document.querySelectorAll('.th-sortable').forEach(th=>{
        const key = th.getAttribute('data-sort');
        const handler = ()=> toggleSort(key);
        th.addEventListener('click', handler);
        th.addEventListener('keydown', (e)=>{ if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); handler(); } });
      });
    }

    // ===== Bind search/paging =====
    $("btnSearch").onclick = ()=>{ state.q = $("q").value.trim(); state.page = 1; runSearch(); };
    $("q").addEventListener("keydown", e=>{ if(e.key==="Enter") $("btnSearch").click(); });

    $("pageSize").addEventListener("change", ()=>{
      state.size = Number($("pageSize").value) || 10;
      localStorage.setItem("students.pageSize", String(state.size));
      state.page = 1; runSearch();
    });

    function bindPager(container){
      container.querySelector('.pager-first').onclick = ()=> { state.page = 1; runSearch(); };
      container.querySelector('.pager-prev').onclick  = ()=> { if (state.page > 1) { state.page--; runSearch(); } };
      container.querySelector('.pager-next').onclick  = ()=> { state.page++; runSearch(); };
      container.querySelector('.pager-last').onclick  = ()=> { state.page = pagesTotal(); runSearch(); };
    }
    document.querySelectorAll('.pager').forEach(bindPager);

    // L·ªçc client theo ƒë·ª£t/kh√≥a (debounce)
    ["filterDot","filterKhoa"].forEach(id=>{
      $(id).addEventListener("input", debounce(async ()=>{
        state.page = 1;
        await runSearch();
      }, 250));
    });

    // ===== init =====
    window.addEventListener('load', async () => {
      await ensureLoggedIn();
      await detectComposePage();
      (function checkRestoredFallback(){
        try {
          const id = localStorage.getItem('restored.mssv');
          if (id) {
            deletedMshv.delete(String(id));
            persistDeletedMshv();
            localStorage.removeItem('restored.mssv');
            state.page = 1;
            runSearch();
          }
        } catch(_) {}
      })();
      $("q").focus();
      (function checkPurgedFallback(){
        try {
          const id = localStorage.getItem('purged.mssv');
          if (id) {
            deletedMshv.delete(String(id));
            persistDeletedMshv();
            localStorage.removeItem('purged.mssv');
            state.page = 1;
            runSearch();
          }
        } catch(_) {}
      })();
      const defaultSize = 10;
      $("pageSize").value = String(defaultSize);
      state.size = defaultSize;

      bindSortHandlers();
      if (state.page > 1 && (state.total - 1) % state.size === 0) {
        state.page--;
      }
      await runSearch();
    });

    // l∆∞u base khi s·ª≠a
    $("apiBase").addEventListener("change", ()=>{
      localStorage.setItem(STORAGE_KEY, $("apiBase").value.trim());
    });

    // ENTER to search for ƒê·ª£t / Kh√≥a
    (function bindEnterForFilters(){
      const dotInput  = document.querySelector('#filterDot, #qDot, input[placeholder="L·ªçc theo ƒê·ª£t"]');
      const khoaInput = document.querySelector('#filterKhoa, #qKhoa, input[placeholder="L·ªçc theo Kh√≥a"]');
      function triggerSearch(){ runSearch(); }
      function bindEnter(el){ if (!el) return; el.addEventListener('keydown', (e)=>{ if (e.key === 'Enter'){ e.preventDefault(); triggerSearch(); } }); }
      bindEnter(dotInput); bindEnter(khoaInput);
    })();

    // N√∫t v√†o Journal theo quy·ªÅn
    (async function controlJournalButton(){
      await detectPrefix();
      const link = document.getElementById('journalLink');
      if (!link) return;

      let role = null;
      try {
        const r = await apiFetch('/me');
        if (r && r.ok) {
          const me = await r.json();
          role = me?.role || null;
        }
      } catch (_) {}

      if (role === 'Admin' || role === 'NhanVien') {
        link.hidden = false;
        link.onclick = null;
      } else {
        link.hidden = true;
        link.addEventListener('click', (e)=>{
          e.preventDefault();
          alert('Quy·ªÅn t√†i kho·∫£n kh√¥ng ƒë∆∞·ª£c ph√©p truy c·∫≠p Nh·∫≠t k√Ω.');
        });
      }
    })();

    // √âp link Journal s·∫°ch
    (function forceCleanJournalLink(){
      const link = document.getElementById('journalLink');
      if (!link) return;
      link.href = '/journal.html';
      link.addEventListener('click', (e)=>{
        e.preventDefault();
        window.location.assign('/journal.html');
      });
    })();

    // Live-search cho √¥ #q (H·ªç t√™n / MSHV) ‚Äî kh√¥ng c·∫ßn b·∫•m T√¨m
    $('q').addEventListener('input', debounce(async () => {
      const v = $('q').value.trim();

      // (tu·ª≥ ch·ªçn) ch·ªâ ch·∫°y khi >= 2 k√Ω t·ª±, c√≤n <2 th√¨ xo√° k·∫øt qu·∫£
      if (v.length < 2) {
        state.q = '';
        state.page = 1;
        await runSearch();      // s·∫Ω tr·∫£ v·ªÅ danh s√°ch theo b·ªô l·ªçc kh√°c (ho·∫∑c r·ªóng)
        return;
      }

      state.q = v;
      state.page = 1;
      await runSearch();
    }, 250));


    (function () {
    // ∆Øu ti√™n query expired=1 (khi b·ªã redirect)
    const params = new URLSearchParams(location.search);
    const byQuery = params.get('expired') === '1';

    // Ho·∫∑c cookie c·ªù do BE set
    const byCookie = document.cookie.split(';').some(c => c.trim().startsWith('__session_expired=1'));

    if (byQuery || byCookie) {
      // Hi·ªán th√¥ng b√°o r·ªông r√£i
      if (typeof showToast === 'function') {
        showToast('Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n, vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.', 'warn', 4500);
      } else {
        // Fallback n·∫øu trang kh√¥ng c√≥ showToast
        alert('Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n, vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.');
      }
      // X√≥a cookie c·ªù ƒë·ªÉ kh·ªèi l·∫∑p l·∫°i
      document.cookie = '__session_expired=; Max-Age=0; Path=/; SameSite=Lax';
    }
  })();
  </script>

  <!-- Toast -->
  <div id="toast" class="fixed top-8 left-1/2 -translate-x-1/2 z-[9999] pointer-events-none hidden">
    <div id="toastInner"
      class="px-5 py-3 rounded-xl shadow-xl text-white font-semibold
            bg-rose-600/95 backdrop-blur
            transition-all duration-300 scale-95 opacity-0
            max-w-[90vw] sm:max-w-md text-center">
    </div>
  </div>

  <!-- Modal ch·ªçn l√Ω do c·∫≠p nh·∫≠t -->
  <div id="reasonModal" class="overlay" aria-modal="true" role="dialog">
    <div class="modal max-w-lg">
      <div class="hd">Th√¥ng tin c·∫≠p nh·∫≠t</div>
      <div class="bd space-y-2">
        <label class="text-sm font-medium text-gray-700 block">Vui l√≤ng ch·ªçn l√Ω do:</label>
        <select id="reasonSelect" class="input w-full">
          <option value="">-- Ch·ªçn l·ªánh b·ªï sung --</option>
          <option value="capnhat_thongtin">C·∫≠p nh·∫≠t th√¥ng tin h·ªçc vi√™n</option>
          <option value="capnhat_hoso_moi">C·∫≠p nh·∫≠t h·ªì s∆° m·ªõi</option>
          <option value="bosung_hoso">B·ªï sung h·ªì s∆°</option>
          <option value="capnhat_chungchi">C·∫≠p nh·∫≠t ch·ª©ng ch·ªâ</option>
          <option value="chinhsua_hoso">Ch·ªânh s·ª≠a h·ªì s∆°</option>
          <option value="khac">L√Ω do kh√°c (nh·∫≠p th√™m)</option>
        </select>
        <div id="reasonOtherWrap" class="hidden">
          <label class="text-sm font-medium text-gray-700 block mt-2">Nh·∫≠p l√Ω do kh√°c:</label>
          <input id="reasonOther" class="input w-full" placeholder="Nh·∫≠p l√Ω do c·ª• th·ªÉ..." />
        </div>
      </div>
      <div class="ft">
        <button id="reasonCancel" class="btn btn-outline">H·ªßy</button>
        <button id="reasonOK" class="btn btn-primary">X√°c nh·∫≠n</button>
      </div>
    </div>
  </div>
  
</body>
</html>
