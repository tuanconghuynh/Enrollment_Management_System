<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Danh s√°ch h·ªì s∆° | Admission Check</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
    .card { background:#fff; border-radius:1rem; box-shadow:0 15px 30px rgba(2,6,23,.06); padding:1.25rem; }
    .input { width:100%; border:1px solid #e5e7eb; border-radius:.75rem; padding:.6rem .85rem; outline:none; background:#fff; }
    .input:focus { box-shadow:0 0 0 3px rgba(59,130,246,.25); border-color:#93c5fd; }
    .btn { padding:.55rem 1rem; border-radius:.75rem; box-shadow:0 1px 2px rgba(0,0,0,.06); font-weight:600; transition: transform .05s ease; }
    .btn:hover { transform: translateY(-1px); }
    .btn[disabled] { opacity:.6; cursor:not-allowed; transform:none; }
    .btn-primary { background:#1d4ed8; color:#fff; }
    .btn-outline { background:#fff; border:1px solid #d1d5db; }
    .btn-soft { background:#eff6ff; color:#1e3a8a; }
    .btn-xs { padding:.25rem .5rem; border-radius:.5rem; font-size:.75rem; }
    .btn-pill { border-radius:999px; }
    .table { width:100%; border-collapse: separate; border-spacing:0; }
    .table th, .table td { border-bottom:1px solid #e5e7eb; padding:.6rem .75rem; }
    .table thead th { background:#f8fafc; font-weight:700; position:sticky; top:0; z-index:1; }
    .row-alt:nth-child(odd) td { background:#fafafa; }
    .badge { display:inline-block; padding:.1rem .5rem; border-radius:.5rem; background:#eef2ff; color:#3730a3; font-size:.75rem; }
    .text-muted { color:#9ca3af; }
  </style>
  <link rel="icon" type="image/png" href="hutech.png" sizes="32x32">
  <link rel="apple-touch-icon" href="hutech.png">
  <meta name="theme-color" content="#2563eb">
</head>
<body class="bg-gray-50">
  <div class="max-w-7xl mx-auto p-6 space-y-6">
    <!-- Header -->
    <header class="flex flex-wrap gap-3 items-center justify-between">
      <div class="min-w-0">
        <h1 class="text-2xl font-bold leading-tight">Danh s√°ch h·ªì s∆°</h1>
        <p class="text-sm text-gray-500">Tra c·ª©u nhanh & thao t√°c in/xu·∫•t.</p>
      </div>
      <div class="flex items-center gap-2">
        <label class="text-sm text-gray-500">API Base</label>
        <input id="apiBase" class="input w-52 md:w-72" placeholder="http://192.168.2.82:8000" />
        <span class="hidden md:inline-block w-px h-6 bg-gray-200"></span>

        <!-- User status -->
        <div id="userBox" class="text-sm text-gray-600 flex items-center gap-2">
          <span id="meText" class="hidden">
           ‚úåÔ∏è Xin ch√†o: <b id="meName"></b> (<span id="meRole"></span>)
          </span>
          <a id="loginLink" href="/login" class="btn btn-outline">ƒêƒÉng nh·∫≠p</a>
          <button id="btnLogout" class="btn btn-outline hidden">ƒêƒÉng xu·∫•t</button>
        </div>

        <a class="btn btn-outline" href="/" title="Trang ch√≠nh">‚Üê Trang ch√≠nh</a>
      </div>
    </header>

    <!-- Toolbar -->
    <section class="card space-y-4">
      <!-- H√†ng 1: T√¨m ki·∫øm (gi·ªØa) -->
      <div class="flex justify-center">
        <div class="w-full max-w-2xl flex flex-wrap items-center gap-2">
          <div class="relative flex-1 min-w-[260px]">
            <input id="q" class="input w-full pl-10" placeholder="Nh·∫≠p h·ªç t√™n ho·∫∑c m√£ h·ªì s∆°..." />
            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">üîé</span>
          </div>
          <button id="btnSearch" class="btn btn-outline shrink-0">üîéT√¨m</button>
        </div>
      </div>

      <!-- H√†ng 2: Theo ng√†y + Theo ƒë·ª£t -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <!-- Theo ng√†y -->
        <div class="flex flex-wrap items-center gap-2 min-w-0">
          <input id="day" type="date" class="input w-36 sm:w-40 md:w-44 lg:w-48 flex-none" />
          <button id="btnExportDay" class="btn btn-outline shrink-0" title="Xu·∫•t Excel theo ng√†y">‚¨áÔ∏è Excel</button>
          <button id="btnPrintDay"  class="btn btn-primary shrink-0" title="In PDF g·ªôp theo ng√†y">üñ®Ô∏è PDF</button>
          <p class="w-full text-xs text-gray-500">Theo ng√†y nh·∫≠n h·ªì s∆°.</p>
        </div>

        <!-- Theo ƒë·ª£t (+Kh√≥a) -->
        <div class="flex flex-wrap items-center gap-2 min-w-0">
          <input id="dot" class="input w-24 sm:w-28 md:w-32 flex-none" placeholder="Nh·∫≠p t√™n ƒë·ª£t" title="VD: 1" />
          <input id="dotKhoa" class="input w-24 sm:w-28 md:w-32 flex-none" placeholder="Nh·∫≠p Kh√≥a" title="VD: 27" />
          <button id="btnExportDot" class="btn btn-outline shrink-0" title="Xu·∫•t Excel theo ƒë·ª£t + kh√≥a">‚¨áÔ∏è Excel</button>
          <button id="btnPrintDot"  class="btn btn-primary shrink-0" title="In PDF g·ªôp theo ƒë·ª£t + kh√≥a">üñ®Ô∏è PDF</button>
          <p class="w-full text-xs text-gray-500">L·ªçc theo <b>ƒë·ª£t</b>; n·∫øu c·∫ßn, nh·∫≠p th√™m <b>Kh√≥a</b> ƒë·ªÉ tr√°nh tr√πng.</p>
        </div>
      </div>
    </section>

    <!-- Results -->
    <section class="card space-y-3">
      <div class="flex items-center justify-between flex-wrap gap-2">
        <div class="text-sm text-gray-600">K·∫øt qu·∫£: <span id="count" class="badge">0</span></div>
        <div id="msg" class="text-sm text-gray-600"></div>
      </div>

      <!-- Pagination toolbar -->
      <div class="flex items-center justify-between gap-3">
        <div class="flex items-center gap-2 text-sm">
          <span>Hi·ªÉn th·ªã</span>
          <select id="pageSize" class="input w-24">
            <option>10</option>
            <option selected>20</option>
            <option>50</option>
            <option>100</option>
          </select>
          <span>d√≤ng/trang</span>
        </div>
        <div class="flex items-center gap-1 text-sm">
          <button id="btnFirst" class="btn btn-outline btn-xs" title="Trang ƒë·∫ßu">‚èÆÔ∏è</button>
          <button id="btnPrev"  class="btn btn-outline btn-xs" title="Trang tr∆∞·ªõc">‚è™</button>
          <span id="pageInfo" class="mx-2 min-w-[160px] text-center">Trang 1/1 ‚Ä¢ 0 m·ª•c</span>
          <button id="btnNext"  class="btn btn-outline btn-xs" title="Trang sau">‚è©</button>
          <button id="btnLast"  class="btn btn-outline btn-xs" title="Trang cu·ªëi">‚è≠Ô∏è</button>
        </div>
      </div>

      <div class="overflow-hidden border rounded-xl">
        <div id="emptyState" class="p-10 text-center text-gray-500 hidden">
          <div class="text-4xl mb-2">üìÑ</div>
          <div class="font-semibold">Ch∆∞a c√≥ d·ªØ li·ªáu</div>
          <div class="text-sm">Nh·∫≠p ƒëi·ªÅu ki·ªán v√† b·∫•m <b>T√¨m</b>.</div>
        </div>

        <div id="tableWrap" class="overflow-auto hidden">
          <table class="table min-w-full">
            <thead>
              <tr>
                <th class="text-left">M√£ HS</th>
                <th class="text-left">H·ªç t√™n</th>
                <th class="text-left">MSHV</th>
                <th>Ng√†y nh·∫≠n</th>
                <th class="text-left">Ng√†nh</th>
                <th>ƒê·ª£t</th>
                <th>Kh√≥a</th>
                <th class="text-left">Ng∆∞·ªùi nh·∫≠n</th>
                <th class="text-center">In</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>

        <div id="loading" class="p-8 text-center text-gray-500 hidden">
          <span class="inline-block w-5 h-5 border-2 border-gray-300 border-t-blue-600 rounded-full animate-spin align-[-2px]"></span>
          <span class="ml-2">ƒêang t·∫£i‚Ä¶</span>
        </div>
      </div>
          <div class="ml-auto flex items-center gap-1 text-sm">
          <button id="btnFirst" class="btn btn-outline btn-xs" title="Trang ƒë·∫ßu">‚èÆÔ∏è</button>
          <button id="btnPrev"  class="btn btn-outline btn-xs" title="Trang tr∆∞·ªõc">‚è™</button>
          <span id="pageInfo" class="mx-2 min-w-[160px] text-center">Trang 1/1 ‚Ä¢ 0 m·ª•c</span>
          <button id="btnNext"  class="btn btn-outline btn-xs" title="Trang sau">‚è©</button>
          <button id="btnLast"  class="btn btn-outline btn-xs" title="Trang cu·ªëi">‚è≠Ô∏è</button>
        </div>
    </section>
  </div>
  <footer class="max-w-6xl mx-auto px-6 pb-4 text-right text-xs text-gray-500">
  ¬© <span class="font-semibold">
    <a href="https://hutech.edu.vn/e-hutech" target="_blank" rel="noopener noreferrer">
      V-HT.PTƒêT HUTECH
    </a>
  </span>
  ‚ûñ Code by:
  <span class="font-semibold">
    <a href="http://zalo.me/tuanconghuynh" target="_blank" rel="noopener noreferrer">
      HC- Tuan
    </a>
  </span>
</footer>


  <script>
    // ===== helpers =====
    const $ = id => document.getElementById(id);
    const apiBase = () => $("apiBase").value.trim().replace(/\/+$/,'');
    const PREFIX_CANDIDATES = ["", "/api"];
    let API_PREFIX = "";

    (function initApiBase(){
      const el = $("apiBase");
      if (!el.value) el.value = window.location.origin;
    })();

    async function detectPrefix() {
      for (const p of PREFIX_CANDIDATES) {
        try { const r = await fetch(apiBase() + p + "/health", {credentials:"include"}); if (r.ok) { API_PREFIX = p; return; } } catch(_){}
      }
      API_PREFIX = "";
    }
    const makeUrl = (path) => apiBase() + API_PREFIX + path;

    async function apiFetch(path, init={}){
      const opts = {credentials:"include", ...init};
      let r = await fetch(makeUrl(path), opts);
      if (r.status === 404) {
        const alt = API_PREFIX === "" ? "/api" : "";
        try {
          const r2 = await fetch(apiBase() + alt + path, opts);
          if (r2.ok) { API_PREFIX = alt; return r2; }
          return r2;
        } catch(e){ throw e; }
      }
      return r;
    }

    function fmtDMY(s){
      if(!s) return "";
      const t = String(s).trim();
      if (/^\d{2}\/\d{2}\/\d{4}$/.test(t)) return t;
      const m = t.match(/^(\d{4})-(\d{2})-(\d{2})/);
      if (m) return `${m[3]}/${m[2]}/${m[1]}`;
      const d = new Date(t); if (!isNaN(d)) {
        const dd = String(d.getDate()).padStart(2,"0");
        const mm = String(d.getMonth()+1).padStart(2,"0");
        const yy = d.getFullYear();
        return `${dd}/${mm}/${yy}`;
      }
      return t;
    }

    function setState({loading=false, empty=false}){
      $("loading").classList.toggle("hidden", !loading);
      $("emptyState").classList.toggle("hidden", !empty);
      $("tableWrap").classList.toggle("hidden", loading || empty);
    }

    const dashIfEmpty = (x) =>
      (x && String(x).trim() !== "" ? x : '<span class="text-muted">‚Äî</span>');

    // ===== User status (/me) + quy·ªÅn =====
    async function ensureMe(){
      try{
        await detectPrefix();
        const r = await apiFetch("/me");
        if(!r.ok) throw new Error();
        const me = await r.json();

        $("meName").textContent = me.full_name || me.username || "";
        $("meRole").textContent = me.role || "";
        $("meText").classList.remove("hidden");
        $("btnLogout").classList.remove("hidden");
        $("loginLink").classList.add("hidden");

        // Quy·ªÅn
        const role   = me.role || "";
        const isAdmin = role === "Admin";
        const isStaff = isAdmin || role === "NhanVien";
        const isCTV   = role === "CongTacVien";

        // ·∫®n Excel v·ªõi CTV
        $("btnExportDay")?.classList.toggle("hidden", isCTV);
        $("btnExportDot")?.classList.toggle("hidden", isCTV);

        // (n·∫øu c√≥ c√°c nav kh√°c tr√™n trang)
        $("navImport")?.classList.toggle("hidden", !isStaff);
        $("navAdmin")?.classList.toggle("hidden", !isAdmin);
        $("navStudents")?.classList.toggle("hidden", !(isStaff || isCTV));
      } catch {
        $("meText").classList.add("hidden");
        $("btnLogout").classList.add("hidden");
        $("loginLink").classList.remove("hidden");
        $("btnExportDay")?.classList.add("hidden");
        $("btnExportDot")?.classList.add("hidden");
      }
    }

    // ====== Ph√¢n trang ph√≠a server ======
    const state = {
      q: "",
      page: 1,
      size: Number(localStorage.getItem("students.pageSize") || 20),
      total: 0,
    };

    function pagesTotal(){ return Math.max(1, Math.ceil(state.total / state.size)); }

    function renderRows(items){
      const tbody = $("tbody"); tbody.innerHTML = "";
      items.forEach((it) => {
        const nganh = it.nganh_nhap_hoc ?? it.nganh ?? "";
        const khoa  = it.khoa ?? it.khoa_hoc ?? it.khoahoc ?? "";
        const dot   = it.dot ?? it.dot_tuyen ?? "";
        const nguoi = it.nguoi_nhan_ky_ten ?? it.nguoi_nhan ?? it.nguoi_ky ?? "";

        const tr = document.createElement("tr");
        tr.className = "row-alt";
        tr.setAttribute("data-id", it.id);
        tr.innerHTML = `
          <td class="border-b whitespace-nowrap font-medium">${dashIfEmpty(it.ma_ho_so)}</td>
          <td class="border-b">${dashIfEmpty(it.ho_ten)}</td>
          <td class="border-b">${dashIfEmpty(it.ma_so_hv)}</td>
          <td class="border-b text-center whitespace-nowrap">${dashIfEmpty(fmtDMY(it.ngay_nhan_hs))}</td>
          <td class="border-b" data-cell="nganh">${dashIfEmpty(nganh)}</td>
          <td class="border-b text-center">${dashIfEmpty(dot)}</td>
          <td class="border-b text-center" data-cell="khoa">${dashIfEmpty(khoa)}</td>
          <td class="border-b" data-cell="nguoi">${dashIfEmpty(nguoi)}</td>
          <td class="border-b text-center whitespace-nowrap">
            <div class="inline-flex gap-2">
              <a class="btn btn-soft btn-xs btn-pill"
                 href="${makeUrl(`/print/a5/${it.id}`)}"
                 target="_blank" rel="noopener" title="In A5">A5</a>
              <a class="btn btn-primary btn-xs btn-pill"
                 href="${makeUrl(`/print/a4-two-up/${it.id}`)}"
                 target="_blank" rel="noopener" title="In A4 (2-up)">A4</a>
            </div>
          </td>`;
        tbody.appendChild(tr);
      });
    }

    function updatePagerUI(){
      $("count").textContent = String(state.total);
      $("pageInfo").textContent = `Trang ${state.page}/${pagesTotal()} ‚Ä¢ ${state.total} m·ª•c`;
      $("btnFirst").disabled = state.page <= 1;
      $("btnPrev").disabled  = state.page <= 1;
      $("btnNext").disabled  = state.page >= pagesTotal();
      $("btnLast").disabled  = state.page >= pagesTotal();
    }

    async function hydrateMissing(items){
      const need = (items||[]).filter(it =>
        !(it.nganh_nhap_hoc || it.nganh) ||
        !it.khoa ||
        !(it.nguoi_nhan_ky_ten || it.nguoi_nhan || it.nguoi_ky)
      );
      if (need.length === 0) return;

      const updateCell = (key, id, value) => {
        if (value == null || value === "") return;
        const el = document.querySelector(`[data-id="${id}"] [data-cell="${key}"]`);
        if (el) el.innerHTML = dashIfEmpty(value);
      };

      const tasks = [];
      let idx = 0;
      const worker = async () => {
        while (idx < need.length) {
          const it = need[idx++];
          let r = await apiFetch(`/applicants/by-code/${encodeURIComponent(it.ma_ho_so)}`).catch(()=>null);
          if (!r || !r.ok) r = await apiFetch(`/applicants/${it.id}`).catch(()=>null);
          if (r && r.ok) {
            const data = await r.json();
            const a = data.applicant || data;
            updateCell("nganh", it.id, a.nganh_nhap_hoc || a.nganh);
            updateCell("khoa",  it.id, a.khoa || a.nien_khoa);
            updateCell("nguoi", it.id, a.nguoi_nhan_ky_ten || a.nguoi_nhan || a.nguoi_ky);
          }
        }
      };
      for (let i=0;i<4;i++) tasks.push(worker());
      await Promise.all(tasks);
    }

    async function fetchPage(){
      setState({loading:true});
      const url = `/applicants/search?q=${encodeURIComponent(state.q)}&page=${state.page}&size=${state.size}`;
      const r = await apiFetch(url).catch(()=>null);
      if (!r || !r.ok){
        setState({empty:true});
        $("msg").textContent = `L·ªói t·∫£i d·ªØ li·ªáu (HTTP ${r ? r.status : "???"})`;
        return;
      }
      const data = await r.json(); // {items, page, size, total}
      state.total = data.total || 0;
      renderRows(data.items || []);
      setState({loading:false, empty: (data.items||[]).length===0});
      updatePagerUI();
      hydrateMissing(data.items || []);
    }

    // ===== Export/In ·∫•n theo ng√†y/ƒë·ª£t =====
    $("day").value = new Date().toISOString().slice(0,10);

    $("btnExportDay").onclick = async ()=>{
      const d = $("day").value; if(!d){ alert("Ch·ªçn ng√†y"); return; }
      const resp = await fetch(makeUrl(`/export/excel?day=${d}`), {credentials:"include"});
      if(!resp.ok){ alert(`L·ªói xu·∫•t Excel: HTTP ${resp.status}`); return; }
      const blob = await resp.blob(); const a = document.createElement('a');
      a.href = URL.createObjectURL(blob); a.download = `tong_ngay_${d}.xlsx`;
      document.body.appendChild(a); a.click(); a.remove();
      setTimeout(()=>URL.revokeObjectURL(a.href), 60000);
    };

    $("btnPrintDay").onclick = ()=>{
      const d = $("day").value; if(!d){ alert("Ch·ªçn ng√†y"); return; }
      window.open(makeUrl(`/batch/print?day=${d}`), "_blank");
    };

    $("btnPrintDot").onclick = async () => {
      const dot  = $("dot").value.trim();
      const khoa = $("dotKhoa").value.trim();
      if (!dot) { alert("Nh·∫≠p t√™n ƒë·ª£t tr∆∞·ªõc ƒë√£"); return; }
      let url = `/batch/print-dot?dot=${encodeURIComponent(dot)}`;
      if (khoa) url += `&khoa=${encodeURIComponent(khoa)}`;
      const resp = await fetch(makeUrl(url), {credentials:"include"});
      if (!resp.ok) { alert(`Kh√¥ng th·ªÉ in theo ƒë·ª£t (HTTP ${resp.status})`); return; }
      const blob = await resp.blob();
      const u = URL.createObjectURL(blob);
      window.open(u, "_blank"); setTimeout(()=>URL.revokeObjectURL(u), 60000);
    };

    $("btnExportDot").onclick = async () => {
      const dot  = $("dot").value.trim();
      const khoa = $("dotKhoa").value.trim();
      if (!dot) { alert("Nh·∫≠p t√™n ƒë·ª£t tr∆∞·ªõc ƒë√£"); return; }
      let url = `/export/excel-dot?dot=${encodeURIComponent(dot)}`;
      if (khoa) url += `&khoa=${encodeURIComponent(khoa)}`;
      const resp = await fetch(makeUrl(url), {credentials:"include"});
      if (!resp.ok) { alert(`Kh√¥ng th·ªÉ xu·∫•t Excel theo ƒë·ª£t (HTTP ${resp.status})`); return; }
      const blob = await resp.blob();
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `tong_dot_${dot}${khoa ? `_khoa_${khoa}` : ""}.xlsx`;
      document.body.appendChild(a); a.click(); a.remove();
      setTimeout(()=>URL.revokeObjectURL(a.href), 60000);
    };

    // ===== Events =====
    $("btnSearch").onclick = () => { state.q = $("q").value.trim(); state.page = 1; fetchPage(); };
    $("q").addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ state.q = $("q").value.trim(); state.page = 1; fetchPage(); } });
    $("btnLogout").onclick = async () => {
      try { await apiFetch("/logout", {method:"POST"}); } catch {}
      location.href = "/login";
    };

    $("pageSize").addEventListener("change", () => {
      state.size = Number($("pageSize").value) || 20;
      localStorage.setItem("students.pageSize", state.size);
      state.page = 1;
      fetchPage();
    });
    $("btnFirst").onclick = () => { if (state.page>1){ state.page=1; fetchPage(); } };
    $("btnPrev").onclick  = () => { if (state.page>1){ state.page--; fetchPage(); } };
    $("btnNext").onclick  = () => { if (state.page<pagesTotal()){ state.page++; fetchPage(); } };
    $("btnLast").onclick  = () => { const pt=pagesTotal(); if (state.page<pt){ state.page=pt; fetchPage(); } };

    // init
    (async function(){
      await detectPrefix();
      await ensureMe();
      $("pageSize").value = String(state.size);
      setState({loading:true});
      // load trang 1 (q r·ªóng = l·∫•y t·∫•t c·∫£)
      fetchPage();
    })();
  </script>
</body>
</html>
