<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bi√™n nh·∫≠n h·ªì s∆° nh·∫≠p h·ªçc | V-HT.PTƒêT HUTECH</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="style.css">
  <link rel="icon" type="image/png" href="hutech.png" sizes="32x32">
  <link rel="apple-touch-icon" href="hutech.png">
  <meta name="theme-color" content="#2563eb">
</head>
<body class="bg-gray-50">
  <!-- Toast -->
  <div id="toast-wrap"></div>

  <div class="max-w-6xl mx-auto p-6 space-y-6">
    <header class="flex flex-wrap items-center justify-between border-b border-gray-200 pb-3">
      <!-- Logo + Ti√™u ƒë·ªÅ -->
      <div class="flex items-center gap-3 min-w-0">
        <a href="/index_home.html" class="flex items-center gap-3 hover:opacity-90 transition">
          <img src="hutech.png" alt="HUTECH" class="h-9 w-9 object-contain select-none" />
          <h1 class="text-2xl font-bold leading-none truncate text-blue-700">
            BI√äN NH·∫¨N H·ªí S∆† NH·∫¨P H·ªåC
          </h1>
        </a>
      </div>

      <!-- API / Buttons -->
      <div class="flex flex-wrap items-center gap-2 text-sm">
        <label for="apiBase" class="text-gray-600 font-medium">API Base</label>
        <input id="apiBase" class="input w-64 md:w-80" placeholder="http://..." />
        <button class="btn btn-outline" id="btnTestApi" title="Ki·ªÉm tra k·∫øt n·ªëi API">üîç Test</button>
        <button class="btn btn-outline" id="btnReloadChecklist" title="T·∫£i l·∫°i danh s√°ch checklist">‚Üª Checklist</button>
      </div>
    </header>

    <style>
      header {
        background: rgba(255,255,255,0.85);
        backdrop-filter: blur(6px);
      }
      a:hover img {
        transform: scale(1.05);
        transition: transform 0.2s ease;
      }
    </style>

    <!-- Quick Nav -->
    <nav class="flex flex-wrap items-center gap-2 -mt-2">
      <a id="navHome"    href="/index_home.html" class="btn btn-primary">üè† Trang ch·ªß</a>
      <a id="navStudents" href="/students_list.html" class="btn btn-outline">üìã Danh s√°ch h·ªì s∆°</a>

      <span class="flex-1"></span>

      <span id="navHello" class="text-sm text-gray-600 hidden"></span>
      <a id="navLogin"  href="/login" class="btn btn-outline">Login</a>
      <button id="navLogout" class="btn btn-secondary hidden">LogOut</button>
    </nav>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Form t·∫°o/c·∫≠p nh·∫≠t h·ªì s∆° -->
      <section class="lg:col-span-2 card">
        <div class="section-title">Nh·∫≠p Th√¥ng Tin H·ªì S∆°</div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="label">M√£ h·ªì s∆°</label>
            <input class="input" id="ma_ho_so" placeholder="HS-XXXXX" />
          </div>
          <div>
            <label class="label">Ng√†y nh·∫≠n HS</label>
            <input class="input" id="ngay_nhan_hs" type="date" />
          </div>
          <div>
            <label class="label" for="khoa">Ni√™n Kh√≥a</label>
            <select class="input" id="khoa" name="khoa">
              <option value="">-- Ch·ªçn kh√≥a --</option>
              <option>23</option><option>24</option><option>25</option><option>26</option>
              <option>27</option><option>28</option><option>29</option><option>30</option>
            </select>
          </div>
          <div>
            <label class="label">ƒê·ª£t</label>
            <select class="input" id="dot">
              <option value="">-- Ch·ªçn ƒë·ª£t --</option>
              <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
              <option>6</option><option>7</option><option>8</option><option>9</option><option>10</option>
              <option>11</option><option>12</option><option>13</option><option>14</option><option>15</option>
              <option>16</option><option>17</option><option>18</option><option>19</option><option>20</option>
            </select>
          </div>
        </div>

        <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="label">H·ªç v√† t√™n</label>
            <input class="input" id="ho_ten" />
          </div>
          <div>
            <label class="label">M√£ s·ªë HV</label>
            <input class="input" id="ma_so_hv" />
          </div>
          <div>
            <label class="label">Ng√†y sinh</label>
            <input class="input" id="ngay_sinh" type="date" />
          </div>
          <div>
            <label class="label">S·ªë ƒêT</label>
            <input class="input" id="so_dt" />
          </div>
          <div>
            <label class="label">Email h·ªçc vi√™n</label>
            <input class="input" id="email_hoc_vien" type="email" />
          </div>
          <div>
            <label class="label">Ng√†nh nh·∫≠p h·ªçc</label>
            <select class="input" id="nganh_nhap_hoc">
              <option value="">-- Ch·ªçn ng√†nh --</option>
              <option>T√¢m l√Ω h·ªçc</option>
              <option>Ng√¥n ng·ªØ Anh</option>
              <option>C√¥ng ngh·ªá th√¥ng tin</option>
              <option>Qu·∫£n tr·ªã kinh doanh</option>
              <option>K·∫ø to√°n</option>
              <option>Lu·∫≠t kinh t·∫ø</option>
              <option>Qu·∫£n l√Ω x√¢y d·ª±ng</option>
              <option>T√†i ch√≠nh - Ng√¢n h√†ng</option>
              <option>Marketing</option>
            </select>
          </div>
          <div>
            <label class="label">ƒê√£ TN tr∆∞·ªõc ƒë√≥</label>
            <select class="input" id="da_tn_truoc_do">
              <option value="">-- Ch·ªçn ƒê·ªëi t∆∞·ª£ng --</option>
              <option>THPT</option><option>Trung c·∫•p</option><option>Cao ƒë·∫≥ng</option><option>ƒê·∫°i h·ªçc</option>
            </select>
          </div>
          <div>
            <label class="label">Ng∆∞·ªùi nh·∫≠n (Ch·ªØ k√Ω)</label>
            <div class="relative">
              <input
                id="nguoi_nhan_ky_ten"
                class="input pr-9 bg-gray-100 text-gray-500 cursor-not-allowed"
                readonly
                title="T·ª± ƒë·ªông l·∫•y theo t√†i kho·∫£n ƒëƒÉng nh·∫≠p"
              />
              <span class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 select-none" title="ƒê√£ kh√≥a">üîí</span>
            </div>
          </div>
        </div>

        <!-- Checklist -->
        <div class="mt-6">
          <div class="section-title">H·ªì s∆° g·ªìm:</div>
          <div class="overflow-auto">
            <table class="min-w-full border bg-white">
              <thead class="bg-gray-100">
                <tr>
                  <th class="p-2 border">STT</th>
                  <th class="p-2 border text-center">Danh m·ª•c</th>
                  <th class="p-2 border">C√≥?</th>
                  <th class="p-2 border">S·ªë l∆∞·ª£ng</th>
                </tr>
              </thead>
              <tbody id="docsBody"></tbody>
            </table>
          </div>
        </div>
        <!-- üÜï Ghi ch√∫ ƒë·∫∑t d∆∞·ªõi b·∫£ng -->
        <div class="mt-4">
          <label class="label">Ghi ch√∫</label>
          <input class="input" id="ghi_chu" />
        </div>

        <div class="mt-6 flex gap-3 flex-wrap items-center">
          <button id="btnSave" class="btn btn-secondary">L∆∞u</button>
          <button id="btnUpdateApplicantMain" class="btn btn-secondary">C·∫≠p nh·∫≠t</button>
        </div>
        <div id="msg" class="mt-3 text-sm text-green-700"></div>
      </section>

      <!-- Panel ph·∫£i -->
      <aside class="card space-y-6 lg:sticky lg:top-4">
        <!-- Tra c·ª©u & Ch·ªânh s·ª≠a -->
        <section>
          <div class="section-title">Tra c·ª©u & Ch·ªânh s·ª≠a h·ªì s∆°</div>

          <label class="label">Nh·∫≠p M√£ S·ªë H·ªçc Vi√™n</label>
          <div class="flex gap-2">
            <input class="input flex-1" id="q_ma_so_hv" placeholder="VD: 2510xxxxxx" />
            <button id="btnLoadApplicantMSHV" class="btn btn-outline">T·∫£i</button>
          </div>

          <label class="label mt-3 block">Ho·∫∑c Nh·∫≠p H·ªç v√† t√™n</label>
          <div class="flex gap-2">
            <input class="input flex-1" id="q_ho_ten" placeholder="VD: Nguy·ªÖn VƒÉn A" />
            <button id="btnSearchByName" class="btn btn-outline">T√¨m</button>
          </div>

          <div id="nameResults" class="mt-2 hidden">
            <div class="text-xs text-gray-500 mb-1">Ch·ªçn m·ªôt k·∫øt qu·∫£ ƒë·ªÉ t·∫£i v√†o form:</div>
            <ul id="nameResultsList" class="divide-y border rounded-md bg-white"></ul>
          </div>

          <div class="grid grid-cols-2 gap-2 mt-3">
            <button id="btnUpdateApplicant" class="btn btn-secondary">C·∫≠p nh·∫≠t</button>
            <button id="btnDeleteApplicant" class="btn btn-outline">Xo√°</button>
          </div>
        </section>

        <!-- In h·ªì s∆° ƒëang m·ªü -->
        <section id="sectionPrintLoaded" class="mt-2">
          <div class="flex gap-2">
            <button id="btnPrintLoadedA5" class="btn btn-outline" disabled>In A5</button>
            <button id="btnPrintLoadedA4" class="btn btn-outline" disabled>In A4</button>
          </div>
          <p id="lookupMsg" class="text-sm text-gray-600 mt-2"></p>
        </section>

        <hr/>

        <section>
          <div class="section-title"><center>TR·ª¢ GI√öP</center></div>
          <ul class="list-disc ml-5 text-sm text-gray-600 space-y-1">
            <li>Ch·ªçn API Base r·ªìi nh·∫•n n√∫t Test cho l·∫ßn ƒë·∫ßu ho·∫∑c khi ƒë·ªïi server.</li>
            <li>Nh·∫•n n√∫t ‚Üª ƒë·ªÉ t·∫£i l·∫°i danh s√°ch h·ªì s∆° v√† checklist t·ª´ server.</li>
            <li>ƒê·ªïi API Base ·ªü g√≥c tr√™n n·∫øu b·∫°n deploy n∆°i kh√°c.</li>
            <li>PDF m·ªü trong tab m·ªõi; n·∫øu b·ªã ch·∫∑n s·∫Ω m·ªü ngay t·∫°i tab.</li>
            <li>T√¨m ki·∫øm theo <b>M√£ s·ªë HV</b> ho·∫∑c <b>H·ªç t√™n</b>.</li>
            <li>ƒê·ªÉ tr·ªëng s·ªë l∆∞·ª£ng trong checklist ƒë·ªÉ ƒë√°nh d·∫•u c√≥/kh√¥ng.</li>
            <li>Li√™n h·ªá Email: <a href="mailto:hc.tuan@hutech.edu.vn">hc.tuan@hutech.edu.vn</a></li>
            <li>Li√™n h·ªá zalo: <a href="http://zalo.me/tuanconghuynh">Hu·ª≥nh C√¥ng Tu·∫•n T·∫°i ƒë√¢y!</a></li>
          </ul>
        </section>
      </aside>
    </div>
  </div>

  <footer class="max-w-6xl mx-auto px-6 pb-4 text-right text-xs text-gray-500">
    ¬© <span class="font-semibold">
      <a href="https://hutech.edu.vn/e-hutech" target="_blank" rel="noopener noreferrer">V-HT.PTƒêT HUTECH</a>
    </span>
    ‚ûñ Code by:
    <span class="font-semibold">
      <a href="http://zalo.me/tuanconghuynh" target="_blank" rel="noopener noreferrer">HC- Tuan</a>
    </span>
  </footer>

  <!-- Modal Xo√° l√Ω do (center) -->
  <div id="modalDel" class="fixed inset-0 bg-slate-900/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-2xl shadow-2xl w-[92vw] max-w-xl">
      <div class="px-5 py-4 border-b flex items-center justify-between">
        <div class="font-semibold">Xo√° h·ªì s∆°</div>
        <button id="mdClose" class="btn btn-outline btn-xs">ƒê√≥ng</button>
      </div>
      <div class="p-5 space-y-3">
        <div id="mdTitle" class="text-sm text-slate-700"></div>
        <label class="text-sm font-semibold text-gray-800 block mb-1">L√Ω do xo√° (b·∫Øt bu·ªôc)</label>
        <textarea id="mdReason" rows="4" class="input w-full" placeholder="Nh·∫≠p l√Ω do..."></textarea>
      </div>
      <div class="px-5 py-4 border-t flex justify-end gap-2">
        <button id="mdCancel" class="btn btn-outline">H·ªßy</button>
        <button id="mdOK" class="btn btn-secondary">OK</button>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script>
  // ·∫®n trang trong l√∫c ki·ªÉm tra ƒëƒÉng nh·∫≠p
  document.documentElement.style.visibility = 'hidden';

  (async () => {
    const base = location.origin.replace(/\/+$/, '');
    const candidates = ["", "/api"];
    let ok = false, matchedPrefix = "";
    for (const p of candidates) {
      try {
        const r = await fetch(base + p + "/me", { credentials: "include", cache: "no-store" });
        if (r.ok) { ok = true; matchedPrefix = p; break; }
      } catch (_) {}
    }
    if (!ok) { const next = encodeURIComponent(location.pathname + location.search); location.replace(`/login?next=${next}`); return; }
    try { localStorage.setItem("apiBase", base); } catch {}
    window.__API_PREFIX = matchedPrefix;
    document.documentElement.style.visibility = '';
  })();

  // ========= helpers =========
  const $ = (id) => document.getElementById(id);

  // Toast (center-top)
  function showToast(msg, type='info', ms=2500){
    const wrap = document.getElementById('toast-wrap');
    if (!wrap) return;

    // Gi·ªõi h·∫°n t·ªëi ƒëa 3 toast ƒëang hi·ªán
    const existing = wrap.querySelectorAll('.toast');
    if (existing.length >= 3) existing[0].remove();

    const el = document.createElement('div');
    el.className = `toast ${type}`;
    el.setAttribute('role','status');
    el.innerHTML = msg;

    wrap.appendChild(el);
    requestAnimationFrame(()=> el.classList.add('show'));

    const t = setTimeout(()=>dismiss(), ms);

    function dismiss(){
      el.classList.remove('show');
      el.addEventListener('transitionend', ()=> el.remove(), {once:true});
    }
    el.onclick = ()=> { clearTimeout(t); dismiss(); };
  }


  // Date utils
  function ymdToDMY_SLASH(s){ if(!s) return ""; const m=String(s).match(/^(\d{4})-(\d{2})-(\d{2})$/); return m?`${m[3]}/${m[2]}/${m[1]}`:s; }
  const ymdKeep = (s)=> (s||"").slice(0,10);
  function fmtDateToInput(s){
    if(!s) return "";
    const m = String(s).match(/^(\d{1,2})[\/-](\d{1,2})[\/-](\d{4})$/);
    if (m) return `${m[3]}-${m[2].padStart(2,'0')}-${m[1].padStart(2,'0')}`;
    const d = new Date(s); return Number.isNaN(d.getTime()) ? String(s).slice(0,10) : d.toISOString().slice(0,10);
  }

  // API base / prefix
  const STORAGE_KEY="apiBase"; let API_PREFIX = window.__API_PREFIX || "";
  function apiBase(){ return ($("apiBase").value || localStorage.getItem(STORAGE_KEY) || window.location.origin).trim().replace(/\/+$/,''); }
  async function pingPrefix(base){ try{let r=await fetch(base+"/health",{credentials:"include"}); if(r.ok) return "";}catch(_){ } try{let r2=await fetch(base+"/api/health",{credentials:"include"}); if(r2.ok) return "/api";}catch(_){ } return null; }
  async function ensureApiBaseAndPrefix(){
    let base = localStorage.getItem(STORAGE_KEY) || window.location.origin; $("apiBase").value = base;
    let pref = await pingPrefix(base); if (pref !== null){ API_PREFIX=pref; return; }
    const guesses=[base, window.location.origin, "http://127.0.0.1:8000", "http://localhost:8000"];
    for (const g of guesses){ const p = await pingPrefix(g); if (p !== null){ $("apiBase").value=g; localStorage.setItem(STORAGE_KEY,g); API_PREFIX=p; return; } }
    for(;;){ const m = prompt("Kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c API.\nNh·∫≠p IP/URL server (vd: http://192.168.2.82:8000):", base); if(!m) break; const p=await pingPrefix(m.trim()); if(p!==null){ $("apiBase").value=m.trim(); localStorage.setItem(STORAGE_KEY,m.trim()); API_PREFIX=p; return; } base=m.trim(); }
    API_PREFIX="";
  }
  const makeUrl = (path)=> apiBase() + (API_PREFIX || "") + path;
  async function apiFetch(path, init={}){ const opts={credentials:"include", ...init}; let r=await fetch(makeUrl(path), opts).catch(()=>null); return r; }
  function handleAuth(r){ if(r && (r.status===401||r.status===403)){ showToast("Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n, vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.","warn",2500); setTimeout(()=>location.href="/login",700); return true; } return false; }
  const safeJson = async (r)=>{ try{ return await r.json(); }catch{ return {}; } };

  // ====== NAV / Auth UI ======
  async function refreshAuthUI(){
    try{
      const r = await apiFetch('/me', { credentials:'include' });
      if (!r || !r.ok){
        ["navHello"].forEach(id=>$(id)?.classList.add("hidden"));
        $("navLogin")?.classList.remove("hidden");
        $("navLogout")?.classList.add("hidden");
        return;
      }
      const me = await r.json();
      const role = me.role || "";

      $("navHello").textContent = `Xin ch√†o, ${me.full_name || me.username} (${role})`;
      $("navHello").classList.remove("hidden");
      $("navLogin")?.classList.add("hidden");
      $("navLogout")?.classList.remove("hidden");
    }catch(_){
      ["navHello"].forEach(id=>$(id)?.classList.add("hidden"));
      $("navLogin")?.classList.remove("hidden");
      $("navLogout")?.classList.add("hidden");
    }
  }

  $("navLogout")?.addEventListener("click", async ()=>{ try{ await apiFetch('/logout', { method:'POST', credentials:'include' }); }catch(_){ } location.href='/login'; });

  // ===== Checklist =====
  const DEFAULT_QTY = { bang_tot_nghiep_dai_hoc:2, bang_diem_dai_hoc:2, bang_tot_nghiep_cao_dang:2, bang_diem_cao_dang:2, bang_tot_nghiep_trung_cap:2, bang_diem_trung_cap:2, anh_3x4:2 };
  const getDefaultQty = (code) => DEFAULT_QTY[code] ?? 1;

  async function loadChecklist() {
    try {
      const r = await apiFetch("/checklist/active");
      if (!r || !r.ok) { showToast("Kh√¥ng l·∫•y ƒë∆∞·ª£c checklist", "error"); return; }
      const data = await r.json();
      const body = $("docsBody"); body.innerHTML = "";
      (data.items||[])
        .sort((a,b)=> (a.order_index ?? a.order_no ?? 0) - (b.order_index ?? b.order_no ?? 0))
        .forEach((it, idx) => {
          const def = getDefaultQty(it.code);
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td class="p-2 border text-center">${idx+1}</td>
            <td class="p-2 border"><div class="font-medium">${it.display_name}</div></td>
            <td class="p-2 border text-center"><input type="checkbox" class="w-5 h-5 has-doc" data-code="${it.code}"></td>
            <td class="p-2 border text-center"><input type="number" min="0" class="input w-24 text-center qty bg-gray-100 text-gray-400" data-code="${it.code}" value="" placeholder="${def}" disabled /></td>`;
          body.appendChild(tr);
        });
      document.querySelectorAll('.has-doc').forEach((chk) => {
        const code = chk.dataset.code; const qty = document.querySelector(`.qty[data-code="${code}"]`); const def = getDefaultQty(code);
        chk.addEventListener("change", () => {
          if (chk.checked) { qty.value = String(def); qty.disabled=false; qty.classList.remove("bg-gray-100","text-gray-400"); }
          else { qty.value=""; qty.disabled=true; qty.classList.add("bg-gray-100","text-gray-400"); }
        });
      });
    } catch (err) { console.error(err); showToast('L·ªói t·∫£i checklist', 'error'); }
  }

  function collectDocs() {
    const rows = Array.from(document.querySelectorAll('#docsBody tr'));
    return rows.map(tr => {
      const chk  = tr.querySelector('.has-doc');
      const qtyI = tr.querySelector('.qty');
      const code = chk.dataset.code;
      const def  = getDefaultQty(code);
      let val = chk.checked ? Number(qtyI.value || def) : 0;
      if (!Number.isFinite(val) || val < 0) val = 0;
      return { code, so_luong: val };
    });
  }

  // ===== Payloads =====
  function payloadForCreate() {
    return {
      ma_ho_so: $("ma_ho_so").value.trim(),
      ngay_nhan_hs: ymdToDMY_SLASH($("ngay_nhan_hs").value),
      ho_ten: $("ho_ten").value.trim(),
      ma_so_hv: $("ma_so_hv").value.trim(),
      ngay_sinh: ymdToDMY_SLASH($("ngay_sinh").value) || null,
      so_dt: $("so_dt").value.trim() || null,
      email_hoc_vien: $("email_hoc_vien").value.trim() || null,
      nganh_nhap_hoc: $("nganh_nhap_hoc").value.trim() || null,
      dot: $("dot").value.trim() || null,
      khoa: $("khoa").value.trim() || null,
      da_tn_truoc_do: $("da_tn_truoc_do").value || null,
      ghi_chu: $("ghi_chu").value.trim() || null,
      nguoi_nhan_ky_ten: $("nguoi_nhan_ky_ten").value.trim() || null,
      docs: collectDocs(),
      checklist_version_name: "v1"
    };
  }
  function payloadForUpdate() {
    return {
      ma_ho_so: $("ma_ho_so").value.trim(),
      ngay_nhan_hs: ymdKeep($("ngay_nhan_hs").value),
      ho_ten: $("ho_ten").value.trim(),
      ma_so_hv: $("ma_so_hv").value.trim(),
      ngay_sinh: ymdKeep($("ngay_sinh").value) || null,
      so_dt: $("so_dt").value.trim() || null,
      email_hoc_vien: $("email_hoc_vien").value.trim() || null,
      nganh_nhap_hoc: $("nganh_nhap_hoc").value.trim() || null,
      dot: $("dot").value.trim() || null,
      khoa: $("khoa").value.trim() || null,
      da_tn_truoc_do: $("da_tn_truoc_do").value || null,
      ghi_chu: $("ghi_chu").value.trim() || null,
      nguoi_nhan_ky_ten: $("nguoi_nhan_ky_ten").value.trim() || null,
      docs: collectDocs()
    };
  }

  // ===== Lookup / Update / Delete =====
  let loadedDocsByCode = {};
  function setPrintButtonsEnabled(on) {
    $("btnPrintLoadedA5").disabled = !on;
    $("btnPrintLoadedA4").disabled = !on;
  }

  function populateFormFromApplicant(a, docs){
    $("ma_ho_so").value = a.ma_ho_so || "";
    $("ngay_nhan_hs").value = fmtDateToInput(a.ngay_nhan_hs);
    $("khoa").value = a.khoa || "";
    $("ho_ten").value = a.ho_ten || "";
    $("ma_so_hv").value = a.ma_so_hv || "";
    $("ngay_sinh").value = fmtDateToInput(a.ngay_sinh);
    $("so_dt").value = a.so_dt || "";
    $("email_hoc_vien").value = a.email_hoc_vien || "";
    $("nganh_nhap_hoc").value = a.nganh_nhap_hoc || "";
    $("dot").value = a.dot || "";
    $("da_tn_truoc_do").value = a.da_tn_truoc_do || "";
    $("ghi_chu").value = a.ghi_chu || "";
    $("nguoi_nhan_ky_ten").value = a.nguoi_nhan_ky_ten || "";

    loadedDocsByCode = {}; (docs||[]).forEach(d => loadedDocsByCode[d.code] = d.so_luong || 0);
    const applyDocsToTable = () => {
      document.querySelectorAll('.has-doc').forEach(chk => {
        const code = chk.dataset.code; const qty = document.querySelector(`.qty[data-code="${code}"]`);
        const n = loadedDocsByCode[code] ?? 0;
        if (n > 0) { chk.checked = true; qty.disabled=false; qty.classList.remove("bg-gray-100","text-gray-400"); qty.value = String(n); }
        else { chk.checked = false; qty.disabled=true; qty.classList.add("bg-gray-100","text-gray-400"); qty.value = ""; }
      });
    };
    if (document.querySelectorAll('#docsBody tr').length === 0) loadChecklist().then(applyDocsToTable); else applyDocsToTable();
  }

  async function loadApplicantByMSHV(mshv){
    let r = await apiFetch(`/applicants/by-mshv/${encodeURIComponent(mshv)}`);
    if (!r || r.status === 404 || r.status === 405) {
      const rs = await apiFetch(`/applicants/search?q=${encodeURIComponent(mshv)}`);
      if (rs && rs.ok) {
        const j = await rs.json();
        const list = Array.isArray(j.items) ? j.items : (Array.isArray(j) ? j : []);
        const hit = list.find(x => (x.ma_so_hv || "").toLowerCase() === String(mshv).toLowerCase()) || list[0];
        if (hit) r = await apiFetch(`/applicants/by-code/${encodeURIComponent(hit.ma_ho_so)}`);
      }
    }
    if (!r || !r.ok) {
      if (r && r.status === 404) showToast(`Kh√¥ng t√¨m th·∫•y MSHV ${mshv}`, "warn");
      const t = r ? await r.text() : "(kh√¥ng ph·∫£n h·ªìi)";
      throw new Error(`L·ªói t·∫£i h·ªì s∆° (HTTP ${r ? r.status : '???'})\n${t}`);
    }
    const data = await r.json();
    return (data && data.applicant) ? { ...data.applicant, docs: data.docs || [] } : data;
  }

  async function updateLoadedApplicant(){
    if(!window.loadedApplicant?.ma_so_hv) throw new Error("Ch∆∞a t·∫£i h·ªì s∆° n√†o ƒë·ªÉ c·∫≠p nh·∫≠t.");
    const body = payloadForUpdate();
    if(!body.ma_ho_so || !body.ho_ten) throw new Error("Thi·∫øu M√£ h·ªì s∆° / H·ªç t√™n.");
    const r = await apiFetch(`/applicants/${encodeURIComponent(window.loadedApplicant.ma_so_hv)}`, {
      method: "PUT", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(body)
    });
    if (handleAuth(r)) return;
    if(!r || !r.ok){ const t = r ? await r.text() : "(kh√¥ng ph·∫£n h·ªìi)"; throw new Error(`C·∫≠p nh·∫≠t th·∫•t b·∫°i (HTTP ${r ? r.status : '???'})\n${t}`); }
    const res = await r.json();
    window.loadedApplicant.ma_ho_so = res.ma_ho_so || body.ma_ho_so;
    return res;
  }

  // ===== Modal h·ªèi l√Ω do xo√° =====
  function askDeleteReason(title, defText=""){
    return new Promise((resolve)=>{
      const wrap = document.getElementById('modalDel');
      const titleEl = document.getElementById('mdTitle');
      const input = document.getElementById('mdReason');
      const ok = document.getElementById('mdOK');
      const cancel = document.getElementById('mdCancel');
      const close = document.getElementById('mdClose');

      titleEl.textContent = title || "Xo√° h·ªì s∆° n√†y?";
      input.value = defText || "";
      wrap.classList.remove('hidden');
      wrap.classList.add('flex');
      input.focus();

      const done = (v)=>{ wrap.classList.add('hidden'); wrap.classList.remove('flex'); ok.onclick=cancel.onclick=close.onclick=null; resolve(v); };
      ok.onclick = ()=>{ const v = (input.value||"").trim(); if(!v){ input.focus(); return; } done(v); };
      cancel.onclick = ()=> done(null);
      close.onclick = ()=> done(null);
      wrap.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ e.preventDefault(); done(null); } });
    });
  }

  async function clearForm(){
    ["ma_ho_so","ngay_nhan_hs","khoa","ho_ten","ma_so_hv","ngay_sinh","so_dt","email_hoc_vien","nganh_nhap_hoc","dot","da_tn_truoc_do","ghi_chu"].forEach(id=>{ const el=$(id); if(!el) return; if(el.type==='checkbox') el.checked=false; else el.value=""; });
    document.querySelectorAll('.has-doc').forEach(chk=>{ chk.checked=false; });
    document.querySelectorAll('.qty').forEach(q=>{ q.value=""; q.disabled=true; q.classList.add("bg-gray-100","text-gray-400"); });
  }

  function resetToNewForm(){
    const today = new Date().toISOString().slice(0,10);
    clearForm();
    $("ngay_nhan_hs").value = today;           // ƒëi·ªÅn l·∫°i h√¥m nay cho nhanh thao t√°c
    // gi·ªØ nguy√™n ng∆∞·ªùi nh·∫≠n ƒë√£ ƒë∆∞·ª£c set theo t√†i kho·∫£n
    // reset tr·∫°ng th√°i
    window.loadedApplicant = null;
    setPrintButtonsEnabled(false);
    $("lookupMsg").textContent = "";
    $("msg").textContent = "";
    document.getElementById('nameResults')?.classList.add('hidden');
  }

  // --- S·ª≠a handler L∆ØU:
  $("btnSave").onclick = async () => {
    const btn = $("btnSave");
    btn.disabled = true; const old = btn.textContent; btn.textContent = "ƒêang l∆∞u...";
    try{
      const res = await createApplicant();
      if (res) {
        showToast(`ƒê√£ l∆∞u h·ªì s∆° <b>${res.ma_so_hv || $("ma_so_hv").value}</b>.`, "success");
        $("msg").textContent = `ƒê√£ l∆∞u h·ªì s∆° ${res.ma_ho_so || $("ma_so_hv").value}.`;
        resetToNewForm(); // üÜï tr·∫£ form v·ªÅ tr·∫Øng
      }
    } finally{ btn.disabled = false; btn.textContent = old; }
  };

  // --- S·ª≠a handler C·∫¨P NH·∫¨T (c·∫£ 2 n√∫t Update):
  ["btnUpdateApplicant", "btnUpdateApplicantMain"].forEach(id=>{
    $(id)?.addEventListener("click", async () => {
      try{
        $("lookupMsg").textContent = "ƒêang c·∫≠p nh·∫≠t...";
        const res = await updateLoadedApplicant();
        if (res?.nguoi_nhan_ky_ten) $("nguoi_nhan_ky_ten").value = res.nguoi_nhan_ky_ten;
        showToast(`ƒê√£ c·∫≠p nh·∫≠t h·ªì s∆° <b>${res.ma_ho_so}</b>`, "success");
        $("lookupMsg").textContent = `C·∫≠p nh·∫≠t xong h·ªì s∆° ${res.ma_ho_so}.`;
        resetToNewForm(); // üÜï tr·∫£ form v·ªÅ tr·∫Øng
      } catch(e){
        $("lookupMsg").textContent = e.message;
        showToast(e.message || "C·∫≠p nh·∫≠t th·∫•t b·∫°i!", "error");
      }
    });
  });


  async function createApplicant(){
    const body = payloadForCreate();
    if(!body.ma_ho_so || !body.ho_ten || !body.ma_so_hv || !body.ngay_nhan_hs){
      showToast("Thi·∫øu M√£ h·ªì s∆° / H·ªç t√™n / MSHV / Ng√†y nh·∫≠n.", "error"); return null;
    }
    const r = await apiFetch("/applicants", { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(body) });
    if (handleAuth(r)) return null;
    const j = await safeJson(r);
    if (!r || !r.ok){ showToast(j.detail || `L·ªói l∆∞u (HTTP ${r ? r.status : '???'})`, "error", 4000); return null; }
    window.loadedApplicant = { ma_so_hv: j.ma_so_hv || body.ma_so_hv, ma_ho_so: j.ma_ho_so || body.ma_ho_so };
    setPrintButtonsEnabled(true);
    return j;
  }

  async function deleteLoadedApplicant(){
    if(!window.loadedApplicant?.ma_so_hv) { showToast("Ch∆∞a t·∫£i h·ªì s∆° n√†o ƒë·ªÉ xo√°.", "warn"); return; }
    const mshv = window.loadedApplicant.ma_so_hv;
    const reason = await askDeleteReason(`Xo√° t·∫°m h·ªì s∆° MSHV ${mshv}?`, "");
    if (reason === null) return;

    const r = await apiFetch(`/applicants/${encodeURIComponent(mshv)}`, {
      method: "DELETE",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify({ reason })
    });
    if (handleAuth(r)) return;

    if (r && r.status === 204){
      window.loadedApplicant = null; loadedDocsByCode = {};
      setPrintButtonsEnabled(false);
      await clearForm();
      $("lookupMsg").textContent = "ƒê√£ xo√° h·ªì s∆°.";
      showToast("ƒê√£ xo√° h·ªì s∆° v√† ghi v√†o nh·∫≠t k√Ω.", "success");
      return;
    }

    let msg = `Xo√° th·∫•t b·∫°i (HTTP ${r ? r.status : '???'})`;
    try { const t = await r.text(); const j = JSON.parse(t); if (j?.detail) msg = j.detail; } catch(_){}
    showToast(msg, "error", 4000);
  }

  // ===== T√¨m theo t√™n =====
  async function searchByName(name) {
    const q = String(name || "").trim().replace(/\s+/g, " ");
    if (q.length < 2) throw new Error("Nh·∫≠p t·ªëi thi·ªÉu 2 k√Ω t·ª± ƒë·ªÉ t√¨m theo t√™n.");

    const urls = [
      `/applicants/search?q=${encodeURIComponent(q)}`,
      `/applicants/search?name=${encodeURIComponent(q)}`,
      `/applicants/search?full_name=${encodeURIComponent(q)}`,
      `/applicants/by-name?q=${encodeURIComponent(q)}`,
    ];
    const readJson = async (r) => { try { return await r.json(); } catch { return null; } };

    let lastErrText = "";
    for (const u of urls) {
      const r = await apiFetch(u);
      if (!r) continue;
      if (r.status === 401 || r.status === 403) { handleAuth(r); return []; }
      if (!r.ok) { try { lastErrText = await r.text(); } catch {} ; continue; }

      const j = await readJson(r);
      if (!j) continue;

      let list = [];
      if (Array.isArray(j)) list = j;
      else if (Array.isArray(j.items)) list = j.items;
      else if (Array.isArray(j.data))  list = j.data;
      else if (Array.isArray(j.results)) list = j.results;
      else if (j.items && j.items.data && Array.isArray(j.items.data)) list = j.items.data;

      list = (list || []).map(it => ({
        ho_ten: it.ho_ten || it.full_name || it.ten || "",
        ma_ho_so: it.ma_ho_so || it.code || it.ma_hs || "",
        ma_so_hv: it.ma_so_hv || it.mssv || it.mshv || "",
        ngay_nhan_hs: it.ngay_nhan_hs || it.created_at || it.ngay || null,
        dot: it.dot || it.dot_tuyen || "",
      }));
      if (list.length) return list;
    }
    if (lastErrText) console.warn("Name search last error:", lastErrText);
    return [];
  }

  function vnNorm(s){ return (s||"").normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/ƒë/g,'d').replace(/ƒê/g,'D').trim().toLowerCase(); }
  function matchScore(name, query){
    const a=vnNorm(name), b=vnNorm(query); if(!a||!b) return 0;
    if (a===b) return 100; if (a.startsWith(b)) return 90; if (a.includes(b)) return 70;
    const toks=b.split(/\s+/).filter(Boolean); return toks.every(t=>a.includes(t)) ? 60 : 0;
  }
  function filterAndSortByName(list, q, limit=20){
    const scored=(list||[]).map(it=>({it, score:matchScore(it.ho_ten||it.full_name||it.ten||'', q)})).filter(x=>x.score>0);
    scored.sort((p,q)=>q.score-p.score); return scored.slice(0,limit).map(x=>x.it);
  }
  function renderNameResults(list){
    list = Array.isArray(list) ? list : (Array.isArray(list?.items) ? list.items : []);
    const box = $("nameResults"); const ul = $("nameResultsList"); if(!box||!ul) return;
    if(!list || list.length===0){ box.classList.remove("hidden"); ul.innerHTML='<li class="p-2 text-sm text-gray-500">Kh√¥ng t√¨m th·∫•y.</li>'; return; }
    ul.innerHTML = list.map(it => {
      const ngay = it.ngay_nhan_hs ? String(it.ngay_nhan_hs).slice(0,10) : '';
      return `
        <li class="p-2 hover:bg-gray-50 cursor-pointer" data-mshv="${it.ma_so_hv||''}">
          <div class="flex justify-between">
            <div class="font-medium">${it.ho_ten||it.full_name||""}</div>
            <div class="text-xs text-gray-500">${ngay}</div>
          </div>
          <div class="text-xs text-gray-600">
            M√£ HS: <span class="font-semibold">${it.ma_ho_so||it.code||""}</span>
            ‚Ä¢ MSHV: ${it.ma_so_hv||it.mssv||it.mshv||''}
            ‚Ä¢ ƒê·ª£t: ${it.dot||it.dot_tuyen||''}
          </div>
        </li>`;
    }).join("");
    if (!ul._boundClick) {
      ul.addEventListener('click', (e)=>{ const li=e.target.closest('li[data-mshv]'); if(!li) return; $("q_ma_so_hv").value = li.dataset.mshv || ''; box.classList.add('hidden'); $("btnLoadApplicantMSHV")?.click(); });
      ul._boundClick = true;
    }
    box.classList.remove('hidden');
  }

  // ===== In h·ªì s∆° ƒëang m·ªü =====
  function openPdf(url){
    const w = window.open(url, "_blank");
    if (!w) window.location.href = url;
  }

  $("btnPrintLoadedA5").onclick = () => {
    if (!window.loadedApplicant?.ma_so_hv) { showToast("Ch∆∞a t·∫£i h·ªì s∆° n√†o.", "warn"); return; }
    showToast("ƒêang m·ªü PDF A5‚Ä¶", "info", 1800);
    openPdf(makeUrl(`/print/a5/${encodeURIComponent(window.loadedApplicant.ma_so_hv)}`));
  };

  $("btnPrintLoadedA4").onclick = () => {
    if (!window.loadedApplicant?.ma_so_hv) { showToast("Ch∆∞a t·∫£i h·ªì s∆° n√†o.", "warn"); return; }
    showToast("ƒêang m·ªü PDF A4‚Ä¶", "info", 1800);
    openPdf(makeUrl(`/print/a4/${encodeURIComponent(window.loadedApplicant.ma_so_hv)}`));
  };

  // ===== Bind actions =====
  $("btnSave").onclick = async () => {
    const btn = $("btnSave");
    btn.disabled = true; const old = btn.textContent; btn.textContent = "ƒêang l∆∞u...";
    try{
      const res = await createApplicant();
      if (res) { $("msg").textContent = `ƒê√£ l∆∞u h·ªì s∆° ${res.ma_ho_so || $("ma_so_hv").value}.`; showToast(`ƒê√£ l∆∞u h·ªì s∆° <b>${res.ma_so_hv || $("ma_so_hv").value}</b>.`, "success"); }
    } finally{ btn.disabled = false; btn.textContent = old; }
  };

  $("btnLoadApplicantMSHV").onclick = async () => {
    try{
      const mshv = $("q_ma_so_hv").value.trim(); if(!mshv){ alert("Nh·∫≠p MSHV (MSSV) ƒë·ªÉ t·∫£i."); return; }
      $("lookupMsg").textContent = "ƒêang t·∫£i theo MSHV...";
      const a = await loadApplicantByMSHV(mshv);
      window.loadedApplicant = { ma_so_hv: a.ma_so_hv, ma_ho_so: a.ma_ho_so };
      populateFormFromApplicant(a, a.docs || []);
      setPrintButtonsEnabled(true);
      $("lookupMsg").textContent = `ƒê√£ t·∫£i h·ªì s∆°: ${a.ho_ten} ‚Ä¢ M√£ HS ${a.ma_ho_so} ‚Ä¢ MSHV ${a.ma_so_hv}`;
    }catch(e){ $("lookupMsg").textContent = e.message; setPrintButtonsEnabled(false); }
  };
  $("q_ma_so_hv").addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); $("btnLoadApplicantMSHV").click(); } });

  $("btnSearchByName").onclick = async () => {
    try{
      const name = $("q_ho_ten").value.trim(); if(name.length < 2){ alert("Nh·∫≠p t·ªëi thi·ªÉu 2 k√Ω t·ª±."); return; }
      $("lookupMsg").textContent = "ƒêang t√¨m theo t√™n...";
      let list = await searchByName(name);
      list = filterAndSortByName(list, name, 25);
      renderNameResults(list);
      $("lookupMsg").textContent = list.length ? `T√¨m th·∫•y ${list.length} k·∫øt qu·∫£.` : "Kh√¥ng t√¨m th·∫•y.";
    }catch(e){ $("lookupMsg").textContent = e.message || "L·ªói t√¨m ki·∫øm."; showToast(e.message || "L·ªói t√¨m ki·∫øm.", "error"); }
  };
  $("q_ho_ten").addEventListener('keydown', (e)=>{ if(e.key==='Enter') $("btnSearchByName").click(); });

  ["btnUpdateApplicant", "btnUpdateApplicantMain"].forEach(id=>{
    $(id)?.addEventListener("click", async () => {
      try{
        $("lookupMsg").textContent = "ƒêang c·∫≠p nh·∫≠t...";
        const res = await updateLoadedApplicant();
        if (res?.nguoi_nhan_ky_ten) $("nguoi_nhan_ky_ten").value = res.nguoi_nhan_ky_ten;
        $("lookupMsg").textContent = `C·∫≠p nh·∫≠t xong h·ªì s∆° ${res.ma_ho_so}.`;
        showToast(`ƒê√£ c·∫≠p nh·∫≠t h·ªì s∆° <b>${res.ma_ho_so}</b>`, "success");
      } catch(e){ $("lookupMsg").textContent = e.message; showToast(e.message || "C·∫≠p nh·∫≠t th·∫•t b·∫°i!", "error"); }
    });
  });

  // Xo√° (m·ªü modal nh·∫≠p l√Ω do)
  $("btnDeleteApplicant").onclick = async () => {
    try{ await deleteLoadedApplicant(); } catch(e){ $("lookupMsg").textContent = e.message; showToast(e.message, "error"); }
  };

  // Reload checklist
  $("btnReloadChecklist").onclick = () => loadChecklist();

  // Test API button
  $("btnTestApi").onclick = async ()=>{
    const base = apiBase();
    const pref = await pingPrefix(base);
    if (pref === null) showToast("Kh√¥ng ping ƒë∆∞·ª£c API /health", "error");
    else { API_PREFIX = pref; localStorage.setItem(STORAGE_KEY, base); showToast(`K·∫øt n·ªëi OK (${base}${pref||""}/health)`, "success"); }
  };
  $("apiBase").addEventListener("change", async ()=>{
    const base = apiBase(); localStorage.setItem(STORAGE_KEY, base);
    const pref = await pingPrefix(base);
    if (pref === null) showToast("Kh√¥ng ping ƒë∆∞·ª£c API /health", "warn");
    else { API_PREFIX = pref; showToast("ƒê√£ c·∫≠p nh·∫≠t m√°y ch·ªß API", "success"); }
  });

  // ===== init =====
  window.addEventListener('load', async () => {
    const today = new Date().toISOString().slice(0,10);
    $("ngay_nhan_hs").value = today;
    $("q_ma_so_hv")?.focus();

    await ensureApiBaseAndPrefix();
    await refreshAuthUI();
    await loadChecklist();
    setPrintButtonsEnabled(false);

    // Auto-load khi c√≥ ?mshv=... tr√™n URL
    const url = new URL(window.location.href);
    const mshv = url.searchParams.get('mshv');
    if (mshv) { $("q_ma_so_hv").value = mshv; $("btnLoadApplicantMSHV").click(); }
  });
  </script>
</body>
</html>
