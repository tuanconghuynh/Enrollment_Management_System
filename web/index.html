<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bi√™n nh·∫≠n h·ªì s∆° nh·∫≠p h·ªçc | V-HT.PTƒêT HUTECH</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
    .card { background:#ffffff; border-radius:1rem; box-shadow:0 10px 20px rgba(2,6,23,.06); padding:1.25rem; }
    .btn { padding:.5rem 1rem; border-radius:.75rem; box-shadow:0 1px 2px rgba(0,0,0,.06); font-weight:600; transition: transform .05s ease; }
    .btn:hover { transform: translateY(-1px); }
    .btn-primary { background:#2563eb; color:#fff; }
    .btn-secondary { background:#111827; color:#fff; }
    .btn-outline { background:#ffffff; border:1px solid #d1d5db; }
    .input { width:100%; border:1px solid #e5e7eb; border-radius:.75rem; padding:.5rem .75rem; outline:none; }
    .input:focus { box-shadow:0 0 0 3px rgba(59,130,246,.3); border-color:#93c5fd; }
    .label { font-size:.85rem; color:#6b7280; }
    .section-title { font-size:1.05rem; font-weight:700; margin-bottom:.5rem; }
    .kbd { padding:.15rem .35rem; border:1px solid #e5e7eb; border-radius:.375rem; background:#f8fafc; color:#334155; font-size:.75rem; }
    thead th { font-weight:700; }
    table tr:nth-child(odd) td { background:#f8fafc; }
    #toast-wrap{position:fixed;right:16px;top:16px;display:flex;flex-direction:column;gap:8px;z-index:9999}
    .toast{min-width:260px;max-width:380px;padding:10px 12px;border-radius:12px;box-shadow:0 10px 24px rgba(0,0,0,.12);color:#0f172a;font-weight:600;opacity:.98;transform:translateY(-10px);animation:toast-in .15s ease-out forwards}
    .toast.info{background:#eef2ff} .toast.success{background:#ecfeff} .toast.warn{background:#fff7ed} .toast.error{background:#fee2e2}
    @keyframes toast-in { from {opacity:.0; transform: translateY(-6px)} to {opacity:1; transform: translateY(0)} }
  </style>
  <link rel="icon" type="image/png" href="hutech.png" sizes="32x32">
  <link rel="apple-touch-icon" href="hutech.png">
  <meta name="theme-color" content="#2563eb">
</head>

<body class="bg-gray-50">
  <div id="toast-wrap"></div>

  <div class="max-w-6xl mx-auto p-6 space-y-6">
    <header class="flex items-center justify-between">
      <div class="flex items-center gap-3 min-w-0">
        <img src="hutech.png" alt="HUTECH" class="h-8 w-8 object-contain select-none" />
        <h1 class="text-2xl font-bold leading-none truncate">V-HTPTƒêT BI√äN NH·∫¨N H·ªí S∆† NH·∫¨P H·ªåC</h1>
      </div>

      <div class="flex items-center gap-2">
        <label class="label">API Base</label>
        <input id="apiBase" class="input w-80" />
        <button class="btn btn-outline" id="btnTestApi">Test</button>
        <button class="btn btn-outline" id="btnReloadChecklist">‚Üª Checklist</button>
      </div>
    </header>

    <!-- Quick Nav -->
    <nav class="flex flex-wrap items-center gap-2 -mt-2">
      <a id="navImport"   href="/import_students.html" class="btn btn-outline hidden">Import H·ªçc vi√™n</a>
      <a id="navStudents" href="/students_list.html"   class="btn btn-outline hidden">Danh s√°ch h·ªì s∆°</a>
      <a id="navAdmin"    href="/admin"                class="btn btn-outline hidden">Qu·∫£n l√Ω T√†i kho·∫£n</a>

      <span class="flex-1"></span>

      <span id="navHello" class="text-sm text-gray-600 hidden"></span>
      <a id="navLogin"  href="/login" class="btn btn-outline">Login</a>
      <button id="navLogout" class="btn btn-secondary hidden">LogOut</button>
    </nav>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Form t·∫°o/c·∫≠p nh·∫≠t h·ªì s∆° -->
      <section class="lg:col-span-2 card">
        <div class="section-title">Nh·∫≠p Th√¥ng Tin H·ªì S∆°</div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="label">M√£ h·ªì s∆°</label>
            <input class="input" id="ma_ho_so" placeholder="HS-XXXXX" />
          </div>
          <div>
            <label class="label">Ng√†y nh·∫≠n HS</label>
            <input class="input" id="ngay_nhan_hs" type="date" />
          </div>
          <div>
            <label class="label" for="khoa">Ni√™n Kh√≥a</label>
            <select class="input" id="khoa" name="khoa">
              <option value="">-- Ch·ªçn kh√≥a --</option>
              <option>23</option><option>24</option><option>25</option><option>26</option>
              <option>27</option><option>28</option><option>29</option><option>30</option>
            </select>
          </div>

        </div>

        <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="label">H·ªç v√† t√™n</label>
            <input class="input" id="ho_ten" />
          </div>
          <div>
            <label class="label">M√£ s·ªë HV</label>
            <input class="input" id="ma_so_hv" />
          </div>
          <div>
            <label class="label">Ng√†y sinh</label>
            <input class="input" id="ngay_sinh" type="date" />
          </div>
          <div>
            <label class="label">S·ªë ƒêT</label>
            <input class="input" id="so_dt" />
          </div>
          <div>
            <label class="label">Ng√†nh nh·∫≠p h·ªçc</label>
            <select class="input" id="nganh_nhap_hoc">
              <option value="">-- Ch·ªçn ng√†nh --</option>
              <option>T√¢m l√Ω h·ªçc</option>
              <option>Ng√¥n ng·ªØ Anh</option>
              <option>C√¥ng ngh·ªá th√¥ng tin</option>
              <option>Qu·∫£n tr·ªã kinh doanh</option>
              <option>K·∫ø to√°n</option>
              <option>Lu·∫≠t kinh t·∫ø</option>
              <option>Qu·∫£n l√Ω x√¢y d·ª±ng</option>
              <option>T√†i ch√≠nh - Ng√¢n h√†ng</option>
              <option>Marketing</option>
            </select>
          </div>
          <div>
            <label class="label">ƒê·ª£t</label>
            <select class="input" id="dot">
              <option value="">-- Ch·ªçn ƒë·ª£t --</option>
              <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
              <option>6</option><option>7</option><option>8</option><option>9</option><option>10</option>
              <option>11</option><option>12</option><option>13</option><option>14</option><option>15</option>
              <option>16</option><option>17</option><option>18</option><option>19</option><option>20</option>
            </select>
          </div>
          <div>
            <label class="label">ƒê√£ TN tr∆∞·ªõc ƒë√≥</label>
            <select class="input" id="da_tn_truoc_do">
              <option value="">-- Ch·ªçn ƒê·ªëi t∆∞·ª£ng --</option>
              <option>THPT</option><option>Trung c·∫•p</option><option>Cao ƒë·∫≥ng</option><option>ƒê·∫°i h·ªçc</option>
            </select>
          </div>
            <div>
              <label class="label">Ng∆∞·ªùi nh·∫≠n (Ch·ªØ k√Ω)</label>
              <div class="relative">
                <input
                  id="nguoi_nhan_ky_ten"
                  class="input pr-9 bg-gray-100 text-gray-500 cursor-not-allowed"
                  readonly
                  title="T·ª± ƒë·ªông l·∫•y theo t√†i kho·∫£n ƒëƒÉng nh·∫≠p"
                />
                <span class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 select-none" title="ƒê√£ kh√≥a">
                  üîí
                </span>
              </div>
            </div>
          <div class="md:col-span-2">
            <label class="label">Ghi ch√∫</label>
            <input class="input" id="ghi_chu" />
          </div>
        </div>

        <!-- Checklist -->
        <div class="mt-6">
          <div class="section-title">H·ªì s∆° g·ªìm</div>
          <div class="overflow-auto">
            <table class="min-w-full border bg-white">
              <thead class="bg-gray-100">
                <tr>
                  <th class="p-2 border">STT</th>
                  <th class="p-2 border text-left">Danh m·ª•c</th>
                  <th class="p-2 border">C√≥?</th>
                  <th class="p-2 border">S·ªë l∆∞·ª£ng</th>
                </tr>
              </thead>
              <tbody id="docsBody"></tbody>
            </table>
          </div>
        </div>

        <div class="mt-6 flex gap-3 flex-wrap items-center">
          <button id="btnSave" class="btn btn-secondary">L∆∞u</button>
          <button id="btnUpdateApplicantMain" class="btn btn-secondary">C·∫≠p nh·∫≠t</button>
          <button id="btnSavePrint" class="btn btn-primary">L∆∞u & In A4</button>
          <button id="btnSavePrintA5" class="btn btn-outline">L∆∞u & In A5</button>
          <span class="text-sm text-gray-500">M·∫πo: nh·∫•n <span class="kbd">Alt</span>+<span class="kbd">P</span> ƒë·ªÉ L∆∞u & In nhanh</span>
        </div>
        <div id="msg" class="mt-3 text-sm text-green-700"></div>
      </section>

      <!-- Panel ph·∫£i -->
      <aside class="card space-y-6 lg:sticky lg:top-4">
        <!-- Tra c·ª©u & Ch·ªânh s·ª≠a -->
        <section>
          <div class="section-title">Tra c·ª©u & Ch·ªânh s·ª≠a h·ªì s∆°</div>
          <label class="label">Nh·∫≠p M√£ h·ªì s∆°</label>
          <div class="flex gap-2">
            <input class="input flex-1" id="q_ma_ho_so" placeholder="VD: HS-0001" />
            <button id="btnLoadApplicant" class="btn btn-outline">T·∫£i</button>
          </div>

          <label class="label mt-3 block">Ho·∫∑c nh·∫≠p H·ªç v√† t√™n</label>
          <div class="flex gap-2">
            <input class="input flex-1" id="q_ho_ten" placeholder="VD: Nguy·ªÖn VƒÉn A" />
            <button id="btnSearchByName" class="btn btn-outline">T√¨m</button>
          </div>

          <div id="nameResults" class="mt-2 hidden">
            <div class="text-xs text-gray-500 mb-1">Ch·ªçn m·ªôt k·∫øt qu·∫£ ƒë·ªÉ t·∫£i v√†o form:</div>
            <ul id="nameResultsList" class="divide-y border rounded-md bg-white"></ul>
          </div>

          <div class="grid grid-cols-2 gap-2 mt-3">
            <button id="btnUpdateApplicant" class="btn btn-secondary">C·∫≠p nh·∫≠t</button>
            <button id="btnDeleteApplicant" class="btn btn-outline">Xo√°</button>
          </div>

          <!-- In h·ªì s∆° ƒëang m·ªü -->
          <div class="flex gap-2 mt-2">
            <button id="btnPrintLoadedA5" class="btn btn-outline" disabled>In A5</button>
            <button id="btnPrintLoadedA42up" class="btn btn-outline" disabled>In A4 (2-up)</button>
          </div>

          <p id="lookupMsg" class="text-sm text-gray-600 mt-2"></p>
        </section>

        <hr/>

        <!-- In / Xu·∫•t theo ng√†y -->
        <section>
          <div class="section-title">In / Xu·∫•t theo ng√†y</div>
          <label class="label">Ng√†y nh·∫≠n HS</label>
          <input class="input" id="batchDate" type="date" />
          <div class="grid grid-cols-1 gap-2 mt-3">
            <button id="btnBatchPDF" class="btn btn-primary w-full">In PDF g·ªôp</button>
            <button id="btnExportExcel" class="btn btn-outline w-full">Xu·∫•t Excel</button>
          </div>
        </section>

        <hr/>

    <!-- In / Xu·∫•t theo ƒë·ª£t -->
    <section>
      <div class="section-title">In / Xu·∫•t theo ƒë·ª£t</div>

      <label class="label">ƒê·ª£t (v√≠ d·ª•: ƒê·ª£t 1/2025)</label>
      <div class="flex flex-wrap items-center gap-2">
        <input class="input flex-1 min-w-[200px]" id="batchDot" placeholder="Nh·∫≠p t√™n ƒë·ª£t..." />
        <input class="input w-20 text-center" id="batchKhoa" placeholder="Kh√≥a" title="VD: 27" />
      </div>

      <div class="grid grid-cols-1 gap-2 mt-3">
        <button id="btnBatchPDFDot"   class="btn btn-primary  w-full">In PDF g·ªôp theo ƒë·ª£t</button>
        <button id="btnExportExcelDot" class="btn btn-outline w-full">Xu·∫•t Excel theo ƒë·ª£t</button>
      </div>

      <p class="text-xs text-gray-500 mt-2">
        C√≥ th·ªÉ nh·∫≠p th√™m <b>Kh√≥a</b> ƒë·ªÉ l·ªçc ƒë√∫ng ‚Äúƒë·ª£t thu·ªôc kh√≥a n√†o‚Äù (tr√°nh tr√πng t√™n ƒë·ª£t).
      </p>
    </section>

        <hr/>

        <section>
          <div class="section-title"><center>TR·ª¢ GI√öP</center></div>
          <ul class="list-disc ml-5 text-sm text-gray-600 space-y-1">
            <li>Ch·ªçn API Base r·ªìi nh·∫•n n√∫t Test cho l·∫ßn ƒë·∫ßu ho·∫∑c khi ƒë·ªïi server.</li>
            <li>Nh·∫•n n√∫t L∆∞u ƒë·ªÉ ghi nh·ªõ API Base.</li>
            <li>Nh·∫•n n√∫t ‚Üª ƒë·ªÉ t·∫£i l·∫°i danh s√°ch h·ªì s∆° v√† checklist t·ª´ server.</li>
            <li>ƒê·ªïi API Base ·ªü g√≥c tr√™n n·∫øu b·∫°n deploy n∆°i kh√°c.</li>
            <li>PDF m·ªü trong tab m·ªõi; n·∫øu b·ªã ch·∫∑n s·∫Ω m·ªü ngay t·∫°i tab.</li>
            <li>In A5: gi·∫•y A4, in 2 m·∫∑t, c·∫Øt ƒë√¥i; A4 (2-up) g·ªôp s·∫µn hai A5.</li>
            <li>T√¨m ki·∫øm theo m√£ h·ªì s∆° ho·∫∑c h·ªç t√™n.</li>
            <li>ƒê·ªÉ tr·ªëng s·ªë l∆∞·ª£ng trong checklist ƒë·ªÉ ƒë√°nh d·∫•u c√≥/kh√¥ng.</li>
            <li>Ng√†y sinh c√≥ th·ªÉ ƒë·ªÉ tr·ªëng n·∫øu kh√¥ng r√µ.</li>
            <li>Li√™n h·ªá Email: <a href="mailto:hc.tuan@hutech.edu.vn">hc.tuan@hutech.edu.vn</a></li>
            <li>Li√™n h·ªá zalo: <a href="http://zalo.me/tuanconghuynh">Hu·ª≥nh C√¥ng Tu·∫•n T·∫°i ƒë√¢y!</a></li>
          </ul>
        </section>
      </aside>
    </div>
  </div>

<footer class="max-w-6xl mx-auto px-6 pb-4 text-right text-xs text-gray-500">
  ¬© <span class="font-semibold">
    <a href="https://hutech.edu.vn/e-hutech" target="_blank" rel="noopener noreferrer">
      V-HT.PTƒêT HUTECH
    </a>
  </span>
  ‚ûñ Code by:
  <span class="font-semibold">
    <a href="http://zalo.me/tuanconghuynh" target="_blank" rel="noopener noreferrer">
      HC- Tuan
    </a>
  </span>
</footer>


  <!-- Scripts -->
  <script>
 
 // ·∫®n trang trong l√∫c ki·ªÉm tra, tr√°nh nh√°y n·ªôi dung
  document.documentElement.style.visibility = 'hidden';

  (async () => {
    const base = location.origin.replace(/\/+$/, '');
    const candidates = ["", "/api"]; // th·ª≠ c·∫£ 2 prefix
    let loggedIn = false;

    for (const p of candidates) {
      try {
        const r = await fetch(base + p + "/me", { credentials: "include" });
        if (r.ok) { loggedIn = true; break; }
        if (r.status === 401 || r.status === 403) { break; }
      } catch (_) {}
    }

    if (!loggedIn) {
      // quay v·ªÅ login v√† gi·ªØ l·∫°i ƒë√≠ch quay v·ªÅ
      const next = encodeURIComponent(location.pathname + location.search);
      location.replace(`/login?next=${next}`);
      return; // d·ª´ng ·ªü ƒë√¢y ƒë·ªÉ kh√¥ng hi·ªán trang
    }

    // OK -> hi·ªÉn th·ªã l·∫°i
    document.documentElement.style.visibility = '';
  })();

  // ========= helpers chung =========
  const $ = (id) => document.getElementById(id);

  // Toast
  function showToast(msg, type='info', ms=2500){
    const wrap = document.getElementById('toast-wrap');
    const el = document.createElement('div');
    el.className = `toast ${type}`;
    el.innerHTML = msg;
    wrap.appendChild(el);
    const t = setTimeout(()=>{ el.style.transition='opacity .15s'; el.style.opacity='0';
      setTimeout(()=> el.remove(), 180);
    }, ms);
    el.onclick = ()=>{ clearTimeout(t); el.remove(); };
  }

  // ==== Date utils (2 d·∫°ng cho POST vs PUT) ====
  // input date (YYYY-MM-DD) -> "DD-MM-YYYY" (create d√πng)
  function ymdToDMY_HYPHEN(s){
    if(!s) return "";
    const m = String(s).match(/^(\d{4})-(\d{2})-(\d{2})$/);
    return m ? `${m[3]}-${m[2]}-${m[1]}` : s;
  }
  // input date (YYYY-MM-DD) -> "YYYY-MM-DD" (update d√πng lu√¥n)
  function ymdKeep(s){ return (s||"").slice(0,10); }

  // server tr·∫£ ISO/str -> set v√†o <input type=date>
  function fmtDateToInput(s){
    if(!s) return "";
    // ch·∫•p nh·∫≠n dd/mm ho·∫∑c dd-mm
    const m = String(s).match(/^(\d{1,2})[\/-](\d{1,2})[\/-](\d{4})$/);
    if (m) return `${m[3]}-${m[2].padStart(2,'0')}-${m[1].padStart(2,'0')}`;
    const d = new Date(s);
    return Number.isNaN(d.getTime()) ? String(s).slice(0,10) : d.toISOString().slice(0,10);
  }

  // ========= API base / prefix =========
  const STORAGE_KEY = "apiBase";
  let API_PREFIX = ""; // "" ho·∫∑c "/api"

  function apiBase(){ return $("apiBase").value.trim().replace(/\/+$/,''); }

  async function pingPrefix(base){
    try{
      let r = await fetch(base + "/health", {credentials:"include"});
      if (r.ok) return "";
    }catch(_){}
    try{
      let r2 = await fetch(base + "/api/health", {credentials:"include"});
      if (r2.ok) return "/api";
    }catch(_){}
    return null;
  }

  async function ensureApiBaseAndPrefix(){
    // ∆∞u ti√™n localStorage, fallback origin
    let base = localStorage.getItem(STORAGE_KEY) || window.location.origin;
    $("apiBase").value = base;
    let pref = await pingPrefix(base);
    if (pref !== null){ API_PREFIX = pref; return; }

    // g·ª£i √Ω v√†i base
    const guesses = [
      base, window.location.origin,
      "http://127.0.0.1:8000",
      "http://localhost:8000"
    ];
    for (const g of guesses){
      const p = await pingPrefix(g);
      if (p !== null){ $("apiBase").value = g; localStorage.setItem(STORAGE_KEY, g); API_PREFIX = p; return; }
    }

    // h·ªèi tay ƒë·∫øn khi OK ho·∫∑c h·ªßy
    for(;;){
      const m = prompt("Kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c API.\nNh·∫≠p IP/URL server (vd: http://192.168.2.82:8000):", base);
      if (!m) break;
      const p = await pingPrefix(m.trim());
      if (p !== null){ $("apiBase").value = m.trim(); localStorage.setItem(STORAGE_KEY, m.trim()); API_PREFIX = p; return; }
      base = m.trim();
    }
    // n·∫øu v·∫´n ch∆∞a set ƒë∆∞·ª£c, ƒë·ªÉ prefix = "" (fetch s·∫Ω l·ªói v√† hi·ªán toast)
    API_PREFIX = "";
  }

  function makeUrl(path){ return apiBase() + API_PREFIX + path; }

  async function apiFetch(path, init={}){
    const opts = { credentials: "include", ...init };
    let r = await fetch(makeUrl(path), opts).catch(()=>null);
    return r; // ƒë√£ x√°c ƒë·ªãnh prefix t·ª´ ƒë·∫ßu
  }

  function handleAuth(r){
    if (r && (r.status===401 || r.status===403)){
      showToast("Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n, vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.", "warn", 2500);
      setTimeout(()=>location.href="/login", 700);
      return true;
    }
    return false;
  }
  const safeJson = async (r)=>{ try{ return await r.json(); }catch{ return {}; } };

  // ====== NAV / Auth UI ======
async function refreshAuthUI(){
  try{
    // lu√¥n k√®m credentials
    const r = await apiFetch('/me', { credentials:'include' });

    // Ch∆∞a ƒëƒÉng nh·∫≠p ho·∫∑c l·ªói => ch·ªâ ·∫©n/hi·ªán n√∫t, KH√îNG redirect
    if (!r || !r.ok){
      ["navImport","navStudents","navAdmin","navHello"].forEach(id=>$(id)?.classList.add("hidden"));
      $("navLogin")?.classList.remove("hidden");
      $("navLogout")?.classList.add("hidden");
      return;
    }

    // ƒê√£ ƒëƒÉng nh·∫≠p
    const me   = await r.json();
    const role = me.role || "";
    const isAdmin = role === "Admin";
    const isStaff = isAdmin || role === "NhanVien";
    const canViewStudents = isStaff || role === "CongTacVien"; // CTV c≈©ng ƒë∆∞·ª£c xem DS

    $("navHello").textContent = `Xin ch√†o, ${me.full_name || me.username} (${role})`;
    $("navHello").classList.remove("hidden");
    $("navLogin")?.classList.add("hidden");
    $("navLogout")?.classList.remove("hidden");

    // Quy·ªÅn menu
    if (isStaff) $("navImport")?.classList.remove("hidden");
    else         $("navImport")?.classList.add("hidden");

    if (isAdmin) $("navAdmin")?.classList.remove("hidden");
    else         $("navAdmin")?.classList.add("hidden");

    if (canViewStudents) $("navStudents")?.classList.remove("hidden");
    else                 $("navStudents")?.classList.add("hidden");

    // Auto ƒëi·ªÅn Ng∆∞·ªùi nh·∫≠n n·∫øu tr·ªëng
    const rec = $("nguoi_nhan_ky_ten");
    if (rec && !rec.value) rec.value = me.full_name || me.username || "";
  }catch(_){
    // L·ªói m·∫°ng‚Ä¶ coi nh∆∞ ch∆∞a ƒëƒÉng nh·∫≠p, KH√îNG redirect
    ["navImport","navStudents","navAdmin","navHello"].forEach(id=>$(id)?.classList.add("hidden"));
    $("navLogin")?.classList.remove("hidden");
    $("navLogout")?.classList.add("hidden");
  }
}

// Logout
$("navLogout")?.addEventListener("click", async ()=>{
  try{ await apiFetch('/logout', { method:'POST', credentials:'include' }); }catch(_){}
  // ch·ªó n√†y redirect v·ªÅ /login l√† h·ª£p l√Ω (ng∆∞·ªùi d√πng b·∫•m ƒêƒÉng xu·∫•t)
  location.href = '/login';
});

  // ===== Checklist =====
  const DEFAULT_QTY = {
    bang_tot_nghiep_dai_hoc: 2,
    bang_diem_dai_hoc: 2,
    bang_tot_nghiep_cao_dang: 2,
    bang_diem_cao_dang: 2,
    bang_tot_nghiep_trung_cap: 2,
    bang_diem_trung_cap: 2,
    anh_3x4: 2,
  };
  const getDefaultQty = (code) => DEFAULT_QTY[code] ?? 1;

  async function loadChecklist() {
    try {
      const r = await apiFetch("/checklist/active");
      if (!r || !r.ok) { showToast("Kh√¥ng l·∫•y ƒë∆∞·ª£c checklist", "error"); return; }
      const data = await r.json();
      const body = $("docsBody");
      body.innerHTML = "";

      (data.items||[])
        .sort((a,b)=> (a.order_index ?? a.order_no ?? 0) - (b.order_index ?? b.order_no ?? 0))
        .forEach((it, idx) => {
          const def = getDefaultQty(it.code);
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td class="p-2 border text-center">${idx+1}</td>
            <td class="p-2 border"><div class="font-medium">${it.display_name}</div></td>
            <td class="p-2 border text-center">
              <input type="checkbox" class="w-5 h-5 has-doc" data-code="${it.code}">
            </td>
            <td class="p-2 border text-center">
              <input type="number" min="0"
                     class="input w-24 text-center qty bg-gray-100 text-gray-400"
                     data-code="${it.code}" value="" placeholder="${def}" disabled />
            </td>`;
          body.appendChild(tr);
        });

      // toggle enable/disable √¥ s·ªë l∆∞·ª£ng
      document.querySelectorAll('.has-doc').forEach((chk) => {
        const code = chk.dataset.code;
        const qty = document.querySelector(`.qty[data-code="${code}"]`);
        const def = getDefaultQty(code);
        chk.addEventListener("change", () => {
          if (chk.checked) {
            qty.value = String(def);
            qty.disabled = false;
            qty.classList.remove("bg-gray-100", "text-gray-400");
          } else {
            qty.value = "";
            qty.disabled = true;
            qty.classList.add("bg-gray-100", "text-gray-400");
          }
        });
      });
    } catch (err) {
      console.error(err);
      showToast('L·ªói t·∫£i checklist', 'error');
    }
  }

  function collectDocs() {
    const rows = Array.from(document.querySelectorAll('#docsBody tr'));
    return rows.map(tr => {
      const chk  = tr.querySelector('.has-doc');
      const qtyI = tr.querySelector('.qty');
      const code = chk.dataset.code;
      const def  = getDefaultQty(code);
      let val = chk.checked ? Number(qtyI.value || def) : 0;
      if (!Number.isFinite(val) || val < 0) val = 0;
      return { code, so_luong: val };
    });
  }

  // ===== Payloads: create vs update (kh√°c ƒë·ªãnh d·∫°ng ng√†y) =====
  function payloadForCreate() {
    return {
      ma_ho_so: $("ma_ho_so").value.trim(),
      ngay_nhan_hs: ymdToDMY_HYPHEN($("ngay_nhan_hs").value), // DD-MM-YYYY
      ho_ten: $("ho_ten").value.trim(),
      ma_so_hv: $("ma_so_hv").value.trim(),
      ngay_sinh: ymdToDMY_HYPHEN($("ngay_sinh").value) || null, // DD-MM-YYYY
      so_dt: $("so_dt").value.trim() || null,
      nganh_nhap_hoc: $("nganh_nhap_hoc").value.trim() || null,
      dot: $("dot").value.trim() || null,
      khoa: $("khoa").value.trim() || null,
      da_tn_truoc_do: $("da_tn_truoc_do").value || null,
      ghi_chu: $("ghi_chu").value.trim() || null,
      nguoi_nhan_ky_ten: $("nguoi_nhan_ky_ten").value.trim() || null,
      docs: collectDocs(),
      checklist_version_name: "v1"
    };
  }
  function payloadForUpdate() {
    return {
      ma_ho_so: $("ma_ho_so").value.trim(),
      ngay_nhan_hs: ymdKeep($("ngay_nhan_hs").value), // YYYY-MM-DD
      ho_ten: $("ho_ten").value.trim(),
      ma_so_hv: $("ma_so_hv").value.trim(),
      ngay_sinh: ymdKeep($("ngay_sinh").value) || null, // YYYY-MM-DD
      so_dt: $("so_dt").value.trim() || null,
      nganh_nhap_hoc: $("nganh_nhap_hoc").value.trim() || null,
      dot: $("dot").value.trim() || null,
      khoa: $("khoa").value.trim() || null,
      da_tn_truoc_do: $("da_tn_truoc_do").value || null,
      ghi_chu: $("ghi_chu").value.trim() || null,
      nguoi_nhan_ky_ten: $("nguoi_nhan_ky_ten").value.trim() || null,
      docs: collectDocs()
    };
  }

  // ===== Save / Create =====
  async function createApplicant(){
    const body = payloadForCreate();
    if(!body.ma_ho_so || !body.ho_ten || !body.ma_so_hv || !body.ngay_nhan_hs){
      showToast("Thi·∫øu M√£ h·ªì s∆° / H·ªç t√™n / MSHV / Ng√†y nh·∫≠n.", "error");
      return null;
    }
    const r = await apiFetch("/applicants", { method: "POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(body) });
    if (handleAuth(r)) return null;
    const j = await safeJson(r);
    if (!r || !r.ok){ showToast(j.detail || `L·ªói l∆∞u (HTTP ${r ? r.status : '???'})`, "error", 4000); return null; }
    window.loadedApplicant = { id: j.id, ma_ho_so: body.ma_ho_so };
    setPrintButtonsEnabled(true);
    return j;
  }

  // ===== Lookup / Update / Delete =====
  let loadedApplicant = null;
  let loadedDocsByCode = {};

  function setPrintButtonsEnabled(on) {
    $("btnPrintLoadedA5").disabled   = !on;
    $("btnPrintLoadedA42up").disabled = !on;
  }

  function populateFormFromApplicant(a, docs){
    $("ma_ho_so").value = a.ma_ho_so || "";
    $("ngay_nhan_hs").value = fmtDateToInput(a.ngay_nhan_hs);
    $("khoa").value = a.khoa || "";
    $("ho_ten").value = a.ho_ten || "";
    $("ma_so_hv").value = a.ma_so_hv || "";
    $("ngay_sinh").value = fmtDateToInput(a.ngay_sinh);
    $("so_dt").value = a.so_dt || "";
    $("nganh_nhap_hoc").value = a.nganh_nhap_hoc || "";
    $("dot").value = a.dot || "";
    $("da_tn_truoc_do").value = a.da_tn_truoc_do || "";
    $("ghi_chu").value = a.ghi_chu || "";
    $("nguoi_nhan_ky_ten").value = a.nguoi_nhan_ky_ten || "";

    loadedDocsByCode = {}; (docs||[]).forEach(d => loadedDocsByCode[d.code] = d.so_luong || 0);

    const applyDocsToTable = () => {
      document.querySelectorAll('.has-doc').forEach(chk => {
        const code = chk.dataset.code;
        const qty = document.querySelector(`.qty[data-code="${code}"]`);
        const n = loadedDocsByCode[code] ?? 0;
        if (n > 0) { chk.checked = true; qty.disabled = false; qty.classList.remove("bg-gray-100","text-gray-400"); qty.value = String(n); }
        else { chk.checked = false; qty.disabled = true; qty.classList.add("bg-gray-100","text-gray-400"); qty.value = ""; }
      });
    };
    if (document.querySelectorAll('#docsBody tr').length === 0) loadChecklist().then(applyDocsToTable); else applyDocsToTable();
  }

  async function loadApplicantByCode(code){
    let r = await apiFetch(`/applicants/find?ma_ho_so=${encodeURIComponent(code)}`);
    if (!r || r.status === 404 || r.status === 405) r = await apiFetch(`/applicants/by-code/${encodeURIComponent(code)}`);
    if (!r || !r.ok) {
      if (r && r.status === 404) showToast(`Kh√¥ng t√¨m th·∫•y h·ªì s∆° ${code}`, "warn");
      const t = r ? await r.text() : "(kh√¥ng ph·∫£n h·ªìi)";
      throw new Error(`L·ªói t·∫£i h·ªì s∆° (HTTP ${r ? r.status : '???'})\n${t}`);
    }
    const data = await r.json();
    const raw = (data && data.applicant) ? { ...data.applicant, docs: data.docs || [] } : data;
    // backend c√≥ th·ªÉ tr·∫£ dd/mm ho·∫∑c ISO, ƒë√£ normalize khi set input
    return raw;
  }

  async function updateLoadedApplicant(){
    if(!loadedApplicant?.id){ throw new Error("Ch∆∞a t·∫£i h·ªì s∆° n√†o ƒë·ªÉ c·∫≠p nh·∫≠t."); }
    const body = payloadForUpdate();
    const r = await apiFetch(`/applicants/${loadedApplicant.id}`, { method: "PUT", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(body) });
    if (handleAuth(r)) return;
    if(!r || !r.ok){ const t = r ? await r.text() : "(kh√¥ng ph·∫£n h·ªìi)"; throw new Error(`C·∫≠p nh·∫≠t th·∫•t b·∫°i (HTTP ${r ? r.status : '???'})\n${t}`); }
    return r.json();
  }

  async function deleteLoadedApplicant(){
    if(!loadedApplicant?.id){ throw new Error("Ch∆∞a t·∫£i h·ªì s∆° n√†o ƒë·ªÉ xo√°."); }
    if(!confirm(`Xo√° h·ªì s∆° ${loadedApplicant.ma_ho_so}?`)) return;
    const r = await apiFetch(`/applicants/${loadedApplicant.id}`, { method: "DELETE" });
    if (handleAuth(r)) return;
    if(!r || !r.ok){ const t = r ? await r.text() : "(kh√¥ng ph·∫£n h·ªìi)"; throw new Error(`Xo√° th·∫•t b·∫°i (HTTP ${r ? r.status : '???'})\n${t}`); }
    loadedApplicant = null; loadedDocsByCode = {};
    setPrintButtonsEnabled(false);
    $("lookupMsg").textContent = "ƒê√£ xo√° h·ªì s∆°.";
    showToast("ƒê√£ xo√° h·ªì s∆°.", "info");
  }

  async function searchByName(name){
    const r = await apiFetch(`/applicants/search?q=${encodeURIComponent(name)}`);
    if(!r || !r.ok){ const t = r ? await r.text() : "(kh√¥ng ph·∫£n h·ªìi)"; throw new Error(`T√¨m theo t√™n l·ªói (HTTP ${r ? r.status : '???'})\n${t}`); }
    return r.json();
  }

  function renderNameResults(list){
    const box = $("nameResults");
    const ul  = $("nameResultsList");
    if(!list || list.length === 0){
      box.classList.remove("hidden");
      ul.innerHTML = '<li class="p-2 text-sm text-gray-500">Kh√¥ng t√¨m th·∫•y.</li>';
      return;
    }
    ul.innerHTML = list.map(it => {
      const ngay = it.ngay_nhan_hs ? String(it.ngay_nhan_hs).slice(0,10) : '';
      return `
        <li class="p-2 hover:bg-gray-50 cursor-pointer" data-code="${it.ma_ho_so}">
          <div class="flex justify-between">
            <div class="font-medium">${it.ho_ten}</div>
            <div class="text-xs text-gray-500">${ngay}</div>
          </div>
          <div class="text-xs text-gray-600">
            M√£: <span class="font-semibold">${it.ma_ho_so}</span>
            ‚Ä¢ MSHV: ${it.ma_so_hv||''}
            ‚Ä¢ ƒê·ª£t: ${it.dot||''}
          </div>
        </li>`;
    }).join("");
    if (!ul._boundClick) {
      ul.addEventListener('click', (e)=>{
        const li = e.target.closest('li[data-code]');
        if (!li) return;
        const code = li.dataset.code;
        $("q_ma_ho_so").value = code;
        box.classList.add('hidden');
        $("btnLoadApplicant").click();
      });
      ul._boundClick = true;
    }
    box.classList.remove('hidden');
  }

  // ===== In / Export =====
  function openPdf(url){
    const w = window.open(url, "_blank");
    if(!w){ window.location.href = url; }
  }

  $("btnBatchPDF").onclick = async () => {
    const d = $("batchDate").value;
    if (!d) { alert("Ch·ªçn ng√†y nh·∫≠n HS"); return; }
    const resp = await apiFetch(`/batch/print?day=${encodeURIComponent(d)}`);
    if (!resp || !resp.ok) {
      let msg = `Kh√¥ng th·ªÉ in (HTTP ${resp?.status||'???'})`;
      try { const j = await resp.json(); if (j?.detail) msg = j.detail; } catch {}
      alert(msg); return;
    }
    const blob = await resp.blob();
    const u = URL.createObjectURL(blob);
    window.open(u, "_blank"); setTimeout(()=>URL.revokeObjectURL(u), 60000);
  };

  $("btnExportExcel").onclick = async () => {
    const d = $("batchDate").value;
    if (!d) { alert("Ch·ªçn ng√†y nh·∫≠n HS"); return; }
    const resp = await apiFetch(`/export/excel?day=${encodeURIComponent(d)}`);
    if (!resp || !resp.ok) {
      let msg = `Kh√¥ng th·ªÉ xu·∫•t Excel (HTTP ${resp?.status||'???'})`;
      try { const j = await resp.json(); if (j?.detail) msg = j.detail; } catch {}
      alert(msg); return;
    }
    const blob = await resp.blob();
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `tong_ngay_${d}.xlsx`;
    document.body.appendChild(a); a.click(); a.remove();
    setTimeout(()=>URL.revokeObjectURL(a.href), 60000);
  };

    // In PDF theo ƒë·ª£t (+Kh√≥a)
  $("btnBatchPDFDot").onclick = async () => {
    const dot  = $("batchDot").value.trim();
    const khoa = $("batchKhoa")?.value.trim();
    if (!dot) { alert("Nh·∫≠p t√™n ƒë·ª£t tr∆∞·ªõc ƒë√£"); return; }

    let url = `/batch/print-dot?dot=${encodeURIComponent(dot)}`;
    if (khoa) url += `&khoa=${encodeURIComponent(khoa)}`;

    const resp = await fetch(makeUrl(url));
    if (!resp.ok) {
      let msg = `Kh√¥ng th·ªÉ in theo ƒë·ª£t (HTTP ${resp.status})`;
      try { const j = await resp.json(); if (j?.detail) msg = j.detail; } catch {}
      alert(msg); return;
    }
    const blob = await resp.blob();
    const u = URL.createObjectURL(blob);
    window.open(u, "_blank"); setTimeout(()=>URL.revokeObjectURL(u), 60000);
  };

  // Xu·∫•t Excel theo ƒë·ª£t (+Kh√≥a)
  $("btnExportExcelDot").onclick = async () => {
    const dot  = $("batchDot").value.trim();
    const khoa = $("batchKhoa")?.value.trim();
    if (!dot) { alert("Nh·∫≠p t√™n ƒë·ª£t tr∆∞·ªõc ƒë√£"); return; }

    let url = `/export/excel-dot?dot=${encodeURIComponent(dot)}`;
    if (khoa) url += `&khoa=${encodeURIComponent(khoa)}`;

    const resp = await fetch(makeUrl(url));
    if (!resp.ok) {
      let msg = `Kh√¥ng th·ªÉ xu·∫•t Excel theo ƒë·ª£t (HTTP ${resp.status})`;
      try { const j = await resp.json(); if (j?.detail) msg = j.detail; } catch {}
      alert(msg); return;
    }
    const blob = await resp.blob();
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `tong_dot_${dot}${khoa ? `_khoa_${khoa}` : ""}.xlsx`;
    document.body.appendChild(a); a.click(); a.remove();
    setTimeout(()=>URL.revokeObjectURL(a.href), 60000);
  };


  // ===== Bind form actions =====
  $("btnSave").onclick = async () => {
    const btn = $("btnSave");
    btn.disabled = true; const old = btn.textContent; btn.textContent = "ƒêang l∆∞u...";
    try{
      const res = await createApplicant();
      if (res) {
        $("msg").textContent = `ƒê√£ l∆∞u h·ªì s∆° ${res.ma_ho_so} (id=${res.id}).`;
        showToast(`ƒê√£ l∆∞u h·ªì s∆° <b>${res.ma_ho_so}</b>.`, "success");
      }
    } finally{
      btn.disabled = false; btn.textContent = old;
    }
  };

  $("btnSavePrint").onclick = async () => {
    const res = await createApplicant();
    if (res) {
      openPdf(makeUrl(`/print/a4-two-up/${res.id}`));
      $("msg").textContent = `ƒê√£ l∆∞u & in A4 (2-up) h·ªì s∆° ${res.ma_ho_so}.`;
      showToast(`ƒê√£ l∆∞u & g·ª≠i in <b>${res.ma_ho_so}</b>.`, "success");
    }
  };

  $("btnSavePrintA5").onclick = async () => {
    const res = await createApplicant();
    if (res) {
      openPdf(makeUrl(`/print/a5/${res.id}`));
      $("msg").textContent = `ƒê√£ l∆∞u & in A5 h·ªì s∆° ${res.ma_ho_so}.`;
      showToast(`ƒê√£ l∆∞u & g·ª≠i in <b>${res.ma_ho_so}</b>.`, "success");
    }
  };

  // Alt+P -> L∆∞u & In (A4 2-up)
  document.addEventListener('keydown', (e) => {
    if (e.altKey && (e.key === 'p' || e.key === 'P')) $("btnSavePrint").click();
  });

  // Lookup bindings
  $("btnLoadApplicant").onclick = async () => {
    try{
      const code = $("q_ma_ho_so").value.trim();
      if(!code){ alert("Nh·∫≠p M√£ h·ªì s∆° ho·∫∑c d√πng √¥ t√¨m theo t√™n ph√≠a d∆∞·ªõi."); return; }
      $("lookupMsg").textContent = "ƒêang t·∫£i...";
      const a = await loadApplicantByCode(code);
      loadedApplicant = { id: a.id, ma_ho_so: a.ma_ho_so };
      populateFormFromApplicant(a, a.docs || []);
      setPrintButtonsEnabled(true);
      $("lookupMsg").textContent = `ƒê√£ t·∫£i h·ªì s∆° ${a.ma_ho_so} (id=${a.id}).`;
    }catch(e){
      $("lookupMsg").textContent = e.message;
      setPrintButtonsEnabled(false);
    }
  };
  $("q_ma_ho_so").addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); $("btnLoadApplicant").click(); } });

  $("btnSearchByName").onclick = async () => {
    try{
      const name = $("q_ho_ten").value.trim();
      if(name.length < 2){ alert("Nh·∫≠p t·ªëi thi·ªÉu 2 k√Ω t·ª± ƒë·ªÉ t√¨m theo t√™n."); return; }
      $("lookupMsg").textContent = "ƒêang t√¨m theo t√™n...";
      const list = await searchByName(name);
      renderNameResults(list);
      $("lookupMsg").textContent = `T√¨m th·∫•y ${list.length} k·∫øt qu·∫£.`;
    }catch(e){ $("lookupMsg").textContent = e.message; }
  };
  $("q_ho_ten").addEventListener('keydown', (e)=>{ if(e.key==='Enter') $("btnSearchByName").click(); });

  // Update (c·∫£ 2 n√∫t)
  ["btnUpdateApplicant", "btnUpdateApplicantMain"].forEach(id=>{
    $(id)?.addEventListener("click", async () => {
      try{
        $("lookupMsg").textContent = "ƒêang c·∫≠p nh·∫≠t...";
        const res = await updateLoadedApplicant();
        $("lookupMsg").textContent = `C·∫≠p nh·∫≠t xong h·ªì s∆° ${res.ma_ho_so}.`;
        showToast(`ƒê√£ c·∫≠p nh·∫≠t h·ªì s∆° <b>${res.ma_ho_so}</b> th√†nh c√¥ng.`, "success");
      } catch(e){
        $("lookupMsg").textContent = e.message;
        showToast(e.message || "C·∫≠p nh·∫≠t th·∫•t b·∫°i.", "error");
      }
    });
  });

  // Delete
  $("btnDeleteApplicant").onclick = async () => {
    try{ await deleteLoadedApplicant(); } catch(e){ $("lookupMsg").textContent = e.message; showToast(e.message, "error"); }
  };

  // Print loaded
  $("btnPrintLoadedA5").onclick = () => {
    if (!loadedApplicant?.id) return alert("Ch∆∞a t·∫£i h·ªì s∆° n√†o.");
    openPdf(makeUrl(`/print/a5/${loadedApplicant.id}`));
  };
  $("btnPrintLoadedA42up").onclick = () => {
    if (!loadedApplicant?.id) return alert("Ch∆∞a t·∫£i h·ªì s∆° n√†o.");
    openPdf(makeUrl(`/print/a4-two-up/${loadedApplicant.id}`));
  };

  // Reload checklist
  $("btnReloadChecklist").onclick = () => loadChecklist();

  // Test API button
  $("btnTestApi").onclick = async ()=>{
    const base = apiBase();
    const pref = await pingPrefix(base);
    if (pref === null) showToast("Kh√¥ng ping ƒë∆∞·ª£c API /health", "error");
    else { API_PREFIX = pref; localStorage.setItem(STORAGE_KEY, base); showToast(`K·∫øt n·ªëi OK (${base}${pref||""}/health)`, "success"); }
  };
  $("apiBase").addEventListener("change", async ()=>{
    const base = apiBase();
    localStorage.setItem(STORAGE_KEY, base);
    const pref = await pingPrefix(base);
    if (pref === null) showToast("Kh√¥ng ping ƒë∆∞·ª£c API /health", "warn");
    else { API_PREFIX = pref; showToast("ƒê√£ c·∫≠p nh·∫≠t m√°y ch·ªß API", "success"); }
  });

  // ===== init =====
  window.addEventListener('load', async () => {
    const today = new Date().toISOString().slice(0,10);
    $("ngay_nhan_hs").value = today;
    $("batchDate").value = today;
    $("q_ma_ho_so")?.focus();

    await ensureApiBaseAndPrefix();
    await refreshAuthUI();
    await loadChecklist();
    setPrintButtonsEnabled(false);
  });
  </script>
</body>
</html>
