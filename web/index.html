<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Biên nhận hồ sơ nhập học | V-HT.PTĐT HUTECH</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
    .card { background:#ffffff; border-radius:1rem; box-shadow:0 10px 20px rgba(2,6,23,.06); padding:1.25rem; }
    .btn { padding:.5rem 1rem; border-radius:.75rem; box-shadow:0 1px 2px rgba(0,0,0,.06); font-weight:600; transition: transform .05s ease; }
    .btn:hover { transform: translateY(-1px); }
    .btn-primary { background:#2563eb; color:#fff; }
    .btn-secondary { background:#111827; color:#fff; }
    .btn-outline { background:#ffffff; border:1px solid #d1d5db; }
    .input { width:100%; border:1px solid #e5e7eb; border-radius:.75rem; padding:.5rem .75rem; outline:none; }
    .input:focus { box-shadow:0 0 0 3px rgba(59,130,246,.3); border-color:#93c5fd; }
    .label { font-size:.85rem; color:#6b7280; }
    .section-title { font-size:1.05rem; font-weight:700; margin-bottom:.5rem; }
    .kbd { padding:.15rem .35rem; border:1px solid #e5e7eb; border-radius:.375rem; background:#f8fafc; color:#334155; font-size:.75rem; }
    thead th { font-weight:700; }
    table tr:nth-child(odd) td { background:#f8fafc; }
    #toast-wrap{position:fixed;right:16px;top:16px;display:flex;flex-direction:column;gap:8px;z-index:9999}
    .toast{min-width:260px;max-width:380px;padding:10px 12px;border-radius:12px;box-shadow:0 10px 24px rgba(0,0,0,.12);color:#0f172a;font-weight:600;opacity:.98;transform:translateY(-10px);animation:toast-in .15s ease-out forwards}
    .toast.info{background:#eef2ff} .toast.success{background:#ecfeff} .toast.warn{background:#fff7ed} .toast.error{background:#fee2e2}
    @keyframes toast-in { from {opacity:.0; transform: translateY(-6px)} to {opacity:1; transform: translateY(0)} }
  </style>
  <link rel="icon" type="image/png" href="hutech.png" sizes="32x32">
  <link rel="apple-touch-icon" href="hutech.png">
  <meta name="theme-color" content="#2563eb">
</head>

<body class="bg-gray-50">
  <div id="toast-wrap"></div>

  <div class="max-w-6xl mx-auto p-6 space-y-6">
    <header class="flex items-center justify-between">
      <div class="flex items-center gap-3 min-w-0">
        <img src="hutech.png" alt="HUTECH" class="h-8 w-8 object-contain select-none" />
        <h1 class="text-2xl font-bold leading-none truncate">V-HTPTĐT BIÊN NHẬN HỒ SƠ NHẬP HỌC</h1>
      </div>

      <div class="flex items-center gap-2">
        <label class="label">API Base</label>
        <input id="apiBase" class="input w-80" />
        <button class="btn btn-outline" id="btnTestApi">Test</button>
        <button class="btn btn-outline" id="btnReloadChecklist">↻ Checklist</button>
      </div>
    </header>

    <!-- Quick Nav -->
    <nav class="flex flex-wrap items-center gap-2 -mt-2">
      <a id="navImport"   href="/import_students.html" class="btn btn-outline hidden">Import Học viên</a>
      <a id="navStudents" href="/students_list.html"   class="btn btn-outline hidden">Danh sách hồ sơ</a>
      <a id="navAdmin"    href="/admin"                class="btn btn-outline hidden">Quản lý Tài khoản</a>

      <span class="flex-1"></span>

      <span id="navHello" class="text-sm text-gray-600 hidden"></span>
      <a id="navLogin"  href="/login" class="btn btn-outline">Login</a>
      <button id="navLogout" class="btn btn-secondary hidden">LogOut</button>
    </nav>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Form tạo/cập nhật hồ sơ -->
      <section class="lg:col-span-2 card">
        <div class="section-title">Nhập Thông Tin Hồ Sơ</div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="label">Mã hồ sơ</label>
            <input class="input" id="ma_ho_so" placeholder="HS-XXXXX" />
          </div>
          <div>
            <label class="label">Ngày nhận HS</label>
            <input class="input" id="ngay_nhan_hs" type="date" />
          </div>
          <div>
            <label class="label" for="khoa">Niên Khóa</label>
            <select class="input" id="khoa" name="khoa">
              <option value="">-- Chọn khóa --</option>
              <option>23</option><option>24</option><option>25</option><option>26</option>
              <option>27</option><option>28</option><option>29</option><option>30</option>
            </select>
          </div>
        </div>

        <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="label">Họ và tên</label>
            <input class="input" id="ho_ten" />
          </div>
          <div>
            <label class="label">Mã số HV</label>
            <input class="input" id="ma_so_hv" />
          </div>
          <div>
            <label class="label">Ngày sinh</label>
            <input class="input" id="ngay_sinh" type="date" />
          </div>
          <div>
            <label class="label">Số ĐT</label>
            <input class="input" id="so_dt" />
          </div>
          <div>
            <label class="label">Ngành nhập học</label>
            <select class="input" id="nganh_nhap_hoc">
              <option value="">-- Chọn ngành --</option>
              <option>Tâm lý học</option>
              <option>Ngôn ngữ Anh</option>
              <option>Công nghệ thông tin</option>
              <option>Quản trị kinh doanh</option>
              <option>Kế toán</option>
              <option>Luật kinh tế</option>
              <option>Quản lý xây dựng</option>
              <option>Tài chính - Ngân hàng</option>
              <option>Marketing</option>
            </select>
          </div>
          <div>
            <label class="label">Đợt</label>
            <select class="input" id="dot">
              <option value="">-- Chọn đợt --</option>
              <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
              <option>6</option><option>7</option><option>8</option><option>9</option><option>10</option>
              <option>11</option><option>12</option><option>13</option><option>14</option><option>15</option>
              <option>16</option><option>17</option><option>18</option><option>19</option><option>20</option>
            </select>
          </div>
          <div>
            <label class="label">Đã TN trước đó</label>
            <select class="input" id="da_tn_truoc_do">
              <option value="">-- Chọn Đối tượng --</option>
              <option>THPT</option><option>Trung cấp</option><option>Cao đẳng</option><option>Đại học</option>
            </select>
          </div>
          <div>
            <label class="label">Người nhận (Chữ ký)</label>
            <input class="input" id="nguoi_nhan_ky_ten" />
          </div>
          <div class="md:col-span-2">
            <label class="label">Ghi chú</label>
            <input class="input" id="ghi_chu" />
          </div>
        </div>

        <!-- Checklist -->
        <div class="mt-6">
          <div class="section-title">Hồ sơ gồm</div>
          <div class="overflow-auto">
            <table class="min-w-full border bg-white">
              <thead class="bg-gray-100">
                <tr>
                  <th class="p-2 border">STT</th>
                  <th class="p-2 border text-left">Danh mục</th>
                  <th class="p-2 border">Có?</th>
                  <th class="p-2 border">Số lượng</th>
                </tr>
              </thead>
              <tbody id="docsBody"></tbody>
            </table>
          </div>
        </div>

        <div class="mt-6 flex gap-3 flex-wrap items-center">
          <button id="btnSave" class="btn btn-secondary">Lưu</button>
          <button id="btnUpdateApplicantMain" class="btn btn-secondary">Cập nhật</button>
          <button id="btnSavePrint" class="btn btn-primary">Lưu & In A4</button>
          <button id="btnSavePrintA5" class="btn btn-outline">Lưu & In A5</button>
          <span class="text-sm text-gray-500">Mẹo: nhấn <span class="kbd">Alt</span>+<span class="kbd">P</span> để Lưu & In nhanh</span>
        </div>
        <div id="msg" class="mt-3 text-sm text-green-700"></div>
      </section>

      <!-- Panel phải -->
      <aside class="card space-y-6 lg:sticky lg:top-4">
        <!-- Tra cứu & Chỉnh sửa -->
        <section>
          <div class="section-title">Tra cứu & Chỉnh sửa hồ sơ</div>
          <label class="label">Nhập Mã hồ sơ</label>
          <div class="flex gap-2">
            <input class="input flex-1" id="q_ma_ho_so" placeholder="VD: HS-0001" />
            <button id="btnLoadApplicant" class="btn btn-outline">Tải</button>
          </div>

          <label class="label mt-3 block">Hoặc nhập Họ và tên</label>
          <div class="flex gap-2">
            <input class="input flex-1" id="q_ho_ten" placeholder="VD: Nguyễn Văn A" />
            <button id="btnSearchByName" class="btn btn-outline">Tìm</button>
          </div>

          <div id="nameResults" class="mt-2 hidden">
            <div class="text-xs text-gray-500 mb-1">Chọn một kết quả để tải vào form:</div>
            <ul id="nameResultsList" class="divide-y border rounded-md bg-white"></ul>
          </div>

          <div class="grid grid-cols-2 gap-2 mt-3">
            <button id="btnUpdateApplicant" class="btn btn-secondary">Cập nhật</button>
            <button id="btnDeleteApplicant" class="btn btn-outline">Xoá</button>
          </div>

          <!-- In hồ sơ đang mở -->
          <div class="flex gap-2 mt-2">
            <button id="btnPrintLoadedA5" class="btn btn-outline" disabled>In A5</button>
            <button id="btnPrintLoadedA42up" class="btn btn-outline" disabled>In A4 (2-up)</button>
          </div>

          <p id="lookupMsg" class="text-sm text-gray-600 mt-2"></p>
        </section>

        <hr/>

        <!-- In / Xuất theo ngày -->
        <section>
          <div class="section-title">In / Xuất theo ngày</div>
          <label class="label">Ngày nhận HS</label>
          <input class="input" id="batchDate" type="date" />
          <div class="grid grid-cols-1 gap-2 mt-3">
            <button id="btnBatchPDF" class="btn btn-primary w-full">In PDF gộp</button>
            <button id="btnExportExcel" class="btn btn-outline w-full">Xuất Excel</button>
          </div>
        </section>

        <hr/>

        <!-- In / Xuất theo đợt -->
        <section>
          <div class="section-title">In / Xuất theo đợt</div>
          <label class="label">Đợt (ví dụ: Đợt 1/2025)</label>
          <input class="input" id="batchDot" placeholder="Nhập tên đợt..." />
          <div class="grid grid-cols-1 gap-2 mt-3">
            <button id="btnBatchPDFDot" class="btn btn-primary w-full">In PDF gộp theo đợt</button>
            <button id="btnExportExcelDot" class="btn btn-outline w-full">Xuất Excel theo đợt</button>
          </div>
        </section>

        <hr/>

        <section>
          <div class="section-title"><center>HELP</center></div>
          <ul class="list-disc ml-5 text-sm text-gray-600 space-y-1">
            <li>Nhớ chạy API ở <code>http://127.0.0.1:8000</code>.</li>
            <li>Đổi API Base ở góc trên nếu bạn deploy nơi khác.</li>
            <li>PDF mở trong tab mới; nếu bị chặn sẽ mở ngay tại tab.</li>
            <li>In A5: giấy A4, in 2 mặt, cắt đôi; A4 (2-up) gộp sẵn hai A5.</li>
            <li>Tìm kiếm theo mã hồ sơ hoặc họ tên.</li>
          </ul>
        </section>
      </aside>
    </div>
  </div>

  <footer class="max-w-6xl mx-auto px-6 pb-4 text-right text-xs text-gray-500">
    code by: <span class="font-semibold">HC- Tuan</span>
  </footer>

  <!-- Scripts -->
  <script>
  // ========= helpers chung =========
  const $ = (id) => document.getElementById(id);

  // Toast
  function showToast(msg, type='info', ms=2500){
    const wrap = document.getElementById('toast-wrap');
    const el = document.createElement('div');
    el.className = `toast ${type}`;
    el.innerHTML = msg;
    wrap.appendChild(el);
    const t = setTimeout(()=>{ el.style.transition='opacity .15s'; el.style.opacity='0';
      setTimeout(()=> el.remove(), 180);
    }, ms);
    el.onclick = ()=>{ clearTimeout(t); el.remove(); };
  }

  // ==== Date utils (2 dạng cho POST vs PUT) ====
  // input date (YYYY-MM-DD) -> "DD-MM-YYYY" (create dùng)
  function ymdToDMY_HYPHEN(s){
    if(!s) return "";
    const m = String(s).match(/^(\d{4})-(\d{2})-(\d{2})$/);
    return m ? `${m[3]}-${m[2]}-${m[1]}` : s;
  }
  // input date (YYYY-MM-DD) -> "YYYY-MM-DD" (update dùng luôn)
  function ymdKeep(s){ return (s||"").slice(0,10); }

  // server trả ISO/str -> set vào <input type=date>
  function fmtDateToInput(s){
    if(!s) return "";
    // chấp nhận dd/mm hoặc dd-mm
    const m = String(s).match(/^(\d{1,2})[\/-](\d{1,2})[\/-](\d{4})$/);
    if (m) return `${m[3]}-${m[2].padStart(2,'0')}-${m[1].padStart(2,'0')}`;
    const d = new Date(s);
    return Number.isNaN(d.getTime()) ? String(s).slice(0,10) : d.toISOString().slice(0,10);
  }

  // ========= API base / prefix =========
  const STORAGE_KEY = "apiBase";
  let API_PREFIX = ""; // "" hoặc "/api"

  function apiBase(){ return $("apiBase").value.trim().replace(/\/+$/,''); }

  async function pingPrefix(base){
    try{
      let r = await fetch(base + "/health", {credentials:"include"});
      if (r.ok) return "";
    }catch(_){}
    try{
      let r2 = await fetch(base + "/api/health", {credentials:"include"});
      if (r2.ok) return "/api";
    }catch(_){}
    return null;
  }

  async function ensureApiBaseAndPrefix(){
    // ưu tiên localStorage, fallback origin
    let base = localStorage.getItem(STORAGE_KEY) || window.location.origin;
    $("apiBase").value = base;
    let pref = await pingPrefix(base);
    if (pref !== null){ API_PREFIX = pref; return; }

    // gợi ý vài base
    const guesses = [
      base, window.location.origin,
      "http://127.0.0.1:8000",
      "http://localhost:8000"
    ];
    for (const g of guesses){
      const p = await pingPrefix(g);
      if (p !== null){ $("apiBase").value = g; localStorage.setItem(STORAGE_KEY, g); API_PREFIX = p; return; }
    }

    // hỏi tay đến khi OK hoặc hủy
    for(;;){
      const m = prompt("Không kết nối được API.\nNhập IP/URL server (vd: http://192.168.2.82:8000):", base);
      if (!m) break;
      const p = await pingPrefix(m.trim());
      if (p !== null){ $("apiBase").value = m.trim(); localStorage.setItem(STORAGE_KEY, m.trim()); API_PREFIX = p; return; }
      base = m.trim();
    }
    // nếu vẫn chưa set được, để prefix = "" (fetch sẽ lỗi và hiện toast)
    API_PREFIX = "";
  }

  function makeUrl(path){ return apiBase() + API_PREFIX + path; }

  async function apiFetch(path, init={}){
    const opts = { credentials: "include", ...init };
    let r = await fetch(makeUrl(path), opts).catch(()=>null);
    return r; // đã xác định prefix từ đầu
  }

  function handleAuth(r){
    if (r && (r.status===401 || r.status===403)){
      showToast("Phiên đăng nhập đã hết hạn, vui lòng đăng nhập lại.", "warn", 2500);
      setTimeout(()=>location.href="/login", 700);
      return true;
    }
    return false;
  }
  const safeJson = async (r)=>{ try{ return await r.json(); }catch{ return {}; } };

  // ====== NAV / Auth UI ======
  async function refreshAuthUI(){
    try{
      const r = await apiFetch('/me');
      if (!r || r.status===401 || r.status===403){ // chưa đăng nhập
        ["navImport","navStudents","navAdmin","navHello"].forEach(id=>$(id)?.classList.add("hidden"));
        $("navLogin").classList.remove("hidden");
        $("navLogout").classList.add("hidden");
        // đẩy về login cho chắc
        location.href = "/login";
        return;
      }
      if (r.ok){
        const me = await r.json();
        const hello = `Xin chào, ${me.full_name || me.username} (${me.role})`;
        $("navHello").textContent = hello;
        $("navHello").classList.remove("hidden");
        $("navLogin").classList.add("hidden");
        $("navLogout").classList.remove("hidden");

        const isAdmin  = me.role === "Admin";
        const isStaff  = isAdmin || me.role === "NhanVien";

        if (isStaff) { $("navImport")?.classList.remove("hidden"); $("navStudents")?.classList.remove("hidden"); }
        else { $("navImport")?.classList.add("hidden"); $("navStudents")?.classList.add("hidden"); }

        if (isAdmin) $("navAdmin")?.classList.remove("hidden");
        else         $("navAdmin")?.classList.add("hidden");

        // auto điền người nhận nếu trống
        const rec = $("nguoi_nhan_ky_ten");
        if (rec && !rec.value) rec.value = me.full_name || me.username || "";
      }
    }catch(_){
      ["navImport","navStudents","navAdmin","navHello"].forEach(id=>$(id)?.classList.add("hidden"));
      $("navLogin").classList.remove("hidden");
      $("navLogout").classList.add("hidden");
      location.href = "/login";
    }
  }
  $("navLogout")?.addEventListener("click", async ()=>{
    try{ await apiFetch('/logout', {method:'POST'}); }catch(_){}
    location.href = '/login';
  });

  // ===== Checklist =====
  const DEFAULT_QTY = {
    bang_tot_nghiep_dai_hoc: 2,
    bang_diem_dai_hoc: 2,
    bang_tot_nghiep_cao_dang: 2,
    bang_diem_cao_dang: 2,
    bang_tot_nghiep_trung_cap: 2,
    bang_diem_trung_cap: 2,
    anh_3x4: 2,
  };
  const getDefaultQty = (code) => DEFAULT_QTY[code] ?? 1;

  async function loadChecklist() {
    try {
      const r = await apiFetch("/checklist/active");
      if (!r || !r.ok) { showToast("Không lấy được checklist", "error"); return; }
      const data = await r.json();
      const body = $("docsBody");
      body.innerHTML = "";

      (data.items||[])
        .sort((a,b)=> (a.order_index ?? a.order_no ?? 0) - (b.order_index ?? b.order_no ?? 0))
        .forEach((it, idx) => {
          const def = getDefaultQty(it.code);
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td class="p-2 border text-center">${idx+1}</td>
            <td class="p-2 border"><div class="font-medium">${it.display_name}</div></td>
            <td class="p-2 border text-center">
              <input type="checkbox" class="w-5 h-5 has-doc" data-code="${it.code}">
            </td>
            <td class="p-2 border text-center">
              <input type="number" min="0"
                     class="input w-24 text-center qty bg-gray-100 text-gray-400"
                     data-code="${it.code}" value="" placeholder="${def}" disabled />
            </td>`;
          body.appendChild(tr);
        });

      // toggle enable/disable ô số lượng
      document.querySelectorAll('.has-doc').forEach((chk) => {
        const code = chk.dataset.code;
        const qty = document.querySelector(`.qty[data-code="${code}"]`);
        const def = getDefaultQty(code);
        chk.addEventListener("change", () => {
          if (chk.checked) {
            qty.value = String(def);
            qty.disabled = false;
            qty.classList.remove("bg-gray-100", "text-gray-400");
          } else {
            qty.value = "";
            qty.disabled = true;
            qty.classList.add("bg-gray-100", "text-gray-400");
          }
        });
      });
    } catch (err) {
      console.error(err);
      showToast('Lỗi tải checklist', 'error');
    }
  }

  function collectDocs() {
    const rows = Array.from(document.querySelectorAll('#docsBody tr'));
    return rows.map(tr => {
      const chk  = tr.querySelector('.has-doc');
      const qtyI = tr.querySelector('.qty');
      const code = chk.dataset.code;
      const def  = getDefaultQty(code);
      let val = chk.checked ? Number(qtyI.value || def) : 0;
      if (!Number.isFinite(val) || val < 0) val = 0;
      return { code, so_luong: val };
    });
  }

  // ===== Payloads: create vs update (khác định dạng ngày) =====
  function payloadForCreate() {
    return {
      ma_ho_so: $("ma_ho_so").value.trim(),
      ngay_nhan_hs: ymdToDMY_HYPHEN($("ngay_nhan_hs").value), // DD-MM-YYYY
      ho_ten: $("ho_ten").value.trim(),
      ma_so_hv: $("ma_so_hv").value.trim(),
      ngay_sinh: ymdToDMY_HYPHEN($("ngay_sinh").value) || null, // DD-MM-YYYY
      so_dt: $("so_dt").value.trim() || null,
      nganh_nhap_hoc: $("nganh_nhap_hoc").value.trim() || null,
      dot: $("dot").value.trim() || null,
      khoa: $("khoa").value.trim() || null,
      da_tn_truoc_do: $("da_tn_truoc_do").value || null,
      ghi_chu: $("ghi_chu").value.trim() || null,
      nguoi_nhan_ky_ten: $("nguoi_nhan_ky_ten").value.trim() || null,
      docs: collectDocs(),
      checklist_version_name: "v1"
    };
  }
  function payloadForUpdate() {
    return {
      ma_ho_so: $("ma_ho_so").value.trim(),
      ngay_nhan_hs: ymdKeep($("ngay_nhan_hs").value), // YYYY-MM-DD
      ho_ten: $("ho_ten").value.trim(),
      ma_so_hv: $("ma_so_hv").value.trim(),
      ngay_sinh: ymdKeep($("ngay_sinh").value) || null, // YYYY-MM-DD
      so_dt: $("so_dt").value.trim() || null,
      nganh_nhap_hoc: $("nganh_nhap_hoc").value.trim() || null,
      dot: $("dot").value.trim() || null,
      khoa: $("khoa").value.trim() || null,
      da_tn_truoc_do: $("da_tn_truoc_do").value || null,
      ghi_chu: $("ghi_chu").value.trim() || null,
      nguoi_nhan_ky_ten: $("nguoi_nhan_ky_ten").value.trim() || null,
      docs: collectDocs()
    };
  }

  // ===== Save / Create =====
  async function createApplicant(){
    const body = payloadForCreate();
    if(!body.ma_ho_so || !body.ho_ten || !body.ma_so_hv || !body.ngay_nhan_hs){
      showToast("Thiếu Mã hồ sơ / Họ tên / MSHV / Ngày nhận.", "error");
      return null;
    }
    const r = await apiFetch("/applicants", { method: "POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(body) });
    if (handleAuth(r)) return null;
    const j = await safeJson(r);
    if (!r || !r.ok){ showToast(j.detail || `Lỗi lưu (HTTP ${r ? r.status : '???'})`, "error", 4000); return null; }
    window.loadedApplicant = { id: j.id, ma_ho_so: body.ma_ho_so };
    setPrintButtonsEnabled(true);
    return j;
  }

  // ===== Lookup / Update / Delete =====
  let loadedApplicant = null;
  let loadedDocsByCode = {};

  function setPrintButtonsEnabled(on) {
    $("btnPrintLoadedA5").disabled   = !on;
    $("btnPrintLoadedA42up").disabled = !on;
  }

  function populateFormFromApplicant(a, docs){
    $("ma_ho_so").value = a.ma_ho_so || "";
    $("ngay_nhan_hs").value = fmtDateToInput(a.ngay_nhan_hs);
    $("khoa").value = a.khoa || "";
    $("ho_ten").value = a.ho_ten || "";
    $("ma_so_hv").value = a.ma_so_hv || "";
    $("ngay_sinh").value = fmtDateToInput(a.ngay_sinh);
    $("so_dt").value = a.so_dt || "";
    $("nganh_nhap_hoc").value = a.nganh_nhap_hoc || "";
    $("dot").value = a.dot || "";
    $("da_tn_truoc_do").value = a.da_tn_truoc_do || "";
    $("ghi_chu").value = a.ghi_chu || "";
    $("nguoi_nhan_ky_ten").value = a.nguoi_nhan_ky_ten || "";

    loadedDocsByCode = {}; (docs||[]).forEach(d => loadedDocsByCode[d.code] = d.so_luong || 0);

    const applyDocsToTable = () => {
      document.querySelectorAll('.has-doc').forEach(chk => {
        const code = chk.dataset.code;
        const qty = document.querySelector(`.qty[data-code="${code}"]`);
        const n = loadedDocsByCode[code] ?? 0;
        if (n > 0) { chk.checked = true; qty.disabled = false; qty.classList.remove("bg-gray-100","text-gray-400"); qty.value = String(n); }
        else { chk.checked = false; qty.disabled = true; qty.classList.add("bg-gray-100","text-gray-400"); qty.value = ""; }
      });
    };
    if (document.querySelectorAll('#docsBody tr').length === 0) loadChecklist().then(applyDocsToTable); else applyDocsToTable();
  }

  async function loadApplicantByCode(code){
    let r = await apiFetch(`/applicants/find?ma_ho_so=${encodeURIComponent(code)}`);
    if (!r || r.status === 404 || r.status === 405) r = await apiFetch(`/applicants/by-code/${encodeURIComponent(code)}`);
    if (!r || !r.ok) {
      if (r && r.status === 404) showToast(`Không tìm thấy hồ sơ ${code}`, "warn");
      const t = r ? await r.text() : "(không phản hồi)";
      throw new Error(`Lỗi tải hồ sơ (HTTP ${r ? r.status : '???'})\n${t}`);
    }
    const data = await r.json();
    const raw = (data && data.applicant) ? { ...data.applicant, docs: data.docs || [] } : data;
    // backend có thể trả dd/mm hoặc ISO, đã normalize khi set input
    return raw;
  }

  async function updateLoadedApplicant(){
    if(!loadedApplicant?.id){ throw new Error("Chưa tải hồ sơ nào để cập nhật."); }
    const body = payloadForUpdate();
    const r = await apiFetch(`/applicants/${loadedApplicant.id}`, { method: "PUT", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(body) });
    if (handleAuth(r)) return;
    if(!r || !r.ok){ const t = r ? await r.text() : "(không phản hồi)"; throw new Error(`Cập nhật thất bại (HTTP ${r ? r.status : '???'})\n${t}`); }
    return r.json();
  }

  async function deleteLoadedApplicant(){
    if(!loadedApplicant?.id){ throw new Error("Chưa tải hồ sơ nào để xoá."); }
    if(!confirm(`Xoá hồ sơ ${loadedApplicant.ma_ho_so}?`)) return;
    const r = await apiFetch(`/applicants/${loadedApplicant.id}`, { method: "DELETE" });
    if (handleAuth(r)) return;
    if(!r || !r.ok){ const t = r ? await r.text() : "(không phản hồi)"; throw new Error(`Xoá thất bại (HTTP ${r ? r.status : '???'})\n${t}`); }
    loadedApplicant = null; loadedDocsByCode = {};
    setPrintButtonsEnabled(false);
    $("lookupMsg").textContent = "Đã xoá hồ sơ.";
    showToast("Đã xoá hồ sơ.", "info");
  }

  async function searchByName(name){
    const r = await apiFetch(`/applicants/search?q=${encodeURIComponent(name)}`);
    if(!r || !r.ok){ const t = r ? await r.text() : "(không phản hồi)"; throw new Error(`Tìm theo tên lỗi (HTTP ${r ? r.status : '???'})\n${t}`); }
    return r.json();
  }

  function renderNameResults(list){
    const box = $("nameResults");
    const ul  = $("nameResultsList");
    if(!list || list.length === 0){
      box.classList.remove("hidden");
      ul.innerHTML = '<li class="p-2 text-sm text-gray-500">Không tìm thấy.</li>';
      return;
    }
    ul.innerHTML = list.map(it => {
      const ngay = it.ngay_nhan_hs ? String(it.ngay_nhan_hs).slice(0,10) : '';
      return `
        <li class="p-2 hover:bg-gray-50 cursor-pointer" data-code="${it.ma_ho_so}">
          <div class="flex justify-between">
            <div class="font-medium">${it.ho_ten}</div>
            <div class="text-xs text-gray-500">${ngay}</div>
          </div>
          <div class="text-xs text-gray-600">
            Mã: <span class="font-semibold">${it.ma_ho_so}</span>
            • MSHV: ${it.ma_so_hv||''}
            • Đợt: ${it.dot||''}
          </div>
        </li>`;
    }).join("");
    if (!ul._boundClick) {
      ul.addEventListener('click', (e)=>{
        const li = e.target.closest('li[data-code]');
        if (!li) return;
        const code = li.dataset.code;
        $("q_ma_ho_so").value = code;
        box.classList.add('hidden');
        $("btnLoadApplicant").click();
      });
      ul._boundClick = true;
    }
    box.classList.remove('hidden');
  }

  // ===== In / Export =====
  function openPdf(url){
    const w = window.open(url, "_blank");
    if(!w){ window.location.href = url; }
  }

  $("btnBatchPDF").onclick = async () => {
    const d = $("batchDate").value;
    if (!d) { alert("Chọn ngày nhận HS"); return; }
    const resp = await apiFetch(`/batch/print?day=${encodeURIComponent(d)}`);
    if (!resp || !resp.ok) {
      let msg = `Không thể in (HTTP ${resp?.status||'???'})`;
      try { const j = await resp.json(); if (j?.detail) msg = j.detail; } catch {}
      alert(msg); return;
    }
    const blob = await resp.blob();
    const u = URL.createObjectURL(blob);
    window.open(u, "_blank"); setTimeout(()=>URL.revokeObjectURL(u), 60000);
  };

  $("btnExportExcel").onclick = async () => {
    const d = $("batchDate").value;
    if (!d) { alert("Chọn ngày nhận HS"); return; }
    const resp = await apiFetch(`/export/excel?day=${encodeURIComponent(d)}`);
    if (!resp || !resp.ok) {
      let msg = `Không thể xuất Excel (HTTP ${resp?.status||'???'})`;
      try { const j = await resp.json(); if (j?.detail) msg = j.detail; } catch {}
      alert(msg); return;
    }
    const blob = await resp.blob();
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `tong_ngay_${d}.xlsx`;
    document.body.appendChild(a); a.click(); a.remove();
    setTimeout(()=>URL.revokeObjectURL(a.href), 60000);
  };

  $("btnBatchPDFDot").onclick = async () => {
    const dot = $("batchDot").value.trim();
    if (!dot) { alert("Nhập tên đợt trước đã"); return; }
    const resp = await apiFetch(`/batch/print-dot?dot=${encodeURIComponent(dot)}`);
    if (!resp || !resp.ok) {
      let msg = `Không thể in theo đợt (HTTP ${resp?.status||'???'})`;
      try { const j = await resp.json(); if (j?.detail) msg = j.detail; } catch {}
      alert(msg); return;
    }
    const blob = await resp.blob();
    const u = URL.createObjectURL(blob);
    window.open(u, "_blank"); setTimeout(()=>URL.revokeObjectURL(u), 60000);
  };

  $("btnExportExcelDot").onclick = async () => {
    const dot = $("batchDot").value.trim();
    if (!dot) { alert("Nhập tên đợt trước đã"); return; }
    const resp = await apiFetch(`/export/excel-dot?dot=${encodeURIComponent(dot)}`);
    if (!resp || !resp.ok) {
      let msg = `Không thể xuất Excel theo đợt (HTTP ${resp?.status||'???'})`;
      try { const j = await resp.json(); if (j?.detail) msg = j.detail; } catch {}
      alert(msg); return;
    }
    const blob = await resp.blob();
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `tong_dot_${dot}.xlsx`;
    document.body.appendChild(a); a.click(); a.remove();
    setTimeout(()=>URL.revokeObjectURL(a.href), 60000);
  };

  // ===== Bind form actions =====
  $("btnSave").onclick = async () => {
    const btn = $("btnSave");
    btn.disabled = true; const old = btn.textContent; btn.textContent = "Đang lưu...";
    try{
      const res = await createApplicant();
      if (res) {
        $("msg").textContent = `Đã lưu hồ sơ ${res.ma_ho_so} (id=${res.id}).`;
        showToast(`Đã lưu hồ sơ <b>${res.ma_ho_so}</b>.`, "success");
      }
    } finally{
      btn.disabled = false; btn.textContent = old;
    }
  };

  $("btnSavePrint").onclick = async () => {
    const res = await createApplicant();
    if (res) {
      openPdf(makeUrl(`/print/a4-two-up/${res.id}`));
      $("msg").textContent = `Đã lưu & in A4 (2-up) hồ sơ ${res.ma_ho_so}.`;
      showToast(`Đã lưu & gửi in <b>${res.ma_ho_so}</b>.`, "success");
    }
  };

  $("btnSavePrintA5").onclick = async () => {
    const res = await createApplicant();
    if (res) {
      openPdf(makeUrl(`/print/a5/${res.id}`));
      $("msg").textContent = `Đã lưu & in A5 hồ sơ ${res.ma_ho_so}.`;
      showToast(`Đã lưu & gửi in <b>${res.ma_ho_so}</b>.`, "success");
    }
  };

  // Alt+P -> Lưu & In (A4 2-up)
  document.addEventListener('keydown', (e) => {
    if (e.altKey && (e.key === 'p' || e.key === 'P')) $("btnSavePrint").click();
  });

  // Lookup bindings
  $("btnLoadApplicant").onclick = async () => {
    try{
      const code = $("q_ma_ho_so").value.trim();
      if(!code){ alert("Nhập Mã hồ sơ hoặc dùng ô tìm theo tên phía dưới."); return; }
      $("lookupMsg").textContent = "Đang tải...";
      const a = await loadApplicantByCode(code);
      loadedApplicant = { id: a.id, ma_ho_so: a.ma_ho_so };
      populateFormFromApplicant(a, a.docs || []);
      setPrintButtonsEnabled(true);
      $("lookupMsg").textContent = `Đã tải hồ sơ ${a.ma_ho_so} (id=${a.id}).`;
    }catch(e){
      $("lookupMsg").textContent = e.message;
      setPrintButtonsEnabled(false);
    }
  };
  $("q_ma_ho_so").addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); $("btnLoadApplicant").click(); } });

  $("btnSearchByName").onclick = async () => {
    try{
      const name = $("q_ho_ten").value.trim();
      if(name.length < 2){ alert("Nhập tối thiểu 2 ký tự để tìm theo tên."); return; }
      $("lookupMsg").textContent = "Đang tìm theo tên...";
      const list = await searchByName(name);
      renderNameResults(list);
      $("lookupMsg").textContent = `Tìm thấy ${list.length} kết quả.`;
    }catch(e){ $("lookupMsg").textContent = e.message; }
  };
  $("q_ho_ten").addEventListener('keydown', (e)=>{ if(e.key==='Enter') $("btnSearchByName").click(); });

  // Update (cả 2 nút)
  ["btnUpdateApplicant", "btnUpdateApplicantMain"].forEach(id=>{
    $(id)?.addEventListener("click", async () => {
      try{
        $("lookupMsg").textContent = "Đang cập nhật...";
        const res = await updateLoadedApplicant();
        $("lookupMsg").textContent = `Cập nhật xong hồ sơ ${res.ma_ho_so}.`;
        showToast(`Đã cập nhật hồ sơ <b>${res.ma_ho_so}</b> thành công.`, "success");
      } catch(e){
        $("lookupMsg").textContent = e.message;
        showToast(e.message || "Cập nhật thất bại.", "error");
      }
    });
  });

  // Delete
  $("btnDeleteApplicant").onclick = async () => {
    try{ await deleteLoadedApplicant(); } catch(e){ $("lookupMsg").textContent = e.message; showToast(e.message, "error"); }
  };

  // Print loaded
  $("btnPrintLoadedA5").onclick = () => {
    if (!loadedApplicant?.id) return alert("Chưa tải hồ sơ nào.");
    openPdf(makeUrl(`/print/a5/${loadedApplicant.id}`));
  };
  $("btnPrintLoadedA42up").onclick = () => {
    if (!loadedApplicant?.id) return alert("Chưa tải hồ sơ nào.");
    openPdf(makeUrl(`/print/a4-two-up/${loadedApplicant.id}`));
  };

  // Reload checklist
  $("btnReloadChecklist").onclick = () => loadChecklist();

  // Test API button
  $("btnTestApi").onclick = async ()=>{
    const base = apiBase();
    const pref = await pingPrefix(base);
    if (pref === null) showToast("Không ping được API /health", "error");
    else { API_PREFIX = pref; localStorage.setItem(STORAGE_KEY, base); showToast(`Kết nối OK (${base}${pref||""}/health)`, "success"); }
  };
  $("apiBase").addEventListener("change", async ()=>{
    const base = apiBase();
    localStorage.setItem(STORAGE_KEY, base);
    const pref = await pingPrefix(base);
    if (pref === null) showToast("Không ping được API /health", "warn");
    else { API_PREFIX = pref; showToast("Đã cập nhật máy chủ API", "success"); }
  });

  // ===== init =====
  window.addEventListener('load', async () => {
    const today = new Date().toISOString().slice(0,10);
    $("ngay_nhan_hs").value = today;
    $("batchDate").value = today;
    $("q_ma_ho_so")?.focus();

    await ensureApiBaseAndPrefix();
    await refreshAuthUI();
    await loadChecklist();
    setPrintButtonsEnabled(false);
  });
  </script>
</body>
</html>
