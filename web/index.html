<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bi√™n nh·∫≠n h·ªì s∆° nh·∫≠p h·ªçc | V-HT.PTƒêT HUTECH</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
    .card { background:#ffffff; border-radius:1rem; box-shadow:0 10px 20px rgba(3, 4, 5, 0.06); padding:1.25rem; }
    .btn { padding:.5rem 1rem; border-radius:.75rem; box-shadow:0 1px 2px rgba(0,0,0,.06); font-weight:600; transition: transform .05s ease; }
    .btn:hover { transform: translateY(-1px); }
    .btn-primary { background:#2563eb; color:#fff; }
    .btn-secondary { background:#111827; color:#fff; }
    .btn-outline { background:#ffffff; border:1px solid #d1d5db; }
    .input { width:100%; border:1px solid #e5e7eb; border-radius:.75rem; padding:.5rem .75rem; outline:none; }
    .input:focus { box-shadow:0 0 0 3px rgba(59,130,246,.3); border-color:#93c5fd; }
    .label { font-size:.85rem; color:#6b7280; }
    .section-title { font-size:1.05rem; font-weight:700; margin-bottom:.5rem; }
    .kbd { padding:.15rem .35rem; border:1px solid #e5e7eb; border-radius:.375rem; background:#f8fafc; color:#334155; font-size:.75rem; }
    thead th { font-weight:700; }
    table tr:nth-child(odd) td { background:#f8fafc; }
    #toast-wrap{position:fixed;right:16px;top:16px;display:flex;flex-direction:column;gap:8px;z-index:9999}
    .toast{min-width:260px;max-width:380px;padding:10px 12px;border-radius:12px;box-shadow:0 10px 24px rgba(0,0,0,.12);color:#0f172a;font-weight:600;opacity:.98;transform:translateY(-10px);animation:toast-in .15s ease-out forwards}
    .toast.info{background:#eef2ff} .toast.success{background:#ecfeff} .toast.warn{background:#fff7ed} .toast.error{background:#fee2e2}
    @keyframes toast-in { from {opacity:.0; transform: translateY(-6px)} to {opacity:1; transform: translateY(0)} }
  </style>
  <link rel="icon" type="image/png" href="hutech.png" sizes="32x32">
  <link rel="apple-touch-icon" href="hutech.png">
  <meta name="theme-color" content="#2563eb">
</head>

<body class="bg-gray-50">
  <div id="toast-wrap"></div>

  <div class="max-w-6xl mx-auto p-6 space-y-6">
    <header class="flex items-center justify-between">
      <div class="flex items-center gap-3 min-w-0">
        <img src="hutech.png" alt="HUTECH" class="h-8 w-8 object-contain select-none" />
        <h1 class="text-2xl font-bold leading-none truncate">V-HTPTƒêT BI√äN NH·∫¨N H·ªí S∆† NH·∫¨P H·ªåC</h1>
      </div>

      <div class="flex items-center gap-2">
        <label class="label">API Base</label>
        <input id="apiBase" class="input w-80" />
        <button class="btn btn-outline" id="btnTestApi">Test</button>
        <button class="btn btn-outline" id="btnReloadChecklist">‚Üª Checklist</button>
      </div>
    </header>

    <!-- Quick Nav -->
    <nav class="flex flex-wrap items-center gap-2 -mt-2">
      <a id="navImport"   href="/import_students.html" class="btn btn-outline hidden">Import H·ªçc vi√™n</a>
      <a id="navStudents" href="/students_list.html"   class="btn btn-outline hidden">Danh s√°ch h·ªì s∆°</a>
      <a id="navAdmin"    href="/admin"                class="btn btn-outline hidden">Qu·∫£n l√Ω T√†i kho·∫£n</a>

      <span class="flex-1"></span>

      <span id="navHello" class="text-sm text-gray-600 hidden"></span>
      <a id="navLogin"  href="/login" class="btn btn-outline">Login</a>
      <button id="navLogout" class="btn btn-secondary hidden">LogOut</button>
    </nav>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Form t·∫°o/c·∫≠p nh·∫≠t h·ªì s∆° -->
      <section class="lg:col-span-2 card">
        <div class="section-title">Nh·∫≠p Th√¥ng Tin H·ªì S∆°</div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="label">M√£ h·ªì s∆°</label>
            <input class="input" id="ma_ho_so" placeholder="HS-XXXXX" />
          </div>
          <div>
            <label class="label">Ng√†y nh·∫≠n HS</label>
            <input class="input" id="ngay_nhan_hs" type="date" />
          </div>
          <div>
            <label class="label" for="khoa">Ni√™n Kh√≥a</label>
            <select class="input" id="khoa" name="khoa">
              <option value="">-- Ch·ªçn kh√≥a --</option>
              <option>23</option><option>24</option><option>25</option><option>26</option>
              <option>27</option><option>28</option><option>29</option><option>30</option>
            </select>
          </div>
          <div>
            <label class="label">ƒê·ª£t</label>
            <select class="input" id="dot">
              <option value="">-- Ch·ªçn ƒë·ª£t --</option>
              <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
              <option>6</option><option>7</option><option>8</option><option>9</option><option>10</option>
              <option>11</option><option>12</option><option>13</option><option>14</option><option>15</option>
              <option>16</option><option>17</option><option>18</option><option>19</option><option>20</option>
            </select>
          </div>
        </div>

        <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="label">H·ªç v√† t√™n</label>
            <input class="input" id="ho_ten" />
          </div>
          <div>
            <label class="label">M√£ s·ªë HV</label>
            <input class="input" id="ma_so_hv" />
          </div>
          <div>
            <label class="label">Ng√†y sinh</label>
            <input class="input" id="ngay_sinh" type="date" />
          </div>
          <div>
            <label class="label">S·ªë ƒêT</label>
            <input class="input" id="so_dt" />
          </div>
          <div>
            <label class="label">Email h·ªçc vi√™n</label>
            <input class="input" id="email_hoc_vien" type="email" />
          </div>
          <div>
            <label class="label">Ng√†nh nh·∫≠p h·ªçc</label>
            <select class="input" id="nganh_nhap_hoc">
              <option value="">-- Ch·ªçn ng√†nh --</option>
              <option>T√¢m l√Ω h·ªçc</option>
              <option>Ng√¥n ng·ªØ Anh</option>
              <option>C√¥ng ngh·ªá th√¥ng tin</option>
              <option>Qu·∫£n tr·ªã kinh doanh</option>
              <option>K·∫ø to√°n</option>
              <option>Lu·∫≠t kinh t·∫ø</option>
              <option>Qu·∫£n l√Ω x√¢y d·ª±ng</option>
              <option>T√†i ch√≠nh - Ng√¢n h√†ng</option>
              <option>Marketing</option>
            </select>
          </div>
          <div>
            <label class="label">ƒê√£ TN tr∆∞·ªõc ƒë√≥</label>
            <select class="input" id="da_tn_truoc_do">
              <option value="">-- Ch·ªçn ƒê·ªëi t∆∞·ª£ng --</option>
              <option>THPT</option><option>Trung c·∫•p</option><option>Cao ƒë·∫≥ng</option><option>ƒê·∫°i h·ªçc</option>
            </select>
          </div>
          <div>
            <label class="label">Ng∆∞·ªùi nh·∫≠n (Ch·ªØ k√Ω)</label>
            <div class="relative">
              <input
                id="nguoi_nhan_ky_ten"
                class="input pr-9 bg-gray-100 text-gray-500 cursor-not-allowed"
                readonly
                title="T·ª± ƒë·ªông l·∫•y theo t√†i kho·∫£n ƒëƒÉng nh·∫≠p"
              />
              <span class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 select-none" title="ƒê√£ kh√≥a">üîí</span>
            </div>
          </div>
          <div class="md:col-span-2">
            <label class="label">Ghi ch√∫</label>
            <input class="input" id="ghi_chu" />
          </div>
        </div>

        <!-- Checklist -->
        <div class="mt-6">
          <div class="section-title">H·ªì s∆° g·ªìm</div>
          <div class="overflow-auto">
            <table class="min-w-full border bg-white">
              <thead class="bg-gray-100">
                <tr>
                  <th class="p-2 border">STT</th>
                  <th class="p-2 border text-left">Danh m·ª•c</th>
                  <th class="p-2 border">C√≥?</th>
                  <th class="p-2 border">S·ªë l∆∞·ª£ng</th>
                </tr>
              </thead>
              <tbody id="docsBody"></tbody>
            </table>
          </div>
        </div>

        <div class="mt-6 flex gap-3 flex-wrap items-center">
          <button id="btnSave" class="btn btn-secondary">L∆∞u</button>
          <button id="btnUpdateApplicantMain" class="btn btn-secondary">C·∫≠p nh·∫≠t</button>
        </div>
        <div id="msg" class="mt-3 text-sm text-green-700"></div>
      </section>

      <!-- Panel ph·∫£i -->
      <aside class="card space-y-6 lg:sticky lg:top-4">
        <!-- Tra c·ª©u & Ch·ªânh s·ª≠a -->
        <section>
          <div class="section-title">Tra c·ª©u & Ch·ªânh s·ª≠a h·ªì s∆°</div>

          <label class="label">Nh·∫≠p M√£ S·ªë H·ªçc Vi√™n</label>
          <div class="flex gap-2">
            <input class="input flex-1" id="q_ma_so_hv" placeholder="VD: 2510xxxxxx" />
            <button id="btnLoadApplicantMSHV" class="btn btn-outline">T·∫£i</button>
          </div>

          <label class="label mt-3 block">Ho·∫∑c Nh·∫≠p H·ªç v√† t√™n</label>
          <div class="flex gap-2">
            <input class="input flex-1" id="q_ho_ten" placeholder="VD: Nguy·ªÖn VƒÉn A" />
            <button id="btnSearchByName" class="btn btn-outline">T√¨m</button>
          </div>

          <div id="nameResults" class="mt-2 hidden">
            <div class="text-xs text-gray-500 mb-1">Ch·ªçn m·ªôt k·∫øt qu·∫£ ƒë·ªÉ t·∫£i v√†o form:</div>
            <ul id="nameResultsList" class="divide-y border rounded-md bg-white"></ul>
          </div>

          <div class="grid grid-cols-2 gap-2 mt-3">
            <button id="btnUpdateApplicant" class="btn btn-secondary">C·∫≠p nh·∫≠t</button>
            <button id="btnDeleteApplicant" class="btn btn-outline">Xo√°</button>
          </div>

          <!-- In h·ªì s∆° ƒëang m·ªü -->
          <div class="flex gap-2 mt-2">
            <button id="btnPrintLoadedA5" class="btn btn-outline" disabled>In A5</button>
            <button id="btnPrintLoadedA4" class="btn btn-outline" disabled>In A4</button>
          </div>
          <p id="lookupMsg" class="text-sm text-gray-600 mt-2"></p>
        </section>

        <hr/>

        <!-- In / Xu·∫•t theo ng√†y -->
        <section>
          <div class="section-title">In / Xu·∫•t theo ng√†y</div>
          <label class="label">Ng√†y nh·∫≠n HS</label>
          <input class="input" id="batchDate" type="date" />
          <div class="grid grid-cols-1 gap-2 mt-3">
            <button id="btnBatchPDF" class="btn btn-primary w-full">In PDF g·ªôp</button>
            <button id="btnExportExcel" class="btn btn-outline w-full">Xu·∫•t Excel</button>
          </div>
        </section>

        <hr/>

        <!-- In / Xu·∫•t theo ƒë·ª£t -->
        <section>
          <div class="section-title">In / Xu·∫•t theo ƒë·ª£t</div>

          <label class="label">Nh·∫≠p (v√≠ d·ª•: ƒê·ª£t 1 Kh√≥a 24)</label>
          <div class="flex flex-wrap items-center gap-2">
            <input class="input w-24 sm:w-28 md:w-32 flex-noneinput w-25 text-center" id="batchDot" placeholder="Nh·∫≠p ƒë·ª£t" />
            <input class="input w-24 sm:w-28 md:w-32 flex-none" id="batchKhoa" placeholder="Nh·∫≠p Kh√≥a" title="VD: 25" />
          </div>

          <div class="grid grid-cols-1 gap-2 mt-3">
            <button id="btnBatchPDFDot"   class="btn btn-primary  w-full">In PDF g·ªôp theo ƒë·ª£t</button>
            <button id="btnExportExcelDot" class="btn btn-outline w-full">Xu·∫•t Excel theo ƒë·ª£t</button>
          </div>

          <p class="text-xs text-gray-500 mt-2">
            C√≥ th·ªÉ nh·∫≠p th√™m <b>Kh√≥a</b> ƒë·ªÉ l·ªçc ƒë√∫ng ‚Äúƒë·ª£t thu·ªôc kh√≥a n√†o‚Äù (tr√°nh tr√πng t√™n ƒë·ª£t).
          </p>
        </section>

        <hr/>

        <section>
          <div class="section-title"><center>TR·ª¢ GI√öP</center></div>
          <ul class="list-disc ml-5 text-sm text-gray-600 space-y-1">
            <li>Ch·ªçn API Base r·ªìi nh·∫•n n√∫t Test cho l·∫ßn ƒë·∫ßu ho·∫∑c khi ƒë·ªïi server.</li>
            <li>Nh·∫•n n√∫t L∆∞u ƒë·ªÉ ghi nh·ªõ API Base.</li>
            <li>Nh·∫•n n√∫t ‚Üª ƒë·ªÉ t·∫£i l·∫°i danh s√°ch h·ªì s∆° v√† checklist t·ª´ server.</li>
            <li>ƒê·ªïi API Base ·ªü g√≥c tr√™n n·∫øu b·∫°n deploy n∆°i kh√°c.</li>
            <li>PDF m·ªü trong tab m·ªõi; n·∫øu b·ªã ch·∫∑n s·∫Ω m·ªü ngay t·∫°i tab.</li>
            <li>In A5: gi·∫•y A4, in 2 m·∫∑t, c·∫Øt ƒë√¥i; A4 (2-up) g·ªôp s·∫µn hai A5.</li>
            <li>T√¨m ki·∫øm theo <b>MSHV</b> ho·∫∑c <b>H·ªç t√™n</b>.</li>
            <li>ƒê·ªÉ tr·ªëng s·ªë l∆∞·ª£ng trong checklist ƒë·ªÉ ƒë√°nh d·∫•u c√≥/kh√¥ng.</li>
            <li>Ng√†y sinh c√≥ th·ªÉ ƒë·ªÉ tr·ªëng n·∫øu kh√¥ng r√µ.</li>
            <li>Li√™n h·ªá Email: <a href="mailto:hc.tuan@hutech.edu.vn">hc.tuan@hutech.edu.vn</a></li>
            <li>Li√™n h·ªá zalo: <a href="http://zalo.me/tuanconghuynh">Hu·ª≥nh C√¥ng Tu·∫•n T·∫°i ƒë√¢y!</a></li>
          </ul>
        </section>
      </aside>
    </div>
  </div>

  <footer class="max-w-6xl mx-auto px-6 pb-4 text-right text-xs text-gray-500">
    ¬© <span class="font-semibold">
      <a href="https://hutech.edu.vn/e-hutech" target="_blank" rel="noopener noreferrer">V-HT.PTƒêT HUTECH</a>
    </span>
    ‚ûñ Code by:
    <span class="font-semibold">
      <a href="http://zalo.me/tuanconghuynh" target="_blank" rel="noopener noreferrer">HC- Tuan</a>
    </span>
  </footer>

  <!-- Scripts -->
  <script>
  // ·∫®n trang trong l√∫c ki·ªÉm tra
  document.documentElement.style.visibility = 'hidden';

  (async () => {
    const base = location.origin.replace(/\/+$/, '');
    const candidates = ["", "/api"];
    let ok = false;
    let matchedPrefix = "";

    for (const p of candidates) {
      try {
        const r = await fetch(base + p + "/me", { credentials: "include", cache: "no-store" });
        if (r.ok) { ok = true; matchedPrefix = p; break; }
      } catch (_) {}
    }

    if (!ok) {
      const next = encodeURIComponent(location.pathname + location.search);
      location.replace(`/login?next=${next}`);
      return;
    }

    try { localStorage.setItem("apiBase", base); } catch {}
    window.__API_PREFIX = matchedPrefix;

    document.documentElement.style.visibility = '';
  })();

  // ========= helpers chung =========
  const $ = (id) => document.getElementById(id);



  // Toast
  function showToast(msg, type='info', ms=2500){
    const wrap = document.getElementById('toast-wrap');
    const el = document.createElement('div');
    el.className = `toast ${type}`;
    el.innerHTML = msg;
    wrap.appendChild(el);
    const t = setTimeout(()=>{ el.style.transition='opacity .15s'; el.style.opacity='0';
      setTimeout(()=> el.remove(), 180);
    }, ms);
    el.onclick = ()=>{ clearTimeout(t); el.remove(); };
  }

  // ==== Date utils (POST d√πng DD/MM/YYYY) ====
  function ymdToDMY_SLASH(s){
    if(!s) return "";
    const m = String(s).match(/^(\d{4})-(\d{2})-(\d{2})$/);
    return m ? `${m[3]}/${m[2]}/${m[1]}` : s;
  }
  function ymdKeep(s){ return (s||"").slice(0,10); }
  function fmtDateToInput(s){
    if(!s) return "";
    const m = String(s).match(/^(\d{1,2})[\/-](\d{1,2})[\/-](\d{4})$/);
    if (m) return `${m[3]}-${m[2].padStart(2,'0')}-${m[1].padStart(2,'0')}`;
    const d = new Date(s);
    return Number.isNaN(d.getTime()) ? String(s).slice(0,10) : d.toISOString().slice(0,10);
  }

  // ========= API base / prefix =========
  const STORAGE_KEY = "apiBase";
  let API_PREFIX = window.__API_PREFIX || "";

  function apiBase(){ return ($("apiBase").value || localStorage.getItem(STORAGE_KEY) || window.location.origin).trim().replace(/\/+$/,''); }

  async function pingPrefix(base){
    try{ let r = await fetch(base + "/health", {credentials:"include"}); if (r.ok) return ""; }catch(_){}
    try{ let r2 = await fetch(base + "/api/health", {credentials:"include"}); if (r2.ok) return "/api"; }catch(_){}
    return null;
  }

  async function ensureApiBaseAndPrefix(){
    let base = localStorage.getItem(STORAGE_KEY) || window.location.origin;
    $("apiBase").value = base;
    let pref = await pingPrefix(base);
    if (pref !== null){ API_PREFIX = pref; return; }

    const guesses = [base, window.location.origin, "http://127.0.0.1:8000", "http://localhost:8000"];
    for (const g of guesses){
      const p = await pingPrefix(g);
      if (p !== null){ $("apiBase").value = g; localStorage.setItem(STORAGE_KEY, g); API_PREFIX = p; return; }
    }

    for(;;){
      const m = prompt("Kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c API.\nNh·∫≠p IP/URL server (vd: http://192.168.2.82:8000):", base);
      if (!m) break;
      const p = await pingPrefix(m.trim());
      if (p !== null){ $("apiBase").value = m.trim(); localStorage.setItem(STORAGE_KEY, m.trim()); API_PREFIX = p; return; }
      base = m.trim();
    }
    API_PREFIX = "";
  }

  function makeUrl(path){ return apiBase() + (API_PREFIX || "") + path; }

  async function apiFetch(path, init={}){
    const opts = { credentials: "include", ...init };
    let r = await fetch(makeUrl(path), opts).catch(()=>null);
    return r;
  }

  function handleAuth(r){
    if (r && (r.status===401 || r.status===403)){
      showToast("Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n, vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.", "warn", 2500);
      setTimeout(()=>location.href="/login", 700);
      return true;
    }
    return false;
  }
  const safeJson = async (r)=>{ try{ return await r.json(); }catch{ return {}; } };

  // ====== NAV / Auth UI ======
  async function refreshAuthUI(){
    try{
      const r = await apiFetch('/me', { credentials:'include' });
      if (!r || !r.ok){
        ["navImport","navStudents","navAdmin","navHello"].forEach(id=>$(id)?.classList.add("hidden"));
        $("navLogin")?.classList.remove("hidden");
        $("navLogout")?.classList.add("hidden");
        return;
      }

      const me   = await r.json();
      const role = me.role || "";
      const isAdmin = role === "Admin";
      const isStaff = isAdmin || role === "NhanVien";
      const canViewStudents = isStaff || role === "CongTacVien";

      $("navHello").textContent = `Xin ch√†o, ${me.full_name || me.username} (${role})`;
      $("navHello").classList.remove("hidden");
      $("navLogin")?.classList.add("hidden");
      $("navLogout")?.classList.remove("hidden");

      if (isStaff) $("navImport")?.classList.remove("hidden"); else $("navImport")?.classList.add("hidden");
      if (isAdmin) $("navAdmin")?.classList.remove("hidden"); else $("navAdmin")?.classList.add("hidden");
      if (canViewStudents) $("navStudents")?.classList.remove("hidden"); else $("navStudents")?.classList.add("hidden");

      const rec = $("nguoi_nhan_ky_ten");
      if (rec && !rec.value) rec.value = me.full_name || me.username || "";
    }catch(_){
      ["navImport","navStudents","navAdmin","navHello"].forEach(id=>$(id)?.classList.add("hidden"));
      $("navLogin")?.classList.remove("hidden");
      $("navLogout")?.classList.add("hidden");
    }
  }

  // Logout
  $("navLogout")?.addEventListener("click", async ()=>{
    try{ await apiFetch('/logout', { method:'POST', credentials:'include' }); }catch(_){}
    location.href = '/login';
  });

  // ===== Checklist =====
  const DEFAULT_QTY = {
    bang_tot_nghiep_dai_hoc: 2,
    bang_diem_dai_hoc: 2,
    bang_tot_nghiep_cao_dang: 2,
    bang_diem_cao_dang: 2,
    bang_tot_nghiep_trung_cap: 2,
    bang_diem_trung_cap: 2,
    anh_3x4: 2,
  };
  const getDefaultQty = (code) => DEFAULT_QTY[code] ?? 1;

  async function loadChecklist() {
    try {
      const r = await apiFetch("/checklist/active");
      if (!r || !r.ok) { showToast("Kh√¥ng l·∫•y ƒë∆∞·ª£c checklist", "error"); return; }
      const data = await r.json();
      const body = $("docsBody");
      body.innerHTML = "";

      (data.items||[])
        .sort((a,b)=> (a.order_index ?? a.order_no ?? 0) - (b.order_index ?? b.order_no ?? 0))
        .forEach((it, idx) => {
          const def = getDefaultQty(it.code);
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td class="p-2 border text-center">${idx+1}</td>
            <td class="p-2 border"><div class="font-medium">${it.display_name}</div></td>
            <td class="p-2 border text-center">
              <input type="checkbox" class="w-5 h-5 has-doc" data-code="${it.code}">
            </td>
            <td class="p-2 border text-center">
              <input type="number" min="0"
                     class="input w-24 text-center qty bg-gray-100 text-gray-400"
                     data-code="${it.code}" value="" placeholder="${def}" disabled />
            </td>`;
          body.appendChild(tr);
        });

      document.querySelectorAll('.has-doc').forEach((chk) => {
        const code = chk.dataset.code;
        const qty = document.querySelector(`.qty[data-code="${code}"]`);
        const def = getDefaultQty(code);
        chk.addEventListener("change", () => {
          if (chk.checked) {
            qty.value = String(def);
            qty.disabled = false;
            qty.classList.remove("bg-gray-100", "text-gray-400");
          } else {
            qty.value = "";
            qty.disabled = true;
            qty.classList.add("bg-gray-100", "text-gray-400");
          }
        });
      });
    } catch (err) {
      console.error(err);
      showToast('L·ªói t·∫£i checklist', 'error');
    }
  }

  function collectDocs() {
    const rows = Array.from(document.querySelectorAll('#docsBody tr'));
    return rows.map(tr => {
      const chk  = tr.querySelector('.has-doc');
      const qtyI = tr.querySelector('.qty');
      const code = chk.dataset.code;
      const def  = getDefaultQty(code);
      let val = chk.checked ? Number(qtyI.value || def) : 0;
      if (!Number.isFinite(val) || val < 0) val = 0;
      return { code, so_luong: val };
    });
  }

  // ===== Payloads =====
  function payloadForCreate() {
    return {
      ma_ho_so: $("ma_ho_so").value.trim(),
      ngay_nhan_hs: ymdToDMY_SLASH($("ngay_nhan_hs").value), // DD/MM/YYYY
      ho_ten: $("ho_ten").value.trim(),
      ma_so_hv: $("ma_so_hv").value.trim(),
      ngay_sinh: ymdToDMY_SLASH($("ngay_sinh").value) || null, // DD/MM/YYYY
      so_dt: $("so_dt").value.trim() || null,
      email_hoc_vien: $("email_hoc_vien").value.trim() || null,
      nganh_nhap_hoc: $("nganh_nhap_hoc").value.trim() || null,
      dot: $("dot").value.trim() || null,
      khoa: $("khoa").value.trim() || null,
      da_tn_truoc_do: $("da_tn_truoc_do").value || null,
      ghi_chu: $("ghi_chu").value.trim() || null,
      nguoi_nhan_ky_ten: $("nguoi_nhan_ky_ten").value.trim() || null,
      docs: collectDocs(),
      checklist_version_name: "v1"
    };
  }
  function payloadForUpdate() {
    return {
      ma_ho_so: $("ma_ho_so").value.trim(),
      ngay_nhan_hs: ymdKeep($("ngay_nhan_hs").value), // YYYY-MM-DD
      ho_ten: $("ho_ten").value.trim(),
      ma_so_hv: $("ma_so_hv").value.trim(),
      ngay_sinh: ymdKeep($("ngay_sinh").value) || null, // YYYY-MM-DD
      so_dt: $("so_dt").value.trim() || null,
      email_hoc_vien: $("email_hoc_vien").value.trim() || null,
      nganh_nhap_hoc: $("nganh_nhap_hoc").value.trim() || null,
      dot: $("dot").value.trim() || null,
      khoa: $("khoa").value.trim() || null,
      da_tn_truoc_do: $("da_tn_truoc_do").value || null,
      ghi_chu: $("ghi_chu").value.trim() || null,
      nguoi_nhan_ky_ten: $("nguoi_nhan_ky_ten").value.trim() || null,
      docs: collectDocs()
    };
  }

  // ===== Save / Create =====
  async function createApplicant(){
    const body = payloadForCreate();
    if(!body.ma_ho_so || !body.ho_ten || !body.ma_so_hv || !body.ngay_nhan_hs){
      showToast("Thi·∫øu M√£ h·ªì s∆° / H·ªç t√™n / MSHV / Ng√†y nh·∫≠n.", "error");
      return null;
    }
    const r = await apiFetch("/applicants", { method: "POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(body) });
    if (handleAuth(r)) return null;
    const j = await safeJson(r);
    if (!r || !r.ok){ showToast(j.detail || `L·ªói l∆∞u (HTTP ${r ? r.status : '???'})`, "error", 4000); return null; }
    // >>> d√πng ma_so_hv l√†m kh√≥a
    window.loadedApplicant = { ma_so_hv: j.ma_so_hv || body.ma_so_hv, ma_ho_so: j.ma_ho_so || body.ma_ho_so };
    setPrintButtonsEnabled(true);
    return j;
  }

  // ===== Lookup / Update / Delete =====
  let loadedDocsByCode = {};

  function setPrintButtonsEnabled(on) {
    $("btnPrintLoadedA5").disabled   = !on;
    $("btnPrintLoadedA4").disabled = !on;
  }

  function populateFormFromApplicant(a, docs){
    $("ma_ho_so").value = a.ma_ho_so || "";
    $("ngay_nhan_hs").value = fmtDateToInput(a.ngay_nhan_hs);
    $("khoa").value = a.khoa || "";
    $("ho_ten").value = a.ho_ten || "";
    $("ma_so_hv").value = a.ma_so_hv || "";
    $("ngay_sinh").value = fmtDateToInput(a.ngay_sinh);
    $("so_dt").value = a.so_dt || "";
    $("email_hoc_vien").value = a.email_hoc_vien || "";
    $("nganh_nhap_hoc").value = a.nganh_nhap_hoc || "";
    $("dot").value = a.dot || "";
    $("da_tn_truoc_do").value = a.da_tn_truoc_do || "";
    $("ghi_chu").value = a.ghi_chu || "";
    $("nguoi_nhan_ky_ten").value = a.nguoi_nhan_ky_ten || "";

    loadedDocsByCode = {}; (docs||[]).forEach(d => loadedDocsByCode[d.code] = d.so_luong || 0);

    const applyDocsToTable = () => {
      document.querySelectorAll('.has-doc').forEach(chk => {
        const code = chk.dataset.code;
        const qty = document.querySelector(`.qty[data-code="${code}"]`);
        const n = loadedDocsByCode[code] ?? 0;
        if (n > 0) { chk.checked = true; qty.disabled = false; qty.classList.remove("bg-gray-100","text-gray-400"); qty.value = String(n); }
        else { chk.checked = false; qty.disabled = true; qty.classList.add("bg-gray-100","text-gray-400"); qty.value = ""; }
      });
    };
    if (document.querySelectorAll('#docsBody tr').length === 0) loadChecklist().then(applyDocsToTable); else applyDocsToTable();
  }

  // Tra c·ª©u THEO MSHV
  async function loadApplicantByMSHV(mshv){
    let r = await apiFetch(`/applicants/by-mshv/${encodeURIComponent(mshv)}`);
    if (!r || r.status === 404 || r.status === 405) {
      const rs = await apiFetch(`/applicants/search?q=${encodeURIComponent(mshv)}`);
      if (rs && rs.ok) {
        const j = await rs.json();
        const list = Array.isArray(j.items) ? j.items : (Array.isArray(j) ? j : []);
        const hit = list.find(x => (x.ma_so_hv || "").toLowerCase() === String(mshv).toLowerCase()) || list[0];
        if (hit) {
          r = await apiFetch(`/applicants/by-code/${encodeURIComponent(hit.ma_ho_so)}`);
        }
      }
    }
    if (!r || !r.ok) {
      if (r && r.status === 404) showToast(`Kh√¥ng t√¨m th·∫•y MSHV ${mshv}`, "warn");
      const t = r ? await r.text() : "(kh√¥ng ph·∫£n h·ªìi)";
      throw new Error(`L·ªói t·∫£i h·ªì s∆° (HTTP ${r ? r.status : '???'})\n${t}`);
    }
    const data = await r.json();
    const raw = (data && data.applicant) ? { ...data.applicant, docs: data.docs || [] } : data;
    return raw;
  }

  async function updateLoadedApplicant(){
    if(!window.loadedApplicant?.ma_so_hv){ throw new Error("Ch∆∞a t·∫£i h·ªì s∆° n√†o ƒë·ªÉ c·∫≠p nh·∫≠t."); }
    const body = payloadForUpdate();
    if(!body.ma_ho_so || !body.ho_ten){
      throw new Error("Thi·∫øu M√£ h·ªì s∆° / H·ªç t√™n.");
    }
    const r = await apiFetch(`/applicants/${encodeURIComponent(window.loadedApplicant.ma_so_hv)}`, {
      method: "PUT",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(body)
    });
    if (handleAuth(r)) return;
    if(!r || !r.ok){ const t = r ? await r.text() : "(kh√¥ng ph·∫£n h·ªìi)"; throw new Error(`C·∫≠p nh·∫≠t th·∫•t b·∫°i (HTTP ${r ? r.status : '???'})\n${t}`); }
    const res = await r.json();
    // ƒë·ªìng b·ªô l·∫°i
    window.loadedApplicant.ma_ho_so = res.ma_ho_so || body.ma_ho_so;
    return res;
  }

  async function deleteLoadedApplicant(){
    if(!window.loadedApplicant?.ma_so_hv){ throw new Error("Ch∆∞a t·∫£i h·ªì s∆° n√†o ƒë·ªÉ xo√°."); }
    if(!confirm(`Xo√° h·ªì s∆° ${window.loadedApplicant.ma_ho_so}?`)) return;
    const r = await apiFetch(`/applicants/${encodeURIComponent(window.loadedApplicant.ma_so_hv)}`, { method: "DELETE" });
    if (handleAuth(r)) return;
    if(!r || !r.ok){ const t = r ? await r.text() : "(kh√¥ng ph·∫£n h·ªìi)"; throw new Error(`Xo√° th·∫•t b·∫°i (HTTP ${r ? r.status : '???'})\n${t}`); }
    window.loadedApplicant = null; loadedDocsByCode = {};
    setPrintButtonsEnabled(false);
    $("lookupMsg").textContent = "ƒê√£ xo√° h·ªì s∆°.";
    showToast("ƒê√£ xo√° h·ªì s∆°.", "info");
  }

  // T√¨m theo t√™n (tr·∫£ list)
  // T√åM THEO T√äN: th·ª≠ nhi·ªÅu endpoint + format tr·∫£ v·ªÅ
  async function searchByName(name) {
    const q = String(name || "").trim().replace(/\s+/g, " ");
    if (q.length < 2) throw new Error("Nh·∫≠p t·ªëi thi·ªÉu 2 k√Ω t·ª± ƒë·ªÉ t√¨m theo t√™n.");

    const urls = [
      `/applicants/search?q=${encodeURIComponent(q)}`,        // chu·∫©n c≈©
      `/applicants/search?name=${encodeURIComponent(q)}`,     // m·ªôt s·ªë BE d√πng name=
      `/applicants/search?full_name=${encodeURIComponent(q)}`,// ho·∫∑c full_name=
      `/applicants/by-name?q=${encodeURIComponent(q)}`,       // ph√≤ng xa BE ƒë·∫∑t route kh√°c
    ];

    // helper ƒë·ªçc JSON an to√†n
    const readJson = async (r) => { try { return await r.json(); } catch { return null; } };

    let lastErrText = "";
    for (const u of urls) {
      const r = await apiFetch(u);
      if (!r) continue;

      if (r.status === 401 || r.status === 403) { handleAuth(r); return []; }
      if (!r.ok) { try { lastErrText = await r.text(); } catch {} ; continue; }

      const j = await readJson(r);
      if (!j) continue;

      // Chu·∫©n ho√° c√°c d·∫°ng c·∫•u tr√∫c ph·ªï bi·∫øn
      let list = [];
      if (Array.isArray(j)) list = j;
      else if (Array.isArray(j.items)) list = j.items;
      else if (Array.isArray(j.data))  list = j.data;
      else if (Array.isArray(j.results)) list = j.results;
      else if (j.items && j.items.data && Array.isArray(j.items.data)) list = j.items.data;

      // map t·ªëi thi·ªÉu c√°c tr∆∞·ªùng c·∫ßn hi·ªÉn th·ªã
      list = (list || []).map(it => ({
        ho_ten: it.ho_ten || it.full_name || it.ten || "",
        ma_ho_so: it.ma_ho_so || it.code || it.ma_hs || "",
        ma_so_hv: it.ma_so_hv || it.mssv || it.mshv || "",
        ngay_nhan_hs: it.ngay_nhan_hs || it.created_at || it.ngay || null,
        dot: it.dot || it.dot_tuyen || "",
      }));

      if (list.length) return list;
    }

    // Kh√¥ng endpoint n√†o tr·∫£ danh s√°ch d√πng ƒë∆∞·ª£c
    if (lastErrText) console.warn("Name search last error:", lastErrText);
    return [];
  }

  // ===== Render danh s√°ch k·∫øt qu·∫£ t√¨m theo t√™n (GLOBAL) =====
  function renderNameResults(list){
    list = Array.isArray(list) ? list : (Array.isArray(list?.items) ? list.items : []);
    const box = $("nameResults");
    const ul  = $("nameResultsList");
    if (!box || !ul) return; // ph√≤ng ng·ª´a thi·∫øu DOM

    if(!list || list.length === 0){
      box.classList.remove("hidden");
      ul.innerHTML = '<li class="p-2 text-sm text-gray-500">Kh√¥ng t√¨m th·∫•y.</li>';
      return;
    }

    ul.innerHTML = list.map(it => {
      const ngay = it.ngay_nhan_hs ? String(it.ngay_nhan_hs).slice(0,10) : '';
      return `
        <li class="p-2 hover:bg-gray-50 cursor-pointer" data-mshv="${it.ma_so_hv||''}">
          <div class="flex justify-between">
            <div class="font-medium">${it.ho_ten||it.full_name||""}</div>
            <div class="text-xs text-gray-500">${ngay}</div>
          </div>
          <div class="text-xs text-gray-600">
            M√£ HS: <span class="font-semibold">${it.ma_ho_so||it.code||""}</span>
            ‚Ä¢ MSHV: ${it.ma_so_hv||it.mssv||it.mshv||''}
            ‚Ä¢ ƒê·ª£t: ${it.dot||it.dot_tuyen||''}
          </div>
        </li>`;
    }).join("");

    // bind ch·ªçn k·∫øt qu·∫£ 1 l·∫ßn
    if (!ul._boundClick) {
      ul.addEventListener('click', (e)=>{
        const li = e.target.closest('li[data-mshv]');
        if (!li) return;
        $("q_ma_so_hv").value = li.dataset.mshv || '';
        box.classList.add('hidden');
        $("btnLoadApplicantMSHV")?.click();
      });
      ul._boundClick = true;
    }
    box.classList.remove('hidden');
  }

  // helper: m·ªü PDF n·∫øu OK; n·∫øu l·ªói (400/404/...) th√¨ hi·ªán c·∫£nh b√°o ƒë·∫πp
  async function openPdfOrAlert(url){
    const resp = await fetch(makeUrl(url), { credentials: "include" });
    if (!resp.ok) {
      let msg = `Kh√¥ng th·ªÉ th·ª±c hi·ªán (HTTP ${resp.status})`;
      try {
        const txt = await resp.text();
        const j = JSON.parse(txt);
        if (j && j.detail) msg = j.detail; // d√πng message t·ª´ backend
      } catch (_) {}
      alert(msg);
      return;
    }
    const blob = await resp.blob();
    const u = URL.createObjectURL(blob);
    window.open(u, "_blank");
    setTimeout(()=>URL.revokeObjectURL(u), 60000);
  }
  // ===== In / Export =====
  function openPdf(url){
    const w = window.open(url, "_blank");
    if(!w){ window.location.href = url; }
  }

  // B·ªè d·∫•u ti·∫øng Vi·ªát & chu·∫©n ho√° so s√°nh
  function vnNorm(s){
    return (s||"")
      .normalize('NFD').replace(/[\u0300-\u036f]/g,'') // strip diacritics
      .replace(/ƒë/g,'d').replace(/ƒê/g,'D')
      .trim().toLowerCase();
  }

  // Ch·∫•m ƒëi·ªÉm m·ª©c kh·ªõp: cao h∆°n = kh·ªõp h∆°n
  function matchScore(name, query){
    const a = vnNorm(name);
    const b = vnNorm(query);
    if (!a || !b) return 0;
    if (a === b) return 100;                 // tr√πng tuy·ªát ƒë·ªëi
    if (a.startsWith(b)) return 90;          // b·∫Øt ƒë·∫ßu b·∫±ng
    if (a.includes(b)) return 70;            // c√≥ ch·ª©a
    // t√°ch t·ª´: t·∫•t c·∫£ token ƒë·ªÅu xu·∫•t hi·ªán
    const tokens = b.split(/\s+/).filter(Boolean);
    const ok = tokens.every(t => a.includes(t));
    return ok ? 60 : 0;
  }

  // L·ªçc + s·∫Øp x·∫øp theo t√™n, gi·ªõi h·∫°n top N
  function filterAndSortByName(list, q, limit=20){
    const scored = (list||[]).map(it => {
      const name = it.ho_ten || it.full_name || it.ten || '';
      const score = matchScore(name, q);
      return {it, score};
    }).filter(x => x.score > 0);

    scored.sort((p,q) => q.score - p.score);
    return scored.slice(0, limit).map(x => x.it);
  }

  $("btnBatchPDF").onclick = async () => {
    const d = $("batchDate").value;
    if (!d) { alert("Ch·ªçn ng√†y nh·∫≠n HS"); return; }
    const resp = await apiFetch(`/batch/print?day=${encodeURIComponent(d)}`);
    if (!resp || !resp.ok) {
      let msg = `Kh√¥ng th·ªÉ in (HTTP ${resp?.status||'???'})`;
      try { const j = await resp.json(); if (j?.detail) msg = j.detail; } catch {}
      alert(msg); return;
    }
    const blob = await resp.blob();
    const u = URL.createObjectURL(blob);
    window.open(u, "_blank"); setTimeout(()=>URL.revokeObjectURL(u), 60000);
  };

  $("btnExportExcel").onclick = async () => {
    const d = $("batchDate").value;
    if (!d) { alert("Ch·ªçn ng√†y nh·∫≠n HS"); return; }
    const resp = await apiFetch(`/export/excel?day=${encodeURIComponent(d)}`);
    if (!resp || !resp.ok) {
      let msg = `Kh√¥ng th·ªÉ xu·∫•t Excel (HTTP ${resp?.status||'???'})`;
      try { const j = await resp.json(); if (j?.detail) msg = j.detail; } catch {}
      alert(msg); return;
    }
    const blob = await resp.blob();
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `tong_ngay_${d}.xlsx`;
    document.body.appendChild(a); a.click(); a.remove();
    setTimeout(()=>URL.revokeObjectURL(a.href), 60000);
  };

  $("btnBatchPDFDot").onclick = async () => {
    const dot  = $("batchDot").value.trim();
    const khoa = $("batchKhoa")?.value.trim();
    if (!dot) { alert("Nh·∫≠p t√™n ƒë·ª£t tr∆∞·ªõc ƒë√£"); return; }

    let url = `/batch/print-dot?dot=${encodeURIComponent(dot)}`;
    if (khoa) url += `&khoa=${encodeURIComponent(khoa)}`;

    const resp = await fetch(makeUrl(url));
    if (!resp.ok) {
      let msg = `Kh√¥ng th·ªÉ in theo ƒë·ª£t (HTTP ${resp.status})`;
      try { const j = await resp.json(); if (j?.detail) msg = j.detail; } catch {}
      alert(msg); return;
    }
    const blob = await resp.blob();
    const u = URL.createObjectURL(blob);
    window.open(u, "_blank"); setTimeout(()=>URL.revokeObjectURL(u), 60000);
  };

  $("btnExportExcelDot").onclick = async () => {
    const dot  = $("batchDot").value.trim();
    const khoa = $("batchKhoa")?.value.trim();
    if (!dot) { alert("Nh·∫≠p t√™n ƒë·ª£t tr∆∞·ªõc ƒë√£"); return; }

    let url = `/export/excel-dot?dot=${encodeURIComponent(dot)}`;
    if (khoa) url += `&khoa=${encodeURIComponent(khoa)}`;

    const resp = await fetch(makeUrl(url));
    if (!resp.ok) {
      let msg = `Kh√¥ng th·ªÉ xu·∫•t Excel theo ƒë·ª£t (HTTP ${resp.status})`;
      try { const j = await resp.json(); if (j?.detail) msg = j.detail; } catch {}
      alert(msg); return;
    }
    const blob = await resp.blob();
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `tong_dot_${dot}${khoa ? `_khoa_${khoa}` : ""}.xlsx`;
    document.body.appendChild(a); a.click(); a.remove();
    setTimeout(()=>URL.revokeObjectURL(a.href), 60000);
  };

  // ===== Bind form actions =====
  $("btnSave").onclick = async () => {
    const btn = $("btnSave");
    btn.disabled = true; const old = btn.textContent; btn.textContent = "ƒêang l∆∞u...";
    try{
      const res = await createApplicant();
      if (res) {
        $("msg").textContent = `ƒê√£ l∆∞u h·ªì s∆° ${res.ma_ho_so || $("ma_ho_so").value}.`;
        showToast(`ƒê√£ l∆∞u h·ªì s∆° <b>${res.ma_ho_so || $("ma_ho_so").value}</b>.`, "success");
      }
    } finally{
      btn.disabled = false; btn.textContent = old;
    }
  };

  // Bind tra c·ª©u THEO MSHV
  $("btnLoadApplicantMSHV").onclick = async () => {
    try{
      const mshv = $("q_ma_so_hv").value.trim();
      if(!mshv){ alert("Nh·∫≠p MSHV (MSSV) ƒë·ªÉ t·∫£i."); return; }
      $("lookupMsg").textContent = "ƒêang t·∫£i theo MSHV...";
      const a = await loadApplicantByMSHV(mshv);
      window.loadedApplicant = { ma_so_hv: a.ma_so_hv, ma_ho_so: a.ma_ho_so }; // <<< d√πng MSSV
      populateFormFromApplicant(a, a.docs || []);
      setPrintButtonsEnabled(true);
      $("lookupMsg").textContent = `ƒê√£ t·∫£i h·ªì s∆°: ${a.ho_ten} ‚Ä¢ M√£ HS ${a.ma_ho_so} ‚Ä¢ MSHV ${a.ma_so_hv}`;
    }catch(e){
      $("lookupMsg").textContent = e.message;
      setPrintButtonsEnabled(false);
    }
  };
  $("q_ma_so_hv").addEventListener('keydown', (e)=>{
    if(e.key==='Enter'){ e.preventDefault(); $("btnLoadApplicantMSHV").click(); }
  });

  // T√¨m theo t√™n
  $("btnSearchByName").onclick = async () => {
    try{
      const name = $("q_ho_ten").value.trim();
      if(name.length < 2){ alert("Nh·∫≠p t·ªëi thi·ªÉu 2 k√Ω t·ª±."); return; }
      $("lookupMsg").textContent = "ƒêang t√¨m theo t√™n...";
      let list = await searchByName(name);
      // l·ªçc theo t√™n (kh√¥ng d·∫•u) ƒë·ªÉ lo·∫°i k·∫øt qu·∫£ lan man
      list = filterAndSortByName(list, name, 25);
      renderNameResults(list);    // h√†m n√†y b·∫°n ƒë√£ c√≥
      renderNameResults(list);                    // <-- gi·ªù ch·∫Øc ch·∫Øn t·ªìn t·∫°i
      $("lookupMsg").textContent = list.length ? `T√¨m th·∫•y ${list.length} k·∫øt qu·∫£.` : "Kh√¥ng t√¨m th·∫•y.";
    }catch(e){
      $("lookupMsg").textContent = e.message || "L·ªói t√¨m ki·∫øm.";
      showToast(e.message || "L·ªói t√¨m ki·∫øm.", "error");
    }
  };

  $("q_ho_ten").addEventListener('keydown', (e)=>{ if(e.key==='Enter') $("btnSearchByName").click(); });

  // Update (c·∫£ 2 n√∫t)
  ["btnUpdateApplicant", "btnUpdateApplicantMain"].forEach(id=>{
    $(id)?.addEventListener("click", async () => {
      try{
        $("lookupMsg").textContent = "ƒêang c·∫≠p nh·∫≠t...";
        const res = await updateLoadedApplicant();
        if (res?.nguoi_nhan_ky_ten) {
          $("nguoi_nhan_ky_ten").value = res.nguoi_nhan_ky_ten;
        }
        $("lookupMsg").textContent = `C·∫≠p nh·∫≠t xong h·ªì s∆° ${res.ma_ho_so}.`;
        showToast(`ƒê√£ c·∫≠p nh·∫≠t h·ªì s∆° <b>${res.ma_ho_so}</b>.`, "success");
      } catch(e){
        $("lookupMsg").textContent = e.message;
        showToast(e.message || "C·∫≠p nh·∫≠t th·∫•t b·∫°i.", "error");
      }
    });
  });

  // Xo√°
  $("btnDeleteApplicant").onclick = async () => {
    try{ await deleteLoadedApplicant(); } catch(e){ $("lookupMsg").textContent = e.message; showToast(e.message, "error"); }
  };

  // In h·ªì s∆° ƒëang m·ªü
  $("btnPrintLoadedA5").onclick = () => {
    if (!window.loadedApplicant?.ma_so_hv) return alert("Ch∆∞a t·∫£i h·ªì s∆° n√†o.");
    openPdf(makeUrl(`/print/a5/${encodeURIComponent(window.loadedApplicant.ma_so_hv)}`));
  };
  $("btnPrintLoadedA4").onclick = () => {
    if (!window.loadedApplicant?.ma_so_hv) return alert("Ch∆∞a t·∫£i h·ªì s∆° n√†o.");
    // ƒê·ªîI endpoint v·ªÅ A4 ƒë∆°n
    openPdf(makeUrl(`/print/a4/${encodeURIComponent(window.loadedApplicant.ma_so_hv)}`));
  };

  // Reload checklist
  $("btnReloadChecklist").onclick = () => loadChecklist();

  // Test API button
  $("btnTestApi").onclick = async ()=>{
    const base = apiBase();
    const pref = await pingPrefix(base);
    if (pref === null) showToast("Kh√¥ng ping ƒë∆∞·ª£c API /health", "error");
    else { API_PREFIX = pref; localStorage.setItem(STORAGE_KEY, base); showToast(`K·∫øt n·ªëi OK (${base}${pref||""}/health)`, "success"); }
  };
  $("apiBase").addEventListener("change", async ()=>{
    const base = apiBase();
    localStorage.setItem(STORAGE_KEY, base);
    const pref = await pingPrefix(base);
    if (pref === null) showToast("Kh√¥ng ping ƒë∆∞·ª£c API /health", "warn");
    else { API_PREFIX = pref; showToast("ƒê√£ c·∫≠p nh·∫≠t m√°y ch·ªß API", "success"); }
  });

  // ===== init =====
  window.addEventListener('load', async () => {
    const today = new Date().toISOString().slice(0,10);
    $("ngay_nhan_hs").value = today;
    $("batchDate").value = today;
    $("q_ma_so_hv")?.focus();

    await ensureApiBaseAndPrefix();
    await refreshAuthUI();
    await loadChecklist();
    setPrintButtonsEnabled(false);

    // Auto-load khi c√≥ ?mshv=... tr√™n URL (n√∫t "S·ª≠a" t·ª´ danh s√°ch)
    const url = new URL(window.location.href);
    const mshv = url.searchParams.get('mshv');
    if (mshv) {
      $("q_ma_so_hv").value = mshv;
      $("btnLoadApplicantMSHV").click();
    }
  });
  </script>
</body>
</html>
